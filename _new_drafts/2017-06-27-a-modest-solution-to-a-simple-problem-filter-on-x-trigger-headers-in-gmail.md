---
layout: post
status: publish
published: true
title: 'A modest solution to a simple problem: Filter on X-Trigger headers in Gmail'
author: isotopp
author_login: kris
author_email: kristian.koehntopp@gmail.com
wordpress_id: 1987
wordpress_url: http://blog.koehntopp.info/?p=1987
date: '2017-06-27 12:55:12 +0200'
date_gmt: '2017-06-27 11:55:12 +0200'
categories:
- Computer Science
- Erklärbär
tags: []
---
<p>I have a very simple problem. My Gmail is receiving a mail with an X-Trigger header and I need to filter these messages (mark them as Archived, as Read an label them into the "filtered" category). Here is a sample: {% highlight console %} $ cat t X-Trigger: test Subject: a test From: kris@koehntopp.de (Kristian Koehntopp) To: kristian.koehntopp@booking.com Testing $ mutt -H t ... {% endhighlight %} Now, generating filters in Gmail is very easy for various capabilities, but for some reason filters on arbitray header lines are not possible. <!--more--> ![](http://blog.koehntopp.info/wp-content/uploads/2017/06/gmail-lists.jpg) Here is what Gmail offers for the trivial cases it supports: Newsletters can be automatically unsubscribed from, using the "Unsubscribe" link shown in the left hand red circle. If you want to tag the mailing list instead, the "Filter messages like these" from the "More" menu will take care of it. You most likely want to filter on the "list-id" header, if present, or on the "from" header line. A full list of supported search operators can be found in the [Gmail Documentation](https://support.google.com/mail/answer/7190?hl=en). But all that search goodness is for supported headers and the bodies of mail, not arbitrary header lines. Time for some overkill: here is [script.google.com](https://script.google.com). It's a thing where you can use Javascript to automate any of G.suite, Gmail and a bunch of other Google Cloud offerings. ![](http://blog.koehntopp.info/wp-content/uploads/2017/06/vaguely-cool.jpg) So this looks vaguely cool, but what can I do here? [Tutorial Time](https://developers.google.com/apps-script/articles/). The [default script](https://developers.google.com/apps-script/overview) will create a Google Docs document in your Gdrive, and then mail you the link.</p>
<p>    function createAndSendDocument() { var doc = DocumentApp.create('Hello, world!'); doc.getBody().appendParagraph('This document was created by Google Apps Script.'); var url = doc.getUrl(); var email = Session.getActiveUser().getEmail(); var subject = doc.getName(); var body = 'Link to your doc: ' + url; GmailApp.sendEmail(email, subject, body); } {% endhighlight %} So, can we talk to Gmail? Turns out, we can, [there is documentation](https://developers.google.com/gmail/api/v1/reference/users/threads). So let's do that: </p>
<p>        function filterByHeader(search, hdr\_regex, labelname) { var label = GmailApp.getUserLabelByName(labelname); var cnt = 0; var threads = GmailApp.search(search); for (var j=0; j\
<threads.length; j++) { thd = threads[j]; msgs = thd.getMessages(); for (var i=0; i\< msgs.length; i++) { var m = msgs[i]; var raw = m.getRawContent(); var headers = raw.substring(0, raw.indexOf("\r\n\r\n")); if (headers.search(hdr\_regex) \>= 0) { cnt++; thd.markUnimportant(); thd.markRead(); thd.moveToArchive(); thd.addLabel(label); } } } return "We had "+cnt+" matches."; } {% endhighlight %} With filterByHeader("is:unread label:inbox newer\_than:1d", /^X-Trigger:/m, "filtered") we are getting precisely what we want. Now, we need to let that run every time a mail is coming in. How do we run code, besides pressing [\>] in the editor? ![](http://blog.koehntopp.info/wp-content/uploads/2017/06/webhook.jpg) If we add a doGet(e) function to our script, it will be running after we are publishing it as a web app. So: </p>
<p>            function doGet(e) { var search = "is:unread label:inbox newer\_than:1d"; var hdr\_regex = /^X-Trigger:/m; var labelname = "kris-test"; var url = filterByHeader(search, hdr\_regex, labelname); return ContentService.createTextOutput(url); } {% endhighlight %} Now, how do we run Webhooks on mail receipt? Well, in theory, we can go to the Google Cloud Console, and enable PubSub, and then have a [watch request](https://developers.google.com/gmail/api/guides/push#watch_request) post a message to a topic of our choice. The consumer/client for that topic is then a push client pointing to our webhook. In practice, generating and posting these events works, and calling the webhook manually works, but when I want to set up the webhook in PubSub, I get an [INVALID ARGUMENT](https://cloud.google.com/pubsub/docs/reference/error-codes). I get no details to debug on, so [at the moment I am stuck](https://twitter.com/attritionorg/status/732446572902940672?lang=en). See also: [https://www.youtube.com/watch?v=ICP1-w593NE#t=26s](https://www.youtube.com/watch?v=ICP1-w593NE#t=26s)</p>
