---
layout: post
status: publish
published: true
title: Wordpressing…
author: isotopp
author_login: kris
author_email: kristian.koehntopp@gmail.com
wordpress_id: 906
wordpress_url: http://blog.koehntopp.info/?p=906
date: '2017-03-02 18:48:24 +0100'
date_gmt: '2017-03-02 17:48:24 +0100'
categories:
- Blog
- Erklärbär
tags: []
---
<p>This blog is running a Wordpress, using Ubuntu, Apache and MySQL. So it's a very basic installation. I made all this with a tiny Scaleway VM and Ansible. My Goal has been to install this thing without actually having to log into the VM ("Look Mom, no hands!"). Of course, I have been logging into the VM, but that's mostly for checking things are going well. <!--more--></p>
<p>## MySQL Installation from Hell<br />
 Ubuntu being a Debian descendant, I am running into a few problems. For example, when installing things such as MySQL from a package, debianoid systems have a tendency to start things from the package immediately. That is of course completely silly, because that's a start with defaults, as the configuration is not yet in place.&nbsp; **How can I install a thing such as MySQL from a .deb without the server being started implicitly?** At the moment I am doing the trifecta backwards, which is kind of not the thing I want to do for a number of reasons. </p>
<p>    - name: MySQL installation defaults file template: src: "mysql-debconf-defaults" dest: "/tmp/mysql-debconf-defaults" owner: "root" group: "root" mode: "0600" - name: set MySQL defaults shell: debconf-set-selections \< /tmp/mysql-debconf-defaults; rm /tmp/mysql-debconf-defaults args: removes: "/tmp/mysql-debconf-defaults" - name: create config directory file: path: "/etc/mysql/conf.d" recurse: "yes" state: "directory" - name: create blog.cnf template: src: "blog.cnf" dest: "/etc/mysql/conf.d/blog.cnf" - name: create /root/.my.cnf template: src: "dotmy.cnf" dest: "/root/.my.cnf" owner: "root" group: "root" mode: "0600" # will also start the server instead of deferring to a handler - name: install MySQL server apt: name: "mysql-server-5.7" {% endhighlight %} This is annoying in multiple ways: The installation is interactive by default and I have install a debconf file, run debconf-set-selections and then remove the file, which is not idempotent and creates an action on every run (the file contains a password, so I cannot leave it laying around). The autostart at package installation precludes proper service startup control. Using notifies and a handler, I would only have one restart for package installation and config file changes. Instead I have to install config files before package installation, in order to prevent the server from starting without a configuration, and then later the server is autostarted by the package installation. Because of the ordering and the autostart, I cannot use notifications and handlers on the config file installations properly, so I am missing automated restarts on config changes.<br />
    ## Boring Apache install<br />
     The Apache installation is pretty boring: Apache whatever from Ubuntu, and the necessary PHP 7 modules. Apparently the required extensions are curl, gd, mcrypt and mysql, with their respective dependencies.<br />
    ## Automated Wordpress<br />
     Looking into Ansible playbooks for Wordpress installation, they usually confine themselves to a prepackages Debfile installation or to curling the current Wordpress and dropping it into webroot. That won't do, we also want to be able to config the wordpress without clicking.<br />
    ### Adding a user<br />
     In my case, I need a wordpress:wordpress user and group for the installation. </p>
<p>        - name: add a wordpress group group: name: wordpress state: present gid: 1000 - name: add a wordpress user user: name: wordpress state: present uid: 1000 group: wordpress home: /var/www/{{ sitename }} shell: /bin/false comment: Wordpress Owner {% endhighlight %} This will be the file owner for everything not writeable by the webserver, later.<br />
        ### Downloading and unpacking<br />
         Unfortunately, having a more recent Wordpress is safer (and hence more important) than having a packaged install. So, we get\_url our stuff and drop it manually. Again, that's hard to make idempotent. At least the download is available as SSL (but of course, no cert checking and checksumming, what do you expect?). </p>
<p>            - name: download wordpress get\_url: url: https://wordpress.org/latest.tar.gz dest: /root/wordpress-latest.tar.gz mode: 0400 - name: unpack wordpress unarchive: remote\_src: yes src: /root/wordpress-latest.tar.gz dest: /root owner: wordpress group: wordpress - name: move archive into place shell: "mv /root/wordpress/\* /var/www/{{ sitename }}" args: creates: /var/www/{{ sitename }}/xmlrpc.php {% endhighlight %}<br />
            ### MySQL/Wordpress Integration<br />
             Wordpress needs a database and a user. That's easily done in Ansible. </p>
<p>                - name: create database for blog mysql\_db: name: "{{ database }}" state: present - name: create database user for blog mysql\_user: name: "{{ database\_user }}" password: "{{ database\_password }}" priv: "{{ database }}.\*:all" state: present {% endhighlight %}<br />
                ### Amend config files for Apache and PHP, drop WP config in place<br />
                 Now the config part of the installation. We need to speak to Apache, to PHP and to WP itself. </p>
<p>                    - name: install wp config template: src: wp-config.php dest: /var/www/{{ sitename }}/wp-config.php mode: '0644' owner: root - name: install apache config template: src: blog.koehntopp.info.conf dest: /etc/apache2/sites-available/{{ sitename }}.conf mode: '0644' owner: root group: root - name: amend php config template: src: 99-kris.ini dest: /etc/php/7.0/conf.d/99-kris.ini mode: '0644' owner: root group: root notify: reload apache - name: enable apache config command: a2ensite {{ sitename }} notify: reload apache args: creates: /etc/apache2/sites-enabled/{{ sitename }}.conf {% endhighlight %} That leaves us with a working, but mostly unconfigured blog. We now need to talk to the MySQL used by Wordpress, or we need a tool. There is a Tool:<br />
                    ### wp-cli<br />
                     wp-cli is a commandline tool in PHP which loads code from the actual Wordpress proper and then enables calling WP internals from the commandline. We download wp-cli, drop a wp-cli install script and run the wp-cli Script to do stuff. We are installing an image or another asset as part of the install to make the cli run idempotent (that's cheating, but the best we can do). </p>
<p>                        - name: install wp-cli get\_url: url: https://raw.github.com/wp-cli/builds/gh-pages/phar/wp-cli.phar dest: /usr/local/bin/wp mode: 0755 owner: root group: root - name: install title image for import copy: src: strandkorb.jpg dest: /tmp/strandkorb.jpg owner: wordpress group: wordpress mode: 0644 - name: install favicon copy: src: favicon.ico dest: /var/www/{{ sitename }}/favicon.ico owner: wordpress group: wordpress mode: 0644 - name: install wp install script template: src: install.wp dest: /tmp/install.wp owner: wordpress group: wordpress mode: 0755 - name: run wp install script shell: sudo -u wordpress bash -c "( cd /var/www/{{ sitename }}; bash -xv /tmp/install.wp )" args: creates: /var/www/{{ sitename }}/wp-content/uploads/strandkorb.jpg {% endhighlight %} The actual work is now done all by the install.wp script.<br />
                        ### Using wp-cli<br />
                         So in order to really config the blog we need to wp-cli the shit out of it. Basic installation and variables incoming like so: </p>
<p>                            # basic install wp core install --url={{ sitename }} --title=Isoblog --admin\_user={{ wp\_user }} --admin\_password={{ wp\_password }} --admin\_email=kristian.koehntopp@gmail.com --skip-email wp option set blogdescription "This is my blog. There are many like it, but this is mine." wp option set start\_of\_week 0 wp option set posts\_per\_rss 50 wp option set default\_ping\_status "closed" wp option set date\_format "Y-m-d" wp option set time\_format "H:i" wp option set permalink\_structure "/index.php/%post\_id%-%postname%/" wp option set gmt\_offset 1 wp option set comment\_registration "" wp option set avatar\_default retro wp option set close\_comments\_for\_old\_posts "" wp option set close\_comments\_days\_old 180 wp option set thread\_comments\_depth 5 {% endhighlight %} Next up is the template and plugin cleanup: </p>
<p>                                # clean up templates, activate ours wp theme install author wp theme activate author wp theme delete twentyfifteen wp theme delete twentyseventeen wp theme delete twentysixteen # get rid of unneeded plugins wp plugin delete hello {% endhighlight %} We then are going to use a number of plugins which need config: </p>
<p>                                    # configure akismet (preinstalled) wp option add wordpress\_api\_key {{ akismet\_key }} wp option add akismet\_strictness 0 wp option add akismet\_show\_user\_comments\_approved 0 wp plugin activate akismet # install google sitemap, no config wp plugin install google-sitemap-generator wp plugin activate google-sitemap-generator # install simple comment editing wp plugin install simple-comment-editing wp plugin activate simple-comment-editing # install google 2FA wp plugin install google-authenticator wp plugin activate google-authenticator # configure user to use this wp user meta add kris googleauthenticator\_description Isoblog wp user meta add kris googleauthenticator\_enabled 1 wp user meta add kris googleauthenticator\_secret {{ ga\_secret }} # install syntax highlighting (no config) wp plugin install wp-syntax wp plugin activate wp-syntax # install wp-optimize (no config) wp plugin install wp-optimize wp plugin activate wp-optimize # security wp plugin install wordfence wp plugin activate wordfence wp plugin install security-ninja wp plugin activate security-ninja # get rid of the default page and post wp comment delete 1 wp post delete 1 wp post delete 2 # upload a title banner, to not enable it wp option set uploads\_use\_yearmonth\_folders "" wp media import --porcelain /tmp/strandkorb.jpg wp option set uploads\_use\_yearmonth\_folders 1 {% endhighlight %} I think the logic here is pretty clear: We are using "wp plugin install" and "wp plugin activate" to get stuff, then use whatever is necessary to push the config (mostly "wp option add"). Actual documentation on this is scarce, but having mysqldump diffs and being able to read them helps a lot. All of this is a rough draft, but seems to mostly work on my test blog.</p>
