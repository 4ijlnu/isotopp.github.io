<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Die wunderbare Welt von Isotopp - Bug #31876: MySQL Commit in Windows</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="site.webmanifest">
<link rel="apple-touch-icon" href="icon.png">
<link rel="favicon.ico" rel="icon" type="image/ico">





    



<link rel="stylesheet" href="/style.min.e525cc19e18f2cbf426091105e559b85dfd95ed4f6e083666ffc41242d16af82.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light px-lg-4 pt-lg-4">
  <div class="container-fluid">

    <a class="navbar-brand justify-content-center" href="" rel="home" title=".Site.Title">
      <img height='48' width='48' src='/assets/img/kris.jpg' class='p-0 me-3 d-block d-lg-inline'>
      <span class='h4 d-block d-lg-inline'>Die wunderbare Welt von Isotopp</span>
    </a>

    <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse text-center" id="navbarSupportedContent">
      <ul class="navbar-nav ms-auto">

      

      
        <li class="nav-item ">
                        <a class="nav-link" href="/about/">
          
          <span>About</span>
          <span class="visually-hidden">(Current)</span>
            </a>
            
        <li class="nav-item ">
                        <a class="nav-link" href="/contribute/">
          
          <span>Contribute</span>
          <span class="visually-hidden">(Current)</span>
            </a>
            
        <li class="nav-item ">
                        <a class="nav-link" href="/search/">
          <svg class='bi' height='1.5rem' width='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#search'/></svg>
          <span></span>
          <span class="visually-hidden">(Current)</span>
            </a>
            
        <li class="nav-item ">
                        <a class="nav-link" href="/tags/">
          <svg class='bi' width='1.5rem' height='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#tags-fill'/></svg>
          <span></span>
          <span class="visually-hidden">(Current)</span>
            </a>
            
        </li>
      </ul>
        
    </div>

  </div>
</nav>


        <main role="main" class="container-fluid p-0">

            


<div class="page">
  <article class="bug-#31876-mysql-commit-in-windows-page">
    <div class='row justify-content-center text-center my-4 mx-0'>
      <header>
        <div class='col'>
          <h1 class="title mb-lg-4 text-white">
            Bug #31876: MySQL Commit in Windows
          </h1>
          <div class='text-uppercase text-light' style='letter-spacing: 0.1rem;'>
              <img src='/assets/img/kris.jpg' class='me-1 p-0' style='width: 1.9rem; border-radius: 1rem;'>
              <a href="https://twitter.com/isotopp" class='text-light text-decoration-none'>
                Kristian Köhntopp
              </a>
            

            
              <span class='d-none d-lg-inline'>-</span> 
              <div class='d-block d-lg-inline'>October 31, 2007</div>
            

          </div>
        </div>
        <img src='https://blog.koehntopp.info/assets/img/background/rijksmuseum.jpg'>
      </header>
    </div>

    <div class='row justify-content-center mx-0 mt-5 mb-5'>
      <div class='col-lg-8'>
        <!-- s9ymdb:3519 --><img width="110" height="57" style="float: right; border: 0px; padding-left: 5px; padding-right: 5px;" src="/uploads/mysql_logo.serendipityThumb.gif" alt="" /> <a href="http://bugs.mysql.com/bug.php?id=31876">Bug #31876</a>: Neulich war ich bei einem Kunden, der ein kleines Testscript hatte, das im wesentlichen 500 mal hintereinander eine Row in eine InnoDB-Tabelle eingefuegt hat und dann ein Commit gesendet hat. Das Script war unter Linux unmöglich schnell, und unter Windows unmöglich langsam - insbesondere war es unter Windows viermal langsamer als dasselbe Script unter DB/2 und MS SQL Server. Das ist natürlich verdächtig und nicht akzeptabel.
<p>Was macht man, wenn man ein Performanceproblem hat? Richtig, man mißt nach. Hier wollten wir erst einmal sehen, was MySQL denn so mit dem Betriebssystem macht, wenn es comitted. Dazu brauchen wir so etwas wie einen Systemcall-Monitor für Windows. Das gibt es zum Glück, und zwar bei der von Microsoft aufgekauften Firma <a href="http://www.microsoft.com/technet/sysinternals/default.mspx">Sysinternals</a> von Mark Russinovich. Wir messen also mit FileMon und ProcMon, was genau MySQL da tut.</p>
<p>Mit innodb_flush_log_on_trx_commit = 1 sehen wir dann im FileMon die folgende Ausgabe:
{% highlight console %}
94      14:43:22        mysqld-nt.exe:2736      WRITE   C:\Programme\MySQL\MySQL Server 5.0\data\ib_logfile0    SUCCESS Offset: 2258432 Length: 1024
95      14:43:22        mysqld-nt.exe:2736      FLUSH   C:\Programme\MySQL\MySQL Server 5.0\data\ib_logfile0    SUCCESS
96      14:43:22        mysqld-nt.exe:2736      WRITE   C:\Programme\MySQL\MySQL Server 5.0\data\ib_logfile0    SUCCESS Offset: 2258944 Length: 512
97      14:43:22        mysqld-nt.exe:2736      FLUSH   C:\Programme\MySQL\MySQL Server 5.0\data\ib_logfile0    SUCCESS
{% endhighlight %}
Mit anderen Worten: Für jede Transaktion ruft MySQL einmal WriteFile() und einmal FlushFileBuffers() auf. Konfiguriert man auf innodb_flush_log_on_trx_commit = 2 um, bekommt man
{% highlight console %}
101     14:35:55        mysqld-nt.exe:548       WRITE   C:\Programme\MySQL\MySQL Server 5.0\data\ib_logfile0    SUCCESS Offset: 1638912 Length: 1024
102     14:35:55        mysqld-nt.exe:548       WRITE   C:\Programme\MySQL\MySQL Server 5.0\data\ib_logfile0    SUCCESS Offset: 1639424 Length: 512
{% endhighlight %}
Das heißt, die WriteFile-Aufrufe finden weiter statt, die FlushFileBuffer-Aufrufe entfallen aber. In InnoDB ist das nicht ACID, weil die WriteFile-Aufrufe die Daten nur vom MySQL-Prozess in den Windows Filesystem Buffer Cache kopieren, aber nicht von dort auf die Platte, und das kann man am Blinken der HDD-LED auch sehen.</p>
<p>Spielt man dasselbe Spiel mit einem DB/2 auf Windows, sieht man
{% highlight console %}
408     15:05:10        db2syscs.exe:2020       WRITE   D:\Daten\Filis\DB2log\S0007531.LOG     SUCCESS Offset: 970752 Length: 4096
409     15:05:10        db2syscs.exe:2020       WRITE   D:\Daten\Filis\DB2log\S0007531.LOG     SUCCESS Offset: 970752 Length: 4096
{% endhighlight %}
DB/2 macht also auch nur WriteFile-Aufrufe, und behauptet, das sei ACID! Mehr noch, am Blinken der Platten-LED kann man sehen, daß das auch wahrscheinlich der Fall ist.</p>
<p>Was ist also anders? Sieht man sich die Sache mit ProcMon an, kann man sehen wie die Dateien in Windows mit dem Aufruf <a href="http://msdn2.microsoft.com/en-us/library/aa363858.aspx">CreateFile</a> und dwCreateDisposition = OPEN_EXISTING geöffnet werden. Dabei gibt man dem Aufruf außerdem noch einen Haufen dwFlagsAndAttributes mit. Uns sollen hier in erster Linie die Flags interessieren.</p>
<p>Normalerweise öffnet MySQL seine InnoDB-Daten- und Logfiles so:
{% highlight console %}
Sequence:       12795
Date &amp; Time:    25.10.2007 11:01:33
Event Class:    File System
Operation:      CreateFile
Result: NAME COLLISION
Path:   C:\Programme\MySQL\MySQL Server 5.0\data\ib_logfile0
TID:    2688
Duration:       0.0000131
Desired Access: Generic Read/Write
Disposition:    Create
Options:        No Buffering, Synchronous IO Non-Alert, Non-Directory File
Attributes:     n/a
ShareMode:      Read
AllocationSize: 0
{% endhighlight %}
Das heisst, wie man in der Zeile &ldquo;Options&rdquo; sehen kann, FILE_FLAG_NO_BUFFERING ist angegeben. Das ist schon mal gut, aber wie man sehen kann, sind immer noch FlushFileBuffer-Aufrufe notwendig. DB/2 und MS SQL Server dagegen machen das so, daß außerdem noch FILE_FLAG_WRITE_THROUGH angegeben wird (und ggf. auch noch FILE_FLAG_RANDOM_ACCESS), berichtet uns ProcMon hier.</p>
<p>Das bedeutet: Brächte man InnoDB dazu seine Daten- und Logfiles mit diesen Flags zu öffnen, wären die FushFileBuffers-Aufrufe nicht mehr notwendig (und mit innodb_flush_log_on_trx_commit = 2 wären sie auch weg). Also patched man</p>
<p>{% highlight console %}
===== innobase/os/os0file.c 1.121 vs edited =====
&mdash; 1.121/innobase/os/os0file.c 2007-08-15 18:54:19 -04:00
+++ edited/innobase/os/os0file.c        2007-10-25 17:34:01 -04:00
@@ -1218,9 +1218,13 @@ try_again:
/* Do not use unbuffered i/o to log files because
value 2 denotes that we do not flush the log at every
commit, but only once per second */</p>
<ul>
<li>
<pre><code>                  attributes |= (FILE_FLAG_WRITE_THROUGH
</code></pre>
</li>
<li>
<pre><code>                         | FILE_FLAG_RANDOM_ACCESS);
          } else if (srv_win_file_flush_method ==  SRV_WIN_IO_UNBUFFERED) {
</code></pre>
</li>
</ul>
<ul>
<li>
<pre><code>                  attributes = attributes | FILE_FLAG_NO_BUFFERING;
</code></pre>
</li>
</ul>
<ul>
<li>
<pre><code>                  attributes |= (FILE_FLAG_NO_BUFFERING
</code></pre>
</li>
<li>
<pre><code>                         | FILE_FLAG_WRITE_THROUGH
</code></pre>
</li>
<li>
<pre><code>                         | FILE_FLAG_RANDOM_ACCESS);
          }
</code></pre>
</li>
</ul>
<p>#endif
} else if (purpose == OS_FILE_NORMAL) {
@@ -1232,7 +1236,9 @@ try_again:
commit, but only once per second */
} else if (srv_win_file_flush_method == SRV_WIN_IO_UNBUFFERED) {</p>
<ul>
<li>
<pre><code>                  attributes = attributes | FILE_FLAG_NO_BUFFERING;
</code></pre>
</li>
</ul>
<ul>
<li>
<pre><code>                  attributes |= (FILE_FLAG_NO_BUFFERING
</code></pre>
</li>
<li>
<pre><code>                         | FILE_FLAG_WRITE_THROUGH
</code></pre>
</li>
<li>
<pre><code>                         | FILE_FLAG_RANDOM_ACCESS);
          }
</code></pre>
</li>
</ul>
<p>#endif
} else {</p>
<p>{% endhighlight %}
Wenn ich mich nicht sehr täusche ist innodb_flush_log_on_trx_commit = 2 jetzt ACID und sehr viel schneller als die Write/Flush-Sequenz - sechs bis sieben Mal schneller. Das Blinken meiner Platten-LED sieht auch plausibel aus.</p>
<p>Dasselbe Verhalten beobachten wir nun auch mit dem Binlog: log-bin= &hellip; sorgt für WriteFile-Aufrufe ins Binlog, und mit sync_binlog = 1 kriegen wir nach jedem Write ein langsames Flush. Besser wäre es, das CreateFile für das Binlog zu finden und dort ebenfalls FILE_FLAG_WRITE_THROUGH zu machen. Damit wäre schon ein normales Binlog-Schreiben &ldquo;sync&rdquo; und schneller als die Write/Flush-Paare von sync_binlog = 1.</p>
<p>Versucht man denselben Benchmark mit Linux, kriege ich auf meinen Testsystemen übrigens vollkommene Unsinnszeiten raus. Das liegt daran, weil
{% highlight console %}
linux:~ # hdparm -I /dev/sda
&hellip;
Enabled Supported:
*    SMART feature set
Security Mode feature set
*    Power Management feature set
*    Write cache
*    Look-ahead
&hellip;
{% endhighlight %}
Der Write-Cache ist also bei dieser Platte enabled. Für so einen ACID-Commit ist das eher nicht so gut. Mit
{% highlight console %}
linux:~ # hdparm -W0 /dev/sda</p>
<p>/dev/sda:
setting drive write-caching to 0 (off)
{% endhighlight %}
ist Linux dann nicht nur genau so ACID wie Windows, sondern auch vergleichbar langsam. Und man bekommt auch bei einem &ldquo;innodb_flush_method = fdatasync / O_DIRECT&rdquo; plötzlich plausible Benchmarkergebnisse zurück. Das nur mal an die Adresse derjenigen, die glauben, daß O_DIRECT nix bringt (bis letzte Woche auch ich).</p>

      </div>
    </div>

    <div class='row justify-content-center mb-3'>
      <div class='col-lg-8 text-center'>
        <span class='letter-spacing-01 text-uppercase text-secondary me-2'>Share</span>
        <a href='https://www.facebook.com/sharer/sharer.php?u=%2fdrafts%2fbug-31876-mysql-commit-in-windows.html' target='_blank'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#facebook'/></svg>
        </a>
        <a href='https://twitter.com/intent/tweet?source=%2fdrafts%2fbug-31876-mysql-commit-in-windows.html&text=Bug%20%2331876%3a%20MySQL%20Commit%20in%20Windows%20%7C%20Die+wunderbare+Welt+von+Isotopp:%20%2fdrafts%2fbug-31876-mysql-commit-in-windows.html' target='_blank'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#twitter'/></svg>
        </a>
      </div>
    </div>

    <div class='row justify-content-center mb-5 pt-5 border-top'>
      <div class='col-lg-4 text-center text-lg-start'>
         
          <div>
            <div class='letter-spacing-01 text-uppercase text-secondary'>
              Next Post
            </div>
            <a class='text-decoration-none' href="/drafts/ein-paar-benchmarks-zum-kalibrieren.html">Ein paar Benchmarks zum kalibrieren</a>
          </div>
        
      </div>

      <div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
         
          <div>
            <div class='letter-spacing-01 text-uppercase text-secondary'>
              Previous Post
            </div>
            <a class='text-decoration-none' href="/drafts/von-der-unf-higkeit-skype-zu-verstehen.html">Von der Unfähigkeit, Skype zu verstehen</a>
          </div>
        
      </div>
    </div>

    
    </article>
</div>



            <footer class='row justify-content-center mb-4 pb-4 mx-0'>
  <div class='col-8 text-center'>
    <div>
      A collection of old stuff, new stuff and random stuff. 
    </div>
    <div class='row text-primary mt-4'>
      <div class='col'>

        <a href='/index.xml' title='Follow RSS feed' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#rss-fill'/></svg>
        </a>

        <a href='mailto:kristian.koehntopp@gmail.com' title='Email' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#envelope'/></svg>
        </a>

        <a href='https://github.com/isotopp' title='Follow on GitHub' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#github'/></svg>
        </a>

        <a href='https://www.reddit.com/user/isotopp' title='Follow on Reddit' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#reddit'/></svg>
        </a>

        <a href='http://steamcommunity.com/id/ixotopp' title='Follow on Steam' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#steam'/></svg>
        </a>

        <a href='https://twitter.com/isotopp' title='Follow on Twitter' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#twitter'/></svg>
        </a>

        <a href='https://www.youtube.com/user/isotopp' title='Follow on YouTube' class=''>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#youtube'/></svg>
        </a>

      </div>
    </div>
  </div>
</footer>


        </main>

	





<script src="/js/bootstrap.js"></script>




<script src="/js/lunr.js"></script>





<script src="/js/app.js"></script>


    </body>
</html>
