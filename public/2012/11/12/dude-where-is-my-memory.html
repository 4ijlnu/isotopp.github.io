<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Die wunderbare Welt von Isotopp - Dude, where is my memory?</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="site.webmanifest">
<link rel="apple-touch-icon" href="icon.png">
<link rel="favicon.ico" rel="icon" type="image/ico">





	



<link rel="stylesheet" href="/style.min.c5e5cd61f54911f9aafd1dbe09c2f90667957bfe1002126c87aace57759f3446.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
	<a class="navbar-brand" href="" rel="home" title=".Site.Title">
	    Die wunderbare Welt von Isotopp
	</a>
	<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
	</button>

	<div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
		
		
		<li class="nav-item ">
                    <a class="nav-link" href="/about/">
			
			<span>About</span>
			<span class="visually-hidden">(Current)</span>
		    </a>
		    
		</li>
            </ul>
            
	</div>
    </div>
</nav>


        <main role="main" class="container-fluid">

            


<div class="page">
    <article class="dude-where-is-my-memory-page">
	<h1 class="title">
            Dude, where is my memory?
	</h1>

	<p>&ldquo;Kris, bitte schau Dir mal unsere Datenbank an.  Wir haben hier einen
Generator für unsere Materialized Views, und auf einer Datenbank von 6 GB
Größe werden 40 GB Speicher gefüllt und wir kommen sogar ins Swappen.&rdquo;</p>
<p>Na, das ist mal interessant.  The fragliche Kiste hat 48 GB RAM, und in der
Tat kaum 6 GB Daten.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> 
 <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">sum</span>(data_length<span style="color:#f92672">+</span>index_length)<span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span> <span style="color:#66d9ef">as</span> gb 
 <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">from</span> tables 
 <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">where</span> table_schema <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">in</span> (<span style="color:#e6db74">&#39;information_schema&#39;</span>, <span style="color:#e6db74">&#39;performance_schema&#39;</span>, <span style="color:#e6db74">&#39;mysql&#39;</span>);
<span style="color:#f92672">+</span><span style="color:#75715e">----------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> gb             <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> <span style="color:#ae81ff">5</span>.<span style="color:#ae81ff">832778930664</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>Aber in &ldquo;top&rdquo; sieht das so aus, und wächst:</p>
<pre><code class="language-console" data-lang="console"> 7552 mysql     15   0 55.1g  43g 6888 S  0.7 91.7 499:13.56 mysqld 
</code></pre><p>Das wird sicher interessant.</p>
<p>Der Zwilling dieser Maschine zeigt ähnliches Verhalten, aber auf einem niedrigeren Level.</p>
<p>Wenn es um Speicherprobleme und Swap geht, dann schaue ich routinemäßig erst
mal die <!-- raw HTML omitted -->numa_maps<!-- raw HTML omitted -->
der Maschine an.  Aber sie und ihr Zwilling sind gut ausbalanciert.</p>
<p>Der Zwilling:</p>
<pre><code class="language-console" data-lang="console"># /usr/local/booking-mysql/numa-maps-summary.pl &lt; /proc/25996/numa_maps 
N0        :      1777572 (  6.78 GB)
N1        :      1777759 (  6.78 GB)
active    :           37 (  0.00 GB)
anon      :      3553604 ( 13.56 GB)
dirty     :      3553605 ( 13.56 GB)
mapmax    :          237 (  0.00 GB)
mapped    :         1783 (  0.01 GB)
</code></pre><p>Wir starten den Server mal neu, um zu sehen, ob das Problem reproduzierbar
ist.  Ich zwinge den InnoDB Buffer Pool auch mal 10 GB kleiner, nur um
sicherzugehen, daß wir da nichts falsch zu groß eingestellt haben.</p>
<p><p class="md__image">
  <img src="/uploads/memory-problem.png" alt="Speichersituation"  />
</p>


Die alte Speichersituation, und nach einem Neustart eine um 10 GB
verkleinerter <code>innodb_buffer_pool_size</code>.</p>
<p>Das scheint in der Tat das Problem zu beheben, aber wir haben immer noch
eine InnoDB Buffer Pool Nutzung, die um den Faktor 3-4 oberhalb der
Datengröße liegt, und das ist kaum zu erklären.  Auch die Resident Set Size
(RES) in top ist immer noch viel größer als die Datengröße.</p>
<p>Was passiert hier wirklich?  Wenn ich doch nur in den Buffer Pool
hineinschauen könnte.</p>
<p>Moment mal. Ich kann:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#66d9ef">version</span>();
<span style="color:#f92672">+</span><span style="color:#75715e">--------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> <span style="color:#66d9ef">version</span>()    <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> <span style="color:#ae81ff">5</span>.<span style="color:#ae81ff">6</span>.<span style="color:#ae81ff">6</span><span style="color:#f92672">-</span>m9<span style="color:#f92672">-</span>log <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#66d9ef">table_name</span> 
<span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">from</span> tables 
<span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">table_name</span> <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;innodb_buffer%&#39;</span>;
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> <span style="color:#66d9ef">table_name</span>               <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> INNODB_BUFFER_PAGE_LRU   <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> INNODB_BUFFER_PAGE       <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> INNODB_BUFFER_POOL_STATS <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">3</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>Nach dem Nachlesen von <!-- raw HTML omitted -->INFORMATION_SCHEMA.INNODB_BUFFER_PAGE<!-- raw HTML omitted -->
bekomme ich</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> page_type, 
<span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">count</span>(<span style="color:#f92672">*</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">16384</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span> <span style="color:#66d9ef">as</span> mb  
<span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">from</span> INNODB_BUFFER_PAGE 
<span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">group</span> <span style="color:#66d9ef">by</span> page_type <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> mb;
<span style="color:#f92672">+</span><span style="color:#75715e">-------------------+----------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> page_type         <span style="color:#f92672">|</span> mb             <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">-------------------+----------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> TRX_SYSTEM        <span style="color:#f92672">|</span>     <span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">01562500</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> IBUF_FREE_LIST    <span style="color:#f92672">|</span>     <span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">12500000</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> INODE             <span style="color:#f92672">|</span>     <span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">15625000</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> FILE_SPACE_HEADER <span style="color:#f92672">|</span>     <span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">23437500</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> EXTENT_DESCRIPTOR <span style="color:#f92672">|</span>     <span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">32812500</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> IBUF_BITMAP       <span style="color:#f92672">|</span>     <span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">45312500</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#66d9ef">SYSTEM</span>            <span style="color:#f92672">|</span>     <span style="color:#ae81ff">2</span>.<span style="color:#ae81ff">03125000</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> ALLOCATED         <span style="color:#f92672">|</span>    <span style="color:#ae81ff">24</span>.<span style="color:#ae81ff">50000000</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> UNDO_LOG          <span style="color:#f92672">|</span>    <span style="color:#ae81ff">27</span>.<span style="color:#ae81ff">75000000</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#66d9ef">INDEX</span>             <span style="color:#f92672">|</span>   <span style="color:#ae81ff">585</span>.<span style="color:#ae81ff">70312500</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> BLOB              <span style="color:#f92672">|</span>  <span style="color:#ae81ff">5073</span>.<span style="color:#ae81ff">81250000</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#66d9ef">UNKNOWN</span>           <span style="color:#f92672">|</span> <span style="color:#ae81ff">21932</span>.<span style="color:#ae81ff">60937500</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">-------------------+----------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">12</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">4</span>.<span style="color:#ae81ff">48</span> sec)
</code></pre></div><p>und vermutlich ein monumentales globales 5-Sekunden-Lock auf dem Buffer
Pool, um dieses Ergebnis zu erzeugen.  UNKNOWN ist in Wahrheit freier
Speicher im Buffer Pool der soeben neu gestarteten Box.  5 GB sind in BLOBs,
und das scheint der Kern unseres Problems zu sein.  INDEX sind die Daten in
den Tabellen (&lsquo;PRIMARY&rsquo;) und die sekundären Indices.  Und der Rest ist
Systemspeicher und sieht nicht krank aus.</p>
<p>Die Frage ist also: Was ist mit dem ganzen BLOB-Speicher da?  Wo kommt der
her?  Leider nutzen uns table_name und index_name hier gar nix, wenn der
page_type BLOB ist:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> page_type,
<span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">table_name</span>, 
<span style="color:#f92672">-&gt;</span> index_name, 
<span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">count</span>(<span style="color:#f92672">*</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">16384</span> <span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span> <span style="color:#66d9ef">as</span> mb 
<span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">from</span> INNODB_BUFFER_PAGE 
<span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">group</span> <span style="color:#66d9ef">by</span> page_type, <span style="color:#66d9ef">table_name</span>, index_name 
<span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> mb;
<span style="color:#f92672">+</span><span style="color:#75715e">-------------------+-----------------------------+-----------------------+----------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> page_type         <span style="color:#f92672">|</span> <span style="color:#66d9ef">table_name</span>                  <span style="color:#f92672">|</span> index_name            <span style="color:#f92672">|</span> mb             <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">-------------------+-----------------------------+-----------------------+----------------+
</span><span style="color:#75715e"></span>...
<span style="color:#f92672">|</span> UNDO_LOG          <span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span>                        <span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span>                  <span style="color:#f92672">|</span>    <span style="color:#ae81ff">27</span>.<span style="color:#ae81ff">75000000</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#66d9ef">INDEX</span>             <span style="color:#f92672">|</span> md2<span style="color:#f92672">/</span>kb_...                  <span style="color:#f92672">|</span> <span style="color:#66d9ef">PRIMARY</span>               <span style="color:#f92672">|</span>   <span style="color:#ae81ff">141</span>.<span style="color:#ae81ff">48437500</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#66d9ef">INDEX</span>             <span style="color:#f92672">|</span> md2<span style="color:#f92672">/</span>kb_...                  <span style="color:#f92672">|</span> <span style="color:#66d9ef">PRIMARY</span>               <span style="color:#f92672">|</span>   <span style="color:#ae81ff">430</span>.<span style="color:#ae81ff">87500000</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> BLOB              <span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span>                        <span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span>                  <span style="color:#f92672">|</span>  <span style="color:#ae81ff">5073</span>.<span style="color:#ae81ff">81250000</span> <span style="color:#f92672">|</span>
</code></pre></div><p>Aber es gibt eine SPACE id, und die kann über INNODB_SYS_TABLESPACES
aufgelöst werden.  Schauen wir mal:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">select</span> page_type, 
<span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">table_name</span>, 
<span style="color:#f92672">-&gt;</span> index_name, 
<span style="color:#f92672">-&gt;</span> sp.name, 
<span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">count</span>(<span style="color:#f92672">*</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">16384</span> <span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span> <span style="color:#66d9ef">as</span> mb 
<span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">from</span> INNODB_BUFFER_PAGE <span style="color:#66d9ef">as</span> bp 
<span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">left</span> <span style="color:#66d9ef">join</span> innodb_sys_tablespaces <span style="color:#66d9ef">as</span> sp 
<span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">on</span> bp.<span style="color:#66d9ef">space</span> <span style="color:#f92672">=</span> sp.<span style="color:#66d9ef">space</span>  
<span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">group</span> <span style="color:#66d9ef">by</span> page_type, <span style="color:#66d9ef">table_name</span>, index_name, bp.<span style="color:#66d9ef">space</span> 
<span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> mb;
...
<span style="color:#f92672">|</span> <span style="color:#66d9ef">INDEX</span>             <span style="color:#f92672">|</span> ...<span style="color:#f92672">|</span> md2<span style="color:#f92672">/</span>kb_...............      <span style="color:#f92672">|</span>   <span style="color:#ae81ff">141</span>.<span style="color:#ae81ff">48437500</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#66d9ef">INDEX</span>             <span style="color:#f92672">|</span> ...<span style="color:#f92672">|</span> md2<span style="color:#f92672">/</span>kb_.................... <span style="color:#f92672">|</span>   <span style="color:#ae81ff">430</span>.<span style="color:#ae81ff">87500000</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> BLOB              <span style="color:#f92672">|</span> ...<span style="color:#f92672">|</span> md2<span style="color:#f92672">/</span>kb_.................... <span style="color:#f92672">|</span>  <span style="color:#ae81ff">5073</span>.<span style="color:#ae81ff">68750000</span> <span style="color:#f92672">|</span>
...
</code></pre></div><p>Also haben wir hier eine bestimmte Tabelle, die den ganzen BLOB-Speicher
aufbraucht.  Die Definition legt das nahe:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">show</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> md2.kb_...<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
       <span style="color:#66d9ef">Table</span>: kb_hotel_hotelpage
<span style="color:#66d9ef">Create</span> <span style="color:#66d9ef">Table</span>: <span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#f92672">`</span>kb_...<span style="color:#f92672">`</span> (
  <span style="color:#f92672">`</span>id<span style="color:#f92672">`</span> mediumint(<span style="color:#ae81ff">8</span>) unsigned <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>body<span style="color:#f92672">`</span> mediumblob <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>digest<span style="color:#f92672">`</span> binary(<span style="color:#ae81ff">20</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>last_change<span style="color:#f92672">`</span> int(<span style="color:#ae81ff">10</span>) unsigned <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>last_check<span style="color:#f92672">`</span> int(<span style="color:#ae81ff">10</span>) unsigned <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span> (<span style="color:#f92672">`</span>id<span style="color:#f92672">`</span>),
  <span style="color:#66d9ef">KEY</span> <span style="color:#f92672">`</span>last_check<span style="color:#f92672">`</span> (<span style="color:#f92672">`</span>last_check<span style="color:#f92672">`</span>)
) ENGINE<span style="color:#f92672">=</span>InnoDB <span style="color:#66d9ef">DEFAULT</span> CHARSET<span style="color:#f92672">=</span>latin1
<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>Diese tabelle enthält mehr oder weniger alle Template-Variablen für eine
id/action-Kombination in serialisierter Form, um die Anzahl von Queries pro
Seite zu reduzieren.  Eine normalisierte, live generierte Form der Seite
braucht eine dreistellige Anzahl von Queries, ein Zugriff auf die
vorgerechneten Daten generiert dieselbe Seite mit weniger als 7 Queries.</p>
<p>Wir schließen unser Debugging ab:</p>
<blockquote>
<p>Kristian&gt; Diese Blobs, werden die oft neu berechnet?</p>
</blockquote>
<blockquote>
<p>SimonB&gt; Im Moment ja, weil ich sie immer aktualisiere.  Normalerweise
würde ich das nur tun, wenn sich der Digest ändert.</p>
</blockquote>
<blockquote>
<p>Kristian&gt; Resident Set Size ist jetzt bei 15 GB und stabil.  Das heißt,
wenn ich den Buffer Pool klein genug halte wird die Maschine nicht
swappen.  Wir verbrauchen eine Menge Network Buffer zusätzlich, wegen der
ganzen Blobs, und das ist weswegen wir so einen großen Speicher-Overhead
pro Connection haben&hellip;  Jedenfalls ist das grad meine operative Theorie.
MySQL &amp; BLOBs = ganz übler Mist.</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#66d9ef">min</span>(<span style="color:#66d9ef">length</span>(body)), 
<span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">max</span>(<span style="color:#66d9ef">length</span>(body)), 
<span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">avg</span>(<span style="color:#66d9ef">length</span>(body)) 
<span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">from</span> md2.kb_...;
<span style="color:#f92672">+</span><span style="color:#75715e">-------------------+-------------------+-------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> <span style="color:#66d9ef">min</span>(<span style="color:#66d9ef">length</span>(body)) <span style="color:#f92672">|</span> <span style="color:#66d9ef">max</span>(<span style="color:#66d9ef">length</span>(body)) <span style="color:#f92672">|</span> <span style="color:#66d9ef">avg</span>(<span style="color:#66d9ef">length</span>(body)) <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">-------------------+-------------------+-------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span>              <span style="color:#ae81ff">3002</span> <span style="color:#f92672">|</span>            <span style="color:#ae81ff">478883</span> <span style="color:#f92672">|</span>        <span style="color:#ae81ff">24968</span>.<span style="color:#ae81ff">2430</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">-------------------+-------------------+-------------------+
</span></code></pre></div><p>Das heißt, ich vermute, daß das ständige neu Schreiben der BLOBs in InnoDB
die Storage Engine dazu bringt, vorübergehend eine große Menge BLOB-Speicher
(neben dem eigentlichen Row-Speicher) zu allozieren.  Und der Per-Connection
Overhead ist größer, weil InnoDB BLOBs in den SQL-Teil von MySQL dupliziert
werden, um dann über die Network Buffer zum Client gesendet zu werden.
Böser Overhead.</p>
<p>MySQL ist nicht sehr gut drain mit großen BLOBs umzugehen.  Vielleicht
sollten wir die SQL-Schicht mit HandlerSocket oder etwas anderem umgehen.</p>


	
    </article>
</div>



            <footer>
    <p>
	&copy; Copyright 2021 Someone or something
    </p>
</footer>


        </main>

	





<script src="/js/bootstrap.js"></script>




<script src="/js/lunr.js"></script>





<script src="/js/app.js"></script>


    </body>
</html>
