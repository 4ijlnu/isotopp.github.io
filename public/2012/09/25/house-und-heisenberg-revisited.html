<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Die wunderbare Welt von Isotopp - House und Heisenberg revisited</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="site.webmanifest">
<link rel="apple-touch-icon" href="icon.png">
<link rel="favicon.ico" rel="icon" type="image/ico">





	



<link rel="stylesheet" href="/style.min.c5e5cd61f54911f9aafd1dbe09c2f90667957bfe1002126c87aace57759f3446.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
	<a class="navbar-brand" href="" rel="home" title=".Site.Title">
	    Die wunderbare Welt von Isotopp
	</a>
	<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
	</button>

	<div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
		
		
		<li class="nav-item ">
                    <a class="nav-link" href="/about/">
			
			<span>About</span>
			<span class="visually-hidden">(Current)</span>
		    </a>
		    
		</li>
            </ul>
            
	</div>
    </div>
</nav>


        <main role="main" class="container-fluid">

            


<div class="page">
    <article class="house-und-heisenberg-revisited-page">
	<h1 class="title">
            House und Heisenberg revisited
	</h1>

	<p>Ich habe heute an dem Problem weiter geforscht und wir haben etabliert, dass
die Ursache nicht der Quelltext des betreffenden Diamond-Collectors sein
kann.</p>
<p>Auf allen betroffenen Kisten habe ich dann gesehen, daß die entsprechenden
Queries gegen Performance-Schema ein</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> performance_schema.threads;
Empty <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">01</span> sec)
</code></pre></div><p>zurück liefern.</p>
<p>Weitere Untersuchung stellt heraus: P_S ist aber an. Jedoch:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> performance_schema.setup_instruments;
Empty <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">03</span> sec)
 
mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> performance_schema.setup_timers;
Empty <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">01</span> sec)
 
mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> performance_schema.setup_consumers;
Empty <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">02</span> sec)
</code></pre></div><p>und das bleibt auch so, sogar über Server-Restarts hinweg.  Warum ist das
so?</p>
<pre><code class="language-console" data-lang="console"># cd /mysql/\*/data/performance_schema/
# ls -l
total 1840
-rw-rw---- 1 mysql mysql  8624 Oct  6  2011 cond_instances.frm
-rw-rw---- 1 mysql mysql 98304 Oct  6  2011 cond_instances.ibd
-rw-rw---- 1 mysql mysql    61 Oct  6  2011 db.opt
-rw-rw---- 1 mysql mysql  9220 Oct  6  2011 events_waits_current.frm
-rw-rw---- 1 mysql mysql 98304 Oct  6  2011 events_waits_current.ibd
...
</code></pre><p>und ein SHOW CREATE TABLE bestätigt das.</p>
<p>Damit ist klar, wieso es überhaupt zu Transaktionen kommen kann:</p>
<p>Der Code im Diamond-Collector setzt nur Queries gegen performance_schema ab.
Da dort normal keine Tabellen vorhanden sind, die Transaktionen
unterstützen, kann es auch nie zu Transaktionen kommen.  In den defekten
Kisten wurden die Tabellen in performance_schema fälschlicherweise als
InnoDB erzeugt.  Das alleine hätte kein Problem erzeugt, weil jedes Kommando
in MySQL eine Transaktion in sich selbst ist - AUTOCOMMIT = 1.</p>
<p>Aber:</p>
<blockquote>
<p>Starting with 1.2.0, MySQLdb disables autocommit by default, as required
by the DB-API standard (PEP-249)&quot;.</p>
</blockquote>
<p>In diesem Fall generiert das Lesen von InnoDB-Tabellen den Start einer r/o
Transaktion und erzeugt einen Stable View auf alle InnoDB Tabellen.  Dieser
wird gehalten bis zum Ende der Transaktion, das niemals kommt, außer der
Collector disconnected.</p>
<p>Die immer weiter wachsende Größe des Undo-Logs verlangsamt den Server bis
zum Stillstand.  Ein KILL auf die Verbindung bringt nur vorübergehende
Linderung.</p>
<p>Der Fix ist in der Tat</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#f92672">#</span> mysql <span style="color:#f92672">-</span>BNe <span style="color:#e6db74">&#34;select 
</span><span style="color:#e6db74">  concat(&#39;drop table &#39;, table_name, &#39;;&#39;) 
</span><span style="color:#e6db74">from 
</span><span style="color:#e6db74">  information_schema.tables 
</span><span style="color:#e6db74">where 
</span><span style="color:#e6db74">  table_schema = &#39;performance_schema&#39;&#34;</span> <span style="color:#f92672">|</span> 
mysql performance_schema
<span style="color:#f92672">#</span> mysql_upgrade
...
</code></pre></div><p>und alles wird gut - sogar ohne Neustart.</p>
<p>Die Ursache für das Seltsame Verhalten™ der betroffenen Büchsen bei einer
automatisierten Installation verbleibt weiter unklar.  Der betreffende
Collector läuft jetzt jedoch auch auf diesen Maschinen und liefert Daten.</p>
<p>Wie viele MySQLer bin ich der Auffassung, dass AUTOCOMMIT = 0 oder SELECT
&hellip;  FOR UPDATE eher schädlich sind.  Dies hier wird ein weiteres
ausgezeichnetes Beispiel in meinem argumentativen Arsenal sein.</p>


	
    </article>
</div>



            <footer>
    <p>
	&copy; Copyright 2021 Someone or something
    </p>
</footer>


        </main>

	





<script src="/js/bootstrap.js"></script>




<script src="/js/lunr.js"></script>





<script src="/js/app.js"></script>


    </body>
</html>
