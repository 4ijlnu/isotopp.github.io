<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Die wunderbare Welt von Isotopp - MySQL hakt...</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="site.webmanifest">
<link rel="apple-touch-icon" href="icon.png">
<link rel="favicon.ico" rel="icon" type="image/ico">





	



<link rel="stylesheet" href="/style.min.c5e5cd61f54911f9aafd1dbe09c2f90667957bfe1002126c87aace57759f3446.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
	<a class="navbar-brand" href="" rel="home" title=".Site.Title">
	    Die wunderbare Welt von Isotopp
	</a>
	<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
	</button>

	<div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
		
		
		<li class="nav-item ">
                    <a class="nav-link" href="/about/">
			
			<span>About</span>
			<span class="visually-hidden">(Current)</span>
		    </a>
		    
		</li>
            </ul>
            
	</div>
    </div>
</nav>


        <main role="main" class="container-fluid">

            


<div class="page">
    <article class="mysql-hakt...-page">
	<h1 class="title">
            MySQL hakt&hellip;
	</h1>

	<p>&ldquo;Hey, Kris!  Wir haben zwischen 16:20 und 17:20 CEST einen Lasttest
durchgeführt und kurz vor 17:00 Uhr einen unerklärlichen Spike und einen
Leistungsabfall festgestellt.  Kannst Du mal gucken?&rdquo;</p>
<p>Klar kann ich.  Wo ich arbeite machen wir etwas, das wir
[Testing in Production]({% link _posts/2011-12-02-testing-in-production.md %})
nennen.</p>
<p>Für Lasttests bedeutet das, daß wir einzelne Systeme im Loadbalancer so
lange relativ höher gewichten bis sie Probleme bekommen und umfallen.  Zur
Kontrolle legen wir mit Apache Siege eine Reihe von Sensor-Requests in das
zu testende System, nicht zur Lastgenerierung, sondern um zu sehen, wann die
Latenz nach oben geht, also um Sättigung des zu testenden Systems zu
bemerken bevor es Fehler zu generieren beginnt.</p>
<p>Wenn wir nahe an den Sättigungspunkt gelangen, erhöhen wir die Last in sehr
winzigen Schritten, bis wir tatsächlich Systemversagen zu beobachten
beginnen und können so nicht nur die Lastgrenze, sondern auch die Symptome
beim Systemversterben genau und unter realistischen Bedingungen ermitteln.
Das macht die Arbeit im Operations Team sehr viel einfacher.</p>
<p>Wenn ein System aber Probleme hat und dann bei statischer Load zurück kommt,
liegt eine andere Situation vor.  Es ist wichtig herauszufinden, was genau
hier passiert.</p>
<p>Hier die Metriken:</p>
<p><p class="md__image">
  <img src="/uploads/mysql-problem1-replication-delay.png" alt="MySQL: Replication Delay"  />
</p>

</p>
<p>Replication Delay legt das Krisenfenster in die Zeit zwischen 16:53 (Delay
Spike) und 17:00 (Recovery).</p>
<p>Zur selben Zeit auch ein Disk Read Spike.  Read Spikes sind ungewöhnlich,
weil das betreffende System so dimensioniert ist, daß es seinen Working Set
praktisch vollständig im Hauptspeicher halten kann:</p>
<p><p class="md__image">
  <img src="/uploads/mysql-problem2-disk-read-spike.png" alt="System: Disk I/O Operations"  />
</p>

</p>
<p>Das fragliche System soll operativ für alle praktischen Zwecke gar nicht von
der Platte lesen.</p>
<p>Wir können nun nach weiteren Quellen für ungewöhnliches Verhalten suchen:
CPU und Connections gehen von 16:52 bis 17:00 hoch, aber es gibt keine Row
Acces Spikes, keine Spikes bei Tmp-Tables-to-disk und auch keine Spikes bei
Sortiervorgängen, insbesondere Merge Sorts.</p>
<p>Der InnoDB Buffer Pool Graph hat am Ende den entscheidenden Hinweis:</p>
<p><p class="md__image">
  <img src="/uploads/mysql-problem3-buffer-pool-drop.png" alt="MySQL: InnoDB Buffer Pool Usage"  />
</p>

</p>
<p>16:52 - InnoDB Buffer Pool <em>verkleinert</em> sich.</p>
<p>Um 16:52 verkleinert sich der InnoDB Buffer Pool.  Das tritt im Normalfall
nur dann auf, wenn Speicherseiten im Pool freigegeben werden, und das
wiederum kann nur dann geschehen, wenn eine Tabelle mit TRUNCATE TABLE
zurückgesetzt oder mit DROP TABLE gelöscht wird.</p>
<p>Wir müssen also schauen, ob es in der Zeit von 16:50 bis 16:53
DDL-Statements gegeben haben, die Tabellen kürzen oder löschen.  Auf allen
unseren Systemen läuft zu diesem Zweck
<a href="http://blog.wl0.org/2011/02/log_processlist-sh-script-for-monitoring-mysql-instances/" target="_blank" rel="noopener">log_processlist</a>


das eine Reihe interessanter Dinge aus der Datenbank für post-mortem
Analysen lokal aufzeichnet und für bis zu eine Woche vorhält.</p>
<p>Tatsächlich findet sich:</p>
<pre><code class="language-console" data-lang="console"># less 16_52.innodb.gz
...
SQL: SELECT * FROM INFORMATION_SCHEMA.INNODB_TRX
910556099       RUNNING 2012-08-08 16:51:59     
  NULL    NULL    0       2       
  TRUNCATE TABLE tmp_gethoteldescriptiontranslations
  truncating table        1       1       0       376
  0       0       0       
  REPEATABLE READ 1       1       
  NULL    0       10000
...
</code></pre><p>Der Pileup entsteht durch eine Folge von DDL-Locks, die durch ein
Wartungsscript erzeugt werden.  Das Script lädt eine neue Tabelle in die
Datenbank, tauscht die aktive Tabelle mit der neuen Tabelle aus und setzt
die alte Tabelle dann zurück bevor es sie löscht.</p>
<p><a href="http://www.mysqlperformanceblog.com/2012/06/22/drop-table-and-stalls-lazy-drop-table-in-percona-server-and-the-new-fixes-in-mysql/" target="_blank" rel="noopener">Background Table Drop</a>


würde hier helfen, aber die fragliche Kiste ist wie ihre Geschwister noch
5.5.16 und nicht 5.5.23.</p>


	
    </article>
</div>



            <footer>
    <p>
	&copy; Copyright 2021 Someone or something
    </p>
</footer>


        </main>

	





<script src="/js/bootstrap.js"></script>




<script src="/js/lunr.js"></script>





<script src="/js/app.js"></script>


    </body>
</html>
