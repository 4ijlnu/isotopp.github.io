<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Die wunderbare Welt von Isotopp - Understanding git</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="site.webmanifest">
<link rel="apple-touch-icon" href="icon.png">
<link rel="favicon.ico" rel="icon" type="image/ico">





	



<link rel="stylesheet" href="/style.min.c5e5cd61f54911f9aafd1dbe09c2f90667957bfe1002126c87aace57759f3446.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
	<a class="navbar-brand" href="" rel="home" title=".Site.Title">
	    Die wunderbare Welt von Isotopp
	</a>
	<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
	</button>

	<div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
		
		
		<li class="nav-item ">
                    <a class="nav-link" href="/about/">
			
			<span>About</span>
			<span class="visually-hidden">(Current)</span>
		    </a>
		    
		</li>
            </ul>
            
	</div>
    </div>
</nav>


        <main role="main" class="container-fluid">

            


<div class="page">
    <article class="understanding-git-page">
	<h1 class="title">
            Understanding git
	</h1>

	<p>It occurred to me that I do not know nearly enough how git works, internally.
The contents of the .git directory seem to be accessible enough, so I am going on a Safari in this blogs git repository.
You can follow along if you check out <a href="https://github.com/isotopp/isotopp.github.io/" target="_blank" rel="noopener">the blog</a>

.</p>
<h1 id="refs">
    <a href="#refs">
	Refs
    </a>
</h1>
<p>All things git live in <code>.git</code>.
The thing we are working with seem to live in <code>.git/refs</code>:</p>
<pre><code class="language-console" data-lang="console">$ find .git/refs -type f
.git/refs/heads/main
.git/refs/remotes/github/main
.git/refs/remotes/origin/HEAD
.git/refs/remotes/origin/main
.git/refs/remotes/origin/master
.git/refs/stash
</code></pre><p>Let&rsquo;s have a look at <code>.git/refs/heads/main</code> and the <code>.git/refs/remotes</code> here.</p>
<pre><code class="language-console" data-lang="console">$ cat .git/refs/heads/main
daad5e31926cdf8a3af0ecff517c4d5892b6f62a
$ cat .git/refs/remotes/github/main
daad5e31926cdf8a3af0ecff517c4d5892b6f62a
$ cat .git/refs/remotes/origin/main
daad5e31926cdf8a3af0ecff517c4d5892b6f62a
</code></pre><h1 id="commits">
    <a href="#commits">
	Commits
    </a>
</h1>
<p>So it appears that all these things reference the same &ldquo;thing&rdquo;, <code>daad5e31926cdf8a3af0ecff517c4d5892b6f62a</code>.
This appears to be a 40 character (40 * 4 bit = 160 bit) SHA-1 hash value.
git has low level commands to type this, and print it.</p>
<pre><code class="language-console" data-lang="console">$ git cat-file -t daad5e31926cdf8a3af0ecff517c4d5892b6f62a
commit
$ git cat-file -p daad5e31926cdf8a3af0ecff517c4d5892b6f62a
tree ba5a4ceb371d42d766832dae545ecf00b9194ea2
parent 75077bc79697ea1e37da496b1210ca26f3c66c2c
parent b71d9463ad8c3b71bd279e88e74ce15e01de2aee
author Kristian Koehntopp &lt;kris-git@koehntopp.de&gt; 1633513546 +0200
committer Kristian Koehntopp &lt;kris-git@koehntopp.de&gt; 1633513546 +0200

Merge remote-tracking branch 'github/main' into main
</code></pre><p>So this is a file of the type <code>commit</code>, and it contains ASCII lines that describe the commit.
Attributes of the commit are a tree, zero or more parent commits, an author, and a committer, as well as a log-message.
The author and commit lines contain a name, a mail address, a Unix timestamp and a timezone.
We can <a href="https://rachelbythebay.com/w/2021/10/05/cmd/" target="_blank" rel="noopener">convert that timestamp carefully</a>

:</p>
<pre><code class="language-console" data-lang="console">$ date -d @1633513546
Wed Oct  6 11:45:46 CEST 2021
</code></pre><p>We can also check out the things the commit points to:
We will find that the parent entries also reference commits (the two commits that precede this one), and the tree entry references a tree object.</p>
<pre><code class="language-console" data-lang="console">$ git cat-file -t 75077bc79697ea1e37da496b1210ca26f3c66c2c
commit
$ git cat-file -t b71d9463ad8c3b71bd279e88e74ce15e01de2aee
commit
$ git cat-file -t ba5a4ceb371d42d766832dae545ecf00b9194ea2
tree
</code></pre><p>Graphically, the highlighted part of the structure:</p>
<p><p class="md__image">
  <img src="/uploads/2021/10/git-tree-view.jpg" alt=""  />
</p>

</p>
<p><em>The commit <code>daad5e31...</code> has two parents: It is a merge commit of <code>b71d9463...</code> and <code>75077bc7...</code></em></p>
<h1 id="tree">
    <a href="#tree">
	Tree
    </a>
</h1>
<p>So a commit references a tree.
A tree is a list of files and other trees, which function as subdirectories.
Together they form a snapshot of the entire blog at this point in time (at this commit).</p>
<pre><code class="language-console" data-lang="console">$ git cat-file -p  bf447432a99b33174809dbe10d1df43576a032b3
100644 blob 199ea559714ed3569a88ab932476b11444244885    .gitignore
100644 blob 09e9c05d0fcf4a403addb0b2b8ee613bc4bd4b1d    CNAME
...
040000 tree f7fe2d64de25404f660561f7cfbce8d78bf05c09    _drafts
040000 tree fe33a062dcb4406a5ecf836ddeb1cfcd9ba85e8b    _includes
...
</code></pre><p>The important takeaway seems to be that git does not store changes made to files, it stores full files.
That is less inefficient than it sounds, because unchanged files will have the same hash.
Things with the same  hash will exist only once in storage, no matter in how many commits (or trees) they are being referenced.</p>
<h1 id="blob">
    <a href="#blob">
	Blob
    </a>
</h1>
<p>And finally files: We can list their content, again, with the same tool.
Using the <code>-t</code> and <code>-s</code> options we can also see their type and size.</p>
<p>Using <code>09e9c05d0fcf4a403addb0b2b8ee613bc4bd4b1d</code> for the <code>CNAME</code> file from the tree above we get:</p>
<pre><code class="language-console" data-lang="console">$ git cat-file -t 09e9c05d0fcf4a403addb0b2b8ee613bc4bd4b1d
blob
$ git cat-file -s 09e9c05d0fcf4a403addb0b2b8ee613bc4bd4b1d
20
$ git cat-file -p 09e9c05d0fcf4a403addb0b2b8ee613bc4bd4b1d
blog.koehntopp.info
</code></pre><h1 id="diffs">
    <a href="#diffs">
	Diffs
    </a>
</h1>
<p>Diffs do not exist in git.
They are instead generated on the fly, by comparing two trees.
Again, this is less inefficient that one might think:
All unchanged files will have also unchanged hashes and therefore need no consideration for a diff.</p>
<p>For objects with different hashes (but identical names), git then generates a diff.</p>
<h1 id="other-structures">
    <a href="#other-structures">
	Other structures
    </a>
</h1>
<p>When you <code>checkout</code>, you ask git to construct a certain tree using a hash, a tag name, branch or anything else.
Every time, git records the checkout in the <code>reflog</code>.</p>
<pre><code class="language-console" data-lang="console">daad5e3 (HEAD -&gt; main, origin/main, github/main) HEAD@{0}: checkout: moving from 8a650853c5525013800c42f68c92b4d431b7b97c to main
8a65085 HEAD@{1}: checkout: moving from main to 8a650853c5525013800c42f68c92b4d431b7b97c
daad5e3 (HEAD -&gt; main, origin/main, github/main) HEAD@{2}: merge github/main: Merge made by the 'recursive' strategy.
75077bc HEAD@{3}: commit: fix 2021-10-06-empty-commits-and-other-wrong-tools-for-the-job.md
72ab462 HEAD@{4}: commit: fix 2021-10-06-empty-commits-and-other-wrong-tools-for-the-job.md
...
</code></pre><p>You can use this list of commit hashes to reconstruct what you did, where known good locations are, and of course to return to them.
This is essential to repair a git repository that somehow was changed unintentionally and that still contains important salvageable data.</p>
<p>We find the original data git uses in <code>.git/logs/HEAD</code>:</p>
<pre><code class="language-console" data-lang="console">$ tail -4 .git/logs/HEAD
72ab462c4d134b02da1e474d3edb9db201e7aecb 75077bc79697ea1e37da496b1210ca26f3c66c2c Kristian Koehntopp &lt;kris-git@koehntopp.de&gt; 1633508667 +0200      commit: fix 2021-10-06-empty-commits-and-other-wrong-tools-for-the-job.md
75077bc79697ea1e37da496b1210ca26f3c66c2c daad5e31926cdf8a3af0ecff517c4d5892b6f62a Kristian Koehntopp &lt;kris-git@koehntopp.de&gt; 1633513546 +0200      merge github/main: Merge made by the 'recursive' strategy.
daad5e31926cdf8a3af0ecff517c4d5892b6f62a 8a650853c5525013800c42f68c92b4d431b7b97c Kristian Koehntopp &lt;kris-git@koehntopp.de&gt; 1634064444 +0200      checkout: moving from main to 8a650853c5525013800c42f68c92b4d431b7b97c
8a650853c5525013800c42f68c92b4d431b7b97c daad5e31926cdf8a3af0ecff517c4d5892b6f62a Kristian Koehntopp &lt;kris-git@koehntopp.de&gt; 1634064654 +0200      checkout: moving from 8a650853c5525013800c42f68c92b4d431b7b97c to main
</code></pre><h1 id="object-storage">
    <a href="#object-storage">
	Object storage
    </a>
</h1>
<p>git stores all things with a hashed name in .git/objects.
The first byte (the first two letters) of the SHA-1 name make up a directory name, the rest goes into a file name.
File content is stored compressed, using zlib.</p>
<p>We can check that using any programming language that supports zlib.
Here in Python:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># $ git log | head -1</span>
<span style="color:#75715e"># commit daad5e31926cdf8a3af0ecff517c4d5892b6f62a</span>
<span style="color:#75715e"># </span>
<span style="color:#75715e"># $ python3</span>
<span style="color:#75715e"># Python 3.8.10 (default, Jun  2 2021, 10:49:15)</span>

<span style="color:#f92672">import</span> zlib
<span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;.git/objects/da/ad5e31926cdf8a3af0ecff517c4d5892b6f62a&#34;</span>, <span style="color:#e6db74">&#34;rb&#34;</span>) <span style="color:#66d9ef">as</span> f:
   fi <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>read()
data <span style="color:#f92672">=</span> zlib<span style="color:#f92672">.</span>decompress(fi)
str <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#34;utf-8&#34;</span>)
<span style="color:#66d9ef">print</span>(str)
</code></pre></div><p>and</p>
<pre><code class="language-console" data-lang="console">commit 333tree ba5a4ceb371d42d766832dae545ecf00b9194ea2
parent 75077bc79697ea1e37da496b1210ca26f3c66c2c
parent b71d9463ad8c3b71bd279e88e74ce15e01de2aee
author Kristian Koehntopp &lt;kris-git@koehntopp.de&gt; 1633513546 +0200
committer Kristian Koehntopp &lt;kris-git@koehntopp.de&gt; 1633513546 +0200

Merge remote-tracking branch 'github/main' into main
</code></pre><p>We see the file has a header, <code>commit 333</code>, terminated by a NULL byte.
This assists in reconstruction a <code>.git</code> directory from fragments, if any structures are lost.</p>
<p>It is followed by the actual file contents, which in this case is a commit, in ASCII.</p>
<p>Things in gits object storage can get orphaned or grow without size.
Maintenance procedures exist that walk the various structures, identify orphaned objects and clean up things.</p>


	
    </article>
</div>



            <footer>
    <p>
	&copy; Copyright 2021 Someone or something
    </p>
</footer>


        </main>

	





<script src="/js/bootstrap.js"></script>




<script src="/js/lunr.js"></script>





<script src="/js/app.js"></script>


    </body>
</html>
