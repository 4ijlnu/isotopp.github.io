<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Die wunderbare Welt von Isotopp - Things you didn&#39;t know about MySQL and Date and Time and DST</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="site.webmanifest">
<link rel="apple-touch-icon" href="icon.png">
<link rel="favicon.ico" rel="icon" type="image/ico">





	



<link rel="stylesheet" href="/style.min.c5e5cd61f54911f9aafd1dbe09c2f90667957bfe1002126c87aace57759f3446.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
	<a class="navbar-brand" href="" rel="home" title=".Site.Title">
	    Die wunderbare Welt von Isotopp
	</a>
	<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
	</button>

	<div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
		
		
		<li class="nav-item ">
                    <a class="nav-link" href="/about/">
			
			<span>About</span>
			<span class="visually-hidden">(Current)</span>
		    </a>
		    
		</li>
            </ul>
            
	</div>
    </div>
</nav>


        <main role="main" class="container-fluid">

            


<div class="page">
    <article class="things-you-didnt-know-about-mysql-and-date-and-time-and-dst-page">
	<h1 class="title">
            Things you didn&rsquo;t know about MySQL and Date and Time and DST
	</h1>

	<p>(based on a conversation with a colleague, and <a href="https://twitter.com/isotopp/status/1376436003129462784" target="_blank" rel="noopener">a bit of Twitter</a>

)</p>
<h2 id="a-conundrum">
    <a href="#a-conundrum">
	A Conundrum
    </a>
</h2>
<p>A developer colleague paged me with this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span>
UNIX_TIMESTAMP(<span style="color:#e6db74">&#34;2021-03-26 03:07:00&#34;</span> <span style="color:#f92672">+</span> INTERVAL <span style="color:#ae81ff">2</span> <span style="color:#66d9ef">YEAR</span>) <span style="color:#f92672">-</span>
UNIX_TIMESTAMP(<span style="color:#e6db74">&#34;2021-03-26 02:07:00&#34;</span> <span style="color:#f92672">+</span> INTERVAL <span style="color:#ae81ff">2</span> <span style="color:#66d9ef">YEAR</span>) <span style="color:#66d9ef">as</span> delta<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
delta: <span style="color:#ae81ff">420</span>
</code></pre></div><p>It is obviously wrong, and weirdly so. It only works for &ldquo;2 year&rdquo;, not with other values:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span>
UNIX_TIMESTAMP(<span style="color:#e6db74">&#34;2021-03-26 03:07:00&#34;</span> <span style="color:#f92672">+</span> INTERVAL <span style="color:#ae81ff">1</span><span style="color:#f92672">-</span><span style="color:#ae81ff">11</span> year_month) <span style="color:#f92672">-</span>
UNIX_TIMESTAMP(<span style="color:#e6db74">&#34;2021-03-26 02:07:00&#34;</span> <span style="color:#f92672">+</span> INTERVAL <span style="color:#ae81ff">1</span><span style="color:#f92672">-</span><span style="color:#ae81ff">11</span> year_month) <span style="color:#66d9ef">as</span> delta<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
delta: <span style="color:#ae81ff">3600</span>

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span>
UNIX_TIMESTAMP(<span style="color:#e6db74">&#34;2021-03-26 03:07:00&#34;</span> <span style="color:#f92672">+</span> INTERVAL <span style="color:#ae81ff">1</span><span style="color:#f92672">-</span><span style="color:#ae81ff">12</span> year_month) <span style="color:#f92672">-</span>
UNIX_TIMESTAMP(<span style="color:#e6db74">&#34;2021-03-26 02:07:00&#34;</span> <span style="color:#f92672">+</span> INTERVAL <span style="color:#ae81ff">1</span><span style="color:#f92672">-</span><span style="color:#ae81ff">12</span> year_month) <span style="color:#66d9ef">as</span> delta<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
delta: <span style="color:#ae81ff">3600</span>

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span>
UNIX_TIMESTAMP(<span style="color:#e6db74">&#34;2021-03-26 03:07:00&#34;</span> <span style="color:#f92672">+</span> INTERVAL <span style="color:#ae81ff">1</span><span style="color:#f92672">-</span><span style="color:#ae81ff">13</span> year_month) <span style="color:#f92672">-</span>
UNIX_TIMESTAMP(<span style="color:#e6db74">&#34;2021-03-26 02:07:00&#34;</span> <span style="color:#f92672">+</span> INTERVAL <span style="color:#ae81ff">1</span><span style="color:#f92672">-</span><span style="color:#ae81ff">13</span> year_month) <span style="color:#66d9ef">as</span> delta<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
delta: <span style="color:#ae81ff">3600</span>
</code></pre></div><p>It has to be exactly 730 days (2 * 365 days, 2 years):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span>
UNIX_TIMESTAMP(<span style="color:#e6db74">&#34;2021-03-26 03:07:00&#34;</span> <span style="color:#f92672">+</span> INTERVAL <span style="color:#ae81ff">729</span> <span style="color:#66d9ef">day</span>) <span style="color:#f92672">-</span>
UNIX_TIMESTAMP(<span style="color:#e6db74">&#34;2021-03-26 02:07:00&#34;</span> <span style="color:#f92672">+</span> interval <span style="color:#ae81ff">729</span> <span style="color:#66d9ef">day</span>) <span style="color:#66d9ef">as</span> delta<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
delta: <span style="color:#ae81ff">3600</span>

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span>
UNIX_TIMESTAMP(<span style="color:#e6db74">&#34;2021-03-26 03:07:00&#34;</span> <span style="color:#f92672">+</span> INTERVAL <span style="color:#ae81ff">730</span> <span style="color:#66d9ef">day</span>) <span style="color:#f92672">-</span>
UNIX_TIMESTAMP(<span style="color:#e6db74">&#34;2021-03-26 02:07:00&#34;</span> <span style="color:#f92672">+</span> interval <span style="color:#ae81ff">730</span> <span style="color:#66d9ef">day</span>) <span style="color:#66d9ef">as</span> delta<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
delta: <span style="color:#ae81ff">420</span>

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span>
UNIX_TIMESTAMP(<span style="color:#e6db74">&#34;2021-03-26 03:07:00&#34;</span> <span style="color:#f92672">+</span> INTERVAL <span style="color:#ae81ff">731</span> <span style="color:#66d9ef">day</span>) <span style="color:#f92672">-</span>
UNIX_TIMESTAMP(<span style="color:#e6db74">&#34;2021-03-26 02:07:00&#34;</span> <span style="color:#f92672">+</span> interval <span style="color:#ae81ff">731</span> <span style="color:#66d9ef">day</span>) <span style="color:#66d9ef">as</span> delta<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
delta: <span style="color:#ae81ff">3600</span>
</code></pre></div><h2 id="the-reason">
    <a href="#the-reason">
	The Reason
    </a>
</h2>
<p>In our math, we have two expressions mixing MySQL Timestamp data types with UNIX Timestamp Integers.</p>
<p>So in the expression <code>UNIX_TIMESTAMP(&quot;2021-03-26 03:07:00&quot; + INTERVAL 2 year) </code> the part <code>&quot;2021-03-26 03:07:00&quot;</code> is a string, which is converted to a MySQL Timestamp type.</p>
<p>This MySQL Timestamp type is then used in an interval arithmethic expression to yield another MySQL Timestamp type.</p>
<p>This resulting MySQL Timestamp type is then fed into the UNIX_TIMESTAMP function, and produces an integer.</p>
<p>The same happens with <code>UNIX_TIMESTAMP(&quot;2021-03-26 02:07:00&quot; + interval 2 year)</code>, producing another integer.</p>
<p>This is not the integer we are looking for:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> from_unixtime(UNIX_TIMESTAMP(<span style="color:#e6db74">&#34;2021-03-26 02:07:00&#34;</span> <span style="color:#f92672">+</span> interval <span style="color:#ae81ff">730</span> <span style="color:#66d9ef">day</span>)) <span style="color:#66d9ef">as</span> t<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
t: <span style="color:#ae81ff">2023</span><span style="color:#f92672">-</span><span style="color:#ae81ff">03</span><span style="color:#f92672">-</span><span style="color:#ae81ff">26</span> <span style="color:#ae81ff">03</span>:<span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span>

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> <span style="color:#66d9ef">global</span> variables <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#34;%time_zone%&#34;</span>;
<span style="color:#f92672">+</span><span style="color:#75715e">------------------+--------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> Variable_name    <span style="color:#f92672">|</span> Value  <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">------------------+--------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> system_time_zone <span style="color:#f92672">|</span> CEST   <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> time_zone        <span style="color:#f92672">|</span> <span style="color:#66d9ef">SYSTEM</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">------------------+--------+
</span></code></pre></div><h3 id="the-first-level-of-wrongness">
    <a href="#the-first-level-of-wrongness">
	The First Level of Wrongness
    </a>
</h3>
<p>The <code>2023-03-26</code> is the day of the proposed time zone switch for 2023.</p>
<p>On this date, in the CET/CEST time zone, <code>02:07:00</code> is an invalid timestamp. MySQL silently, without error or warning, rounds this up to the next valid timestamp, <code>03:00:00</code>.</p>
<p>This also happened yesterday:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#960050;background-color:#1e0010">$</span> mysql <span style="color:#75715e">--show-warnings
</span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> from_unixtime(unix_timestamp(<span style="color:#e6db74">&#34;2021-03-28 02:07:00&#34;</span>)) <span style="color:#66d9ef">as</span> t<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
t: <span style="color:#ae81ff">2021</span><span style="color:#f92672">-</span><span style="color:#ae81ff">03</span><span style="color:#f92672">-</span><span style="color:#ae81ff">28</span> <span style="color:#ae81ff">03</span>:<span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span>
</code></pre></div><p>This should error, and must at least warn. It does neither.</p>
<h3 id="the-second-level-of-wrongness">
    <a href="#the-second-level-of-wrongness">
	The Second Level of Wrongness
    </a>
</h3>
<p>For</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> from_unixtime(UNIX_TIMESTAMP(<span style="color:#e6db74">&#34;2021-03-26 02:07:00&#34;</span> <span style="color:#f92672">+</span> interval <span style="color:#ae81ff">730</span> <span style="color:#66d9ef">day</span>)) <span style="color:#66d9ef">as</span> t<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
t: <span style="color:#ae81ff">2023</span><span style="color:#f92672">-</span><span style="color:#ae81ff">03</span><span style="color:#f92672">-</span><span style="color:#ae81ff">26</span> <span style="color:#ae81ff">03</span>:<span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span>
</code></pre></div><p>there is the choice of producing the correct timestamp or producing an error. Silently fast forwarding to the next valid timestamp is incorrect in all cases.</p>
<h2 id="setting-utc">
    <a href="#setting-utc">
	Setting UTC
    </a>
</h2>
<p>The database is running with the <code>time_zone set</code> to <code>SYSTEM</code>, and the system is running with the <code>system_time_zone</code> (a read-only variable) set to <code>CEST</code> (was: <code>CET</code>), which was picked up after the server start (on my laptop, in this case).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> <span style="color:#66d9ef">global</span> variables <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#34;%time_zone%&#34;</span>;
<span style="color:#f92672">+</span><span style="color:#75715e">------------------+--------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> Variable_name    <span style="color:#f92672">|</span> Value  <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">------------------+--------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> system_time_zone <span style="color:#f92672">|</span> CEST   <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> time_zone        <span style="color:#f92672">|</span> <span style="color:#66d9ef">SYSTEM</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">------------------+--------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">2</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">01</span> sec)
t: <span style="color:#ae81ff">2023</span><span style="color:#f92672">-</span><span style="color:#ae81ff">03</span><span style="color:#f92672">-</span><span style="color:#ae81ff">26</span> <span style="color:#ae81ff">03</span>:<span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span>
</code></pre></div><p>Trying to set the <code>time_zone</code> to UTC fails. This is because the time_zone tables have not been loaded.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#960050;background-color:#1e0010">$</span> mysql_tzinfo_to_sql <span style="color:#f92672">/</span>usr<span style="color:#f92672">/</span><span style="color:#66d9ef">share</span><span style="color:#f92672">/</span>zoneinfo <span style="color:#f92672">|</span> mysql <span style="color:#f92672">-</span>u root <span style="color:#f92672">-</span>p<span style="color:#e6db74">&#39;&#39;</span> mysql
...
</code></pre></div><p>With that, I can</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#960050;background-color:#1e0010">$</span> mysql <span style="color:#f92672">-</span>u root <span style="color:#f92672">-</span>p
mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">set</span> <span style="color:#66d9ef">global</span> time_zone<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;UTC&#34;</span>;
Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">set</span> <span style="color:#66d9ef">session</span> time_zone<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;UTC&#34;</span>;
Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>And with that, I can avoid the conversion:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> from_unixtime(unix_timestamp(<span style="color:#e6db74">&#34;2021-03-28 00:07:00&#34;</span>)) <span style="color:#66d9ef">as</span> t;
<span style="color:#f92672">+</span><span style="color:#75715e">---------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> t                   <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">---------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> <span style="color:#ae81ff">2021</span><span style="color:#f92672">-</span><span style="color:#ae81ff">03</span><span style="color:#f92672">-</span><span style="color:#ae81ff">28</span> <span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">07</span>:<span style="color:#ae81ff">00</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">---------------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> from_unixtime(unix_timestamp(<span style="color:#e6db74">&#34;2021-03-28 01:07:00&#34;</span>)) <span style="color:#66d9ef">as</span> t;
<span style="color:#f92672">+</span><span style="color:#75715e">---------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> t                   <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">---------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> <span style="color:#ae81ff">2021</span><span style="color:#f92672">-</span><span style="color:#ae81ff">03</span><span style="color:#f92672">-</span><span style="color:#ae81ff">28</span> <span style="color:#ae81ff">01</span>:<span style="color:#ae81ff">07</span>:<span style="color:#ae81ff">00</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">---------------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> from_unixtime(unix_timestamp(<span style="color:#e6db74">&#34;2021-03-28 02:07:00&#34;</span>)) <span style="color:#66d9ef">as</span> t;
<span style="color:#f92672">+</span><span style="color:#75715e">---------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> t                   <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">---------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> <span style="color:#ae81ff">2021</span><span style="color:#f92672">-</span><span style="color:#ae81ff">03</span><span style="color:#f92672">-</span><span style="color:#ae81ff">28</span> <span style="color:#ae81ff">02</span>:<span style="color:#ae81ff">07</span>:<span style="color:#ae81ff">00</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">---------------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> from_unixtime(unix_timestamp(<span style="color:#e6db74">&#34;2021-03-28 03:07:00&#34;</span>)) <span style="color:#66d9ef">as</span> t;
<span style="color:#f92672">+</span><span style="color:#75715e">---------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> t                   <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">---------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> <span style="color:#ae81ff">2021</span><span style="color:#f92672">-</span><span style="color:#ae81ff">03</span><span style="color:#f92672">-</span><span style="color:#ae81ff">28</span> <span style="color:#ae81ff">03</span>:<span style="color:#ae81ff">07</span>:<span style="color:#ae81ff">00</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">---------------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>Thsi will also yield the correct result for the type-mixed difference I showed above:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span>
UNIX_TIMESTAMP(<span style="color:#e6db74">&#34;2021-03-26 03:07:00&#34;</span> <span style="color:#f92672">+</span> INTERVAL <span style="color:#ae81ff">2</span> <span style="color:#66d9ef">YEAR</span>) <span style="color:#f92672">-</span>
UNIX_TIMESTAMP(<span style="color:#e6db74">&#34;2021-03-26 02:07:00&#34;</span> <span style="color:#f92672">+</span> INTERVAL <span style="color:#ae81ff">2</span> <span style="color:#66d9ef">YEAR</span>) <span style="color:#66d9ef">as</span> delta<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
delta: <span style="color:#ae81ff">3600</span>
</code></pre></div><h2 id="not-mixing-mysql-date-types-and-unix-timestamps">
    <a href="#not-mixing-mysql-date-types-and-unix-timestamps">
	Not mixing MySQL Date Types and UNIX Timestamps
    </a>
</h2>
<p>The original math fails, because it mixes UNIX Timestamps and Date Interval Arithmethics.</p>
<p>We can handle this all the way in MySQL, using the extremely weird <a href="https://dev.mysql.com/doc/refman/8.0/en/date-and-time-functions.html#function_timestampdiff" target="_blank" rel="noopener"><code>timestampdiff()</code></a>

 function (more on that below):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> 
  timestampdiff(
    <span style="color:#66d9ef">second</span>,
    date_add(<span style="color:#e6db74">&#34;2021-03-26 02:07:00&#34;</span>, INTERVAL <span style="color:#ae81ff">2</span> <span style="color:#66d9ef">YEAR</span>), 
    date_add(<span style="color:#e6db74">&#34;2021-03-26 03:07:00&#34;</span>, INTERVAL <span style="color:#ae81ff">2</span> <span style="color:#66d9ef">YEAR</span>)
  ) <span style="color:#66d9ef">as</span> t<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
t: <span style="color:#ae81ff">3600</span>
</code></pre></div><p>We can handle this all the way in Integers with Unix Timestamps:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#ae81ff">86400</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">365</span> <span style="color:#66d9ef">as</span> t <span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
t: <span style="color:#ae81ff">31536000</span>

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> 
  (unix_timestamp(<span style="color:#e6db74">&#34;2021-03-26 03:07:00&#34;</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">*</span><span style="color:#ae81ff">31536000</span>) <span style="color:#f92672">-</span> 
  (unix_timestamp(<span style="color:#e6db74">&#34;2021-03-26 02:07:00&#34;</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">*</span> <span style="color:#ae81ff">31536000</span>) <span style="color:#66d9ef">as</span> t <span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
t: <span style="color:#ae81ff">3600</span>
</code></pre></div><p>Both give us correct results.</p>
<h2 id="date-and-time-syntax">
    <a href="#date-and-time-syntax">
	Date and Time Syntax
    </a>
</h2>
<p>MySQL provides you <code>INTERVAL</code> syntax with operators:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#e6db74">&#34;2021-03-29 10:02:03&#34;</span> <span style="color:#f92672">+</span> interval <span style="color:#ae81ff">1</span> hour <span style="color:#66d9ef">as</span> t<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
t: <span style="color:#ae81ff">2021</span><span style="color:#f92672">-</span><span style="color:#ae81ff">03</span><span style="color:#f92672">-</span><span style="color:#ae81ff">29</span> <span style="color:#ae81ff">11</span>:<span style="color:#ae81ff">02</span>:<span style="color:#ae81ff">03</span>
</code></pre></div><p>and with functions:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> date_add(<span style="color:#e6db74">&#34;2021-03-29 10:02:03&#34;</span>, interval <span style="color:#ae81ff">1</span> hour) <span style="color:#66d9ef">as</span> t<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
t: <span style="color:#ae81ff">2021</span><span style="color:#f92672">-</span><span style="color:#ae81ff">03</span><span style="color:#f92672">-</span><span style="color:#ae81ff">29</span> <span style="color:#ae81ff">11</span>:<span style="color:#ae81ff">02</span>:<span style="color:#ae81ff">03</span>
</code></pre></div><p>Interval Syntax is weird. You can&rsquo;t</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#e6db74">&#34;2021-03-29 10:02:03&#34;</span> <span style="color:#f92672">+</span> interval <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">month</span> <span style="color:#ae81ff">1</span> hour <span style="color:#66d9ef">as</span> t<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
ERROR <span style="color:#ae81ff">1064</span> (<span style="color:#ae81ff">42000</span>): You have an error <span style="color:#66d9ef">in</span> your <span style="color:#66d9ef">SQL</span> syntax; <span style="color:#66d9ef">check</span> the manual that corresponds <span style="color:#66d9ef">to</span> your MySQL server <span style="color:#66d9ef">version</span> <span style="color:#66d9ef">for</span> the <span style="color:#66d9ef">right</span> syntax <span style="color:#66d9ef">to</span> use near <span style="color:#e6db74">&#39;1 hour as t&#39;</span> <span style="color:#66d9ef">at</span> line <span style="color:#ae81ff">1</span>
</code></pre></div><p>You can only</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#e6db74">&#34;2021-03-29 10:02:03&#34;</span> <span style="color:#f92672">+</span> interval <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">month</span> <span style="color:#f92672">+</span> interval <span style="color:#ae81ff">1</span> hour <span style="color:#66d9ef">as</span> t<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
t: <span style="color:#ae81ff">2021</span><span style="color:#f92672">-</span><span style="color:#ae81ff">04</span><span style="color:#f92672">-</span><span style="color:#ae81ff">29</span> <span style="color:#ae81ff">11</span>:<span style="color:#ae81ff">02</span>:<span style="color:#ae81ff">03</span>
</code></pre></div><p>With date_add() it is worse, because you have to nest:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> date_add(<span style="color:#e6db74">&#34;2021-03-29 10:02:03&#34;</span>, interval <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">month</span> <span style="color:#f92672">+</span> interval <span style="color:#ae81ff">1</span> hour) <span style="color:#66d9ef">as</span> t<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
ERROR <span style="color:#ae81ff">1064</span> (<span style="color:#ae81ff">42000</span>): You have an error <span style="color:#66d9ef">in</span> your <span style="color:#66d9ef">SQL</span> syntax; <span style="color:#66d9ef">check</span> the manual that corresponds <span style="color:#66d9ef">to</span> your MySQL server <span style="color:#66d9ef">version</span> <span style="color:#66d9ef">for</span> the <span style="color:#66d9ef">right</span> syntax <span style="color:#66d9ef">to</span> use near <span style="color:#e6db74">&#39;1 hour) as t&#39;</span> <span style="color:#66d9ef">at</span> line <span style="color:#ae81ff">1</span>
</code></pre></div><p>That would be then</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> date_add(date_add(<span style="color:#e6db74">&#34;2021-03-29 10:02:03&#34;</span>, interval <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">month</span>), interval <span style="color:#ae81ff">1</span> hour) <span style="color:#66d9ef">as</span> t<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
t: <span style="color:#ae81ff">2021</span><span style="color:#f92672">-</span><span style="color:#ae81ff">04</span><span style="color:#f92672">-</span><span style="color:#ae81ff">29</span> <span style="color:#ae81ff">11</span>:<span style="color:#ae81ff">02</span>:<span style="color:#ae81ff">03</span>
</code></pre></div><p>So <code>date_add()</code> and <code>date_sub()</code> both take a timestamp and an interval, and can be written as <code>+</code> and <code>-</code>, avoiding the nesting.</p>
<h2 id="a-word-of-warning-on-diff-functions">
    <a href="#a-word-of-warning-on-diff-functions">
	A Word of Warning on DIFF functions
    </a>
</h2>
<p>There are two functions with underscores in the name, DATE_ADD() and DATE_SUB(), which take a timestamp and an interval. They produce a new timestamp.</p>
<p>There are three functions without underscores in the name DATEDIFF(), TIMEDIFF() and TIMESTAMPDIFF(), which take two timestamps and produce the difference.</p>
<p>They are all subtly different, and the parameter order for TIMESTAMPDIFF() is the other way around.</p>
<p>Read carefully:</p>
<p><a href="https://dev.mysql.com/doc/refman/8.0/en/date-and-time-functions.html#function_datediff" target="_blank" rel="noopener"><code>datediff(a, b)</code></a>

 calculates the DATE difference as <code>a-b</code>. The time part of the timestamps is ignored.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> datediff(now() <span style="color:#f92672">+</span> interval <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">month</span>, now()) <span style="color:#66d9ef">as</span> t<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
t: <span style="color:#ae81ff">31</span>

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> datediff(now() <span style="color:#f92672">+</span> interval <span style="color:#ae81ff">2</span> <span style="color:#66d9ef">month</span>, now() <span style="color:#f92672">+</span> interval <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">month</span>) <span style="color:#66d9ef">as</span> t<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
t: <span style="color:#ae81ff">30</span>
</code></pre></div><p><a href="https://dev.mysql.com/doc/refman/8.0/en/date-and-time-functions.html#function_timediff" target="_blank" rel="noopener"><code>timediff(a, b)</code></a>

 calculates the TIME difference as <code>a-b</code>. The DATE and TIME parts are being used. The range is limited to the range of the TIME type, which is from &lsquo;-838:59:59&rsquo; to &lsquo;838:59:59&rsquo;.</p>
<p>That is 5 weeks, less 1 hour and 1 second (5 weeks are 840 hours, <code>5 * 7 * 24</code>).</p>
<p><a href="https://dev.mysql.com/doc/refman/8.0/en/date-and-time-functions.html#function_timestampdiff" target="_blank" rel="noopener"><code>timestampdiff(unit, a, b)</code></a>

 can do &ldquo;proper&rdquo; difference between <code>b</code> and <code>a</code>. The result is reported in the unit specified.</p>
<p>The order of the parameters is inexplicably reversed: We calculate <code>b-a</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> timestampdiff(hour, <span style="color:#e6db74">&#34;2021-03-29 10:02:03&#34;</span>, <span style="color:#e6db74">&#34;2021-03-29 10:02:03&#34;</span> <span style="color:#f92672">+</span> interval <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">month</span> <span style="color:#f92672">+</span> interval <span style="color:#ae81ff">1</span> hour) <span style="color:#66d9ef">as</span> t<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
t: <span style="color:#ae81ff">745</span>
</code></pre></div><h1 id="tldr">
    <a href="#tldr">
	TL;DR
    </a>
</h1>
<ul>
<li>The lack of warning and error is now a MySQL Service Request.</li>
<li>The original problem comes up because of the mixing of Unix Timestamp Arithmethic and MySQL Interval Arithmethic.</li>
<li>There are ways to do it pure play either way, and they both result in the right result.</li>
<li>There is <code>DATEDIFF()</code>, <code>TIMEDIFF()</code>, and <code>TIMESTAMPDIFF()</code>, and they are weird, and inconsistent and you really, really want to read the <a href="https://dev.mysql.com/doc/refman/8.0/en/date-and-time-functions.html" target="_blank" rel="noopener">Date and Time Functions</a>

 page, very carefully.</li>
</ul>


	
    </article>
</div>



            <footer>
    <p>
	&copy; Copyright 2021 Someone or something
    </p>
</footer>


        </main>

	





<script src="/js/bootstrap.js"></script>




<script src="/js/lunr.js"></script>





<script src="/js/app.js"></script>


    </body>
</html>
