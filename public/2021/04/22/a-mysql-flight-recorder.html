<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Die wunderbare Welt von Isotopp - A MySQL flight recorder</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="site.webmanifest">
<link rel="apple-touch-icon" href="icon.png">
<link rel="favicon.ico" rel="icon" type="image/ico">





	



<link rel="stylesheet" href="/style.min.c5e5cd61f54911f9aafd1dbe09c2f90667957bfe1002126c87aace57759f3446.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
	<a class="navbar-brand" href="" rel="home" title=".Site.Title">
	    Die wunderbare Welt von Isotopp
	</a>
	<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
	</button>

	<div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
		
		
		<li class="nav-item ">
                    <a class="nav-link" href="/about/">
			
			<span>About</span>
			<span class="visually-hidden">(Current)</span>
		    </a>
		    
		</li>
            </ul>
            
	</div>
    </div>
</nav>


        <main role="main" class="container-fluid">

            


<div class="page">
    <article class="a-mysql-flight-recorder-page">
	<h1 class="title">
            A MySQL flight recorder
	</h1>

	<p>Sometimes things go wrong, and it surely would be nice if you at least knew afterwards what happened. Where I work, we are running a shell script older than time itself, once a minute. The script writes files to <code>/var/log/mysql_pl</code>, into a directory named after the current weekday and named after the current hour and minute.</p>
<p>So when a box crashes on Thursday at 22:09, as long as I can login to it, I still can try to look at <code>/var/log/mysql_pl/Thu/22_0?</code> and try to reconstruct what happened before the crash. Often the buildup to catastrophe is clearly visible.</p>
<h2 id="a-version-in-python">
    <a href="#a-version-in-python">
	A version in Python
    </a>
</h2>
<p>Our shell script is not really portable or viable outside the work environment, so I rewrite a similar thing in Python. It has no dependencies outside of a base install of a modern Python, except for <code>mysqlclient</code> (<code>MySQLdb</code>) to connect to the database.</p>
<p>The full script is <a href="https://github.com/isotopp/mysql-dev-examples/tree/master/mysql-flight-recorder" target="_blank" rel="noopener">available on github</a>

.</p>
<h2 id="ini-file">
    <a href="#ini-file">
	ini file
    </a>
</h2>
<p>It requires an <code>*.ini</code> file, and searches for it in <a href="https://github.com/isotopp/mysql-dev-examples/blob/master/mysql-flight-recorder/flight_recorder.py#L299-L314" target="_blank" rel="noopener">a number of locations</a>

:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">    f <span style="color:#f92672">=</span> config<span style="color:#f92672">.</span>read(
        [
            <span style="color:#e6db74">&#34;/etc/mysql/mysql-flight-recorder.ini&#34;</span>,
            <span style="color:#e6db74">&#34;/etc/mysql/mysql_flight_recorder.ini&#34;</span>,
            os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>expanduser(<span style="color:#e6db74">&#34;~/.mysql-flight-recorder.ini&#34;</span>),
            os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>expanduser(<span style="color:#e6db74">&#34;~/.mysql_flight_recorder.ini&#34;</span>),
            os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>expanduser(<span style="color:#e6db74">&#34;~/mysql-flight-recorder.ini&#34;</span>),
            os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>expanduser(<span style="color:#e6db74">&#34;~/mysql_flight_recorder.ini&#34;</span>),
            <span style="color:#e6db74">&#34;./.mysql-flight-recorder.ini&#34;</span>,
            <span style="color:#e6db74">&#34;./.mysql_flight_recorder.ini&#34;</span>,
            <span style="color:#e6db74">&#34;./mysql-flight-recorder.ini&#34;</span>,
            <span style="color:#e6db74">&#34;./mysql_flight_recorder.ini&#34;</span>,
        ]
    )
</code></pre></div><p>So it is either <code>mysql_flight_recorder.ini</code> or <code>mysql-flight-recorder.ini</code> with underbars or dashes, in <code>/etc/mysql</code>, in your home as a dotfile or non-dotfile, or in the current directory as a dotfile or non-dotfile.</p>
<p>The <code>*.ini</code> files looks like this:</p>
<pre><code class="language-console" data-lang="console">[DEFAULT]
logdir = /home/kris/Python/mysql/mysql-flight-recorder/mysql_flight_recorder
pidfile = /home/kris/Python/mysql/mysql-flight-recorder/mysql_flight_recorder.pid
compresscmd= bzip2 -9f
</code></pre><p>That is, the <code>DEFAULT</code> section defines</p>
<ul>
<li>logdir: a direcory where to put the logfiles.</li>
<li>pidfile: It also needs a filename (as an absolute pathname) for a pidfile, which is being used to prevent concurrent execution.</li>
<li>compresscmd: And finally, the logfiles can be compressed, and the compress command needs to be specified. The compress command needs to be given in a way that existing compressed files are overwritten, that is why in the example the <code>-f</code> option is given.</li>
</ul>
<p>After that, for each host that is to be checked a section is defined. The section name defines the log file prefix, the <code>compresscmd</code> controls the suffix. In each section, we need to specify username, password, host and port for the connection. No attempt at using TLS is being made in my quick hack.</p>
<p>The default config shown produces</p>
<pre><code class="language-console" data-lang="console">(venv) kris@server:~/Python/mysql/mysql-flight-recorder$ ls -l mysql_flight_recorder/Thu/
total 48
-rw-rw-r-- 1 kris kris 21424 Apr 22 23:35 localhost_23_35.bz2
-rw-rw-r-- 1 kris kris 20975 Apr 22 23:36 localhost_23_36.bz2
...
</code></pre><h2 id="what-is-being-logged">
    <a href="#what-is-being-logged">
	What is being logged?
    </a>
</h2>
<p>We run</p>
<ul>
<li><code>select version() as version</code></li>
<li><code>show global status like 'Uptime'</code></li>
<li><code>show full processlist</code></li>
<li><code>show slave status</code> (this will need a version gate soon to use <code>show replica status</code>)</li>
<li><code>show engine innodb status</code></li>
<li><code>select * from information_schema.innodb_trx</code></li>
<li><code>select * from information_schema.innodb_locks</code> (this has a version gate and uses <code>select * from performance_schema.data_locks</code> on 8.0)</li>
<li><code>select * from information_schema.innodb_lock_waits</code> (this has a version gate and uses <code>select * from performance_schema.data_lock_waits</code> on 8.0)</li>
<li><code>select * from information_schema.innodb_cmp</code></li>
<li><code>select * from information_schema.innodb_cmpmem</code></li>
<li><code>select * from information_schema.innodb_metrics</code></li>
<li><code>show global status</code></li>
<li><code>show global variables</code></li>
</ul>
<p>That&rsquo;s a lot of data, but bzip2 compressed it to around 20KB per minute. At 10000 files per week this ends up using 200 MB of disk space, which is reasonable for a post-mortem data stash.</p>
<h2 id="possible-extensions">
    <a href="#possible-extensions">
	Possible extensions
    </a>
</h2>
<p>The original shell script has better support for TLS based communication, because it works using the command line client. The Python script needs TLS added.</p>
<p>The original shell script has some more version gating to handle older versions of MySQL and MariaDB. It tolerates missing data tables instead of terminating with an error.</p>
<p>The original shell script has a PMP trigger logic and can attach a gdb to the mysqld when certain conditions are met in order to PMP it. As we work only remotely in this version of the script, this is conceptually not supported.</p>


	
    </article>
</div>



            <footer>
    <p>
	&copy; Copyright 2021 Someone or something
    </p>
</footer>


        </main>

	





<script src="/js/bootstrap.js"></script>




<script src="/js/lunr.js"></script>





<script src="/js/app.js"></script>


    </body>
</html>
