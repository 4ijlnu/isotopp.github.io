<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Die wunderbare Welt von Isotopp - Making an unexpected leap with interval syntax</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="site.webmanifest">
<link rel="apple-touch-icon" href="icon.png">
<link rel="favicon.ico" rel="icon" type="image/ico">





	



<link rel="stylesheet" href="/style.min.c5e5cd61f54911f9aafd1dbe09c2f90667957bfe1002126c87aace57759f3446.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
	<a class="navbar-brand" href="" rel="home" title=".Site.Title">
	    Die wunderbare Welt von Isotopp
	</a>
	<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
	</button>

	<div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
		
		
		<li class="nav-item ">
                    <a class="nav-link" href="/about/">
			
			<span>About</span>
			<span class="visually-hidden">(Current)</span>
		    </a>
		    
		</li>
            </ul>
            
	</div>
    </div>
</nav>


        <main role="main" class="container-fluid">

            


<div class="page">
    <article class="making-an-unexpected-leap-with-interval-syntax-page">
	<h1 class="title">
            Making an unexpected leap with interval syntax
	</h1>

	<p>(based on a find by Ruud van Tol, and several Twitter contributions)</p>
<p>Ruud commented on [our DST discussion]({% link _posts/2021-03-29-mysql-date-time-dst.md %}) with</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SELECT</span> 
<span style="color:#e6db74">&#39;2019-02-28 12:34:56&#39;</span><span style="color:#f92672">+</span> INTERVAL <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">YEAR</span> <span style="color:#f92672">+</span> INTERVAL <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">DAY</span> <span style="color:#66d9ef">as</span> a, 
<span style="color:#e6db74">&#39;2019-02-28 12:34:56&#39;</span><span style="color:#f92672">+</span> INTERVAL <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">DAY</span> <span style="color:#f92672">+</span> INTERVAL <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">YEAR</span>  <span style="color:#66d9ef">as</span> b<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
a: <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">02</span><span style="color:#f92672">-</span><span style="color:#ae81ff">29</span> <span style="color:#ae81ff">12</span>:<span style="color:#ae81ff">34</span>:<span style="color:#ae81ff">56</span>
b: <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">03</span><span style="color:#f92672">-</span><span style="color:#ae81ff">01</span> <span style="color:#ae81ff">12</span>:<span style="color:#ae81ff">34</span>:<span style="color:#ae81ff">56</span>
</code></pre></div><p>2019 is a year before a leap year. Adding (left to right) a year brings us to <code>2020-02-28</code>, and then adding a day makes this <code>2020-02-29</code>, because it&rsquo;s a leap year.</p>
<p>On the other hand, adding a day first makes it <code>2019-03-01</code>, and then adding a year makes it <code>2020-03-01</code>, a different result.</p>
<p>Clearly, addition is not commutative on dates, and having a two step interval addition is breaking expectations here.</p>
<h2 id="compound-interval-notation">
    <a href="#compound-interval-notation">
	Compound Interval Notation
    </a>
</h2>
<p>MySQL is offering a bit of syntax for compound intervals. You can look it up in the <a href="https://dev.mysql.com/doc/refman/8.0/en/expressions.html#temporal-intervals" target="_blank" rel="noopener">manual</a>

.</p>
<p>To write up compound intervals, there is a select number of unit names that are actually allowed, and a special expression syntax for each one.</p>
<p>For example, you can <code>+ interval 12:23:56.789 hour_microsecond</code>, or <code>+ interval 01-01 year_month</code>. You can&rsquo;t jump a year and a day, because there is no unit for that. Instead you have to write this down in MySQL in a two step interval addition and suddenly order matters.</p>
<p>If you think that this is a cumbersome solution and a cumbersome syntax, you will see me nodding in agreement.</p>
<h2 id="other-databases">
    <a href="#other-databases">
	Other databases
    </a>
</h2>
<h3 id="sqlite">
    <a href="#sqlite">
	SQLite
    </a>
</h3>
<p><a href="https://twitter.com/MohammedSahaf/status/1377771663350173705" target="_blank" rel="noopener">Mohammed S. Al Sahaf</a>

 contributes this syntax for <a href="https://sqlite.org/lang_datefunc.html" target="_blank" rel="noopener">SQLite</a>

:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">sqlite<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span>
  date(<span style="color:#e6db74">&#39;2019-02-28&#39;</span>, <span style="color:#e6db74">&#39;+1 year&#39;</span>, <span style="color:#e6db74">&#39;+1 day&#39;</span>) <span style="color:#66d9ef">as</span> a,
  date(<span style="color:#e6db74">&#39;2019-02-28&#39;</span>, <span style="color:#e6db74">&#39;+1 day&#39;</span>, <span style="color:#e6db74">&#39;+1 year&#39;</span>) <span style="color:#66d9ef">as</span> b;
a           b
<span style="color:#75715e">----------  ----------
</span><span style="color:#75715e"></span><span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">02</span><span style="color:#f92672">-</span><span style="color:#ae81ff">29</span>  <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">03</span><span style="color:#f92672">-</span><span style="color:#ae81ff">01</span>
</code></pre></div><p>confirming that this is not a problem specific to MySQL.</p>
<h3 id="postgres">
    <a href="#postgres">
	Postgres
    </a>
</h3>
<p><a href="https://twitter.com/ascherbaum/status/1377617850509180932" target="_blank" rel="noopener">Andreas Scherbaum</a>

 demonstrates the more generic Postgres Syntax:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">pgsql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SELECT</span> 
<span style="color:#e6db74">&#39;2019-02-28 12:34:56&#39;</span>::<span style="color:#66d9ef">TIMESTAMP</span> <span style="color:#f92672">+</span> INTERVAL <span style="color:#e6db74">&#39;1 year 1 day&#39;</span> <span style="color:#66d9ef">as</span> a,
<span style="color:#e6db74">&#39;2019-02-28 12:34:56&#39;</span>::<span style="color:#66d9ef">TIMESTAMP</span> <span style="color:#f92672">+</span> INTERVAL <span style="color:#e6db74">&#39;1 day 1 year&#39;</span> <span style="color:#66d9ef">as</span> b;

a: <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">02</span><span style="color:#f92672">-</span><span style="color:#ae81ff">29</span>T12:<span style="color:#ae81ff">34</span>:<span style="color:#ae81ff">56</span>Z	
b: <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">02</span><span style="color:#f92672">-</span><span style="color:#ae81ff">29</span>T12:<span style="color:#ae81ff">34</span>:<span style="color:#ae81ff">56</span>Z	
</code></pre></div><p>This works, because Postgres offers a syntax for a single interval that can combine arbitrary units. So internally both times it&rsquo;s the same order of operations (a span of a year and a day) in a single interval.</p>
<p>The <a href="http://sqlfiddle.com/#!17/76411/3/0" target="_blank" rel="noopener">two-step operation</a>

 gives the same result as MYSQL.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">pgsql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SELECT</span> 
<span style="color:#e6db74">&#39;2019-02-28 12:34:56&#39;</span>::<span style="color:#66d9ef">TIMESTAMP</span> <span style="color:#f92672">+</span> INTERVAL <span style="color:#e6db74">&#39;1 year&#39;</span> <span style="color:#f92672">+</span> INTERVAL <span style="color:#e6db74">&#39;1 day&#39;</span> <span style="color:#66d9ef">as</span> a,
<span style="color:#e6db74">&#39;2019-02-28 12:34:56&#39;</span>::<span style="color:#66d9ef">TIMESTAMP</span> <span style="color:#f92672">+</span> INTERVAL <span style="color:#e6db74">&#39;1 day&#39;</span> <span style="color:#f92672">+</span> INTERVAL <span style="color:#e6db74">&#39;1 year&#39;</span> <span style="color:#66d9ef">as</span> b;

a: <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">02</span><span style="color:#f92672">-</span><span style="color:#ae81ff">29</span>T12:<span style="color:#ae81ff">34</span>:<span style="color:#ae81ff">56</span>Z	
b: <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">03</span><span style="color:#f92672">-</span><span style="color:#ae81ff">01</span>T12:<span style="color:#ae81ff">34</span>:<span style="color:#ae81ff">56</span>Z
</code></pre></div><h3 id="cockroach">
    <a href="#cockroach">
	Cockroach
    </a>
</h3>
<p><a href="https://twitter.com/MohammedSahaf/status/1377772984585367553" target="_blank" rel="noopener">Mohammed</a>

 also demonstrates that Cockroach has the same syntax that allows Postgres to make the calculation in a single step:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">Cockroach<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span>
<span style="color:#e6db74">&#39;2019-02-28 12:34:56&#39;</span>::<span style="color:#66d9ef">TIMESTAMP</span> <span style="color:#f92672">+</span> INTERVAL <span style="color:#e6db74">&#39;1 year 1 day&#39;</span> <span style="color:#66d9ef">as</span> a,
<span style="color:#e6db74">&#39;2019-02-28 12:34:56&#39;</span>::<span style="color:#66d9ef">TIMESTAMP</span> <span style="color:#f92672">+</span> INTERVAL <span style="color:#e6db74">&#39;1 day 1 year&#39;</span> <span style="color:#66d9ef">as</span> b;
              a             <span style="color:#f92672">|</span>             b
<span style="color:#75715e">----------------------------+----------------------------
</span><span style="color:#75715e"></span>  <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">02</span><span style="color:#f92672">-</span><span style="color:#ae81ff">29</span> <span style="color:#ae81ff">12</span>:<span style="color:#ae81ff">34</span>:<span style="color:#ae81ff">56</span><span style="color:#f92672">+</span><span style="color:#ae81ff">00</span>.<span style="color:#ae81ff">00</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">02</span><span style="color:#f92672">-</span><span style="color:#ae81ff">29</span> <span style="color:#ae81ff">12</span>:<span style="color:#ae81ff">34</span>:<span style="color:#ae81ff">56</span><span style="color:#f92672">+</span><span style="color:#ae81ff">00</span>.<span style="color:#ae81ff">00</span>
</code></pre></div><h2 id="what-to-do-about-it">
    <a href="#what-to-do-about-it">
	What to do about it?
    </a>
</h2>
<p>I do not think that the different results for &ldquo;a day and a year&rdquo; and &ldquo;a year and a day&rdquo; for leap years in current MySQL are a bug, but they are certainly unexpected.</p>
<p>I do think the current syntax for compound intervals that MySQL has is cumbersome and limited. It is also different from Postgres and Cockroach.</p>
<p>Picking up Postgres/Cockroach interval notation would allow MySQL to get rid of &ldquo;day_microsecond&rdquo; and all the special expression syntaxes. It would also allow it to write arbitrary intervals with a much simpler notation.</p>
<p>So, MySQL, please consider</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#e6db74">&#39;2019-02-29 12:34:56&#39;</span> <span style="color:#f92672">+</span> interval <span style="color:#e6db74">&#39;1 day 1 year&#39;</span> <span style="color:#66d9ef">as</span> a;

a: <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">02</span><span style="color:#f92672">-</span><span style="color:#ae81ff">29</span> <span style="color:#ae81ff">12</span>:<span style="color:#ae81ff">34</span>:<span style="color:#ae81ff">56</span>
</code></pre></div><p>sort it internally into a canonical expression and make it possible to jump to &lsquo;2020-02-29 12:34:56&rsquo; in a single interval jump.</p>
<p>Until then, make sure that you manually order your chained intervals into the proper sequence of steps. And if it is not from large to small, prepare to be surprised.</p>


	
    </article>
</div>



            <footer>
    <p>
	&copy; Copyright 2021 Someone or something
    </p>
</footer>


        </main>

	





<script src="/js/bootstrap.js"></script>




<script src="/js/lunr.js"></script>





<script src="/js/app.js"></script>


    </body>
</html>
