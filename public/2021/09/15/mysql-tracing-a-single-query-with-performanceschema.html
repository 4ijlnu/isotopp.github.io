<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Die wunderbare Welt von Isotopp - MySQL: Tracing a single query with PERFORMANCE_SCHEMA</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="site.webmanifest">
<link rel="apple-touch-icon" href="icon.png">
<link rel="favicon.ico" rel="icon" type="image/ico">





	



<link rel="stylesheet" href="/style.min.c5e5cd61f54911f9aafd1dbe09c2f90667957bfe1002126c87aace57759f3446.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
	<a class="navbar-brand" href="" rel="home" title=".Site.Title">
	    Die wunderbare Welt von Isotopp
	</a>
	<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
	</button>

	<div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
		
		
		<li class="nav-item ">
                    <a class="nav-link" href="/about/">
			
			<span>About</span>
			<span class="visually-hidden">(Current)</span>
		    </a>
		    
		</li>
            </ul>
            
	</div>
    </div>
</nav>


        <main role="main" class="container-fluid">

            


<div class="page">
    <article class="mysql-tracing-a-single-query-with-performance_schema-page">
	<h1 class="title">
            MySQL: Tracing a single query with PERFORMANCE_SCHEMA
	</h1>

	<p>My task is to collect performance data about a single query, using <code>PERFORMANCE_SCHEMA</code> (P_S for short) in MySQL, to ship it elsewhere for integration with other data.</p>
<p>In a grander scheme of things, I will need to define what performance data from a query I am actually interested in.
I will also need to find a way to attribute the query (as seen on the server) to a point in the codebase of the client, which is not always easy when an ORM or other SQL generator is being used.
And finally I will need to find a way to view the query execution in the context of the client code execution, because the data access is only a part of the system performance.</p>
<p>But this is about query execution in the server, and the instrumentation available to me in MySQL 8, at least to get things started.
So we take the tour of performance schema, and then run one example query (a simple join) and see what we can find out about this query.</p>
<h1 id="performance-schema-the-10000m-view">
    <a href="#performance-schema-the-10000m-view">
	Performance Schema, the 10.000m view
    </a>
</h1>
<p><a href="https://dev.mysql.com/doc/refman/8.0/en/performance-schema.html" target="_blank" rel="noopener">The Manual</a>

 has a major chapter that covers P_S in details.
The original idea of P_S is to have a bunch of preallocated memory areas without locks, presented to the database itself as tables.</p>
<p>P_S is unusual in the way that P_S &ldquo;tables&rdquo; are never locked while you work with them.
That means the values in a &ldquo;table&rdquo; can change while you read them.
That is important - if you for example calculate percentages, they may not add up to 100%.
If you <code>ORDER BY</code>, the sort may or may not be stable.</p>
<p>These are good properties: P_S will not freeze the server, and you won&rsquo;t kill the server by working with P_S tables.</p>
<p>It is a good idea to make a copy of P_S tables while you work with them, by turning off subquery merging with <code>select /*+ NO_MERGE(t) */ </code>, and then materializing P_S tables in subqueries.</p>
<p>Originally, P_S also had no secondary indexes, so joining P_S tables against other P_S tables did not work efficiently.
That was probably a good idea, because joining against a table that is changing while you execute the join is probably generating random results anyway.
But because it is so common, and because MySQL itself does this now internally in <code>sys.*</code>, secondary indexes to join efficiently now exist.
That does not make the joins more correct, but at least you get the result faster.</p>
<p>I wrote about all this [in an earlier article]({% link _posts/2020-12-01-not-joining-on-performance-schema.md %}).</p>
<h2 id="instruments-objects-actors-threads-and-consumers">
    <a href="#instruments-objects-actors-threads-and-consumers">
	Instruments, Objects, Actors, Threads and Consumers
    </a>
</h2>
<p>The data P_S collects is centered around three major things:</p>
<ul>
<li>Time consumed. In database servers, that is mostly wait time - waiting on I/O or locks.</li>
<li>Data transferred. In database servers, that is mostly pages read or written. In a way, this related to I/O wait.</li>
<li>Memory used. In database servers, that is buffers allocated - how large, and how often, and peak usage.</li>
</ul>
<p>P_S collects this in the form of &ldquo;events&rdquo; (and takes care to note that P_S events are not binlog events or other any events).
The collection points are in the database server code, which is instrumented, so the collectors are <em>instruments</em>.</p>
<p>The thing that the server code works on may be of a certain kind, for example a table or another <em>object</em> in the server, but have a variable identity (that would be different tables, with different names).
Instruments can be filtered by using object names.</p>
<p>The activity done in the server is done on behalf of a database user, in the form of <em>user@host</em> or, new in MySQL 8, using roles.
The entity on which behalf the server is working on is called the <em>actor</em>.</p>
<p>The activity done in the server is also done in the context of a <em>thread</em>, some of which are background threads, while the majority in a busy server are usually connection threads.</p>
<p>And finally, the data collected is put into the in-memory tables of P_S.
These come in various groups, and are called <em>consumers</em>.</p>
<p><p class="md__image">
  <img src="/uploads/2021/09/performance_schema_filtering.png" alt=""  />
</p>

</p>
<p><em>Data is collected from objects using instruments. Instruments can be turned on and off. Their collected data is then filtered by Objects, Actors and Threads, and finally dropped into consumers. Many consumers are aggregates, some collect information specific to one query execution.</em></p>
<p>For each of these things there is a <code>setup_...</code> table that controls how event data is collected by the instrumentation, filtered and the consumed in result tables.
In parallel, object identities are collected in <code>..._instances</code> tables, which are needed to resolve object identities.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql [localhost:<span style="color:#ae81ff">8025</span>] <span style="color:#960050;background-color:#1e0010">{</span>msandbox<span style="color:#960050;background-color:#1e0010">}</span> (performance_schema) <span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> tables <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#34;setup_%&#34;</span>;
<span style="color:#f92672">+</span><span style="color:#75715e">----------------------------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> Tables_in_performance_schema (setup_<span style="color:#f92672">%</span>) <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----------------------------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> setup_actors                           <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> setup_consumers                        <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> setup_instruments                      <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> setup_objects                          <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> setup_threads                          <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----------------------------------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">5</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

mysql [localhost:<span style="color:#ae81ff">8025</span>] <span style="color:#960050;background-color:#1e0010">{</span>msandbox<span style="color:#960050;background-color:#1e0010">}</span> (performance_schema) <span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> tables <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#34;%_instances&#34;</span>;
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------------------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> Tables_in_performance_schema (<span style="color:#f92672">%</span>_instances) <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------------------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> cond_instances                             <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> file_instances                             <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> mutex_instances                            <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> prepared_statements_instances              <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> rwlock_instances                           <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> socket_instances                           <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------------------------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">6</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

mysql [localhost:<span style="color:#ae81ff">8025</span>] <span style="color:#960050;background-color:#1e0010">{</span>msandbox<span style="color:#960050;background-color:#1e0010">}</span> (performance_schema) <span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> socket_instances;
<span style="color:#f92672">+</span><span style="color:#75715e">----------------------------------------+-----------------------+-----------+-----------+-----------+-------+--------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> EVENT_NAME                             <span style="color:#f92672">|</span> OBJECT_INSTANCE_BEGIN <span style="color:#f92672">|</span> THREAD_ID <span style="color:#f92672">|</span> SOCKET_ID <span style="color:#f92672">|</span> IP        <span style="color:#f92672">|</span> PORT  <span style="color:#f92672">|</span> <span style="color:#66d9ef">STATE</span>  <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----------------------------------------+-----------------------+-----------+-----------+-----------+-------+--------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> wait<span style="color:#f92672">/</span>io<span style="color:#f92672">/</span>socket<span style="color:#f92672">/</span>mysqlx<span style="color:#f92672">/</span>tcpip_socket     <span style="color:#f92672">|</span>             <span style="color:#ae81ff">106328376</span> <span style="color:#f92672">|</span>        <span style="color:#ae81ff">44</span> <span style="color:#f92672">|</span>        <span style="color:#ae81ff">21</span> <span style="color:#f92672">|</span> ::        <span style="color:#f92672">|</span> <span style="color:#ae81ff">18025</span> <span style="color:#f92672">|</span> ACTIVE <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> wait<span style="color:#f92672">/</span>io<span style="color:#f92672">/</span>socket<span style="color:#f92672">/</span>mysqlx<span style="color:#f92672">/</span>unix_socket      <span style="color:#f92672">|</span>             <span style="color:#ae81ff">106328688</span> <span style="color:#f92672">|</span>        <span style="color:#ae81ff">44</span> <span style="color:#f92672">|</span>        <span style="color:#ae81ff">22</span> <span style="color:#f92672">|</span>           <span style="color:#f92672">|</span>     <span style="color:#ae81ff">0</span> <span style="color:#f92672">|</span> ACTIVE <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> wait<span style="color:#f92672">/</span>io<span style="color:#f92672">/</span>socket<span style="color:#f92672">/</span><span style="color:#66d9ef">sql</span><span style="color:#f92672">/</span>server_tcpip_socket <span style="color:#f92672">|</span>             <span style="color:#ae81ff">106329000</span> <span style="color:#f92672">|</span>         <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>        <span style="color:#ae81ff">26</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">127</span>.<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">8025</span> <span style="color:#f92672">|</span> ACTIVE <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> wait<span style="color:#f92672">/</span>io<span style="color:#f92672">/</span>socket<span style="color:#f92672">/</span><span style="color:#66d9ef">sql</span><span style="color:#f92672">/</span>server_unix_socket  <span style="color:#f92672">|</span>             <span style="color:#ae81ff">106329312</span> <span style="color:#f92672">|</span>         <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>        <span style="color:#ae81ff">28</span> <span style="color:#f92672">|</span>           <span style="color:#f92672">|</span>     <span style="color:#ae81ff">0</span> <span style="color:#f92672">|</span> ACTIVE <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> wait<span style="color:#f92672">/</span>io<span style="color:#f92672">/</span>socket<span style="color:#f92672">/</span><span style="color:#66d9ef">sql</span><span style="color:#f92672">/</span>client_connection   <span style="color:#f92672">|</span>             <span style="color:#ae81ff">106330560</span> <span style="color:#f92672">|</span>        <span style="color:#ae81ff">50</span> <span style="color:#f92672">|</span>        <span style="color:#ae81ff">41</span> <span style="color:#f92672">|</span>           <span style="color:#f92672">|</span>     <span style="color:#ae81ff">0</span> <span style="color:#f92672">|</span> ACTIVE <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----------------------------------------+-----------------------+-----------+-----------+-----------+-------+--------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">5</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><h2 id="current-history-and-history-long-tables-vs-summaries">
    <a href="#current-history-and-history-long-tables-vs-summaries">
	Current, History and History Long Tables vs. Summaries
    </a>
</h2>
<p>P_S collects data in a lot of summary table, which should not interest us that much here.
Our task is to look at the performance data of a single, individual query to better understand what happened when it ran.</p>
<p>These unaggregated tables are <code>events_transactions</code>, <code>events_statements</code>, <code>events_stages</code> and <code>events_waits</code>.
For each of them, we have  <code>_current</code>, <code>_history</code> or <code>_history_long</code> tables.</p>
<p>The <code>_current</code> tables contain one entry for the currently running thread.
The <code>_history</code> tables contain a configurable number of entries for each thread, for example 10 per thread.
And the <code>_history_long</code> tables contain a configurable number of entries, shared across all threads, for example 10.000 in total.
As the server continues to execute statements and produce events, old entries are discarded and new entries are added, automatically.
Additionally, each query execution is aggregated along several dimensions in summary tables.
Summary tables state these dimension(s) using <code>by_&lt;dimensionname&gt;</code>, for example <code>_by_user_by_eventname</code> or similar.</p>
<p>In current MySQL, P_S is enabled by default.
But not all instruments and consumers are enabled, because some instrumentation slows query execution down, and some consumers can use a lot of memory.
To be fast and safe, all memory is statically allocated at config change so the memory resource usage of P_S is constant and no allocations are made during execution.</p>
<p>We can enable all instrumentation completely with this SQL:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql [localhost:<span style="color:#ae81ff">8025</span>] <span style="color:#960050;background-color:#1e0010">{</span>msandbox<span style="color:#960050;background-color:#1e0010">}</span> (performance_schema) <span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">UPDATE</span> 
 <span style="color:#f92672">-&gt;</span> performance_schema.setup_instruments <span style="color:#66d9ef">SET</span> ENABLED <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;YES&#39;</span>, TIMED <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;YES&#39;</span>;
Query OK, <span style="color:#ae81ff">494</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
<span style="color:#66d9ef">Rows</span> matched: <span style="color:#ae81ff">1216</span>  Changed: <span style="color:#ae81ff">494</span>  Warnings: <span style="color:#ae81ff">0</span>

mysql [localhost:<span style="color:#ae81ff">8025</span>] <span style="color:#960050;background-color:#1e0010">{</span>msandbox<span style="color:#960050;background-color:#1e0010">}</span> (performance_schema) <span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">UPDATE</span> 
 <span style="color:#f92672">-&gt;</span> performance_schema.setup_consumers <span style="color:#66d9ef">SET</span> ENABLED <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;YES&#39;</span>;
Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
<span style="color:#66d9ef">Rows</span> matched: <span style="color:#ae81ff">15</span>  Changed: <span style="color:#ae81ff">0</span>  Warnings: <span style="color:#ae81ff">0</span>
</code></pre></div><p>When we look at one of these tables, for example <code>events_statements_current</code>, we see a structure like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql [localhost:<span style="color:#ae81ff">8025</span>] <span style="color:#960050;background-color:#1e0010">{</span>msandbox<span style="color:#960050;background-color:#1e0010">}</span> (performance_schema) <span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> events_statements_current<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
<span style="color:#f92672">***************************</span> <span style="color:#ae81ff">1</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">***************************</span>
       <span style="color:#66d9ef">Table</span>: events_statements_current
<span style="color:#66d9ef">Create</span> <span style="color:#66d9ef">Table</span>: <span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#f92672">`</span>events_statements_current<span style="color:#f92672">`</span> (
  <span style="color:#f92672">`</span>THREAD_ID<span style="color:#f92672">`</span> bigint unsigned <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>EVENT_ID<span style="color:#f92672">`</span> bigint unsigned <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>END_EVENT_ID<span style="color:#f92672">`</span> bigint unsigned <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>EVENT_NAME<span style="color:#f92672">`</span> varchar(<span style="color:#ae81ff">128</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span><span style="color:#66d9ef">SOURCE</span><span style="color:#f92672">`</span> varchar(<span style="color:#ae81ff">64</span>) <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>TIMER_START<span style="color:#f92672">`</span> bigint unsigned <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>TIMER_END<span style="color:#f92672">`</span> bigint unsigned <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>TIMER_WAIT<span style="color:#f92672">`</span> bigint unsigned <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">NULL</span>,
...
  <span style="color:#f92672">`</span>NESTING_EVENT_ID<span style="color:#f92672">`</span> bigint unsigned <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>NESTING_EVENT_TYPE<span style="color:#f92672">`</span> enum(<span style="color:#e6db74">&#39;TRANSACTION&#39;</span>,<span style="color:#e6db74">&#39;STATEMENT&#39;</span>,<span style="color:#e6db74">&#39;STAGE&#39;</span>,<span style="color:#e6db74">&#39;WAIT&#39;</span>) <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>NESTING_EVENT_LEVEL<span style="color:#f92672">`</span> int <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>STATEMENT_ID<span style="color:#f92672">`</span> bigint unsigned <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span> (<span style="color:#f92672">`</span>THREAD_ID<span style="color:#f92672">`</span>,<span style="color:#f92672">`</span>EVENT_ID<span style="color:#f92672">`</span>)
) ENGINE<span style="color:#f92672">=</span>PERFORMANCE_SCHEMA <span style="color:#66d9ef">DEFAULT</span> CHARSET<span style="color:#f92672">=</span>utf8mb4 <span style="color:#66d9ef">COLLATE</span><span style="color:#f92672">=</span>utf8mb4_0900_ai_ci
<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>That is, events are tagged with a <code>THREAD_ID</code> (which is not a CONNECTION_ID() as seen in processlist), an <code>EVENT_ID/END_EVENT_ID</code> bracket, various source and timer values and for further dissection, a <code>NESTING_EVENT_ID</code> and <code>_TYPE</code>.</p>
<p>We can translate processlist ids into thread ids using the <code>P_S.THREADS</code> table, and then use this to limit our view on the <code>events_statements_current</code> table:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql [localhost:<span style="color:#ae81ff">8025</span>] <span style="color:#960050;background-color:#1e0010">{</span>msandbox<span style="color:#960050;background-color:#1e0010">}</span> (performance_schema) <span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> thread_id <span style="color:#66d9ef">from</span> threads 
 <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">where</span> processlist_id <span style="color:#f92672">=</span> connection_id();
<span style="color:#f92672">+</span><span style="color:#75715e">-----------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> thread_id <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">-----------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span>        <span style="color:#ae81ff">50</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">-----------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

mysql [localhost:<span style="color:#ae81ff">8025</span>] <span style="color:#960050;background-color:#1e0010">{</span>msandbox<span style="color:#960050;background-color:#1e0010">}</span> (performance_schema) <span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> 
 <span style="color:#f92672">-&gt;</span> thread_id, 
 <span style="color:#f92672">-&gt;</span> event_id, 
 <span style="color:#f92672">-&gt;</span> event_name, 
 <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">source</span>, 
 <span style="color:#f92672">-&gt;</span> sys.format_time(timer_wait), 
 <span style="color:#f92672">-&gt;</span> sql_text 
 <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">from</span> events_statements_current 
 <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">where</span> thread_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">50</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
<span style="color:#f92672">***************************</span> <span style="color:#ae81ff">1</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">***************************</span>
                  thread_id: <span style="color:#ae81ff">50</span>
                   event_id: <span style="color:#ae81ff">88463</span>
                 event_name: <span style="color:#66d9ef">statement</span><span style="color:#f92672">/</span><span style="color:#66d9ef">sql</span><span style="color:#f92672">/</span><span style="color:#66d9ef">select</span>
                     <span style="color:#66d9ef">source</span>: init_net_server_extension.cc:<span style="color:#ae81ff">94</span>
sys.format_time(timer_wait): <span style="color:#ae81ff">341</span>.<span style="color:#ae81ff">04</span> us
                   sql_text: <span style="color:#66d9ef">select</span> thread_id, event_id, event_name, <span style="color:#66d9ef">source</span>, sys.format_time(timer_wait), sql_text <span style="color:#66d9ef">from</span> events_statements_current <span style="color:#66d9ef">where</span> thread_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">50</span>
<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>So running this query took 341 Microsends, or 0.341 ms.
And sources are named after their location in the server sourcecode, <a href="https://github.com/mysql/mysql-server/blob/8.0/sql/conn_handler/init_net_server_extension.cc#L94-L96" target="_blank" rel="noopener">filename and line number</a>

.</p>
<p>Events exist in a hierarchy: wait events nest within stage events, which nest within statement events, which nest within transaction events.
Some nested events refer to their own type, for example, statement events can point to other statement events they are nested in.
Other events refer to their enclosing context in the hierarchy.
Nesting Event ID, Type and Level make this clear.</p>
<h2 id="instrument-names">
    <a href="#instrument-names">
	Instrument names
    </a>
</h2>
<p>The manual explains <a href="https://dev.mysql.com/doc/refman/8.0/en/performance-schema-instrument-naming.html" target="_blank" rel="noopener">Instrument Names</a>

.
They have path-like names that group instruments hierarchically, for example <code>wait/io/file/innodb/innodb_data_file</code>.
This is a <code>wait</code> event, <code>io</code> related, specifically <code>file</code> I/O, more specific <code>innodb</code> and even more specific <code>innodb_data_file</code>.
Looking at other fields in the <code>events_waits_history</code> table, we would see the file name as part of the <code>OBJECT_SCHEMA.OBJECT_NAME</code> designator for this event.
That means, we can see how long we waited for I/O coming from this specific file or going to the file.</p>
<p>Further up in the nesting we would at the statement level see the actual <code>SQL_TEXT</code>, and also the number of rows scanned.
That means we can get a rough estimate why this particular statement instance was slow - for example, the plan was good, the number of rows was low, but we see a lot of actual file IO waits, so probably the buffer pool was cold.</p>
<p>The manual page above discusses the instrument names at length and it is important to get an overview of what exists and what is measured.
Specifically, for statement level entries the instruments vary during query execution and become more detailed, as they reflect the progress in understanding of the server about the nature of the statement as it is executed.</p>
<h1 id="an-example-run">
    <a href="#an-example-run">
	An example run
    </a>
</h1>
<p>In a freshly restarted idle server, we login a shell and <code>use world</code> for the world sample database.
This is a tiny database, but because the server has been just restarted, nothing of it is cached.
We run a simple query:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql [localhost:<span style="color:#ae81ff">8025</span>] <span style="color:#960050;background-color:#1e0010">{</span>msandbox<span style="color:#960050;background-color:#1e0010">}</span> (world) <span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> 
 <span style="color:#f92672">-&gt;</span> co.continent, 
 <span style="color:#f92672">-&gt;</span> co.name <span style="color:#66d9ef">as</span> country, 
 <span style="color:#f92672">-&gt;</span> co.population <span style="color:#66d9ef">as</span> copop, 
 <span style="color:#f92672">-&gt;</span> ci.name <span style="color:#66d9ef">as</span> capital, 
 <span style="color:#f92672">-&gt;</span> ci.population <span style="color:#66d9ef">as</span> cipop 
 <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">from</span> country <span style="color:#66d9ef">as</span> co <span style="color:#66d9ef">join</span> city <span style="color:#66d9ef">as</span> ci
  <span style="color:#f92672">-&gt;</span>   <span style="color:#66d9ef">on</span> co.capital <span style="color:#f92672">=</span> ci.id 
  <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">where</span> continent <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Europe&#39;</span>;
<span style="color:#f92672">+</span><span style="color:#75715e">-----------+-------------------------------+-----------+------------------------------------+---------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> continent <span style="color:#f92672">|</span> country                       <span style="color:#f92672">|</span> copop     <span style="color:#f92672">|</span> capital                            <span style="color:#f92672">|</span> cipop   <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">-----------+-------------------------------+-----------+------------------------------------+---------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> Europe    <span style="color:#f92672">|</span> Albania                       <span style="color:#f92672">|</span>   <span style="color:#ae81ff">3401200</span> <span style="color:#f92672">|</span> Tirana                             <span style="color:#f92672">|</span>  <span style="color:#ae81ff">270000</span> <span style="color:#f92672">|</span>
...
<span style="color:#f92672">|</span> Europe    <span style="color:#f92672">|</span> Yugoslavia                    <span style="color:#f92672">|</span>  <span style="color:#ae81ff">10640000</span> <span style="color:#f92672">|</span> Beograd                            <span style="color:#f92672">|</span> <span style="color:#ae81ff">1204000</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">-----------+-------------------------------+-----------+------------------------------------+---------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">46</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>Now let&rsquo;s check what we can find out, using a second session:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql [localhost:<span style="color:#ae81ff">8025</span>] <span style="color:#960050;background-color:#1e0010">{</span>msandbox<span style="color:#960050;background-color:#1e0010">}</span> (performance_schema) <span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> threads 
 <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">where</span> processlist_db <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;world&#39;</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
<span style="color:#f92672">***************************</span> <span style="color:#ae81ff">1</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">***************************</span>
          THREAD_ID: <span style="color:#ae81ff">48</span>
               NAME: thread<span style="color:#f92672">/</span><span style="color:#66d9ef">sql</span><span style="color:#f92672">/</span>one_connection
               <span style="color:#66d9ef">TYPE</span>: FOREGROUND
     PROCESSLIST_ID: <span style="color:#ae81ff">9</span>
   PROCESSLIST_USER: msandbox
   PROCESSLIST_HOST: localhost
     PROCESSLIST_DB: world
PROCESSLIST_COMMAND: Sleep
   PROCESSLIST_TIME: <span style="color:#ae81ff">4</span>
  PROCESSLIST_STATE: <span style="color:#66d9ef">NULL</span>
   PROCESSLIST_INFO: <span style="color:#66d9ef">NULL</span>
   PARENT_THREAD_ID: <span style="color:#ae81ff">1</span>
               <span style="color:#66d9ef">ROLE</span>: <span style="color:#66d9ef">NULL</span>
       INSTRUMENTED: YES
            HISTORY: YES
    CONNECTION_TYPE: Socket
       THREAD_OS_ID: <span style="color:#ae81ff">346752</span>
     RESOURCE_GROUP: USR_default
<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>In our case we are only interested in the fact that our <code>thread/sql/one_connection</code> in the processlist is shown as connection <code>9</code>, but internally has a thread_id of <code>48</code>.
The Linux Operating System PID is <code>346752</code>.</p>
<p>We can use this to check <code>events_transactions_wait</code>, and find</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql [localhost:<span style="color:#ae81ff">8025</span>] <span style="color:#960050;background-color:#1e0010">{</span>msandbox<span style="color:#960050;background-color:#1e0010">}</span> (performance_schema) <span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> 
 <span style="color:#f92672">-&gt;</span> thread_id, 
 <span style="color:#f92672">-&gt;</span> event_id, 
 <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">state</span>, 
 <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">source</span>, 
 <span style="color:#f92672">-&gt;</span> sys.format_time(timer_wait) <span style="color:#66d9ef">as</span> timer, 
 <span style="color:#f92672">-&gt;</span> nesting_event_id, 
 <span style="color:#f92672">-&gt;</span> nesting_event_type 
 <span style="color:#f92672">-</span> <span style="color:#66d9ef">from</span> events_transactions_history 
 <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">where</span> thread_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">48</span>;
<span style="color:#f92672">+</span><span style="color:#75715e">-----------+----------+-----------+-----------------+-----------+------------------+--------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> thread_id <span style="color:#f92672">|</span> event_id <span style="color:#f92672">|</span> <span style="color:#66d9ef">state</span>     <span style="color:#f92672">|</span> <span style="color:#66d9ef">source</span>          <span style="color:#f92672">|</span> timer     <span style="color:#f92672">|</span> nesting_event_id <span style="color:#f92672">|</span> nesting_event_type <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">-----------+----------+-----------+-----------------+-----------+------------------+--------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span>        <span style="color:#ae81ff">48</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">179</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">COMMITTED</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">handler</span>.cc:<span style="color:#ae81ff">1328</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">496</span>.<span style="color:#ae81ff">05</span> us <span style="color:#f92672">|</span>               <span style="color:#ae81ff">85</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">STATEMENT</span>          <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>        <span style="color:#ae81ff">48</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">401</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">COMMITTED</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">handler</span>.cc:<span style="color:#ae81ff">1328</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">559</span>.<span style="color:#ae81ff">99</span> us <span style="color:#f92672">|</span>              <span style="color:#ae81ff">278</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">STATEMENT</span>          <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>        <span style="color:#ae81ff">48</span> <span style="color:#f92672">|</span>     <span style="color:#ae81ff">5606</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">COMMITTED</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">handler</span>.cc:<span style="color:#ae81ff">1328</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">3</span>.<span style="color:#ae81ff">03</span> ms   <span style="color:#f92672">|</span>             <span style="color:#ae81ff">5574</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">STATEMENT</span>          <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">-----------+----------+-----------+-----------------+-----------+------------------+--------------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">3</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>Why are there three statement events? We can check:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql [localhost:<span style="color:#ae81ff">8025</span>] <span style="color:#960050;background-color:#1e0010">{</span>msandbox<span style="color:#960050;background-color:#1e0010">}</span> (performance_schema) <span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> 
 <span style="color:#f92672">-&gt;</span> thread_id, 
 <span style="color:#f92672">-&gt;</span> event_id, 
 <span style="color:#f92672">-&gt;</span> sql_text 
 <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">from</span> events_statements_history 
 <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">where</span> thread_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">48</span> <span style="color:#66d9ef">and</span> event_id <span style="color:#66d9ef">in</span> (<span style="color:#ae81ff">85</span>, <span style="color:#ae81ff">278</span>, <span style="color:#ae81ff">5574</span>);
<span style="color:#f92672">+</span><span style="color:#75715e">-----------+----------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> thread_id <span style="color:#f92672">|</span> event_id <span style="color:#f92672">|</span> sql_text                                                                                                                                                                                        <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">-----------+----------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span>        <span style="color:#ae81ff">48</span> <span style="color:#f92672">|</span>       <span style="color:#ae81ff">85</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">show</span> databases                                                                                                                                                                                  <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>        <span style="color:#ae81ff">48</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">278</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">show</span> tables                                                                                                                                                                                     <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>        <span style="color:#ae81ff">48</span> <span style="color:#f92672">|</span>     <span style="color:#ae81ff">5574</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">select</span> co.continent, co.name <span style="color:#66d9ef">as</span> country, co.population <span style="color:#66d9ef">as</span> copop, ci.name <span style="color:#66d9ef">as</span> capital, ci.population <span style="color:#66d9ef">as</span> cipop <span style="color:#66d9ef">from</span> country <span style="color:#66d9ef">as</span> co <span style="color:#66d9ef">join</span> city <span style="color:#66d9ef">as</span> ci <span style="color:#66d9ef">on</span> co.capital <span style="color:#f92672">=</span> ci.id <span style="color:#66d9ef">where</span> continent <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Europe&#39;</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">-----------+----------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">3</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>The mysql command line client is running from the sandbox with <code>/home/kris/opt/mysql/8.0.25/bin/mysql --defaults-file=/home/kris/sandboxes/msb_8_0_25/my.sandbox.cnf world</code>.
Autocompletion for names is not disabled.
So on client startup, the client invisibly runs <code>show databases</code> to learn the names of all databases for autocompletion.
It then enters the <code>world</code> database as requested and runs <code>show tables</code> to learn the names of all tables in the <code>world</code> database.</p>
<p>Only then we come to the prompt and can paste our query.</p>
<p>We are only interested in <code>thread_id = 48 AND event_id = 5574</code>, our query.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql [localhost:<span style="color:#ae81ff">8025</span>] <span style="color:#960050;background-color:#1e0010">{</span>msandbox<span style="color:#960050;background-color:#1e0010">}</span> (performance_schema) <span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> 
 <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">from</span> events_statements_history 
 <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">where</span> thread_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">48</span> <span style="color:#66d9ef">AND</span> event_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">5574</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
<span style="color:#f92672">***************************</span> <span style="color:#ae81ff">1</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">***************************</span>
              THREAD_ID: <span style="color:#ae81ff">48</span>
               EVENT_ID: <span style="color:#ae81ff">5574</span>
           END_EVENT_ID: <span style="color:#ae81ff">6624</span>
             EVENT_NAME: <span style="color:#66d9ef">statement</span><span style="color:#f92672">/</span><span style="color:#66d9ef">sql</span><span style="color:#f92672">/</span><span style="color:#66d9ef">select</span>
                 <span style="color:#66d9ef">SOURCE</span>: init_net_server_extension.cc:<span style="color:#ae81ff">94</span>
            TIMER_START: <span style="color:#ae81ff">61628458852000</span>
              TIMER_END: <span style="color:#ae81ff">61631769329000</span>
             TIMER_WAIT: <span style="color:#ae81ff">3310477000</span>
              LOCK_TIME: <span style="color:#ae81ff">224000000</span>
               SQL_TEXT: <span style="color:#66d9ef">select</span> co.continent, co.name <span style="color:#66d9ef">as</span> country, co.population <span style="color:#66d9ef">as</span> copop, ci.name <span style="color:#66d9ef">as</span> capital, ci.population <span style="color:#66d9ef">as</span> cipop <span style="color:#66d9ef">from</span> country <span style="color:#66d9ef">as</span> co <span style="color:#66d9ef">join</span> city <span style="color:#66d9ef">as</span> ci <span style="color:#66d9ef">on</span> co.capital <span style="color:#f92672">=</span> ci.id <span style="color:#66d9ef">where</span> continent <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Europe&#39;</span>
                 DIGEST: <span style="color:#ae81ff">409</span>c336982f0d3d45c4b29da77fe83aed12c6043e8ce9771c11ec82ff347e647
            DIGEST_TEXT: <span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">`</span>co<span style="color:#f92672">`</span> . <span style="color:#f92672">`</span>continent<span style="color:#f92672">`</span> , <span style="color:#f92672">`</span>co<span style="color:#f92672">`</span> . <span style="color:#f92672">`</span>name<span style="color:#f92672">`</span> <span style="color:#66d9ef">AS</span> <span style="color:#f92672">`</span>country<span style="color:#f92672">`</span> , <span style="color:#f92672">`</span>co<span style="color:#f92672">`</span> . <span style="color:#f92672">`</span>population<span style="color:#f92672">`</span> <span style="color:#66d9ef">AS</span> <span style="color:#f92672">`</span>copop<span style="color:#f92672">`</span> , <span style="color:#f92672">`</span>ci<span style="color:#f92672">`</span> . <span style="color:#f92672">`</span>name<span style="color:#f92672">`</span> <span style="color:#66d9ef">AS</span> <span style="color:#f92672">`</span>capital<span style="color:#f92672">`</span> , <span style="color:#f92672">`</span>ci<span style="color:#f92672">`</span> . <span style="color:#f92672">`</span>population<span style="color:#f92672">`</span> <span style="color:#66d9ef">AS</span> <span style="color:#f92672">`</span>cipop<span style="color:#f92672">`</span> <span style="color:#66d9ef">FROM</span> <span style="color:#f92672">`</span>country<span style="color:#f92672">`</span> <span style="color:#66d9ef">AS</span> <span style="color:#f92672">`</span>co<span style="color:#f92672">`</span> <span style="color:#66d9ef">JOIN</span> <span style="color:#f92672">`</span>city<span style="color:#f92672">`</span> <span style="color:#66d9ef">AS</span> <span style="color:#f92672">`</span>ci<span style="color:#f92672">`</span> <span style="color:#66d9ef">ON</span> <span style="color:#f92672">`</span>co<span style="color:#f92672">`</span> . <span style="color:#f92672">`</span>capital<span style="color:#f92672">`</span> <span style="color:#f92672">=</span> <span style="color:#f92672">`</span>ci<span style="color:#f92672">`</span> . <span style="color:#f92672">`</span>id<span style="color:#f92672">`</span> <span style="color:#66d9ef">WHERE</span> <span style="color:#f92672">`</span>continent<span style="color:#f92672">`</span> <span style="color:#f92672">=</span> <span style="color:#f92672">?</span>
         CURRENT_SCHEMA: world
            OBJECT_TYPE: <span style="color:#66d9ef">NULL</span>
          OBJECT_SCHEMA: <span style="color:#66d9ef">NULL</span>
            OBJECT_NAME: <span style="color:#66d9ef">NULL</span>
  OBJECT_INSTANCE_BEGIN: <span style="color:#66d9ef">NULL</span>
            MYSQL_ERRNO: <span style="color:#ae81ff">0</span>
      <span style="color:#66d9ef">RETURNED_SQLSTATE</span>: <span style="color:#66d9ef">NULL</span>
           <span style="color:#66d9ef">MESSAGE_TEXT</span>: <span style="color:#66d9ef">NULL</span>
                 ERRORS: <span style="color:#ae81ff">0</span>
               WARNINGS: <span style="color:#ae81ff">0</span>
          ROWS_AFFECTED: <span style="color:#ae81ff">0</span>
              ROWS_SENT: <span style="color:#ae81ff">46</span>
          ROWS_EXAMINED: <span style="color:#ae81ff">92</span>
CREATED_TMP_DISK_TABLES: <span style="color:#ae81ff">0</span>
     CREATED_TMP_TABLES: <span style="color:#ae81ff">0</span>
       SELECT_FULL_JOIN: <span style="color:#ae81ff">0</span>
 SELECT_FULL_RANGE_JOIN: <span style="color:#ae81ff">0</span>
           SELECT_RANGE: <span style="color:#ae81ff">0</span>
     SELECT_RANGE_CHECK: <span style="color:#ae81ff">0</span>
            SELECT_SCAN: <span style="color:#ae81ff">0</span>
      SORT_MERGE_PASSES: <span style="color:#ae81ff">0</span>
             SORT_RANGE: <span style="color:#ae81ff">0</span>
              SORT_ROWS: <span style="color:#ae81ff">0</span>
              SORT_SCAN: <span style="color:#ae81ff">0</span>
          NO_INDEX_USED: <span style="color:#ae81ff">0</span>
     NO_GOOD_INDEX_USED: <span style="color:#ae81ff">0</span>
       NESTING_EVENT_ID: <span style="color:#66d9ef">NULL</span>
     NESTING_EVENT_TYPE: <span style="color:#66d9ef">NULL</span>
    NESTING_EVENT_LEVEL: <span style="color:#ae81ff">0</span>
           STATEMENT_ID: <span style="color:#ae81ff">125</span>
<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>The statement is <code>statement/sql/select</code>.
It took 3310477000 picoseconds (3.31ms) to run.
The <code>sql_text</code> is the full text of the statement (up to a cutoff point, in order to manage memory consumption).
The parsed statement is called <code>digest_text</code> - identifiers are quoted, whitespace is normalized, actual constants are replaced with placeholders, and (not shown here) variable length <code>WHERE ... IN (...)</code> clauses are shortened with ellipses.
This normalized digest is then hashed and produces an identifier for this group of identically formed statements, the <code>digest</code>.
We learn about the number of rows looked at, <code>92</code> and sent, <code>46</code>.
No special flags indicating specific execution modes were set.</p>
<p>We can use the <code>event_id</code> to look even deeper:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql [localhost:<span style="color:#ae81ff">8025</span>] <span style="color:#960050;background-color:#1e0010">{</span>msandbox<span style="color:#960050;background-color:#1e0010">}</span> (performance_schema) <span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> 
 <span style="color:#f92672">-&gt;</span> thread_id, 
 <span style="color:#f92672">-&gt;</span> event_id, 
 <span style="color:#f92672">-&gt;</span> event_name, 
 <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">source</span>, 
 <span style="color:#f92672">-&gt;</span> sys.format_time(timer_wait) <span style="color:#66d9ef">as</span> timer 
 <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">from</span> events_stages_history 
 <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">where</span> thread_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">48</span> 
 <span style="color:#f92672">-&gt;</span>   <span style="color:#66d9ef">and</span> nesting_event_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">5574</span> 
 <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> event_id;
<span style="color:#f92672">+</span><span style="color:#75715e">-----------+----------+--------------------------------------+----------------------+-----------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> thread_id <span style="color:#f92672">|</span> event_id <span style="color:#f92672">|</span> event_name                           <span style="color:#f92672">|</span> <span style="color:#66d9ef">source</span>               <span style="color:#f92672">|</span> timer     <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">-----------+----------+--------------------------------------+----------------------+-----------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span>        <span style="color:#ae81ff">48</span> <span style="color:#f92672">|</span>     <span style="color:#ae81ff">5610</span> <span style="color:#f92672">|</span> stage<span style="color:#f92672">/</span><span style="color:#66d9ef">sql</span><span style="color:#f92672">/</span>optimizing                 <span style="color:#f92672">|</span> sql_optimizer.cc:<span style="color:#ae81ff">270</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">15</span>.<span style="color:#ae81ff">88</span> us  <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>        <span style="color:#ae81ff">48</span> <span style="color:#f92672">|</span>     <span style="color:#ae81ff">5611</span> <span style="color:#f92672">|</span> stage<span style="color:#f92672">/</span><span style="color:#66d9ef">sql</span><span style="color:#f92672">/</span><span style="color:#66d9ef">statistics</span>                 <span style="color:#f92672">|</span> sql_optimizer.cc:<span style="color:#ae81ff">534</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">703</span>.<span style="color:#ae81ff">58</span> us <span style="color:#f92672">|</span> <span style="color:#f92672">&lt;-</span> <span style="color:#f92672">!!</span>
<span style="color:#f92672">|</span>        <span style="color:#ae81ff">48</span> <span style="color:#f92672">|</span>     <span style="color:#ae81ff">5710</span> <span style="color:#f92672">|</span> stage<span style="color:#f92672">/</span><span style="color:#66d9ef">sql</span><span style="color:#f92672">/</span>preparing                  <span style="color:#f92672">|</span> sql_optimizer.cc:<span style="color:#ae81ff">618</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">31</span>.<span style="color:#ae81ff">93</span> us  <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>        <span style="color:#ae81ff">48</span> <span style="color:#f92672">|</span>     <span style="color:#ae81ff">5712</span> <span style="color:#f92672">|</span> stage<span style="color:#f92672">/</span><span style="color:#66d9ef">sql</span><span style="color:#f92672">/</span>executing                  <span style="color:#f92672">|</span> sql_union.cc:<span style="color:#ae81ff">1126</span>    <span style="color:#f92672">|</span> <span style="color:#ae81ff">2</span>.<span style="color:#ae81ff">26</span> ms   <span style="color:#f92672">|</span> <span style="color:#f92672">&lt;-</span> <span style="color:#f92672">!!</span>
<span style="color:#f92672">|</span>        <span style="color:#ae81ff">48</span> <span style="color:#f92672">|</span>     <span style="color:#ae81ff">6593</span> <span style="color:#f92672">|</span> stage<span style="color:#f92672">/</span><span style="color:#66d9ef">sql</span><span style="color:#f92672">/</span><span style="color:#66d9ef">end</span>                        <span style="color:#f92672">|</span> sql_select.cc:<span style="color:#ae81ff">586</span>    <span style="color:#f92672">|</span> <span style="color:#ae81ff">1</span>.<span style="color:#ae81ff">86</span> us   <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>        <span style="color:#ae81ff">48</span> <span style="color:#f92672">|</span>     <span style="color:#ae81ff">6594</span> <span style="color:#f92672">|</span> stage<span style="color:#f92672">/</span><span style="color:#66d9ef">sql</span><span style="color:#f92672">/</span>query <span style="color:#66d9ef">end</span>                  <span style="color:#f92672">|</span> sql_parse.cc:<span style="color:#ae81ff">4542</span>    <span style="color:#f92672">|</span> <span style="color:#ae81ff">1</span>.<span style="color:#ae81ff">93</span> us   <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>        <span style="color:#ae81ff">48</span> <span style="color:#f92672">|</span>     <span style="color:#ae81ff">6596</span> <span style="color:#f92672">|</span> stage<span style="color:#f92672">/</span><span style="color:#66d9ef">sql</span><span style="color:#f92672">/</span>waiting <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">handler</span> <span style="color:#66d9ef">commit</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">handler</span>.cc:<span style="color:#ae81ff">1594</span>      <span style="color:#f92672">|</span> <span style="color:#ae81ff">9</span>.<span style="color:#ae81ff">05</span> us   <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>        <span style="color:#ae81ff">48</span> <span style="color:#f92672">|</span>     <span style="color:#ae81ff">6600</span> <span style="color:#f92672">|</span> stage<span style="color:#f92672">/</span><span style="color:#66d9ef">sql</span><span style="color:#f92672">/</span>closing tables             <span style="color:#f92672">|</span> sql_parse.cc:<span style="color:#ae81ff">4593</span>    <span style="color:#f92672">|</span> <span style="color:#ae81ff">14</span>.<span style="color:#ae81ff">02</span> us  <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>        <span style="color:#ae81ff">48</span> <span style="color:#f92672">|</span>     <span style="color:#ae81ff">6621</span> <span style="color:#f92672">|</span> stage<span style="color:#f92672">/</span><span style="color:#66d9ef">sql</span><span style="color:#f92672">/</span>freeing items              <span style="color:#f92672">|</span> sql_parse.cc:<span style="color:#ae81ff">5042</span>    <span style="color:#f92672">|</span> <span style="color:#ae81ff">29</span>.<span style="color:#ae81ff">4</span> us   <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>        <span style="color:#ae81ff">48</span> <span style="color:#f92672">|</span>     <span style="color:#ae81ff">6623</span> <span style="color:#f92672">|</span> stage<span style="color:#f92672">/</span><span style="color:#66d9ef">sql</span><span style="color:#f92672">/</span>cleaning up                <span style="color:#f92672">|</span> sql_parse.cc:<span style="color:#ae81ff">2252</span>    <span style="color:#f92672">|</span> <span style="color:#ae81ff">1</span>.<span style="color:#ae81ff">17</span> us   <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">-----------+----------+--------------------------------------+----------------------+-----------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">10</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>These are the various exection stages of our statement - we select by <code>thread_id</code> and with the <code>event_id</code> of the statement, <code>5574</code> as a <code>nesting_id</code>, ordered by <code>event_id</code>.
Time was consumed by the <code>stage/sql/statistics</code> phase, looking up table stats for a good execution plan, and then by the actual query execution in <code>stage/sql/executing</code>.
The former took 0.7ms (703.58us), the latter 2.26ms.</p>
<p>We are interested in what took so long, specifically, so we look into waits for event_ids 5611 and 5712 - finding nothing, and also nothing particularly time consuming:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql [localhost:<span style="color:#ae81ff">8025</span>] <span style="color:#960050;background-color:#1e0010">{</span>msandbox<span style="color:#960050;background-color:#1e0010">}</span> (performance_schema) <span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span>
 <span style="color:#f92672">-&gt;</span> thread_id, 
 <span style="color:#f92672">-&gt;</span> event_id, 
 <span style="color:#f92672">-&gt;</span> event_name, 
 <span style="color:#f92672">-&gt;</span> sys.format_time(timer_wait) <span style="color:#66d9ef">as</span> timer, 
 <span style="color:#f92672">-&gt;</span> nesting_event_type, 
 <span style="color:#f92672">-&gt;</span> nesting_event_id, 
 <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">operation</span> 
 <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">from</span> events_waits_history 
 <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">where</span> thread_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">48</span>
  <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> event_id;
<span style="color:#f92672">+</span><span style="color:#75715e">-----------+----------+------------------------------------------+-----------+--------------------+------------------+-----------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> thread_id <span style="color:#f92672">|</span> event_id <span style="color:#f92672">|</span> event_name                               <span style="color:#f92672">|</span> timer     <span style="color:#f92672">|</span> nesting_event_type <span style="color:#f92672">|</span> nesting_event_id <span style="color:#f92672">|</span> <span style="color:#66d9ef">operation</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">-----------+----------+------------------------------------------+-----------+--------------------+------------------+-----------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span>        <span style="color:#ae81ff">48</span> <span style="color:#f92672">|</span>     <span style="color:#ae81ff">6614</span> <span style="color:#f92672">|</span> wait<span style="color:#f92672">/</span>synch<span style="color:#f92672">/</span>mutex<span style="color:#f92672">/</span>innodb<span style="color:#f92672">/</span>trx_mutex        <span style="color:#f92672">|</span> <span style="color:#ae81ff">56</span>.<span style="color:#ae81ff">26</span> ns  <span style="color:#f92672">|</span> STAGE              <span style="color:#f92672">|</span>             <span style="color:#ae81ff">6600</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">lock</span>      <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>        <span style="color:#ae81ff">48</span> <span style="color:#f92672">|</span>     <span style="color:#ae81ff">6615</span> <span style="color:#f92672">|</span> wait<span style="color:#f92672">/</span>synch<span style="color:#f92672">/</span>mutex<span style="color:#f92672">/</span>innodb<span style="color:#f92672">/</span>trx_mutex        <span style="color:#f92672">|</span> <span style="color:#ae81ff">48</span>.<span style="color:#ae81ff">64</span> ns  <span style="color:#f92672">|</span> STAGE              <span style="color:#f92672">|</span>             <span style="color:#ae81ff">6600</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">lock</span>      <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>        <span style="color:#ae81ff">48</span> <span style="color:#f92672">|</span>     <span style="color:#ae81ff">6616</span> <span style="color:#f92672">|</span> wait<span style="color:#f92672">/</span>synch<span style="color:#f92672">/</span>mutex<span style="color:#f92672">/</span>innodb<span style="color:#f92672">/</span>trx_mutex        <span style="color:#f92672">|</span> <span style="color:#ae81ff">50</span>.<span style="color:#ae81ff">4</span> ns   <span style="color:#f92672">|</span> STAGE              <span style="color:#f92672">|</span>             <span style="color:#ae81ff">6600</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">lock</span>      <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>        <span style="color:#ae81ff">48</span> <span style="color:#f92672">|</span>     <span style="color:#ae81ff">6617</span> <span style="color:#f92672">|</span> wait<span style="color:#f92672">/</span>synch<span style="color:#f92672">/</span>mutex<span style="color:#f92672">/</span>innodb<span style="color:#f92672">/</span>trx_mutex        <span style="color:#f92672">|</span> <span style="color:#ae81ff">46</span>.<span style="color:#ae81ff">88</span> ns  <span style="color:#f92672">|</span> STAGE              <span style="color:#f92672">|</span>             <span style="color:#ae81ff">6600</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">lock</span>      <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>        <span style="color:#ae81ff">48</span> <span style="color:#f92672">|</span>     <span style="color:#ae81ff">6618</span> <span style="color:#f92672">|</span> wait<span style="color:#f92672">/</span>synch<span style="color:#f92672">/</span>mutex<span style="color:#f92672">/</span>innodb<span style="color:#f92672">/</span>trx_mutex        <span style="color:#f92672">|</span> <span style="color:#ae81ff">43</span>.<span style="color:#ae81ff">36</span> ns  <span style="color:#f92672">|</span> STAGE              <span style="color:#f92672">|</span>             <span style="color:#ae81ff">6600</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">lock</span>      <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>        <span style="color:#ae81ff">48</span> <span style="color:#f92672">|</span>     <span style="color:#ae81ff">6619</span> <span style="color:#f92672">|</span> wait<span style="color:#f92672">/</span>synch<span style="color:#f92672">/</span>mutex<span style="color:#f92672">/</span>innodb<span style="color:#f92672">/</span>trx_mutex        <span style="color:#f92672">|</span> <span style="color:#ae81ff">45</span>.<span style="color:#ae81ff">12</span> ns  <span style="color:#f92672">|</span> STAGE              <span style="color:#f92672">|</span>             <span style="color:#ae81ff">6600</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">lock</span>      <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>        <span style="color:#ae81ff">48</span> <span style="color:#f92672">|</span>     <span style="color:#ae81ff">6620</span> <span style="color:#f92672">|</span> wait<span style="color:#f92672">/</span>synch<span style="color:#f92672">/</span>mutex<span style="color:#f92672">/</span><span style="color:#66d9ef">sql</span><span style="color:#f92672">/</span>LOCK_table_cache    <span style="color:#f92672">|</span> <span style="color:#ae81ff">66</span>.<span style="color:#ae81ff">8</span> ns   <span style="color:#f92672">|</span> STAGE              <span style="color:#f92672">|</span>             <span style="color:#ae81ff">6600</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">lock</span>      <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>        <span style="color:#ae81ff">48</span> <span style="color:#f92672">|</span>     <span style="color:#ae81ff">6622</span> <span style="color:#f92672">|</span> wait<span style="color:#f92672">/</span>io<span style="color:#f92672">/</span>socket<span style="color:#f92672">/</span><span style="color:#66d9ef">sql</span><span style="color:#f92672">/</span>client_connection     <span style="color:#f92672">|</span> <span style="color:#ae81ff">18</span>.<span style="color:#ae81ff">91</span> us  <span style="color:#f92672">|</span> STAGE              <span style="color:#f92672">|</span>             <span style="color:#ae81ff">6621</span> <span style="color:#f92672">|</span> send      <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>        <span style="color:#ae81ff">48</span> <span style="color:#f92672">|</span>     <span style="color:#ae81ff">6624</span> <span style="color:#f92672">|</span> wait<span style="color:#f92672">/</span>synch<span style="color:#f92672">/</span>mutex<span style="color:#f92672">/</span><span style="color:#66d9ef">sql</span><span style="color:#f92672">/</span>THD::LOCK_thd_query <span style="color:#f92672">|</span> <span style="color:#ae81ff">124</span>.<span style="color:#ae81ff">23</span> ns <span style="color:#f92672">|</span> STAGE              <span style="color:#f92672">|</span>             <span style="color:#ae81ff">6623</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">lock</span>      <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>        <span style="color:#ae81ff">48</span> <span style="color:#f92672">|</span>     <span style="color:#ae81ff">6626</span> <span style="color:#f92672">|</span> wait<span style="color:#f92672">/</span>io<span style="color:#f92672">/</span>socket<span style="color:#f92672">/</span><span style="color:#66d9ef">sql</span><span style="color:#f92672">/</span>client_connection     <span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span>      <span style="color:#f92672">|</span> WAIT               <span style="color:#f92672">|</span>             <span style="color:#ae81ff">6625</span> <span style="color:#f92672">|</span> recv      <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">-----------+----------+------------------------------------------+-----------+--------------------+------------------+-----------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">10</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>We can see I/O in a global summary, and the timings make sense in the context of the experiment:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql [localhost:<span style="color:#ae81ff">8025</span>] <span style="color:#960050;background-color:#1e0010">{</span>msandbox<span style="color:#960050;background-color:#1e0010">}</span> (performance_schema) <span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span>
 <span style="color:#f92672">-&gt;</span> object_type, 
 <span style="color:#f92672">-&gt;</span> object_schema, 
 <span style="color:#f92672">-&gt;</span> object_name, 
 <span style="color:#f92672">-&gt;</span> count_star, 
 <span style="color:#f92672">-&gt;</span> sys.format_time(max_timer_read) <span style="color:#66d9ef">as</span> <span style="color:#f92672">`</span><span style="color:#66d9ef">read</span><span style="color:#f92672">`</span>, 
 <span style="color:#f92672">-&gt;</span> sys.format_time(max_timer_write) <span style="color:#66d9ef">as</span> <span style="color:#f92672">`</span><span style="color:#66d9ef">write</span><span style="color:#f92672">`</span>, 
 <span style="color:#f92672">-&gt;</span> sys.format_time(max_timer_fetch) <span style="color:#66d9ef">as</span> <span style="color:#f92672">`</span><span style="color:#66d9ef">fetch</span><span style="color:#f92672">`</span>
  <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">from</span> table_io_waits_summary_by_table 
  <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">where</span> object_schema <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;world&#39;</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
<span style="color:#f92672">***************************</span> <span style="color:#ae81ff">1</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">***************************</span>
  object_type: <span style="color:#66d9ef">TABLE</span>
object_schema: world
  object_name: city
   count_star: <span style="color:#ae81ff">46</span>
         <span style="color:#66d9ef">read</span>: <span style="color:#ae81ff">569</span>.<span style="color:#ae81ff">17</span> us
        <span style="color:#66d9ef">write</span>: <span style="color:#ae81ff">0</span> ps
        <span style="color:#66d9ef">fetch</span>: <span style="color:#ae81ff">569</span>.<span style="color:#ae81ff">17</span> us
<span style="color:#f92672">***************************</span> <span style="color:#ae81ff">2</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">***************************</span>
  object_type: <span style="color:#66d9ef">TABLE</span>
object_schema: world
  object_name: country
   count_star: <span style="color:#ae81ff">47</span>
         <span style="color:#66d9ef">read</span>: <span style="color:#ae81ff">703</span>.<span style="color:#ae81ff">4</span> us
        <span style="color:#66d9ef">write</span>: <span style="color:#ae81ff">0</span> ps
        <span style="color:#66d9ef">fetch</span>: <span style="color:#ae81ff">703</span>.<span style="color:#ae81ff">4</span> us
...
</code></pre></div><p>But why are the I/O times not visible to us?
That&rsquo;s a bit unclear.
My theory was that the reads happen asynchronously by some background thread.
But a quick query shows no time spend on reader threads.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql [localhost:<span style="color:#ae81ff">8025</span>] <span style="color:#960050;background-color:#1e0010">{</span>msandbox<span style="color:#960050;background-color:#1e0010">}</span> (performance_schema) <span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> 
 <span style="color:#f92672">-&gt;</span> t.thread_id, 
 <span style="color:#f92672">-&gt;</span> t.name, 
 <span style="color:#f92672">-&gt;</span> t.<span style="color:#66d9ef">type</span> 
 <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">from</span> threads <span style="color:#66d9ef">as</span> t <span style="color:#66d9ef">join</span> events_waits_summary_by_thread_by_event_name <span style="color:#66d9ef">as</span> e 
 <span style="color:#f92672">-&gt;</span>    <span style="color:#66d9ef">on</span> t.thread_id <span style="color:#f92672">=</span> e.thread_id  
 <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">where</span> e.max_timer_wait <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> 
 <span style="color:#f92672">-&gt;</span>    <span style="color:#66d9ef">and</span> e.event_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;wait/io/file/innodb/innodb_data_file&#39;</span>;
<span style="color:#f92672">+</span><span style="color:#75715e">-----------+---------------------------------------------+------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> thread_id <span style="color:#f92672">|</span> name                                        <span style="color:#f92672">|</span> <span style="color:#66d9ef">type</span>       <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">-----------+---------------------------------------------+------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span>         <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span> thread<span style="color:#f92672">/</span><span style="color:#66d9ef">sql</span><span style="color:#f92672">/</span>main                             <span style="color:#f92672">|</span> BACKGROUND <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>         <span style="color:#ae81ff">9</span> <span style="color:#f92672">|</span> thread<span style="color:#f92672">/</span>innodb<span style="color:#f92672">/</span>io_write_thread               <span style="color:#f92672">|</span> BACKGROUND <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>        <span style="color:#ae81ff">10</span> <span style="color:#f92672">|</span> thread<span style="color:#f92672">/</span>innodb<span style="color:#f92672">/</span>io_write_thread               <span style="color:#f92672">|</span> BACKGROUND <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>        <span style="color:#ae81ff">11</span> <span style="color:#f92672">|</span> thread<span style="color:#f92672">/</span>innodb<span style="color:#f92672">/</span>io_write_thread               <span style="color:#f92672">|</span> BACKGROUND <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>        <span style="color:#ae81ff">12</span> <span style="color:#f92672">|</span> thread<span style="color:#f92672">/</span>innodb<span style="color:#f92672">/</span>io_write_thread               <span style="color:#f92672">|</span> BACKGROUND <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>        <span style="color:#ae81ff">13</span> <span style="color:#f92672">|</span> thread<span style="color:#f92672">/</span>innodb<span style="color:#f92672">/</span>page_flush_coordinator_thread <span style="color:#f92672">|</span> BACKGROUND <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>        <span style="color:#ae81ff">33</span> <span style="color:#f92672">|</span> thread<span style="color:#f92672">/</span>innodb<span style="color:#f92672">/</span>clone_gtid_thread             <span style="color:#f92672">|</span> BACKGROUND <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>        <span style="color:#ae81ff">47</span> <span style="color:#f92672">|</span> thread<span style="color:#f92672">/</span><span style="color:#66d9ef">sql</span><span style="color:#f92672">/</span>one_connection                   <span style="color:#f92672">|</span> FOREGROUND <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>        <span style="color:#ae81ff">48</span> <span style="color:#f92672">|</span> thread<span style="color:#f92672">/</span><span style="color:#66d9ef">sql</span><span style="color:#f92672">/</span>one_connection                   <span style="color:#f92672">|</span> FOREGROUND <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">-----------+---------------------------------------------+------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">9</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>We seem to be unable to attribute time spent loading data from disk to a specific thread, and we seem to unable to account for the runtime of certain stages by looking at waits.
That&rsquo;s unexpected.</p>
<h1 id="memory-only-as-summary">
    <a href="#memory-only-as-summary">
	Memory only as summary
    </a>
</h1>
<p>Diverse <code>memory_%</code> tables exist to track memory usage in the server.
All of these tables are summary tables, there are no memory events tables that could trace memory usage per query.
That might be okay.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql [localhost:<span style="color:#ae81ff">8025</span>] <span style="color:#960050;background-color:#1e0010">{</span>msandbox<span style="color:#960050;background-color:#1e0010">}</span> (performance_schema) <span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> tables <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;%memory%&#39;</span>;
<span style="color:#f92672">+</span><span style="color:#75715e">-----------------------------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> Tables_in_performance_schema (<span style="color:#f92672">%</span>memory<span style="color:#f92672">%</span>) <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">-----------------------------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> memory_summary_by_account_by_event_name <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> memory_summary_by_host_by_event_name    <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> memory_summary_by_thread_by_event_name  <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> memory_summary_by_user_by_event_name    <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> memory_summary_global_by_event_name     <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">-----------------------------------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">5</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>We can do interesting things with stuff such as <code>memory_summary_by_thread_by_event_name</code>, at least on our mostly idle server.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql [localhost:<span style="color:#ae81ff">8025</span>] <span style="color:#960050;background-color:#1e0010">{</span>msandbox<span style="color:#960050;background-color:#1e0010">}</span> (performance_schema) <span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> 
 <span style="color:#f92672">-&gt;</span> thread_id, 
 <span style="color:#f92672">-&gt;</span> event_name, 
 <span style="color:#f92672">-&gt;</span> count_alloc, 
 <span style="color:#f92672">-&gt;</span> sum_number_of_bytes_alloc, 
 <span style="color:#f92672">-&gt;</span> high_number_of_bytes_used 
 <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">from</span> memory_summary_by_thread_by_event_name 
 <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">where</span> thread_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">48</span> 
 <span style="color:#f92672">-&gt;</span>   <span style="color:#66d9ef">and</span> HIGH_NUMBER_OF_BYTES_USED <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> 
 <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> HIGH_NUMBER_OF_BYTES_USED <span style="color:#66d9ef">desc</span> <span style="color:#66d9ef">limit</span> <span style="color:#ae81ff">5</span>;
<span style="color:#f92672">+</span><span style="color:#75715e">-----------+-------------------------------+-------------+---------------------------+---------------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> thread_id <span style="color:#f92672">|</span> event_name                    <span style="color:#f92672">|</span> count_alloc <span style="color:#f92672">|</span> sum_number_of_bytes_alloc <span style="color:#f92672">|</span> high_number_of_bytes_used <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">-----------+-------------------------------+-------------+---------------------------+---------------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span>        <span style="color:#ae81ff">48</span> <span style="color:#f92672">|</span> memory<span style="color:#f92672">/</span><span style="color:#66d9ef">sql</span><span style="color:#f92672">/</span>THD::main_mem_root <span style="color:#f92672">|</span>          <span style="color:#ae81ff">22</span> <span style="color:#f92672">|</span>                   <span style="color:#ae81ff">1181008</span> <span style="color:#f92672">|</span>                    <span style="color:#ae81ff">613544</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>        <span style="color:#ae81ff">48</span> <span style="color:#f92672">|</span> memory<span style="color:#f92672">/</span>innodb<span style="color:#f92672">/</span>memory          <span style="color:#f92672">|</span>         <span style="color:#ae81ff">226</span> <span style="color:#f92672">|</span>                   <span style="color:#ae81ff">1059368</span> <span style="color:#f92672">|</span>                    <span style="color:#ae81ff">250032</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>        <span style="color:#ae81ff">48</span> <span style="color:#f92672">|</span> memory<span style="color:#f92672">/</span><span style="color:#66d9ef">sql</span><span style="color:#f92672">/</span>dd::objects        <span style="color:#f92672">|</span>         <span style="color:#ae81ff">205</span> <span style="color:#f92672">|</span>                     <span style="color:#ae81ff">47432</span> <span style="color:#f92672">|</span>                     <span style="color:#ae81ff">44648</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>        <span style="color:#ae81ff">48</span> <span style="color:#f92672">|</span> memory<span style="color:#f92672">/</span>innodb<span style="color:#f92672">/</span>ha_innodb       <span style="color:#f92672">|</span>          <span style="color:#ae81ff">26</span> <span style="color:#f92672">|</span>                     <span style="color:#ae81ff">35784</span> <span style="color:#f92672">|</span>                     <span style="color:#ae81ff">35784</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>        <span style="color:#ae81ff">48</span> <span style="color:#f92672">|</span> memory<span style="color:#f92672">/</span>innodb<span style="color:#f92672">/</span>fil0fil         <span style="color:#f92672">|</span>           <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>                     <span style="color:#ae81ff">65600</span> <span style="color:#f92672">|</span>                     <span style="color:#ae81ff">32800</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">-----------+-------------------------------+-------------+---------------------------+---------------------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">5</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><h1 id="no-explain">
    <a href="#no-explain">
	No EXPLAIN
    </a>
</h1>
<p>Another thing that would be useful to collect from P_S is the actual execution plan of a query.
But while we can explain a lot of statements by running <code>EXPLAIN &lt;stmt&gt;</code>, and while we can <code>EXPLAIN FOR CONNECT ...</code>, the former is not the recorded execution plan, and the latter only works while the query is running.
It&rsquo;s the actual execution plan while the query executes, but it is not recorded.</p>
<h1 id="summary">
    <a href="#summary">
	Summary
    </a>
</h1>
<p>A lot of information about query execution can be gathered from P_S.
The query execution can be broken down in statements, stages and waits.
Specifically, statements collect a lot of interesting quality flags.
Stages can collect percentages of completion for long running queries and give a general feel about where in the query execution time is spent.
Waits should be able to attribute time to individual operations in the database server, but specifically for file I/O this seems to be more complicated, and I have not been able to solve it.</p>
<p>We can see waits for I/O summary tables, and we can see a lot of other statistical information in other summary tables.
We can also use additional tables not covered here for debugging (for example <code>DATA_LOCKS</code> for locking behavior).</p>
<p>Memory instrumentation is interesting, but at this stage it is unclear to me if it is sufficient.</p>
<p>It seems to be really hard to record execution plans together with statements.</p>
<p>More experimentation with more complicated queries is necessary to see if it is possible to see things like sorting, temp files and similar operations, and attribute time to these operations.</p>
<p>The number of queries on P_S necessary to extract information about a single query is staggering, a 10:1 ratio.
At least filters exist and are on by default, so that I do not have to hear my monitoring noise in my monitoring.
That is good.</p>
<p>I could really use a single large JSON blob containing the entire package with performance data for a query, at once - one query to trace one query.
That is, the information from transaction, statement, stages, waits, the execution plan and the memory consumption for a given transaction or statement, in one go.</p>


	
    </article>
</div>



            <footer>
    <p>
	&copy; Copyright 2021 Someone or something
    </p>
</footer>


        </main>

	





<script src="/js/bootstrap.js"></script>




<script src="/js/lunr.js"></script>





<script src="/js/app.js"></script>


    </body>
</html>
