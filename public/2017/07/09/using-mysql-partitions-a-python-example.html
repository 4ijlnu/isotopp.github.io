<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Die wunderbare Welt von Isotopp - Using MySQL Partitions (a Python example)</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="site.webmanifest">
<link rel="apple-touch-icon" href="icon.png">
<link rel="favicon.ico" rel="icon" type="image/ico">





	



<link rel="stylesheet" href="/style.min.c5e5cd61f54911f9aafd1dbe09c2f90667957bfe1002126c87aace57759f3446.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
	<a class="navbar-brand" href="" rel="home" title=".Site.Title">
	    Die wunderbare Welt von Isotopp
	</a>
	<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
	</button>

	<div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
		
		
		<li class="nav-item ">
                    <a class="nav-link" href="/about/">
			
			<span>About</span>
			<span class="visually-hidden">(Current)</span>
		    </a>
		    
		</li>
            </ul>
            
	</div>
    </div>
</nav>


        <main role="main" class="container-fluid">

            


<div class="page">
    <article class="using-mysql-partitions-a-python-example-page">
	<h1 class="title">
            Using MySQL Partitions (a Python example)
	</h1>

	<p>Today somebody had a problem with expiring a large table (a Serendipity
Blog table).</p>
<p>In MySQL InnoDB, tables are physically ordered by primary key (InnoDB data
is a B+ tree, a balanced tree where the data pages are the leaves of the
tree). If you are expiring old data from such a log table, you are deleting
from the left hand side of the tree, and since it is a balanced tree, that
triggers a lot of rebalancing - hence it is very slow.</p>
<p>If you rename the old table and INSERT â€¦ SELECT the data you want to keep
back into the original table, that can be faster.</p>
<p>But if the data you want to keep is larger than memory, the indexing of the
data will still be slow. A nice way to handle log tables are partitions.
Here is an example. It&rsquo;s not very cleaned up, but it works on my system.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#! /usr/bin/env python --</span>

<span style="color:#75715e"># setting up the python environment:</span>

<span style="color:#75715e"># pip install virtualenv</span>
<span style="color:#75715e"># virtualenv partitions</span>
<span style="color:#75715e"># cd partitions</span>
<span style="color:#75715e"># source bin/activate</span>
<span style="color:#75715e"># pip install --update pip</span>
<span style="color:#75715e"># pip install mysqlclient click</span>

<span style="color:#75715e"># setting up the MySQL:</span>
<span style="color:#75715e"># create user demo@localhost identified by &#34;pfrtlng&#34;;</span>
<span style="color:#75715e"># grant all on demo.* to demo@localhost;</span>

<span style="color:#75715e"># Testing:</span>
<span style="color:#75715e"># ./partitions drop --name keks</span>
<span style="color:#75715e"># ./partitions create --name keks</span>
<span style="color:#75715e"># ./partitions fill --name keks</span>
<span style="color:#75715e"># mysql -u demo -ppfrtlng demo -e &#39;select * from information_schema.partitions where table_name = &#34;keks&#34;&#39;</span>

<span style="color:#75715e"># ./partitions add --name keks</span>
<span style="color:#75715e"># mysql -u demo -ppfrtlng demo -e &#39;select * from information_schema.partitions where table_name = &#34;keks&#34;&#39;</span>
<span style="color:#75715e"># ./partitions add --name keks</span>
<span style="color:#75715e"># ./partitions add --name keks</span>
<span style="color:#75715e"># ./partitions add --name keks</span>
<span style="color:#75715e"># mysql -u demo -ppfrtlng demo -e &#39;select * from information_schema.partitions where table_name = &#34;keks&#34;&#39;</span>

<span style="color:#75715e"># ./partitions dropbyname --name keks --pname p0</span>
<span style="color:#75715e"># mysql -u demo -ppfrtlng demo -e &#39;select * from information_schema.partitions where table_name = &#34;keks&#34;&#39;</span>

<span style="color:#75715e"># ./partitions dropbyvalue --name keks --valuebelow 500001</span>
<span style="color:#75715e"># mysql -u demo -ppfrtlng demo -e &#39;select * from information_schema.partitions where table_name = &#34;keks&#34;&#39;</span>

<span style="color:#75715e"># ./partitions drop --name keks</span>

<span style="color:#f92672">import</span> click

<span style="color:#f92672">import</span> MySQLdb
<span style="color:#f92672">import</span> random
<span style="color:#f92672">import</span> string

<span style="color:#f92672">from</span> pprint <span style="color:#f92672">import</span> pprint

<span style="color:#75715e"># A lot of SQL collected here</span>
db_config <span style="color:#f92672">=</span> dict(
  host   <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;localhost&#34;</span>,
  user   <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;demo&#34;</span>,
  passwd <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;pfrtlng&#34;</span>,
  db     <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;demo&#34;</span>,
)

sql_drop_table <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;drop table </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;</span>

sql_create_table <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;&#34;create table </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> (
</span><span style="color:#e6db74">  counter_id integer not null primary key auto_increment,
</span><span style="color:#e6db74">  data       varchar(64) not null
</span><span style="color:#e6db74">) </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">
</span><span style="color:#e6db74">&#34;&#34;&#34;</span>
sql_partition_clause <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;partition by range (counter_id) ( </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> )&#39;</span>
sql_partition_range_clause <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;partition p</span><span style="color:#e6db74">%d</span><span style="color:#e6db74"> values less than (</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">),&#39;</span>

sql_insert_into <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;insert into </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> ( counter_id, data ) values ( </span><span style="color:#e6db74">%d</span><span style="color:#e6db74">, &#34;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34; )&#39;</span>

sql_find_partitions <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;&#34;select partition_name, partition_description 
</span><span style="color:#e6db74">  from information_schema.partitions 
</span><span style="color:#e6db74"> where table_schema = &#39;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">   and table_name = &#39;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39; 
</span><span style="color:#e6db74">order by cast(PARTITION_DESCRIPTION as signed) desc 
</span><span style="color:#e6db74"> limit 2&#34;&#34;&#34;</span>

sql_alter_table_add_partition <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;alter table </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> add partition ( partition </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> values less than (</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">))&#39;</span>

sql_alter_table_drop_partition <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;alter table </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> drop partition </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;</span>

sql_find_partition_by_value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;&#34;select partition_name
</span><span style="color:#e6db74">  from information_schema.partitions
</span><span style="color:#e6db74"> where table_schema = &#39;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">   and table_name   = &#39;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">   and cast(partition_description as signed) &lt; </span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#34;&#34;&#34;</span>

<span style="color:#75715e">###########</span>
<span style="color:#75715e"># create a db connection</span>
db <span style="color:#f92672">=</span> MySQLdb<span style="color:#f92672">.</span>connect(<span style="color:#f92672">**</span>db_config)


<span style="color:#a6e22e">@click.group</span>(help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Test row expiration with and without partitions.&#39;</span>)
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">partitions</span>():
  <span style="color:#66d9ef">pass</span>

<span style="color:#a6e22e">@partitions.command</span>()
<span style="color:#a6e22e">@click.option</span>(<span style="color:#e6db74">&#39;--name&#39;</span>, default<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;demo&#39;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Table name to drop&#39;</span>)
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">drop</span>(name):
  cmd <span style="color:#f92672">=</span> sql_drop_table <span style="color:#f92672">%</span> name
  
<span style="color:#75715e">#  click.echo(&#39;CMD: %s&#39; % cmd)</span>
  <span style="color:#66d9ef">try</span>:
    c <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>cursor()
    c<span style="color:#f92672">.</span>execute(cmd)
    click<span style="color:#f92672">.</span>echo(<span style="color:#e6db74">&#39;Table &#34;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34; dropped.&#39;</span> <span style="color:#f92672">%</span> name)
  <span style="color:#66d9ef">except</span> MySQLdb<span style="color:#f92672">.</span>OperationalError <span style="color:#66d9ef">as</span> e:
    click<span style="color:#f92672">.</span>echo(<span style="color:#e6db74">&#39;Table &#34;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34; did not exist.&#39;</span> <span style="color:#f92672">%</span> name)

<span style="color:#a6e22e">@partitions.command</span>()
<span style="color:#a6e22e">@click.option</span>(<span style="color:#e6db74">&#39;--name&#39;</span>, default<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;demo&#39;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Table name to create&#39;</span>)
<span style="color:#a6e22e">@click.option</span>(<span style="color:#e6db74">&#39;--partitioned/--no-partitioned&#39;</span>, default<span style="color:#f92672">=</span>True, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Create table partitioned?&#39;</span>)
<span style="color:#a6e22e">@click.option</span>(<span style="color:#e6db74">&#39;--size&#39;</span>, default<span style="color:#f92672">=</span><span style="color:#ae81ff">1000000</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Expected table size&#39;</span>)
<span style="color:#a6e22e">@click.option</span>(<span style="color:#e6db74">&#39;--psize&#39;</span>, default<span style="color:#f92672">=</span><span style="color:#ae81ff">100000</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Partition size&#39;</span>)
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create</span>(name, partitioned, size, psize):
  pcmd <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>

  <span style="color:#75715e"># add partitioning clause to create table statement</span>
  <span style="color:#66d9ef">if</span> (partitioned):
    ppcmd <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
    counter <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
    <span style="color:#75715e"># add all the ranges</span>
    <span style="color:#66d9ef">for</span> r <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, size<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>, psize):
      ppcmd   <span style="color:#f92672">=</span> ppcmd <span style="color:#f92672">+</span> ( sql_partition_range_clause <span style="color:#f92672">%</span> (counter, r))
      counter <span style="color:#f92672">=</span> counter <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>

    <span style="color:#75715e"># remove the trailing comma</span>
    pcmd  <span style="color:#f92672">=</span> sql_partition_clause <span style="color:#f92672">%</span> ( ppcmd<span style="color:#f92672">.</span>rstrip(<span style="color:#e6db74">&#39;,&#39;</span>) )
  
  <span style="color:#75715e"># complete the create table statement</span>
  cmd  <span style="color:#f92672">=</span> sql_create_table <span style="color:#f92672">%</span> ( name, pcmd )

  c <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>cursor()
  <span style="color:#66d9ef">try</span>:
    c<span style="color:#f92672">.</span>execute(cmd)
    click<span style="color:#f92672">.</span>echo(<span style="color:#e6db74">&#39;Table &#34;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34; created </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> partitions.&#39;</span> <span style="color:#f92672">%</span> ( name, <span style="color:#e6db74">&#34;with&#34;</span> <span style="color:#66d9ef">if</span> partitioned <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#34;without&#34;</span>))
  <span style="color:#66d9ef">except</span> MySQLdb<span style="color:#f92672">.</span>OperationalError <span style="color:#66d9ef">as</span> e:
    click<span style="color:#f92672">.</span>echo(<span style="color:#e6db74">&#39;Table &#34;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34; already exists.&#39;</span> <span style="color:#f92672">%</span> name)

<span style="color:#a6e22e">@partitions.command</span>()
<span style="color:#a6e22e">@click.option</span>(<span style="color:#e6db74">&#39;--name&#39;</span>, default<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;demo&#39;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Table name to insert into&#39;</span>)
<span style="color:#a6e22e">@click.option</span>(<span style="color:#e6db74">&#39;--size&#39;</span>, default<span style="color:#f92672">=</span><span style="color:#ae81ff">1000000</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Number of rows to load into the table.&#39;</span>)
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fill</span>(name, size):
  <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, size):
    str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(random<span style="color:#f92672">.</span>choice(string<span style="color:#f92672">.</span>ascii_uppercase <span style="color:#f92672">+</span> string<span style="color:#f92672">.</span>digits) <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">20</span>))
    cmd <span style="color:#f92672">=</span> sql_insert_into <span style="color:#f92672">%</span> (name, i, str)

    c <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>cursor()
    <span style="color:#66d9ef">try</span>:
      c<span style="color:#f92672">.</span>execute(cmd)
    <span style="color:#66d9ef">except</span> MySQLdb<span style="color:#f92672">.</span>Error <span style="color:#66d9ef">as</span> e:
      click<span style="color:#f92672">.</span>echo(<span style="color:#e6db74">&#34;MySQL Error: </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> e)
    
    <span style="color:#75715e"># commit every 1000 statements</span>
    <span style="color:#66d9ef">if</span> (i <span style="color:#f92672">%</span> <span style="color:#ae81ff">10000</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>):
      db<span style="color:#f92672">.</span>commit()

  <span style="color:#75715e"># one final commit</span>
  db<span style="color:#f92672">.</span>commit()

<span style="color:#a6e22e">@partitions.command</span>()
<span style="color:#a6e22e">@click.option</span>(<span style="color:#e6db74">&#39;--name&#39;</span>, default<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;demo&#39;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Table name to add partition to&#39;</span>)
<span style="color:#a6e22e">@click.option</span>(<span style="color:#e6db74">&#39;--size&#39;</span>, default<span style="color:#f92672">=</span>None, type<span style="color:#f92672">=</span>click<span style="color:#f92672">.</span>INT, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Partition size in id count&#39;</span>)
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add</span>(name, size):
  <span style="color:#66d9ef">global</span> db_config <span style="color:#75715e"># we need the schema name</span>
  schema <span style="color:#f92672">=</span> db_config[<span style="color:#e6db74">&#39;db&#39;</span>]

  cmd <span style="color:#f92672">=</span> sql_find_partitions <span style="color:#f92672">%</span> ( schema, name ); <span style="color:#75715e"># find me the two last partitions from I_S.PARTITIONS</span>
<span style="color:#75715e">#  click.echo(&#34;Sql: %s&#34; % cmd)</span>
  c <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>cursor(MySQLdb<span style="color:#f92672">.</span>cursors<span style="color:#f92672">.</span>DictCursor)
  c<span style="color:#f92672">.</span>execute(cmd)
  r <span style="color:#f92672">=</span> c<span style="color:#f92672">.</span>fetchall()

  <span style="color:#75715e"># if no size was given, we take the interval from the two highest numbered partitions as default</span>
  <span style="color:#66d9ef">if</span> size <span style="color:#f92672">is</span> None:
    size  <span style="color:#f92672">=</span> int(r[<span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#39;partition_description&#39;</span>]) <span style="color:#f92672">-</span> int(r[<span style="color:#ae81ff">1</span>][<span style="color:#e6db74">&#39;partition_description&#39;</span>])
  limit <span style="color:#f92672">=</span> int(r[<span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#39;partition_description&#39;</span>]) <span style="color:#f92672">+</span> size

  <span style="color:#75715e"># we automatically calculate the new partition name p(XX+1) from the last pXX</span>
  pname <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;p&#39;</span> <span style="color:#f92672">+</span> str(int(r[<span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#39;partition_name&#39;</span>][<span style="color:#ae81ff">1</span>:]) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>)

  cmd <span style="color:#f92672">=</span> sql_alter_table_add_partition <span style="color:#f92672">%</span> ( name, pname, limit )
<span style="color:#75715e">#  click.echo(&#34;Sql: %s&#34; % cmd)</span>
  c <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>cursor()
  <span style="color:#66d9ef">try</span>:
    c<span style="color:#f92672">.</span>execute(cmd)
    click<span style="color:#f92672">.</span>echo(<span style="color:#e6db74">&#39;Partition </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> has been added (values less than </span><span style="color:#e6db74">%d</span><span style="color:#e6db74">, that is a </span><span style="color:#e6db74">%d</span><span style="color:#e6db74"> step size.)&#39;</span> <span style="color:#f92672">%</span> (pname, limit, size))
  <span style="color:#66d9ef">except</span> MySQLdb<span style="color:#f92672">.</span>Error <span style="color:#66d9ef">as</span> e:
    click<span style="color:#f92672">.</span>echo(<span style="color:#e6db74">&#34;MySQL Error: </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> e )
    exit(<span style="color:#ae81ff">1</span>)

<span style="color:#a6e22e">@partitions.command</span>()
<span style="color:#a6e22e">@click.option</span>(<span style="color:#e6db74">&#39;--name&#39;</span>, default<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;demo&#39;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Table name to drop partition from&#39;</span>)
<span style="color:#a6e22e">@click.option</span>(<span style="color:#e6db74">&#39;--pname&#39;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Drop partition by name pXXX&#39;</span>)
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">dropbyname</span>(name, pname):
  <span style="color:#66d9ef">if</span> pname <span style="color:#f92672">is</span> None:
    click<span style="color:#f92672">.</span>echo(<span style="color:#e6db74">&#39;I need a --pname&#39;</span>)
    exit(<span style="color:#ae81ff">1</span>)
  
  cmd <span style="color:#f92672">=</span> sql_alter_table_drop_partition <span style="color:#f92672">%</span> ( name, pname)
<span style="color:#75715e">#  click.echo(&#39;Sql: %s&#39; % cmd)</span>
  c <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>cursor()
  <span style="color:#66d9ef">try</span>:
    c<span style="color:#f92672">.</span>execute(cmd)
    click<span style="color:#f92672">.</span>echo(<span style="color:#e6db74">&#34;Dropped partition named </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> pname)
  <span style="color:#66d9ef">except</span> MySQLdb<span style="color:#f92672">.</span>Error <span style="color:#66d9ef">as</span> e:
    click<span style="color:#f92672">.</span>echo(<span style="color:#e6db74">&#34;MySQL Error: </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> e)
    exit(<span style="color:#ae81ff">1</span>)

<span style="color:#a6e22e">@partitions.command</span>()
<span style="color:#a6e22e">@click.option</span>(<span style="color:#e6db74">&#39;--name&#39;</span>, default<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;demo&#39;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Table name to drop partitions from&#39;</span>)
<span style="color:#a6e22e">@click.option</span>(<span style="color:#e6db74">&#39;--valuebelow&#39;</span>, type<span style="color:#f92672">=</span>click<span style="color:#f92672">.</span>INT, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Drop all partitions with values below X&#39;</span>)
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">dropbyvalue</span>(name, valuebelow):
  <span style="color:#66d9ef">global</span> db_config <span style="color:#75715e"># we need the schema name</span>
  schema <span style="color:#f92672">=</span> db_config[<span style="color:#e6db74">&#39;db&#39;</span>]
  
  <span style="color:#66d9ef">if</span> valuebelow <span style="color:#f92672">is</span> None:
    click<span style="color:#f92672">.</span>echo(<span style="color:#e6db74">&#39;I need a --valuebelow&#39;</span>)
    exit(<span style="color:#ae81ff">1</span>)

  cmd <span style="color:#f92672">=</span> sql_find_partition_by_value <span style="color:#f92672">%</span> ( schema, name, valuebelow)
<span style="color:#75715e">#  click.echo(&#34;Sql: %s&#34; % cmd)</span>
 
  c <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>cursor()
  <span style="color:#66d9ef">try</span>:
    c<span style="color:#f92672">.</span>execute(cmd)
  <span style="color:#66d9ef">except</span> MySQL<span style="color:#f92672">.</span>Error <span style="color:#66d9ef">as</span> e:
    click<span style="color:#f92672">.</span>echo(<span style="color:#e6db74">&#34;MySQL Error: </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> e)
    exit(<span style="color:#ae81ff">1</span>)
  
  result <span style="color:#f92672">=</span> c<span style="color:#f92672">.</span>fetchall() <span style="color:#75715e"># reseult[rownr][0] is partition name</span>
  
  <span style="color:#66d9ef">for</span> row <span style="color:#f92672">in</span> result:
    cmd <span style="color:#f92672">=</span> sql_alter_table_drop_partition <span style="color:#f92672">%</span> (name, row[<span style="color:#ae81ff">0</span>])
<span style="color:#75715e">#    click.echo(&#34;Sql: %s&#34; % cmd)</span>
    c <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>cursor()
    <span style="color:#66d9ef">try</span>:
      c<span style="color:#f92672">.</span>execute(cmd)
      click<span style="color:#f92672">.</span>echo(<span style="color:#e6db74">&#34;Dropped partition named </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> row[<span style="color:#ae81ff">0</span>])
    <span style="color:#66d9ef">except</span> MySQL<span style="color:#f92672">.</span>Error <span style="color:#66d9ef">as</span> e:
      click<span style="color:#f92672">.</span>echo(<span style="color:#e6db74">&#34;MySQL Error: </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> e)

partitions()
</code></pre></div>

	
    </article>
</div>



            <footer>
    <p>
	&copy; Copyright 2021 Someone or something
    </p>
</footer>


        </main>

	





<script src="/js/bootstrap.js"></script>




<script src="/js/lunr.js"></script>





<script src="/js/app.js"></script>


    </body>
</html>
