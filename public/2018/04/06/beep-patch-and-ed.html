<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Die wunderbare Welt von Isotopp - beep, patch and ed</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="site.webmanifest">
<link rel="apple-touch-icon" href="icon.png">
<link rel="favicon.ico" rel="icon" type="image/ico">





	



<link rel="stylesheet" href="/style.min.c5e5cd61f54911f9aafd1dbe09c2f90667957bfe1002126c87aace57759f3446.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
	<a class="navbar-brand" href="" rel="home" title=".Site.Title">
	    Die wunderbare Welt von Isotopp
	</a>
	<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
	</button>

	<div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
		
		
		<li class="nav-item ">
                    <a class="nav-link" href="/about/">
			
			<span>About</span>
			<span class="visually-hidden">(Current)</span>
		    </a>
		    
		</li>
            </ul>
            
	</div>
    </div>
</nav>


        <main role="main" class="container-fluid">

            


<div class="page">
    <article class="beep-patch-and-ed-page">
	<h1 class="title">
            beep, patch and ed
	</h1>

	<p>So a few days ago, somebody found an exploit in beep - now
<a href="https://nvd.nist.gov/vuln/detail/CVE-2018-0492" target="_blank" rel="noopener">CVE-2018-0492</a>

.</p>
<p>beep is a program that is part of Debian (and Ubuntu) to have the PC speaker
multiple times, at different frequencies, with different pauses and beep
lengths. That works just fine. It&rsquo;s also SUID root. There is zero code in it
that deals with the fact that it may run privileged.</p>
<p>The author confidently writes:</p>
<blockquote>
<p>Some users will encounter a situation where beep dies with a complaint
from ioctl(). The reason for this, as Peter Tirsek was nice enough to
point out to me, stems from how the kernel handles beep&rsquo;s attempt to poke
at (for non-programmers: ioctl is a sort of catch-all function that lets
you poke at things that have no other predefined poking-at mechanism) the
tty, which is how it beeps. The short story is, the kernel checks that
either:</p>
<ul>
<li>you are the superuser</li>
<li>you own the current tty</li>
</ul>
<p>What this means is that root can always make beep work (to the best of my
knowledge!), and that any local user can make beep work, BUT a non-root
remote user cannot use beep in it&rsquo;s natural state.</p>
<p>What&rsquo;s worse, an xterm, or other x-session counts, as far as the kernel is
concerned, as &lsquo;remote&rsquo;, so beep won&rsquo;t work from a non-privileged xterm
either. I had originally chalked this up to a bug, but there&rsquo;s actually
nothing I can do about it, and it really is a Good Thing that the kernel
does things this way.</p>
<p>There is also a solution. By default beep is not installed with the suid
bit set, because that would just be zany. On the other hand, if you do
make it suid root, all your problems with beep bailing on ioctl calls will
magically vanish, which is pleasant, and the only reason not to is that
any suid program is a potential security hole.</p>
<p>Conveniently, beep is very short, so auditing it is pretty
straightforward. Decide for yourself, of course, but it looks safe to me -
there&rsquo;s only one buffer and fgets doesn&rsquo;t let it overflow, there&rsquo;s only
one file opening, and while there is a potential race condition there,
it&rsquo;s with /dev/console. If someone can exploit this race by replacing
/dev/console, you&rsquo;ve got bigger problems. :)</p>
</blockquote>
<p>So here is how you race this: <a href="https://gist.github.com/fkt/5f8f9560ef54e11ff7df8bec09dc8f9a" target="_blank" rel="noopener">beepbop</a>

</p>
<p>Which is bad, because Ubuntu and Debian both install beep SUID root, by
default. You can check with &ldquo;dpkg-reconfigure -plow beep&rdquo;.</p>
<p><p class="md__image">
  <img src="/uploads/2018/04/dpkg-reconfigure-beep.png" alt=""  />
</p>

</p>
<p>Debian installs beep SUID root by default, &ldquo;dpkg-reconfigure -plow
beep&rdquo;</p>
<p>Somebody also created a fun website for the beep problem, complete with
logo and name: <a href="https://holeybeep.ninja/" target="_blank" rel="noopener">Holey Beep</a>

.</p>
<p><p class="md__image">
  <img src="/uploads/2018/04/holey-beep.png" alt=""  />
</p>

</p>
<p><a href="https://holeybeep.ninja/" target="_blank" rel="noopener">Holey Beep</a>

: The site, which is done very tongue
in cheek, also contained a <a href="https://holeybeep.ninja/beep.patch" target="_blank" rel="noopener">patch</a>

 for
the problem, advertising it like this:</p>
<p><p class="md__image">
  <img src="/uploads/2018/04/patch-exploit.png" alt=""  />
</p>

</p>
<p>So why would your computer beep when it applies a patch?
That&rsquo;s another fun thing. The patch contains this hunk:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff"><span style="color:#f92672">--- /dev/null	2018-13-37 13:37:37.000000000 +0100
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+++ b/beep.c	2018-13-37 13:38:38.000000000 +0100
</span><span style="color:#a6e22e"></span>1337a
1,112d
<span style="font-weight:bold">!id&gt;~/pwn.lol;beep # 13-21 12:53:21.000000000 +0100
</span><span style="font-weight:bold"></span>.
</code></pre></div><p>and that looks very much like an ed-script. In fact, until recently that is
exactly what patch did: popen a copy of ed and feed it. The line &ldquo;id &gt;
~/pwn.lol; beep&rdquo; will hence be run, create a file pwn.lol in $HOME with the
current user id, and then execute beep. That&rsquo;s the promised beep you hear.</p>
<p>Of course code execution by a thing you expect to handle data is a problem,
and that is now
<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-1000156" target="_blank" rel="noopener">CVE-2018-1000156</a>

.</p>
<p>It&rsquo;s fixed by writing the ed code to a tmp file while filtering the commands
fed to ed, and then feeding the filtered input into ed.</p>


	
    </article>
</div>



            <footer>
    <p>
	&copy; Copyright 2021 Someone or something
    </p>
</footer>


        </main>

	





<script src="/js/bootstrap.js"></script>




<script src="/js/lunr.js"></script>





<script src="/js/app.js"></script>


    </body>
</html>
