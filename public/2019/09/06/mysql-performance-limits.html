<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Die wunderbare Welt von Isotopp - MySQL Performance Limits</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="site.webmanifest">
<link rel="apple-touch-icon" href="icon.png">
<link rel="favicon.ico" rel="icon" type="image/ico">





	



<link rel="stylesheet" href="/style.min.c5e5cd61f54911f9aafd1dbe09c2f90667957bfe1002126c87aace57759f3446.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
	<a class="navbar-brand" href="" rel="home" title=".Site.Title">
	    Die wunderbare Welt von Isotopp
	</a>
	<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
	</button>

	<div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
		
		
		<li class="nav-item ">
                    <a class="nav-link" href="/about/">
			
			<span>About</span>
			<span class="visually-hidden">(Current)</span>
		    </a>
		    
		</li>
            </ul>
            
	</div>
    </div>
</nav>


        <main role="main" class="container-fluid">

            


<div class="page">
    <article class="mysql-performance-limits-page">
	<h1 class="title">
            MySQL Performance Limits
	</h1>

	<p>The last time I saw a MySQL server operating at a performance limit
was in 2012. Back them we had a production master on (then) current
hardware, running stable at about 21000 QPS. At 24000 QPS it tended
to become unstable and fall over, dying in global locks on the
InnoDB Adaptive Hash Index or other global locks.</p>
<p>I need to better understand how MySQL works today, and what the limits
are on a box that is considered large in 2019.</p>
<h1 id="what-do-i-expect">
    <a href="#what-do-i-expect">
	What do I expect?
    </a>
</h1>
<p>Well, boxen are a lot larger than they have been in 2012, and
we invented NVME and Flash Storage since then.</p>
<p>I expect MySQL to be able to eat the full box I am throwing at
it and not die in locks. I also expect the performance levels
I can reach to be scaling with the query execution times I observe
in production times number of cores.</p>
<p>I do observe appro. 1/3 ms query execution time on the queries
I simulate here, in production. So I would like to see about
3000 QPS per core. With a 64 core box, that would be around 200k QPS,
easily 10x-ish more than in 2012.</p>
<h1 id="what-did-i-get">
    <a href="#what-did-i-get">
	What did I get?
    </a>
</h1>
<p>This is all read testing of a memory resident data set. Other testing
to follow.</p>
<p>After some woes described below, I got 200k QPS or better in all
cases, for simple PK lookups in fact almost 2x as much.</p>
<p>SK lookups are about 1/2 as fast as PK lookups or faster, allowing
for &ldquo;one level of indirection&rdquo;.</p>
<p>MySQL 8 scales well enough to eat all of a 64 core box with 1/2 TB
of RAM without choking or locking up or being otherwise jittery. It
is adequate for any hardware that in 2019 we can reasonably throw at
it. From a 2012 PoV this is an awesome achievement.</p>
<h1 id="the-box">
    <a href="#the-box">
	The box
    </a>
</h1>
<p>So my current test box is an single socket AMD 7702 (64C, HT off)
with 512G of memory and</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># nvme list</span>
Node             SN                   Model                                    Namespace Usage                      Format           FW Rev
---------------- -------------------- ---------------------------------------- --------- -------------------------- ---------------- --------
/dev/nvme0n1     39X0A05ZTZZF         KCM51VUG800G                             <span style="color:#ae81ff">1</span>          27.79  GB / 800.17  GB    <span style="color:#ae81ff">512</span>   B +  <span style="color:#ae81ff">0</span> B   3006T21F
/dev/nvme1n1     29X0A00CTZZF         KCM51VUG800G                             <span style="color:#ae81ff">1</span>          27.79  GB / 800.17  GB    <span style="color:#ae81ff">512</span>   B +  <span style="color:#ae81ff">0</span> B   3006T21F
/dev/nvme2n1     2950A00FTZZF         KCM51VUG800G                             <span style="color:#ae81ff">1</span>          27.79  GB / 800.17  GB    <span style="color:#ae81ff">512</span>   B +  <span style="color:#ae81ff">0</span> B   3006T21F
/dev/nvme3n1     39X0A067TZZF         KCM51VUG800G                             <span style="color:#ae81ff">1</span>          27.79  GB / 800.17  GB    <span style="color:#ae81ff">512</span>   B +  <span style="color:#ae81ff">0</span> B   3006T21F
/dev/nvme4n1     39X0A060TZZF         KCM51VUG800G                             <span style="color:#ae81ff">1</span>          27.79  GB / 800.17  GB    <span style="color:#ae81ff">512</span>   B +  <span style="color:#ae81ff">0</span> B   3006T21F
/dev/nvme5n1     39X0A069TZZF         KCM51VUG800G                             <span style="color:#ae81ff">1</span>          27.79  GB / 800.17  GB    <span style="color:#ae81ff">512</span>   B +  <span style="color:#ae81ff">0</span> B   3006T21F
/dev/nvme6n1     39X0A06ETZZF         KCM51VUG800G                             <span style="color:#ae81ff">1</span>          27.79  GB / 800.17  GB    <span style="color:#ae81ff">512</span>   B +  <span style="color:#ae81ff">0</span> B   3006T21F
/dev/nvme7n1     39X0A05LTZZF         KCM51VUG800G                             <span style="color:#ae81ff">1</span>          27.79  GB / 800.17  GB    <span style="color:#ae81ff">512</span>   B +  <span style="color:#ae81ff">0</span> B   3006T21F

<span style="color:#75715e"># vgcreate kristest /dev/nvme{0..7}n1</span>
<span style="color:#75715e"># lvcreate -n mysql -L4T -i8 kristest</span>
<span style="color:#75715e"># mkfs -t xfs /dev/kristest/mysql</span>
</code></pre></div><p>I then run the performance-datagen.sql script to create a test table
kristest.t, and then run performance-querygen.py to create a file
with test queries, file.sql.</p>
<p>mysqlslap then does</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mysqlslap --user<span style="color:#f92672">=</span>kristest --password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&lt;secret&gt;&#39;</span> --host<span style="color:#f92672">=</span>localhost --concurrency<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> --iterations<span style="color:#f92672">=</span><span style="color:#ae81ff">20000</span> --create-schema<span style="color:#f92672">=</span>kristest --verbose --query<span style="color:#f92672">=</span>./file.sql
</code></pre></div><p>and I observe the running test with <code>innotop -d1 -mQ</code> and <code>innotop -d1 -mC</code>.</p>
<h1 id="findings">
    <a href="#findings">
	Findings
    </a>
</h1>
<h2 id="mysql-8016-binlog-row-minimal-buffer-pool-384g">
    <a href="#mysql-8016-binlog-row-minimal-buffer-pool-384g">
	MySQL 8.0.16, Binlog, ROW, MINIMAL, Buffer Pool 384G
    </a>
</h2>
<p>For all tests:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ du -sh /mysql/kristest/data
87G
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">root<span style="color:#f92672">@</span>localhost [kristest]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#a6e22e">count</span>(<span style="color:#f92672">*</span>) <span style="color:#66d9ef">from</span> t;
<span style="color:#f92672">+-----------+</span>
<span style="color:#f92672">|</span> <span style="color:#a6e22e">count</span>(<span style="color:#f92672">*</span>)  <span style="color:#f92672">|</span>
<span style="color:#f92672">+-----------+</span>
<span style="color:#f92672">|</span> <span style="color:#ae81ff">134217728</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+-----------+</span>
<span style="color:#ae81ff">1</span> row <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">6</span>.<span style="color:#ae81ff">13</span> sec)
</code></pre></div><h3 id="testmodes-1">
    <a href="#testmodes-1">
	Testmodes 1
    </a>
</h3>
<pre><code>testmodes = [ 1 ]

VSZ 421G
RES 32.8G
load average: 63.52, 61.70, 59.23
QPS 384k
</code></pre><h3 id="testmodes-1-2">
    <a href="#testmodes-1-2">
	Testmodes 1, 2
    </a>
</h3>
<pre><code>testmodes = [ 1, 2 ]

VSZ 421G
RES 34.3G
load average: 63.82, 64.89, 61.63
QPS 270k-320k
</code></pre><h3 id="testmodes-1-2-3">
    <a href="#testmodes-1-2-3">
	Testmodes 1, 2, 3
    </a>
</h3>
<pre><code>testmodes = [ 1, 2, 3 ]

VSZ 421G
RES 88.4G
load average: 64.10, 57.94, 56.72
QPS 5.5k-6.2k
</code></pre><p>There is a distinct warmup phase during which the box is not
saturated and Read I/O can be observed. When the RES approaches
disk size, this disk traffic ceases and final load and final
QPS ratings are achieved.</p>
<h3 id="testmodes-1-2-3-4">
    <a href="#testmodes-1-2-3-4">
	Testmodes 1, 2, 3, 4
    </a>
</h3>
<pre><code>testmodes = [ 1, 2, 3, 4 ]

VSZ 421G
RES 94.6G
load average: 65.91, 63.10, 59.75
QPS 407-1002 (yup, no &quot;k&quot;, this is as low as 407 QPS)
</code></pre><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">root<span style="color:#f92672">@</span>localhost [kristest]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">explain</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> t <span style="color:#66d9ef">where</span> i1 <span style="color:#66d9ef">in</span> ( <span style="color:#ae81ff">64419</span>,<span style="color:#ae81ff">37384</span>,<span style="color:#ae81ff">17490</span>,<span style="color:#ae81ff">7919</span>,<span style="color:#ae81ff">42137</span>,<span style="color:#ae81ff">70137</span>,<span style="color:#ae81ff">56196</span>,<span style="color:#ae81ff">54754</span>,<span style="color:#ae81ff">70263</span> );
<span style="color:#f92672">+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+</span>
<span style="color:#f92672">|</span> id <span style="color:#f92672">|</span> select_type <span style="color:#f92672">|</span> <span style="color:#66d9ef">table</span> <span style="color:#f92672">|</span> partitions <span style="color:#f92672">|</span> type  <span style="color:#f92672">|</span> possible_keys <span style="color:#f92672">|</span> <span style="color:#66d9ef">key</span>  <span style="color:#f92672">|</span> key_len <span style="color:#f92672">|</span> ref  <span style="color:#f92672">|</span> rows  <span style="color:#f92672">|</span> filtered <span style="color:#f92672">|</span> Extra                 <span style="color:#f92672">|</span>
<span style="color:#f92672">+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span> SIMPLE      <span style="color:#f92672">|</span> t     <span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span>       <span style="color:#f92672">|</span> range <span style="color:#f92672">|</span> i1            <span style="color:#f92672">|</span> i1   <span style="color:#f92672">|</span> <span style="color:#ae81ff">4</span>       <span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">12674</span> <span style="color:#f92672">|</span>   <span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">00</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">Using</span> <span style="color:#66d9ef">index</span> <span style="color:#66d9ef">condition</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------+</span>
<span style="color:#ae81ff">1</span> row <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span>, <span style="color:#ae81ff">1</span> <span style="color:#a6e22e">warning</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

root<span style="color:#f92672">@</span>localhost [kristest]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> t <span style="color:#66d9ef">where</span> i1 <span style="color:#66d9ef">in</span> ( <span style="color:#ae81ff">64419</span>,<span style="color:#ae81ff">37384</span>,<span style="color:#ae81ff">17490</span>,<span style="color:#ae81ff">7919</span>,<span style="color:#ae81ff">42137</span>,<span style="color:#ae81ff">70137</span>,<span style="color:#ae81ff">56196</span>,<span style="color:#ae81ff">54754</span>,<span style="color:#ae81ff">70263</span> );
...
<span style="color:#f92672">|</span> <span style="color:#ae81ff">134777240</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">95</span>ab0836<span style="color:#f92672">-</span>c97e<span style="color:#f92672">-</span><span style="color:#ae81ff">11</span>e9<span style="color:#f92672">-</span>b92c<span style="color:#f92672">-</span><span style="color:#ae81ff">98039</span>bbd64c8 <span style="color:#f92672">|</span> <span style="color:#ae81ff">95</span>ab0838<span style="color:#f92672">-</span>c97e<span style="color:#f92672">-</span><span style="color:#ae81ff">11</span>e9<span style="color:#f92672">-</span>b92c<span style="color:#f92672">-</span><span style="color:#ae81ff">98039</span>bbd64c8 <span style="color:#f92672">|</span> <span style="color:#ae81ff">95</span>ab0839<span style="color:#f92672">-</span>c97e<span style="color:#f92672">-</span><span style="color:#ae81ff">11</span>e9<span style="color:#f92672">-</span>b92c<span style="color:#f92672">-</span><span style="color:#ae81ff">98039</span>bbd64c8 <span style="color:#f92672">|</span> <span style="color:#ae81ff">95</span>ab083b<span style="color:#f92672">-</span>c97e<span style="color:#f92672">-</span><span style="color:#ae81ff">11</span>e9<span style="color:#f92672">-</span>b92c<span style="color:#f92672">-</span><span style="color:#ae81ff">98039</span>bbd64c8 <span style="color:#f92672">|</span> <span style="color:#ae81ff">95</span>ab083c<span style="color:#f92672">-</span>c97e<span style="color:#f92672">-</span><span style="color:#ae81ff">11</span>e9<span style="color:#f92672">-</span>b92c<span style="color:#f92672">-</span><span style="color:#ae81ff">98039</span>bbd64c8 <span style="color:#f92672">|</span> <span style="color:#ae81ff">95</span>ab083e<span style="color:#f92672">-</span>c97e<span style="color:#f92672">-</span><span style="color:#ae81ff">11</span>e9<span style="color:#f92672">-</span>b92c<span style="color:#f92672">-</span><span style="color:#ae81ff">98039</span>bbd64c8 <span style="color:#f92672">|</span> <span style="color:#ae81ff">95</span>ab083f<span style="color:#f92672">-</span>c97e<span style="color:#f92672">-</span><span style="color:#ae81ff">11</span>e9<span style="color:#f92672">-</span>b92c<span style="color:#f92672">-</span><span style="color:#ae81ff">98039</span>bbd64c8 <span style="color:#f92672">|</span> <span style="color:#ae81ff">95</span>ab0841<span style="color:#f92672">-</span>c97e<span style="color:#f92672">-</span><span style="color:#ae81ff">11</span>e9<span style="color:#f92672">-</span>b92c<span style="color:#f92672">-</span><span style="color:#ae81ff">98039</span>bbd64c8 <span style="color:#f92672">|</span> <span style="color:#ae81ff">95</span>ab0842<span style="color:#f92672">-</span>c97e<span style="color:#f92672">-</span><span style="color:#ae81ff">11</span>e9<span style="color:#f92672">-</span>b92c<span style="color:#f92672">-</span><span style="color:#ae81ff">98039</span>bbd64c8 <span style="color:#f92672">|</span> <span style="color:#ae81ff">95</span>ab0844<span style="color:#f92672">-</span>c97e<span style="color:#f92672">-</span><span style="color:#ae81ff">11</span>e9<span style="color:#f92672">-</span>b92c<span style="color:#f92672">-</span><span style="color:#ae81ff">98039</span>bbd64c8 <span style="color:#f92672">|</span> <span style="color:#ae81ff">70263</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">27807</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">28246</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">57810</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">4313</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">48136</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">27740</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">94290</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">88230</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">58281</span> <span style="color:#f92672">|</span>
...
<span style="color:#ae81ff">12674</span> rows <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">38</span> sec)
</code></pre></div><h1 id="increase-selectivity">
    <a href="#increase-selectivity">
	Increase selectivity
    </a>
</h1>
<p>In our testing above, we see that the cardinality of i1 is 100k, and
the table size is 128m. That&rsquo;s 1280 result rows on the average for
a random value of i1.</p>
<p>We also observe that testmode 4 results ask for 2-11 values of i1 or i2,
where testmode 3 results ask for a single value of i1 or i2. The average
number of testmode 4 values we ask for is 6, and testmode 4 happens
to be 6x slower.</p>
<p>So it might be that the number of result set rows is determining the
query speed.</p>
<p>We can test: We increase the cardinality of i1 to match id, 128. And
for i2 we are going up to 256m cardinality.</p>
<h2 id="the-slow-way">
    <a href="#the-slow-way">
	The slow way
    </a>
</h2>
<p>Modify the dataset:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">root<span style="color:#f92672">@</span>localhost [kristest]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">update</span> t <span style="color:#66d9ef">set</span> i1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">rand</span>() <span style="color:#f92672">*</span> <span style="color:#ae81ff">134937574</span>, i2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">rand</span>() <span style="color:#f92672">*</span> <span style="color:#ae81ff">134937574</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>;
Query OK, <span style="color:#ae81ff">134217728</span> rows <span style="color:#a6e22e">affected</span> (<span style="color:#ae81ff">1</span> hour <span style="color:#ae81ff">53</span> min <span style="color:#ae81ff">17</span>.<span style="color:#ae81ff">46</span> sec)
Rows matched: <span style="color:#ae81ff">134217728</span>  Changed: <span style="color:#ae81ff">134217728</span>  Warnings: <span style="color:#ae81ff">0</span>
</code></pre></div><p>During the execution of that update statement, we see an aggregate write
load of 320 MB/s (~40 MB/s per NVME). This is not very high. It needs to
be tested with more write benchmarks, later.</p>
<p>Also, there are four INDEX() definitions active on t, i1, i2, c1
and c2, two of which are being updated.</p>
<p>This is not fast, either, and this is the n00b way of doing things. We
redo this again, differently:</p>
<h2 id="a-faster-way">
    <a href="#a-faster-way">
	A faster way
    </a>
</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">root<span style="color:#f92672">@</span>localhost [kristest]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">alter</span> <span style="color:#66d9ef">table</span> t <span style="color:#66d9ef">drop</span> <span style="color:#66d9ef">index</span> i1, <span style="color:#66d9ef">drop</span> <span style="color:#66d9ef">index</span> i2;
Query OK, <span style="color:#ae81ff">0</span> rows <span style="color:#a6e22e">affected</span> (<span style="color:#ae81ff">1</span> min <span style="color:#ae81ff">46</span>.<span style="color:#ae81ff">85</span> sec)
Records: <span style="color:#ae81ff">0</span>  Duplicates: <span style="color:#ae81ff">0</span>  Warnings: <span style="color:#ae81ff">0</span>
root<span style="color:#f92672">@</span>localhost [kristest]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">update</span> t <span style="color:#66d9ef">set</span> i1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">rand</span>() <span style="color:#f92672">*</span> <span style="color:#ae81ff">134937574</span>, i2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">rand</span>() <span style="color:#f92672">*</span> <span style="color:#ae81ff">134937574</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>;
Query OK, <span style="color:#ae81ff">134217728</span> rows <span style="color:#a6e22e">affected</span> (<span style="color:#ae81ff">26</span> min <span style="color:#ae81ff">5</span>.<span style="color:#ae81ff">07</span> sec)
Rows matched: <span style="color:#ae81ff">134217728</span>  Changed: <span style="color:#ae81ff">134217728</span>  Warnings: <span style="color:#ae81ff">0</span>
root<span style="color:#f92672">@</span>localhost [kristest]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">alter</span> <span style="color:#66d9ef">table</span> t <span style="color:#66d9ef">add</span> <span style="color:#66d9ef">index</span> (i1), <span style="color:#66d9ef">add</span> <span style="color:#66d9ef">index</span> (i2);
Query OK, <span style="color:#ae81ff">0</span> rows <span style="color:#a6e22e">affected</span> (<span style="color:#ae81ff">6</span> min <span style="color:#ae81ff">23</span>.<span style="color:#ae81ff">04</span> sec)
Records: <span style="color:#ae81ff">0</span>  Duplicates: <span style="color:#ae81ff">0</span>  Warnings: <span style="color:#ae81ff">0</span>
</code></pre></div><p>TBH, I&rsquo;d expect MySQL by now to do bulk index updates in mass ALTER tables
quicker than &lsquo;the slow way&rsquo; in 2019. OTOH, that is probably stuff that
you get when you pay for Red Oracle instead of Blue.</p>
<h2 id="testing-with-selective-i1-i2">
    <a href="#testing-with-selective-i1-i2">
	Testing with selective i1, i2
    </a>
</h2>
<p>Now i1 and i2 are much more selective, and instead of 12k result rows,
a search on i1 should on the average return 1 row, on i2 even 0.5 rows.
Let&rsquo;s see how that affects runtimes up SK lookup queries (testmode 3, 4).</p>
<p>Let&rsquo;s rerun everything, starting with a cold mysqld again, so that I
do get proper memory sizes as well.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># du -sh /mysql/kristest/data</span>
94G     /mysql/kristest/data
</code></pre></div><h3 id="testmodes-1-1">
    <a href="#testmodes-1-1">
	Testmodes 1
    </a>
</h3>
<pre><code>testmodes = [ 1 ]

VSZ 421G
RES 32.8G
load average: 64.14, 43.67, 20.08
QPS 360k-420k
</code></pre><h3 id="testmodes-1-2-1">
    <a href="#testmodes-1-2-1">
	Testmodes 1, 2
    </a>
</h3>
<pre><code>testmodes = [ 1, 2 ]

VSZ 421G
RES 33.8G
load average: 60.36, 56.82, 39.73
QPS 280k-330k
</code></pre><h3 id="testmodes-1-2-3-1">
    <a href="#testmodes-1-2-3-1">
	Testmodes 1, 2, 3
    </a>
</h3>
<pre><code>testmodes = [ 1, 2, 3 ]

VSZ 421G
RES 34.6G
load average: 58.61, 58.29, 55.80
QPS 200k-320k (very jittery)
</code></pre><p>Did not reach load 60+, even after long warmup and with 0 I/O.
Some i2 queries can return 0 rows, might be the cause?</p>
<h3 id="testmodes-1-2-3-4-1">
    <a href="#testmodes-1-2-3-4-1">
	Testmodes 1, 2, 3, 4
    </a>
</h3>
<pre><code>testmodes = [ 1, 2, 3, 4 ]

VSZ 421G
RES 35.6G
load average: 67.68, 63.57, 58.80
QPS 210k-260k
</code></pre><p>After an even longer wait, performance jitters way less and stabilizes
around 248k with a jitter of &lt;10k in both directions. Warmup times
for this size of hardware and this amount of memory are insane.</p>
<p>And with our changes:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">root<span style="color:#f92672">@</span>localhost [kristest]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">explain</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> t <span style="color:#66d9ef">where</span> i1 <span style="color:#66d9ef">in</span> ( <span style="color:#ae81ff">64419</span>,<span style="color:#ae81ff">37384</span>,<span style="color:#ae81ff">17490</span>,<span style="color:#ae81ff">7919</span>,<span style="color:#ae81ff">42137</span>,<span style="color:#ae81ff">70137</span>,<span style="color:#ae81ff">56196</span>,<span style="color:#ae81ff">54754</span>,<span style="color:#ae81ff">70263</span> );
<span style="color:#f92672">+----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+-----------------------+</span>
<span style="color:#f92672">|</span> id <span style="color:#f92672">|</span> select_type <span style="color:#f92672">|</span> <span style="color:#66d9ef">table</span> <span style="color:#f92672">|</span> partitions <span style="color:#f92672">|</span> type  <span style="color:#f92672">|</span> possible_keys <span style="color:#f92672">|</span> <span style="color:#66d9ef">key</span>  <span style="color:#f92672">|</span> key_len <span style="color:#f92672">|</span> ref  <span style="color:#f92672">|</span> rows <span style="color:#f92672">|</span> filtered <span style="color:#f92672">|</span> Extra                 <span style="color:#f92672">|</span>
<span style="color:#f92672">+----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+-----------------------+</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span> SIMPLE      <span style="color:#f92672">|</span> t     <span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span>       <span style="color:#f92672">|</span> range <span style="color:#f92672">|</span> i1            <span style="color:#f92672">|</span> i1   <span style="color:#f92672">|</span> <span style="color:#ae81ff">4</span>       <span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span> <span style="color:#f92672">|</span>   <span style="color:#ae81ff">22</span> <span style="color:#f92672">|</span>   <span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">00</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">Using</span> <span style="color:#66d9ef">index</span> <span style="color:#66d9ef">condition</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+-----------------------+</span>
<span style="color:#ae81ff">1</span> row <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span>, <span style="color:#ae81ff">1</span> <span style="color:#a6e22e">warning</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
root<span style="color:#f92672">@</span>localhost [kristest]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> t <span style="color:#66d9ef">where</span> i1 <span style="color:#66d9ef">in</span> ( <span style="color:#ae81ff">64419</span>,<span style="color:#ae81ff">37384</span>,<span style="color:#ae81ff">17490</span>,<span style="color:#ae81ff">7919</span>,<span style="color:#ae81ff">42137</span>,<span style="color:#ae81ff">70137</span>,<span style="color:#ae81ff">56196</span>,<span style="color:#ae81ff">54754</span>,<span style="color:#ae81ff">70263</span> );
...
<span style="color:#f92672">|</span> <span style="color:#ae81ff">116937151</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">68</span>da9462<span style="color:#f92672">-</span>c97e<span style="color:#f92672">-</span><span style="color:#ae81ff">11</span>e9<span style="color:#f92672">-</span>b92c<span style="color:#f92672">-</span><span style="color:#ae81ff">98039</span>bbd64c8 <span style="color:#f92672">|</span> <span style="color:#ae81ff">68</span>da9464<span style="color:#f92672">-</span>c97e<span style="color:#f92672">-</span><span style="color:#ae81ff">11</span>e9<span style="color:#f92672">-</span>b92c<span style="color:#f92672">-</span><span style="color:#ae81ff">98039</span>bbd64c8 <span style="color:#f92672">|</span> <span style="color:#ae81ff">68</span>da9466<span style="color:#f92672">-</span>c97e<span style="color:#f92672">-</span><span style="color:#ae81ff">11</span>e9<span style="color:#f92672">-</span>b92c<span style="color:#f92672">-</span><span style="color:#ae81ff">98039</span>bbd64c8 <span style="color:#f92672">|</span> <span style="color:#ae81ff">68</span>da9467<span style="color:#f92672">-</span>c97e<span style="color:#f92672">-</span><span style="color:#ae81ff">11</span>e9<span style="color:#f92672">-</span>b92c<span style="color:#f92672">-</span><span style="color:#ae81ff">98039</span>bbd64c8 <span style="color:#f92672">|</span> <span style="color:#ae81ff">68</span>da9469<span style="color:#f92672">-</span>c97e<span style="color:#f92672">-</span><span style="color:#ae81ff">11</span>e9<span style="color:#f92672">-</span>b92c<span style="color:#f92672">-</span><span style="color:#ae81ff">98039</span>bbd64c8 <span style="color:#f92672">|</span> <span style="color:#ae81ff">68</span>da946a<span style="color:#f92672">-</span>c97e<span style="color:#f92672">-</span><span style="color:#ae81ff">11</span>e9<span style="color:#f92672">-</span>b92c<span style="color:#f92672">-</span><span style="color:#ae81ff">98039</span>bbd64c8 <span style="color:#f92672">|</span> <span style="color:#ae81ff">68</span>da946c<span style="color:#f92672">-</span>c97e<span style="color:#f92672">-</span><span style="color:#ae81ff">11</span>e9<span style="color:#f92672">-</span>b92c<span style="color:#f92672">-</span><span style="color:#ae81ff">98039</span>bbd64c8 <span style="color:#f92672">|</span> <span style="color:#ae81ff">68</span>da946d<span style="color:#f92672">-</span>c97e<span style="color:#f92672">-</span><span style="color:#ae81ff">11</span>e9<span style="color:#f92672">-</span>b92c<span style="color:#f92672">-</span><span style="color:#ae81ff">98039</span>bbd64c8 <span style="color:#f92672">|</span> <span style="color:#ae81ff">68</span>da946f<span style="color:#f92672">-</span>c97e<span style="color:#f92672">-</span><span style="color:#ae81ff">11</span>e9<span style="color:#f92672">-</span>b92c<span style="color:#f92672">-</span><span style="color:#ae81ff">98039</span>bbd64c8 <span style="color:#f92672">|</span> <span style="color:#ae81ff">68</span>da9470<span style="color:#f92672">-</span>c97e<span style="color:#f92672">-</span><span style="color:#ae81ff">11</span>e9<span style="color:#f92672">-</span>b92c<span style="color:#f92672">-</span><span style="color:#ae81ff">98039</span>bbd64c8 <span style="color:#f92672">|</span> <span style="color:#ae81ff">56196</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">74380528</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">81571</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">57401</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">42293</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">39260</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">69425</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">29342</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">38434</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">4147</span> <span style="color:#f92672">|</span>
...
<span style="color:#ae81ff">15</span> rows <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>Yes, optimizer estimates can be a bit off. Still, the point is being
made: Cardinality is up, result set size is down, performance returns.</p>
<p>We have been looking at a result set size/selectivity problem, not at
sucky handling of SK in InnoDB.</p>


	
    </article>
</div>



            <footer>
    <p>
	&copy; Copyright 2021 Someone or something
    </p>
</footer>


        </main>

	





<script src="/js/bootstrap.js"></script>




<script src="/js/lunr.js"></script>





<script src="/js/app.js"></script>


    </body>
</html>
