<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Die wunderbare Welt von Isotopp - Gruppenweises TOP N in MySQL: Der Tabellengrößenreport</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="site.webmanifest">
<link rel="apple-touch-icon" href="icon.png">
<link rel="favicon.ico" rel="icon" type="image/ico">





	



<link rel="stylesheet" href="/style.min.c5e5cd61f54911f9aafd1dbe09c2f90667957bfe1002126c87aace57759f3446.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
	<a class="navbar-brand" href="" rel="home" title=".Site.Title">
	    Die wunderbare Welt von Isotopp
	</a>
	<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
	</button>

	<div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
		
		
		<li class="nav-item ">
                    <a class="nav-link" href="/about/">
			
			<span>About</span>
			<span class="visually-hidden">(Current)</span>
		    </a>
		    
		</li>
            </ul>
            
	</div>
    </div>
</nav>


        <main role="main" class="container-fluid">

            


<div class="page">
    <article class="gruppenweises-top-n-in-mysql-der-tabellengr%C3%B6%C3%9Fenreport-page">
	<h1 class="title">
            Gruppenweises TOP N in MySQL: Der Tabellengrößenreport
	</h1>

	<p>Jeder Datenbankserver bei uns hat ein Script laufen, daß den Inhalt von
information_schema.tables jede Nacht einmal in eine Systemdatenbank in das
DBA Schema kopiert. Dort haben wir dba.table_sizes:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">root<span style="color:#f92672">@</span>sysmdb [dba]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> table_sizes<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
       <span style="color:#66d9ef">Table</span>: table_sizes
<span style="color:#66d9ef">Create</span> <span style="color:#66d9ef">Table</span>: <span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#f92672">`</span>table_sizes<span style="color:#f92672">`</span> (
  <span style="color:#f92672">`</span>hostname<span style="color:#f92672">`</span> varchar(<span style="color:#ae81ff">64</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>datadir<span style="color:#f92672">`</span> varchar(<span style="color:#ae81ff">64</span>) CHARACTER <span style="color:#66d9ef">SET</span> latin1 <span style="color:#66d9ef">COLLATE</span> latin1_bin <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>report_date<span style="color:#f92672">`</span> date <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>table_schema<span style="color:#f92672">`</span> varchar(<span style="color:#ae81ff">64</span>) CHARACTER <span style="color:#66d9ef">SET</span> latin1 <span style="color:#66d9ef">COLLATE</span> latin1_bin <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span><span style="color:#66d9ef">table_name</span><span style="color:#f92672">`</span> varchar(<span style="color:#ae81ff">64</span>) CHARACTER <span style="color:#66d9ef">SET</span> latin1 <span style="color:#66d9ef">COLLATE</span> latin1_bin <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>engine<span style="color:#f92672">`</span> varchar(<span style="color:#ae81ff">64</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>data_length<span style="color:#f92672">`</span> bigint(<span style="color:#ae81ff">20</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>index_length<span style="color:#f92672">`</span> bigint(<span style="color:#ae81ff">20</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>table_rows<span style="color:#f92672">`</span> bigint(<span style="color:#ae81ff">20</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#66d9ef">UNIQUE</span> <span style="color:#66d9ef">KEY</span> <span style="color:#f92672">`</span>hostname<span style="color:#f92672">`</span> (<span style="color:#f92672">`</span>hostname<span style="color:#f92672">`</span>,<span style="color:#f92672">`</span>datadir<span style="color:#f92672">`</span>,<span style="color:#f92672">`</span>report_date<span style="color:#f92672">`</span>,<span style="color:#f92672">`</span>table_schema<span style="color:#f92672">`</span>,<span style="color:#f92672">`</span><span style="color:#66d9ef">table_name</span><span style="color:#f92672">`</span>)
) ENGINE<span style="color:#f92672">=</span>InnoDB <span style="color:#66d9ef">DEFAULT</span> CHARSET<span style="color:#f92672">=</span>latin1
<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>Gesucht war nun eine Query, die für jeden Sonntag eine Liste der 10 größten
Tabellen eines bestimmten Servers &lsquo;master&rsquo; für 2010 produziert.</p>
<p>Die Lösung ist fragil insofern, als daß sie eine undokumentierte Eigenschaft
des Servers ausnutzt. Aber sie ist auch schnell.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">set</span> <span style="color:#f92672">@</span><span style="color:#66d9ef">old</span> :<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#f92672">@</span><span style="color:#66d9ef">count</span> :<span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; 
<span style="color:#66d9ef">select</span> <span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> (
  <span style="color:#66d9ef">select</span> 
    <span style="color:#f92672">@</span><span style="color:#66d9ef">count</span> :<span style="color:#f92672">=</span> <span style="color:#66d9ef">if</span>(<span style="color:#f92672">@</span><span style="color:#66d9ef">old</span> <span style="color:#f92672">&lt;=&gt;</span> report_date, <span style="color:#f92672">@</span><span style="color:#66d9ef">count</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">c</span>, 
    <span style="color:#f92672">@</span><span style="color:#66d9ef">old</span>   :<span style="color:#f92672">=</span> report_date <span style="color:#66d9ef">as</span> report_date,
    hostname, 
    <span style="color:#66d9ef">table_name</span>, 
    (data_length<span style="color:#f92672">+</span>index_length)<span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span> <span style="color:#66d9ef">as</span> gb 
  <span style="color:#66d9ef">from</span> 
    table_sizes 
  <span style="color:#66d9ef">where</span>
    date_format(report_date, <span style="color:#e6db74">&#39;%W&#39;</span>) <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Sunday&#39;</span> <span style="color:#66d9ef">and</span> 
    report_date <span style="color:#f92672">&gt;</span> <span style="color:#e6db74">&#39;2010-01-01&#39;</span> <span style="color:#66d9ef">and</span>
    hostname <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;master&#39;</span> <span style="color:#66d9ef">and</span> 
    datadir <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/mysql/bp/data/&#39;</span> <span style="color:#66d9ef">and</span>
    table_schema <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;bp&#39;</span> 
  <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> 
    report_date, gb <span style="color:#66d9ef">desc</span> 
  ) <span style="color:#66d9ef">as</span> t 
<span style="color:#66d9ef">where</span> 
  t.<span style="color:#66d9ef">c</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">10</span>
;
</code></pre></div><p>Wir definieren einen Zustandsspeicher @old, der das report_date der
folgenden Zeile speichert und einen Zähler @count. Sessionvariablen (die
@-Variablen da) haben einen impliziten Typ, und @old verhält sich anders
(falsch), wenn es mit 0 initalisiert wird.</p>
<p>Im inneren SELECT zählen wir @count um eins hoch, wenn report_date sich
nicht ändert, oder setzen es auf 0, wenn report_date sich geändert hat. Der
&lt;=&gt;-Operator ist dabei failsafe gegenüber NULL-Werten. Danach, und das ist
wichtig, aktualisieren wir @old mit dem aktuellen report_date, und danach
geben wir die Werte aus, an denen wir interessiert sind. Die WHERE-Clause
der inneren Query wählt dabei die Daten aus, an denen wir interessiert sind:
Sonntage aus 2010, Daten vom Master, von der Instanz mit dem passenden
datadir, und dort aus dem passenden Schema. Das sortieren wir dann.</p>
<p>Die Ausgabe hat nun eine laufende Nummer c, die aus dem Hochzählen von
@count resultiert. Dieser Zähler wird an report_date-Wechseln zurückgesetzt.
Mit der äußeren Query schneiden wir nun alle Werte ab, bei denen der Zähler
zu hoch ist.</p>
<p>Die Query ist fragil, und ein übler Hack, da sie auf der internen
Ausführungsreihenfolge des SQL-Statements basiert. Sie kann bei jedem
Upgrade des Servers plötzlich fehlschlagen, weil sich Serverinterna ändern.</p>


	
    </article>
</div>



            <footer>
    <p>
	&copy; Copyright 2021 Someone or something
    </p>
</footer>


        </main>

	





<script src="/js/bootstrap.js"></script>




<script src="/js/lunr.js"></script>





<script src="/js/app.js"></script>


    </body>
</html>
