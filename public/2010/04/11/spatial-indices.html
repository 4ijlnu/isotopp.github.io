<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Die wunderbare Welt von Isotopp - Spatial Indices</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="site.webmanifest">
<link rel="apple-touch-icon" href="icon.png">
<link rel="favicon.ico" rel="icon" type="image/ico">





	



<link rel="stylesheet" href="/style.min.c5e5cd61f54911f9aafd1dbe09c2f90667957bfe1002126c87aace57759f3446.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
	<a class="navbar-brand" href="" rel="home" title=".Site.Title">
	    Die wunderbare Welt von Isotopp
	</a>
	<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
	</button>

	<div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
		
		
		<li class="nav-item ">
                    <a class="nav-link" href="/about/">
			
			<span>About</span>
			<span class="visually-hidden">(Current)</span>
		    </a>
		    
		</li>
            </ul>
            
	</div>
    </div>
</nav>


        <main role="main" class="container-fluid">

            


<div class="page">
    <article class="spatial-indices-page">
	<h1 class="title">
            Spatial Indices
	</h1>

	<p>On 2010-04-06 12:26:49 +0200,
<a href="http://groups.google.com/group/de.comp.datenbanken.mysql/msg/a7f1b9043c202ef1?hl=de&amp;dmode=source&amp;output=gplain" target="_blank" rel="noopener">Egon Schmid</a>

 said:</p>
<blockquote>
<p>Ich hab eine 60 MB grosse SQL-Datei von der OpenGeoDB
(-&gt;http://fa-technik.adfc.de/code/opengeodb/) runtergeladen, wo sämtliche
Informationen der Deutschlandkarte vorhanden sind, und werde es damit mal
testen.Das Ausführen der INSERTs dauert allerdings einige Stunden :) Es
läuft derzeit immer noch&hellip;</p>
</blockquote>
<p>InnoDB, AUTOCOMMIT = 1. Vor dem source von DE.sql ein BEGIN WORK machen, danach
ein COMMIT. Dann geht es sehr viel schneller.</p>
<p>Mit diesen Daten und einem Beispielort kann man experimentieren.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">root<span style="color:#f92672">@</span>localhost [geodb]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> 
    td.loc_id, td.text_val, tn.name 
<span style="color:#66d9ef">from</span> 
   geodb_textdata <span style="color:#66d9ef">as</span> td <span style="color:#66d9ef">join</span> 
   geodb_type_names <span style="color:#66d9ef">as</span> tn <span style="color:#66d9ef">on</span> 
       td.text_type <span style="color:#f92672">=</span> tn.type_id 
<span style="color:#66d9ef">where</span>
   td.text_val <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Kiel&#39;</span> <span style="color:#66d9ef">and</span> 
   tn.name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Name&#39;</span>;
<span style="color:#f92672">+</span><span style="color:#75715e">--------+----------+------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> loc_id <span style="color:#f92672">|</span> text_val <span style="color:#f92672">|</span> name <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------+----------+------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span>    <span style="color:#ae81ff">469</span> <span style="color:#f92672">|</span> Kiel     <span style="color:#f92672">|</span> Name <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">19236</span> <span style="color:#f92672">|</span> Kiel     <span style="color:#f92672">|</span> Name <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------+----------+------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">2</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>Zum Beispiel finden wir mal alles, was um den Beispielort herum liegt:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">root<span style="color:#f92672">@</span>localhost [geodb]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">explain</span> <span style="color:#66d9ef">select</span> 
    co.loc_id, td.text_val 
<span style="color:#66d9ef">from</span> 
    geodb_coordinates <span style="color:#66d9ef">as</span> co <span style="color:#66d9ef">join</span> 
    geodb_textdata <span style="color:#66d9ef">as</span> td <span style="color:#66d9ef">on</span> 
        co.loc_id <span style="color:#f92672">=</span> td.loc_id <span style="color:#66d9ef">join</span> 
    geodb_type_names <span style="color:#66d9ef">as</span> tn <span style="color:#66d9ef">on</span> 
        td.text_type <span style="color:#f92672">=</span> tn.type_id 
<span style="color:#66d9ef">where</span> 
    lat <span style="color:#f92672">=</span> <span style="color:#ae81ff">54</span>.<span style="color:#ae81ff">3333</span> <span style="color:#66d9ef">and</span> 
    lon <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>.<span style="color:#ae81ff">1333</span> <span style="color:#66d9ef">and</span> 
    tn.name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Name&#39;</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
<span style="color:#f92672">===</span> <span style="color:#ae81ff">1</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">===</span>
           id: <span style="color:#ae81ff">1</span>
  select_type: <span style="color:#66d9ef">SIMPLE</span>
        <span style="color:#66d9ef">table</span>: co
         <span style="color:#66d9ef">type</span>: index_merge
possible_keys: coord_loc_id_idx,coord_lon_idx,coord_lat_idx
          <span style="color:#66d9ef">key</span>: coord_lat_idx,coord_lon_idx
      key_len: <span style="color:#ae81ff">9</span>,<span style="color:#ae81ff">9</span>
          <span style="color:#66d9ef">ref</span>: <span style="color:#66d9ef">NULL</span>
         <span style="color:#66d9ef">rows</span>: <span style="color:#ae81ff">1</span>
        Extra: <span style="color:#66d9ef">Using</span> <span style="color:#66d9ef">intersect</span>(coord_lat_idx,coord_lon_idx); <span style="color:#66d9ef">Using</span> <span style="color:#66d9ef">where</span>
<span style="color:#f92672">===</span> <span style="color:#ae81ff">2</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">===</span>
           id: <span style="color:#ae81ff">1</span>
  select_type: <span style="color:#66d9ef">SIMPLE</span>
        <span style="color:#66d9ef">table</span>: tn
         <span style="color:#66d9ef">type</span>: <span style="color:#66d9ef">ref</span>
possible_keys: type_id,tid_tnames_idx,name_tnames_idx
          <span style="color:#66d9ef">key</span>: name_tnames_idx
      key_len: <span style="color:#ae81ff">767</span>
          <span style="color:#66d9ef">ref</span>: const
         <span style="color:#66d9ef">rows</span>: <span style="color:#ae81ff">1</span>
        Extra: <span style="color:#66d9ef">Using</span> <span style="color:#66d9ef">where</span>; <span style="color:#66d9ef">Using</span> <span style="color:#66d9ef">index</span>
<span style="color:#f92672">===</span> <span style="color:#ae81ff">3</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">===</span>
           id: <span style="color:#ae81ff">1</span>
  select_type: <span style="color:#66d9ef">SIMPLE</span>
        <span style="color:#66d9ef">table</span>: td
         <span style="color:#66d9ef">type</span>: <span style="color:#66d9ef">ref</span>
possible_keys: text_lid_idx,text_type_idx
          <span style="color:#66d9ef">key</span>: text_lid_idx
      key_len: <span style="color:#ae81ff">4</span>
          <span style="color:#66d9ef">ref</span>: geodb.co.loc_id
         <span style="color:#66d9ef">rows</span>: <span style="color:#ae81ff">2344</span>
        Extra: <span style="color:#66d9ef">Using</span> <span style="color:#66d9ef">where</span>
<span style="color:#ae81ff">3</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>Wie man sieht wird ein index_merge (intersect) verwendet, wenn man mit
festen Koordinaten arbeitet. Hier das Ergebnis:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">root<span style="color:#f92672">@</span>localhost [geodb]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span>
    co.loc_id, td.text_val 
<span style="color:#66d9ef">from</span> 
    geodb_coordinates <span style="color:#66d9ef">as</span> co <span style="color:#66d9ef">join</span> 
    geodb_textdata <span style="color:#66d9ef">as</span> td <span style="color:#66d9ef">on</span> 
        co.loc_id <span style="color:#f92672">=</span> td.loc_id <span style="color:#66d9ef">join</span>
    geodb_type_names <span style="color:#66d9ef">as</span> tn 
        <span style="color:#66d9ef">on</span> td.text_type <span style="color:#f92672">=</span> tn.type_id 
<span style="color:#66d9ef">where</span>
    lat <span style="color:#f92672">=</span> <span style="color:#ae81ff">54</span>.<span style="color:#ae81ff">3333</span> <span style="color:#66d9ef">and</span> 
    lon <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>.<span style="color:#ae81ff">1333</span> <span style="color:#66d9ef">and</span> 
    tn.name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Name&#39;</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
<span style="color:#f92672">===</span> <span style="color:#ae81ff">1</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">===</span>
  loc_id: <span style="color:#ae81ff">469</span>
text_val: Kiel
<span style="color:#f92672">===</span> <span style="color:#ae81ff">2</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">===</span>
  loc_id: <span style="color:#ae81ff">19236</span>
text_val: Kiel
....
<span style="color:#f92672">===</span> <span style="color:#ae81ff">13</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">===</span>
  loc_id: <span style="color:#ae81ff">106031</span>
text_val: Wik
<span style="color:#ae81ff">13</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">01</span> sec)
</code></pre></div><p>Eine Umkreissuche (BETWEEN) sieht wesentlich schlechter aus - Axel Schwenke
hat das ja bereits erläutert - der Index-Merge funktioniert derzeit nur bei
Konstanten:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">root<span style="color:#f92672">@</span>localhost [geodb]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">explain</span> <span style="color:#66d9ef">select</span> 
    co.loc_id, td.text_val 
<span style="color:#66d9ef">from</span> 
    geodb_coordinates <span style="color:#66d9ef">as</span> co <span style="color:#66d9ef">join</span> 
    geodb_textdata <span style="color:#66d9ef">as</span> td <span style="color:#66d9ef">on</span> 
        co.loc_id <span style="color:#f92672">=</span> td.loc_id <span style="color:#66d9ef">join</span> 
    geodb_type_names <span style="color:#66d9ef">as</span> tn <span style="color:#66d9ef">on</span> 
        td.text_type <span style="color:#f92672">=</span> tn.type_id 
<span style="color:#66d9ef">where</span> 
    lat <span style="color:#66d9ef">between</span> <span style="color:#ae81ff">54</span>.<span style="color:#ae81ff">3</span> <span style="color:#66d9ef">and</span> <span style="color:#ae81ff">54</span>.<span style="color:#ae81ff">4</span> <span style="color:#66d9ef">and</span> 
    lon <span style="color:#66d9ef">between</span> <span style="color:#ae81ff">10</span>.<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">and</span> <span style="color:#ae81ff">10</span>.<span style="color:#ae81ff">2</span> <span style="color:#66d9ef">and</span> 
    tn.name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Name&#39;</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
<span style="color:#f92672">===</span> <span style="color:#ae81ff">1</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">===</span>
           id: <span style="color:#ae81ff">1</span>
  select_type: <span style="color:#66d9ef">SIMPLE</span>
        <span style="color:#66d9ef">table</span>: tn
         <span style="color:#66d9ef">type</span>: <span style="color:#66d9ef">ref</span>
possible_keys: type_id,tid_tnames_idx,name_tnames_idx
          <span style="color:#66d9ef">key</span>: name_tnames_idx
      key_len: <span style="color:#ae81ff">767</span>
          <span style="color:#66d9ef">ref</span>: const
         <span style="color:#66d9ef">rows</span>: <span style="color:#ae81ff">1</span>
        Extra: <span style="color:#66d9ef">Using</span> <span style="color:#66d9ef">where</span>; <span style="color:#66d9ef">Using</span> <span style="color:#66d9ef">index</span>
<span style="color:#f92672">===</span> <span style="color:#ae81ff">2</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">===</span>
           id: <span style="color:#ae81ff">1</span>
  select_type: <span style="color:#66d9ef">SIMPLE</span>
        <span style="color:#66d9ef">table</span>: td
         <span style="color:#66d9ef">type</span>: <span style="color:#66d9ef">ref</span>
possible_keys: text_lid_idx,text_type_idx
          <span style="color:#66d9ef">key</span>: text_type_idx
      key_len: <span style="color:#ae81ff">4</span>
          <span style="color:#66d9ef">ref</span>: geodb.tn.type_id
         <span style="color:#66d9ef">rows</span>: <span style="color:#ae81ff">2344</span>
        Extra: 
<span style="color:#f92672">===</span> <span style="color:#ae81ff">3</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">===</span>
           id: <span style="color:#ae81ff">1</span>
  select_type: <span style="color:#66d9ef">SIMPLE</span>
        <span style="color:#66d9ef">table</span>: co
         <span style="color:#66d9ef">type</span>: <span style="color:#66d9ef">ref</span>
possible_keys: coord_loc_id_idx,coord_lon_idx,coord_lat_idx
          <span style="color:#66d9ef">key</span>: coord_loc_id_idx
      key_len: <span style="color:#ae81ff">4</span>
          <span style="color:#66d9ef">ref</span>: geodb.td.loc_id
         <span style="color:#66d9ef">rows</span>: <span style="color:#ae81ff">303</span>
        Extra: <span style="color:#66d9ef">Using</span> <span style="color:#66d9ef">where</span>
<span style="color:#ae81ff">3</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>Hier die Laufzeit:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">root<span style="color:#f92672">@</span>localhost [geodb]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> 
    co.loc_id, td.text_val
<span style="color:#66d9ef">from</span> 
    geodb_coordinates <span style="color:#66d9ef">as</span> co <span style="color:#66d9ef">join</span> 
    geodb_textdata <span style="color:#66d9ef">as</span> td <span style="color:#66d9ef">on</span> 
        co.loc_id <span style="color:#f92672">=</span> td.loc_id <span style="color:#66d9ef">join</span> 
    geodb_type_names <span style="color:#66d9ef">as</span> tn <span style="color:#66d9ef">on</span> 
        td.text_type <span style="color:#f92672">=</span> tn.type_id 
<span style="color:#66d9ef">where</span>
    lat <span style="color:#66d9ef">between</span> <span style="color:#ae81ff">54</span>.<span style="color:#ae81ff">3</span> <span style="color:#66d9ef">and</span> <span style="color:#ae81ff">54</span>.<span style="color:#ae81ff">4</span> <span style="color:#66d9ef">and</span> 
    lon <span style="color:#66d9ef">between</span> <span style="color:#ae81ff">10</span>.<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">and</span> <span style="color:#ae81ff">10</span>.<span style="color:#ae81ff">2</span> <span style="color:#66d9ef">and</span> 
    tn.name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Name&#39;</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
<span style="color:#f92672">===</span> <span style="color:#ae81ff">1</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">===</span>
  loc_id: <span style="color:#ae81ff">469</span>
text_val: Kiel
<span style="color:#f92672">===</span> <span style="color:#ae81ff">2</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">===</span>
  loc_id: <span style="color:#ae81ff">19236</span>
text_val: Kiel
....
<span style="color:#f92672">===</span> <span style="color:#ae81ff">30</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">===</span>
  loc_id: <span style="color:#ae81ff">106953</span>
text_val: Rammsee
<span style="color:#ae81ff">30</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">50</span> sec)
</code></pre></div><p>Wir können versuchen, mit einem RTREE dabei zu gehen. Dazu brauchen wir die
Daten in MyISAM:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">root<span style="color:#f92672">@</span>localhost [geodb]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> co 
    <span style="color:#66d9ef">like</span> geodb_coordinates;
Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">18</span> sec)

root<span style="color:#f92672">@</span>localhost [geodb]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">alter</span> <span style="color:#66d9ef">table</span> co engine <span style="color:#f92672">=</span> myisam;
Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">18</span> sec)
Records: <span style="color:#ae81ff">0</span>  Duplicates: <span style="color:#ae81ff">0</span>  Warnings: <span style="color:#ae81ff">0</span>

root<span style="color:#f92672">@</span>localhost [geodb]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> co <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> geodb_coordinates;
Query OK, <span style="color:#ae81ff">60645</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">50</span> sec)
Records: <span style="color:#ae81ff">60645</span>  Duplicates: <span style="color:#ae81ff">0</span>  Warnings: <span style="color:#ae81ff">0</span>
</code></pre></div><p>Wir müssen außerdem eine Spalte latlon als POINT anlegen und einen SPATIAL index auf diesen Point setzen:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">root<span style="color:#f92672">@</span>localhost [geodb]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">alter</span> <span style="color:#66d9ef">table</span> co 
     <span style="color:#66d9ef">add</span> <span style="color:#66d9ef">column</span> latlon point <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span>, 
     <span style="color:#66d9ef">add</span> spatial <span style="color:#66d9ef">index</span> (latlon);
Query OK, <span style="color:#ae81ff">60645</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">83</span> sec)
Records: <span style="color:#ae81ff">60645</span>  Duplicates: <span style="color:#ae81ff">0</span>  Warnings: <span style="color:#ae81ff">0</span>
</code></pre></div><p>Die lat und lon Daten müssen nach latlon konvertiert werden:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#75715e">-- 5.1.35 or later
</span><span style="color:#75715e"></span>root<span style="color:#f92672">@</span>localhost [geodb]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">update</span> co 
    <span style="color:#66d9ef">set</span> latlon <span style="color:#f92672">=</span> point(lat, lon);
Query OK, <span style="color:#ae81ff">60645</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">1</span>.<span style="color:#ae81ff">45</span> sec)
<span style="color:#66d9ef">Rows</span> matched: <span style="color:#ae81ff">60645</span>  Changed: <span style="color:#ae81ff">60645</span>  Warnings: <span style="color:#ae81ff">0</span>
<span style="color:#75715e">-- older MySQL: update co 
</span><span style="color:#75715e">--     set latlon = GeomFromText(concat(&#39;Point(&#39;, lat,&#39;,&#39;,lon)));
</span></code></pre></div><p>Ein kleiner Test:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">root<span style="color:#f92672">@</span>localhost [geodb]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> 
    astext(latlon)
<span style="color:#66d9ef">from</span> 
    co 
<span style="color:#66d9ef">limit</span> <span style="color:#ae81ff">10</span>;
<span style="color:#f92672">+</span><span style="color:#75715e">------------------------------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> astext(latlon)                           <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">------------------------------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> POINT(<span style="color:#ae81ff">54</span>.<span style="color:#ae81ff">7833</span> <span style="color:#ae81ff">9</span>.<span style="color:#ae81ff">43333</span>)                   <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> POINT(<span style="color:#ae81ff">54</span>.<span style="color:#ae81ff">7833</span> <span style="color:#ae81ff">9</span>.<span style="color:#ae81ff">43333</span>)                   <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> POINT(<span style="color:#ae81ff">54</span>.<span style="color:#ae81ff">3333</span> <span style="color:#ae81ff">10</span>.<span style="color:#ae81ff">1333</span>)                   <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> POINT(<span style="color:#ae81ff">54</span>.<span style="color:#ae81ff">3333</span> <span style="color:#ae81ff">10</span>.<span style="color:#ae81ff">1333</span>)                   <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> POINT(<span style="color:#ae81ff">53</span>.<span style="color:#ae81ff">8667</span> <span style="color:#ae81ff">10</span>.<span style="color:#ae81ff">7</span>)                      <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> POINT(<span style="color:#ae81ff">53</span>.<span style="color:#ae81ff">8667</span> <span style="color:#ae81ff">10</span>.<span style="color:#ae81ff">7</span>)                      <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> POINT(<span style="color:#ae81ff">54</span>.<span style="color:#ae81ff">0667</span> <span style="color:#ae81ff">9</span>.<span style="color:#ae81ff">98333</span>)                   <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> POINT(<span style="color:#ae81ff">54</span>.<span style="color:#ae81ff">0667</span> <span style="color:#ae81ff">9</span>.<span style="color:#ae81ff">98333</span>)                   <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> POINT(<span style="color:#ae81ff">54</span>.<span style="color:#ae81ff">1474367521367</span> <span style="color:#ae81ff">9</span>.<span style="color:#ae81ff">11139581196581</span>) <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> POINT(<span style="color:#ae81ff">54</span>.<span style="color:#ae81ff">15</span> <span style="color:#ae81ff">9</span>.<span style="color:#ae81ff">28333</span>)                     <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">------------------------------------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">10</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">02</span> sec)
</code></pre></div><p>Die Tabelle sieht jetzt so aus:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">root<span style="color:#f92672">@</span>localhost [geodb]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> co<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
<span style="color:#f92672">===</span> <span style="color:#ae81ff">1</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">===</span>
       <span style="color:#66d9ef">Table</span>: co
<span style="color:#66d9ef">Create</span> <span style="color:#66d9ef">Table</span>: <span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#f92672">`</span>co<span style="color:#f92672">`</span> (
  <span style="color:#f92672">`</span>loc_id<span style="color:#f92672">`</span> int(<span style="color:#ae81ff">11</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>coord_type<span style="color:#f92672">`</span> int(<span style="color:#ae81ff">11</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>lat<span style="color:#f92672">`</span> double <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>lon<span style="color:#f92672">`</span> double <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>coord_subtype<span style="color:#f92672">`</span> int(<span style="color:#ae81ff">11</span>) <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>valid_since<span style="color:#f92672">`</span> date <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>date_type_since<span style="color:#f92672">`</span> int(<span style="color:#ae81ff">11</span>) <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>valid_until<span style="color:#f92672">`</span> date <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>date_type_until<span style="color:#f92672">`</span> int(<span style="color:#ae81ff">11</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>latlon<span style="color:#f92672">`</span> point <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#66d9ef">KEY</span> <span style="color:#f92672">`</span>coord_loc_id_idx<span style="color:#f92672">`</span> (<span style="color:#f92672">`</span>loc_id<span style="color:#f92672">`</span>),
  <span style="color:#66d9ef">KEY</span> <span style="color:#f92672">`</span>coord_lon_idx<span style="color:#f92672">`</span> (<span style="color:#f92672">`</span>lon<span style="color:#f92672">`</span>),
  <span style="color:#66d9ef">KEY</span> <span style="color:#f92672">`</span>coord_lat_idx<span style="color:#f92672">`</span> (<span style="color:#f92672">`</span>lat<span style="color:#f92672">`</span>),
  <span style="color:#66d9ef">KEY</span> <span style="color:#f92672">`</span>coord_type_idx<span style="color:#f92672">`</span> (<span style="color:#f92672">`</span>coord_type<span style="color:#f92672">`</span>),
  <span style="color:#66d9ef">KEY</span> <span style="color:#f92672">`</span>coord_stype_idx<span style="color:#f92672">`</span> (<span style="color:#f92672">`</span>coord_subtype<span style="color:#f92672">`</span>),
  <span style="color:#66d9ef">KEY</span> <span style="color:#f92672">`</span>coord_since_idx<span style="color:#f92672">`</span> (<span style="color:#f92672">`</span>valid_since<span style="color:#f92672">`</span>),
  <span style="color:#66d9ef">KEY</span> <span style="color:#f92672">`</span>coord_until_idx<span style="color:#f92672">`</span> (<span style="color:#f92672">`</span>valid_until<span style="color:#f92672">`</span>),
  SPATIAL <span style="color:#66d9ef">KEY</span> <span style="color:#f92672">`</span>latlon<span style="color:#f92672">`</span> (<span style="color:#f92672">`</span>latlon<span style="color:#f92672">`</span>)
) ENGINE<span style="color:#f92672">=</span>MyISAM <span style="color:#66d9ef">DEFAULT</span> CHARSET<span style="color:#f92672">=</span>utf8
<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>Wir definieren unseren Suchumkreis einmal als @poly Variable. Danach wird
einiges einfacher:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">root<span style="color:#f92672">@</span>localhost [geodb]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">set</span> <span style="color:#f92672">@</span>poly <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Polygon((54.3 10.1, 54.4 10.1, 54.4 10.2,54.3 10.2, 54.3 10.1 ))&#39;</span>;
Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>Wird unser SPATIAL Index denn auch verwendet? Wir testen:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">root<span style="color:#f92672">@</span>localhost [geodb]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">explain</span> <span style="color:#66d9ef">select</span> 
    co.loc_id 
<span style="color:#66d9ef">from</span> 
    co
<span style="color:#66d9ef">where</span>
    mbrcontains(geomfromtext(<span style="color:#f92672">@</span>poly), co.latlon)<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
<span style="color:#f92672">===</span> <span style="color:#ae81ff">1</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">===</span>
           id: <span style="color:#ae81ff">1</span>
  select_type: <span style="color:#66d9ef">SIMPLE</span>
        <span style="color:#66d9ef">table</span>: co
         <span style="color:#66d9ef">type</span>: range
possible_keys: latlon
          <span style="color:#66d9ef">key</span>: latlon
      key_len: <span style="color:#ae81ff">34</span>
          <span style="color:#66d9ef">ref</span>: <span style="color:#66d9ef">NULL</span>
         <span style="color:#66d9ef">rows</span>: <span style="color:#ae81ff">11</span>
        Extra: <span style="color:#66d9ef">Using</span> <span style="color:#66d9ef">where</span>
<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>In der richtigen Suche müssen wir einen STRAIGHT_JOIN forcen, weil sonst die
Join-Order und die Indexverwendung nicht stimmt:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">root<span style="color:#f92672">@</span>localhost [geodb]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">explain</span> <span style="color:#66d9ef">select</span> straight_join 
    co.loc_id, td.text_val 
<span style="color:#66d9ef">from</span> 
    co <span style="color:#66d9ef">as</span> co <span style="color:#66d9ef">join</span> 
    geodb_textdata <span style="color:#66d9ef">as</span> td 
        <span style="color:#66d9ef">on</span> co.loc_id <span style="color:#f92672">=</span> td.loc_id <span style="color:#66d9ef">join</span> 
    geodb_type_names <span style="color:#66d9ef">as</span> tn <span style="color:#66d9ef">on</span> 
        td.text_type <span style="color:#f92672">=</span> tn.type_id
<span style="color:#66d9ef">where</span> 
    tn.name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Name&#39;</span> <span style="color:#66d9ef">and</span> 
    mbrcontains(geomfromtext(<span style="color:#f92672">@</span>poly), co.latlon)<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
<span style="color:#f92672">===</span> <span style="color:#ae81ff">1</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">===</span>
           id: <span style="color:#ae81ff">1</span>
  select_type: <span style="color:#66d9ef">SIMPLE</span>
        <span style="color:#66d9ef">table</span>: co
         <span style="color:#66d9ef">type</span>: range
possible_keys: coord_loc_id_idx,latlon
          <span style="color:#66d9ef">key</span>: latlon
      key_len: <span style="color:#ae81ff">34</span>
          <span style="color:#66d9ef">ref</span>: <span style="color:#66d9ef">NULL</span>
         <span style="color:#66d9ef">rows</span>: <span style="color:#ae81ff">11</span>
        Extra: <span style="color:#66d9ef">Using</span> <span style="color:#66d9ef">where</span>
<span style="color:#f92672">===</span> <span style="color:#ae81ff">2</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">===</span>
           id: <span style="color:#ae81ff">1</span>
  select_type: <span style="color:#66d9ef">SIMPLE</span>
        <span style="color:#66d9ef">table</span>: td
         <span style="color:#66d9ef">type</span>: <span style="color:#66d9ef">ref</span>
possible_keys: text_lid_idx,text_type_idx
          <span style="color:#66d9ef">key</span>: text_lid_idx
      key_len: <span style="color:#ae81ff">4</span>
          <span style="color:#66d9ef">ref</span>: geodb.co.loc_id
         <span style="color:#66d9ef">rows</span>: <span style="color:#ae81ff">2344</span>
        Extra: 
<span style="color:#f92672">===</span> <span style="color:#ae81ff">3</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">===</span>
           id: <span style="color:#ae81ff">1</span>
  select_type: <span style="color:#66d9ef">SIMPLE</span>
        <span style="color:#66d9ef">table</span>: tn
         <span style="color:#66d9ef">type</span>: <span style="color:#66d9ef">ref</span>
possible_keys: type_id,tid_tnames_idx,name_tnames_idx
          <span style="color:#66d9ef">key</span>: type_id
      key_len: <span style="color:#ae81ff">4</span>
          <span style="color:#66d9ef">ref</span>: geodb.td.text_type
         <span style="color:#66d9ef">rows</span>: <span style="color:#ae81ff">1</span>
        Extra: <span style="color:#66d9ef">Using</span> <span style="color:#66d9ef">where</span>
<span style="color:#ae81ff">3</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>Und hier die Ausgabe:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">root<span style="color:#f92672">@</span>localhost [geodb]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> straight_join 
    co.loc_id, td.text_val
<span style="color:#66d9ef">from</span> 
    co <span style="color:#66d9ef">as</span> co <span style="color:#66d9ef">join</span>
    geodb_textdata <span style="color:#66d9ef">as</span> td <span style="color:#66d9ef">on</span>
        co.loc_id <span style="color:#f92672">=</span> td.loc_id <span style="color:#66d9ef">join</span> 
    geodb_type_names <span style="color:#66d9ef">as</span> tn <span style="color:#66d9ef">on</span> 
        td.text_type <span style="color:#f92672">=</span> tn.type_id 
<span style="color:#66d9ef">where</span> 
    tn.name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Name&#39;</span> <span style="color:#66d9ef">and</span> 
    mbrcontains(geomfromtext(<span style="color:#f92672">@</span>poly), co.latlon)<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
<span style="color:#f92672">===</span> <span style="color:#ae81ff">1</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">===</span>
  loc_id: <span style="color:#ae81ff">18070</span>
text_val: Heikendorf
<span style="color:#f92672">===</span> <span style="color:#ae81ff">2</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">===</span>
  loc_id: <span style="color:#ae81ff">21024</span>
text_val: Mönkeberg
...
<span style="color:#f92672">===</span> <span style="color:#ae81ff">30</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">===</span>
  loc_id: <span style="color:#ae81ff">19236</span>
text_val: Kiel
<span style="color:#ae81ff">30</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div>

	
    </article>
</div>



            <footer>
    <p>
	&copy; Copyright 2021 Someone or something
    </p>
</footer>


        </main>

	





<script src="/js/bootstrap.js"></script>




<script src="/js/lunr.js"></script>





<script src="/js/app.js"></script>


    </body>
</html>
