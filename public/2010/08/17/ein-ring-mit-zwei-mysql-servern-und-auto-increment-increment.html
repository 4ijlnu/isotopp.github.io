<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Die wunderbare Welt von Isotopp - Ein Ring mit zwei MySQL-Servern und auto_increment_increment</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="site.webmanifest">
<link rel="apple-touch-icon" href="icon.png">
<link rel="favicon.ico" rel="icon" type="image/ico">





	



<link rel="stylesheet" href="/style.min.c5e5cd61f54911f9aafd1dbe09c2f90667957bfe1002126c87aace57759f3446.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
	<a class="navbar-brand" href="" rel="home" title=".Site.Title">
	    Die wunderbare Welt von Isotopp
	</a>
	<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
	</button>

	<div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
		
		
		<li class="nav-item ">
                    <a class="nav-link" href="/about/">
			
			<span>About</span>
			<span class="visually-hidden">(Current)</span>
		    </a>
		    
		</li>
            </ul>
            
	</div>
    </div>
</nav>


        <main role="main" class="container-fluid">

            


<div class="page">
    <article class="ein-ring-mit-zwei-mysql-servern-und-auto_increment_increment-page">
	<h1 class="title">
            Ein Ring mit zwei MySQL-Servern und auto_increment_increment
	</h1>

	<p>Lalufu fragte in den Kommentaren von
[Master-Master]({% link _posts/2010-08-16-master-master-und-distributed-transactions.md %}):</p>
<blockquote>
<p>Ich habe eine MM-Replikation mit zwei Servern.</p>
<p>Beide haben auto_increment_increment=10,</p>
<p>Server A hat auto_increment_offset=0 und Server B hat
auto_increment_offset=1.</p>
<p>Ich lege mir eine Tabelle mit einem auto_increment-Feld (id) an und mache
auf Server A einen INSERT, dann kriegt die row id=0, und wird auf B
repliziert, richtig?</p>
<p>Dann noch einen INSERT auf A, die row kriegt id=10, und wird auf B
repliziert.Wenn ich jetzt auf B einen INSERT mache, welchen Wert kriegt
das id in der row?</p>
</blockquote>
<p>Statt einer Antwort hier die Methode zum selber rausfinden.</p>
<p>Wir installieren zwei MySQL-Instanzen zum Testen (Mac OS X mit Macports).
Das ist recht einfach, denn dazu muß man nur zwei Datenverzeichnisse mit
mysql_install_db initialisieren und passende minimale Konfigurationen
erzeugen.</p>
<pre><code class="language-console" data-lang="console">KK:~ kris$ cd /tmp
KK:tmp kris$ mkdir eins zwei
KK:tmp kris$ mysql_install_db5 --datadir=/tmp/eins --user=kris
Installing MySQL system tables...
...

KK:tmp kris$ mysql_install_db5 --datadir=/tmp/zwei --user=kris
Installing MySQL system tables...
...

KK:tmp kris$ cd eins
KK:eins kris$ cat &gt; my.cnf
[mysqld]
datadir=/tmp/eins
socket=/tmp/eins/mysql.sock
port=3307
log_bin
server_id = 1
auto_increment_increment = 10
auto_increment_offset = 1
innodb


KK:eins kris$ cd ../zwei
KK:zwei kris$ cat my.cnf
[mysqld]datadir=/tmp/zwei
socket=/tmp/zwei/mysql.sock
port=3308
log_bin
server_id = 2
auto_increment_increment = 10
auto_increment_offset = 2
innodb
</code></pre><p>Die Server können nun gestartet werden. Wir geben jedem Server einen Zeiger
auf seine Konfiguration mit.</p>
<pre><code class="language-console" data-lang="console">KK:zwei kris$ cd ../eins
KK:eins kris$ mysqld_safe5 --defaults-file=/tmp/eins/my.cnf &amp;
100817 13:05:02 mysqld_safe Logging to '/tmp/eins/KK.local.err'.
100817 13:05:02 mysqld_safe Starting mysqld daemon with databases from /tmp/eins

KK:eins kris$ cd ../zwei
KK:zwei kris$ mysqld_safe5 --defaults-file=/tmp/zwei/my.cnf &amp;
100817 13:05:40 mysqld_safe Logging to '/tmp/zwei/KK.local.err'.
100817 13:05:40 mysqld_safe Starting mysqld daemon with databases from /tmp/zwei

KK:zwei kris$ lsof -i -n -P | grep my
mysqld    1042 kris   10u  IPv4 0x05691740      0t0  TCP \*:3307 (LISTEN)
mysqld    1112 kris   10u  IPv4 0x0ba7eec8      0t0  TCP \*:3308 (LISTEN)
</code></pre><p>Nachdem wir die zwei Server laufen haben und beide leer sind, können wir
eine Datenbank aufsetzen und die Replikation konfigurieren. Wir nutzen hier
den Spezialfall, daß beide Server dieselben Daten haben, weil sie leer sind,
können uns also eine Menge Arbeit sparen.</p>
<p>Ich habe die Angewohnheit, bei multiplen Instanzen auf einer Hardware
@@hostname und @@datadir abzufragen, da die Kombination beider Werte eine
Instanz eindeutig identifiziert. So kann ich sicher sein, mit dem richtigen
Server zu sprechen.</p>
<pre><code class="language-console" data-lang="console">KK:zwei kris$ mysql5 --host=127.0.0.1 --port=3307
...

root@localhost [(none)]&gt; select @@hostname, @@datadir;
+------------+------------+
| @@hostname | @@datadir  |
+------------+------------+
| KK.local   | /tmp/eins/ |
+------------+------------+
1 row in set (0.00 sec)

root@localhost [(none)]&gt; create database kris;
Query OK, 1 row affected (0.00 sec)

root@localhost [(none)]&gt; create table kris.t ( id integer not null primary key auto_increment, d varchar(20) charset latin1 ) engine = innodb;
Query OK, 0 rows affected (0.10 sec)

root@localhost [(none)]&gt; quit
Bye
</code></pre><p>Und dasselbe drüben auch noch mal.</p>
<pre><code class="language-console" data-lang="console">KK:zwei kris$ mysql5 --host=127.0.0.1 --port=3308
root@localhost [(none)]&gt; select @@hostname, @@datadir;
+------------+------------+
| @@hostname | @@datadir  |
+------------+------------+
| KK.local   | /tmp/zwei/ |
+------------+------------+
1 row in set (0.00 sec)

root@localhost [(none)]&gt; create database kris;
Query OK, 1 row affected (0.00 sec)

root@localhost [(none)]&gt; create table kris.t ( id integer not null primary key auto_increment, d varchar(20) charset latin1 ) engine = innodb;
Query OK, 0 rows affected (0.06 sec)

root@localhost [(none)]&gt; quit
Bye
</code></pre><p>Nachdem wir jetzt eine Testdatenbank mit einer leeren Testtabelle haben,
können wir replizieren. Wir setzen zunächst einmal den Server 3307 (eins)
auf. Dazu definieren wir einen Account für zwei mit dem Privileg <code>replication slave</code> und notieren die Binlog-Position von eins:</p>
<pre><code class="language-console" data-lang="console">KK:zwei kris$ mysql5 --host=127.0.0.1 --port=3307
...

root@localhost [(none)]&gt; grant replication slave on \*.\* to 'zwei'@'127.0.0.1' identified by 's3cr3t!';
Query OK, 0 rows affected (0.05 sec)

root@localhost [(none)]&gt; show master status;
+---------------+----------+--------------+------------------+
| File          | Position | Binlog_Do_DB | Binlog_Ignore_DB |
+---------------+----------+--------------+------------------+
| KK-bin.000003 |      106 |              |                  |
+---------------+----------+--------------+------------------+
1 row in set (0.00 sec)

root@localhost [(none)]&gt; quit
Bye
</code></pre><p>Mit diesen Daten können wir nun zwei einrichten. Auch dort muß ein Account
mit <code>replication slave</code> eingerichtet werden. Wir lassen außerdem einmal ein
<code>CHANGE MASTER</code> Statement los, und starten den Slave auf zwei, sodaß er von
eins repliziert. Am Ende notieren wir uns das Binlog von zwei, um auch auf
eins ein <code>CHANGE MASTER</code> machen zu können.</p>
<pre><code class="language-console" data-lang="console">KK:zwei kris$ mysql5 --host=127.0.0.1 --port=3308
...

root@localhost [(none)]&gt; grant replication slave on \*.\* to 'eins'@'127.0.0.1' identified by 's3cr3t!';
Query OK, 0 rows affected (0.00 sec)

root@localhost [(none)]&gt; change master to master_host = '127.0.0.1', master_port = 3307, master_user = 'zwei', master_password = 's3cr3t!', master_log_file = 'KK-bin.000003', master_log_pos = 106;
Query OK, 0 rows affected (0.80 sec)

root@localhost [(none)]&gt; start slave;
Query OK, 0 rows affected (0.02 sec)

root@localhost [(none)]&gt; show slave status\G
...
Slave_IO_Running: Yes
Slave_SQL_Running: Yes
...

root@localhost [(none)]&gt; show master status;
+---------------+----------+--------------+------------------+
| File          | Position | Binlog_Do_DB | Binlog_Ignore_DB |
+---------------+----------+--------------+------------------+
| KK-bin.000003 |      246 |              |                  |
+---------------+----------+--------------+------------------+
1 row in set (0.00 sec)
root@localhost [(none)]&gt; quit
Bye
</code></pre><p>Jetzt muß nur noch auf dem Server eins das <code>CHANGE MASTER</code> mit diesen Daten
laufen.</p>
<pre><code class="language-console" data-lang="console">KK:zwei kris$ mysql5 --host=127.0.0.1 --port=3307
...
root@localhost [(none)]&gt; change master to master_host = '127.0.0.1', master_port = 3308, master_user = 'eins', master_password = 's3cr3t!', master_log_file = 'KK-bin.000003', master_log_pos = 246;
Query OK, 0 rows affected (0.77 sec)

root@localhost [(none)]&gt; start slave;
Query OK, 0 rows affected (0.00 sec)

root@localhost [(none)]&gt; show slave status\G
...
Slave_IO_Running: Yes
Slave_SQL_Running: Yes
...
</code></pre><p>Wir haben nun einen Ring, der zwischen zwei Instanzen auf Port 3307 und Port
3308 repliziert. Das kann man auch sehen:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">KK:zwei kris$ lsof <span style="color:#f92672">-</span>i <span style="color:#f92672">-</span>n <span style="color:#f92672">-</span>P <span style="color:#f92672">|</span> grep my
mysqld    <span style="color:#ae81ff">1210</span> kris   <span style="color:#ae81ff">11</span>u  IPv4 <span style="color:#ae81ff">0</span>x06091e98      <span style="color:#ae81ff">0</span>t0  TCP <span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">*</span>:<span style="color:#ae81ff">3307</span> (<span style="color:#66d9ef">LISTEN</span>)
mysqld    <span style="color:#ae81ff">1210</span> kris   <span style="color:#ae81ff">31</span>u  IPv4 <span style="color:#ae81ff">0</span>x0ba6def8      <span style="color:#ae81ff">0</span>t0  TCP <span style="color:#ae81ff">127</span>.<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">1</span>:<span style="color:#ae81ff">3307</span><span style="color:#f92672">-&gt;</span><span style="color:#ae81ff">127</span>.<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">1</span>:<span style="color:#ae81ff">50981</span> (ESTABLISHED)
mysqld    <span style="color:#ae81ff">1210</span> kris   <span style="color:#ae81ff">37</span>u  IPv4 <span style="color:#ae81ff">0</span>x098bab4c      <span style="color:#ae81ff">0</span>t0  TCP <span style="color:#ae81ff">127</span>.<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">1</span>:<span style="color:#ae81ff">50989</span><span style="color:#f92672">-&gt;</span><span style="color:#ae81ff">127</span>.<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">1</span>:<span style="color:#ae81ff">3308</span> (ESTABLISHED)
mysqld    <span style="color:#ae81ff">1282</span> kris   <span style="color:#ae81ff">11</span>u  IPv4 <span style="color:#ae81ff">0</span>x0ba7eec8      <span style="color:#ae81ff">0</span>t0  TCP <span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">*</span>:<span style="color:#ae81ff">3308</span> (<span style="color:#66d9ef">LISTEN</span>)
mysqld    <span style="color:#ae81ff">1282</span> kris   <span style="color:#ae81ff">31</span>u  IPv4 <span style="color:#ae81ff">0</span>x0ba7faec      <span style="color:#ae81ff">0</span>t0  TCP <span style="color:#ae81ff">127</span>.<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">1</span>:<span style="color:#ae81ff">3308</span><span style="color:#f92672">-&gt;</span><span style="color:#ae81ff">127</span>.<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">1</span>:<span style="color:#ae81ff">50989</span> (ESTABLISHED)
mysqld    <span style="color:#ae81ff">1282</span> kris   <span style="color:#ae81ff">35</span>u  IPv4 <span style="color:#ae81ff">0</span>x098b9b1c      <span style="color:#ae81ff">0</span>t0  TCP <span style="color:#ae81ff">127</span>.<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">1</span>:<span style="color:#ae81ff">50981</span><span style="color:#f92672">-&gt;</span><span style="color:#ae81ff">127</span>.<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">1</span>:<span style="color:#ae81ff">3307</span> (ESTABLISHED)
</code></pre></div><p>Jetzt können wir testen:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">KK:zwei kris$ mysql5 <span style="color:#75715e">--host=127.0.0.1 --port=3307 -e &#39;insert into kris.t values (NULL, &#34;auf eins&#34;);&#39;
</span><span style="color:#75715e"></span>KK:zwei kris$ mysql5 <span style="color:#75715e">--host=127.0.0.1 --port=3308 -e &#39;insert into kris.t values (NULL, &#34;auf zwei&#34;);&#39;
</span><span style="color:#75715e"></span>KK:zwei kris$ mysql5 <span style="color:#75715e">--host=127.0.0.1 --port=3308 -e &#39;select \* from kris.t;&#39;
</span><span style="color:#75715e"></span><span style="color:#f92672">+</span><span style="color:#75715e">----+----------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> id <span style="color:#f92672">|</span> d        <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+----------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span>  <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span> auf eins <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span> auf zwei <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+----------+
</span><span style="color:#75715e"></span>
KK:zwei kris$ mysql5 <span style="color:#75715e">--host=127.0.0.1 --port=3307 -e &#39;insert into kris.t values (NULL, &#34;nochmal eins&#34;);&#39;
</span><span style="color:#75715e"></span>KK:zwei kris$ mysql5 <span style="color:#75715e">--host=127.0.0.1 --port=3307 -e &#39;select \* from kris.t;&#39;
</span><span style="color:#75715e"></span><span style="color:#f92672">+</span><span style="color:#75715e">----+--------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> id <span style="color:#f92672">|</span> d            <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+--------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span>  <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span> auf eins     <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span> auf zwei     <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#ae81ff">11</span> <span style="color:#f92672">|</span> nochmal eins <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+--------------+
</span></code></pre></div><p>Die Antwort lautet also:</p>
<p>Jeder Server hat seinen eigenen AUTO_INCREMENT-Zähler an der Tabelle, der
mit dem <code>auto_increment_offset</code> initialisiert wird und der in Schritten von
<code>auto_increment_increment</code> hochgezählt wird. Das geschieht jedoch nur, wenn
ein Nullwert in die Tabelle eingetragen wird, also nur bei lokalen
INSERT-Statements. Statements, die durch Replikation übermittelt werden,
bringen einen Wert vom Master mit und zählen nichts hoch.</p>


	
    </article>
</div>



            <footer>
    <p>
	&copy; Copyright 2021 Someone or something
    </p>
</footer>


        </main>

	





<script src="/js/bootstrap.js"></script>




<script src="/js/lunr.js"></script>





<script src="/js/app.js"></script>


    </body>
</html>
