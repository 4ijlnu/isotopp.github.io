<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Die wunderbare Welt von Isotopp - SQL Clause is coming to town</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="site.webmanifest">
<link rel="apple-touch-icon" href="icon.png">
<link rel="favicon.ico" rel="icon" type="image/ico">





	



<link rel="stylesheet" href="/style.min.c5e5cd61f54911f9aafd1dbe09c2f90667957bfe1002126c87aace57759f3446.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
	<a class="navbar-brand" href="" rel="home" title=".Site.Title">
	    Die wunderbare Welt von Isotopp
	</a>
	<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
	</button>

	<div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
		
		
		<li class="nav-item ">
                    <a class="nav-link" href="/about/">
			
			<span>About</span>
			<span class="visually-hidden">(Current)</span>
		    </a>
		    
		</li>
            </ul>
            
	</div>
    </div>
</nav>


        <main role="main" class="container-fluid">

            


<div class="page">
    <article class="sql-clause-is-coming-to-town-page">
	<h1 class="title">
            SQL Clause is coming to town
	</h1>

	<p><a href="https://twitter.com/roliepoly/status/1342549035211661312" target="_blank" rel="noopener">Olya Kudriavtseva has an ugly christmas sweater</a>

:</p>
<p><a href="https://twitter.com/roliepoly/status/1342549035211661312" target="_blank" rel="noopener"><p class="md__image">
  <img src="/uploads/2020/12/sql-clause.jpg" alt=""  />
</p>

</a>

</p>
<p><em>&ldquo;He&rsquo;s making a table. He&rsquo;s sorting it twice. SELECT * FROM contacts WHERE behavior = &ldquo;nice&rdquo;; SQL Clause is coming town!</em>  (<a href="https://www.xonot.com/product/sql-clause-sweatshirt/" target="_blank" rel="noopener">buy here</a>

)</p>
<p><a href="https://twitter.com/imightbemary/status/1342676590145105921" target="_blank" rel="noopener">Katie Bauer observes</a>

:</p>
<blockquote>
<p>I mean, except for the fact that sorting something twice is TERRIBLY optimized</p>
</blockquote>
<p>So how bad is this? Let&rsquo;s find out.</p>
<h2 id="some-test-data">
    <a href="#some-test-data">
	Some test data
    </a>
</h2>
<p>We are defining a table <code>santa</code>, where we store peoples names (GDPR, <a href="https://eur-lex.europa.eu/eli/reg/2016/679/oj" target="_blank" rel="noopener">EU Regulation 2016/679</a>

 applies!), their behavior (naughty or nice), their age, their location, and their wishlist items.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> santa (
	id integer <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span> <span style="color:#66d9ef">primary</span> <span style="color:#66d9ef">key</span> auto_increment,
	name varchar(<span style="color:#ae81ff">64</span>) <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span>,
	loc point srid <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span>,
	age integer <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span>,
	behavior enum(<span style="color:#e6db74">&#39;naughty&#39;</span>, <span style="color:#e6db74">&#39;nice&#39;</span>) <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span>,
	wish varchar(<span style="color:#ae81ff">64</span>) <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span>
)
</code></pre></div><p>We are also writing some code to generate data (to evade GDPR, we are using randomly generated test data):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, size):
	data <span style="color:#f92672">=</span> {
	    <span style="color:#e6db74">&#34;id&#34;</span>: i,
	    <span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">.</span>join([chr(randint(<span style="color:#ae81ff">97</span>, <span style="color:#ae81ff">97</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">26</span>)) <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">64</span>)]),
	    <span style="color:#e6db74">&#34;xloc&#34;</span>: random()<span style="color:#f92672">*</span><span style="color:#ae81ff">360</span><span style="color:#f92672">-</span><span style="color:#ae81ff">180</span>,
	    <span style="color:#e6db74">&#34;yloc&#34;</span>: random()<span style="color:#f92672">*</span><span style="color:#ae81ff">180</span><span style="color:#f92672">-</span><span style="color:#ae81ff">90</span>,
	    <span style="color:#e6db74">&#34;age&#34;</span>: randint(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">100</span>),
	    <span style="color:#e6db74">&#34;behavior&#34;</span>: <span style="color:#e6db74">&#34;naughty&#34;</span> <span style="color:#66d9ef">if</span> random() <span style="color:#f92672">&gt;</span> nicelevel <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#34;nice&#34;</span>,
	    <span style="color:#e6db74">&#34;wish&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">.</span>join([chr(randint(<span style="color:#ae81ff">97</span>, <span style="color:#ae81ff">97</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">26</span>)) <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">64</span>)]),
	}

	c<span style="color:#f92672">.</span>execute(sql, data)
	<span style="color:#66d9ef">if</span> i<span style="color:#f92672">%</span><span style="color:#ae81ff">1000</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
	    <span style="color:#66d9ef">print</span>(f<span style="color:#e6db74">&#34;{i=}&#34;</span>)
	    db<span style="color:#f92672">.</span>commit()

db<span style="color:#f92672">.</span>commit()
</code></pre></div><p>The full data generator is available as <a href="https://github.com/isotopp/mysql-dev-examples/blob/master/mysql-santa/santa.py" target="_blank" rel="noopener">santa.py</a>

. Note that the data generator there defines more indexes - see below.</p>
<p>In our example we generate one million rows, and assume a general niceness of 0.9 (90% of the children are nice). Also, all of our children have 64 characters long names, a single 64 characters long wish, a random age, and are equidistributed on a perfect sphere.</p>
<p>Our real planet is not a perfect sphere, and also not many people live in the Pacific Ocean. Also, not many children have 64 character names.</p>
<h2 id="sorting-it-twice">
    <a href="#sorting-it-twice">
	Sorting it twice
    </a>
</h2>
<p>How do you even sort the data twice? Now, assuming we sort by name, we can run an increasingly deeply nested subquery:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">kris<span style="color:#f92672">@</span>localhost [kris]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#66d9ef">count</span>(<span style="color:#f92672">*</span>) <span style="color:#66d9ef">from</span> santa <span style="color:#66d9ef">where</span> behavior <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;nice&#39;</span>;
<span style="color:#f92672">+</span><span style="color:#75715e">----------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> <span style="color:#66d9ef">count</span>(<span style="color:#f92672">*</span>) <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span>   <span style="color:#ae81ff">900216</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">25</span> sec)

kris<span style="color:#f92672">@</span>localhost [kris]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">explain</span> <span style="color:#66d9ef">select</span> <span style="color:#66d9ef">count</span>(<span style="color:#f92672">*</span>) <span style="color:#66d9ef">from</span> santa <span style="color:#66d9ef">where</span> behavior <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;nice&#39;</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
<span style="color:#f92672">***************************</span> <span style="color:#ae81ff">1</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">***************************</span>
           id: <span style="color:#ae81ff">1</span>
  select_type: <span style="color:#66d9ef">SIMPLE</span>
        <span style="color:#66d9ef">table</span>: santa
   partitions: <span style="color:#66d9ef">NULL</span>
         <span style="color:#66d9ef">type</span>: <span style="color:#66d9ef">ALL</span>
possible_keys: <span style="color:#66d9ef">NULL</span>
          <span style="color:#66d9ef">key</span>: <span style="color:#66d9ef">NULL</span>
      key_len: <span style="color:#66d9ef">NULL</span>
          <span style="color:#66d9ef">ref</span>: <span style="color:#66d9ef">NULL</span>
         <span style="color:#66d9ef">rows</span>: <span style="color:#ae81ff">987876</span>
     filtered: <span style="color:#ae81ff">50</span>.<span style="color:#ae81ff">00</span>
        Extra: <span style="color:#66d9ef">Using</span> <span style="color:#66d9ef">where</span>
<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span>, <span style="color:#ae81ff">1</span> warning (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

Note (Code <span style="color:#ae81ff">1003</span>): <span style="color:#75715e">/* select#1 */</span> <span style="color:#66d9ef">select</span> <span style="color:#66d9ef">count</span>(<span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">AS</span> <span style="color:#f92672">`</span><span style="color:#66d9ef">count</span>(<span style="color:#f92672">*</span>)<span style="color:#f92672">`</span> <span style="color:#66d9ef">from</span> <span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>santa<span style="color:#f92672">`</span> <span style="color:#66d9ef">where</span> (<span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>santa<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>behavior<span style="color:#f92672">`</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;nice&#39;</span>)
</code></pre></div><p>Out of 1 million children, we have around 900k nice children. No indexes can be used to resolve the query.</p>
<p>Let&rsquo;s order by name, using a subquery:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">kris<span style="color:#f92672">@</span>localhost [kris]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">explain</span> 
  <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">select</span> t.name <span style="color:#66d9ef">from</span> (
  <span style="color:#f92672">-&gt;</span>   <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> santa <span style="color:#66d9ef">where</span> behavior <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;nice&#39;</span>
  <span style="color:#f92672">-&gt;</span> ) <span style="color:#66d9ef">as</span> t <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> name;
<span style="color:#f92672">+</span><span style="color:#75715e">----+-------------+-------+------------+------+---------------+------+---------+------+--------+----------+-----------------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> id <span style="color:#f92672">|</span> select_type <span style="color:#f92672">|</span> <span style="color:#66d9ef">table</span> <span style="color:#f92672">|</span> partitions <span style="color:#f92672">|</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">|</span> possible_keys <span style="color:#f92672">|</span> <span style="color:#66d9ef">key</span>  <span style="color:#f92672">|</span> key_len <span style="color:#f92672">|</span> <span style="color:#66d9ef">ref</span>  <span style="color:#f92672">|</span> <span style="color:#66d9ef">rows</span>   <span style="color:#f92672">|</span> filtered <span style="color:#f92672">|</span> Extra                       <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+-------------+-------+------------+------+---------------+------+---------+------+--------+----------+-----------------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span>  <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">SIMPLE</span>      <span style="color:#f92672">|</span> santa <span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span>       <span style="color:#f92672">|</span> <span style="color:#66d9ef">ALL</span>  <span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span>          <span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span>    <span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">987876</span> <span style="color:#f92672">|</span>    <span style="color:#ae81ff">50</span>.<span style="color:#ae81ff">00</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">Using</span> <span style="color:#66d9ef">where</span>; <span style="color:#66d9ef">Using</span> filesort <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+-------------+-------+------------+------+---------------+------+---------+------+--------+----------+-----------------------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span>, <span style="color:#ae81ff">1</span> warning (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

Note (Code <span style="color:#ae81ff">1003</span>): <span style="color:#75715e">/* select#1 */</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>santa<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>name<span style="color:#f92672">`</span> <span style="color:#66d9ef">AS</span> <span style="color:#f92672">`</span>name<span style="color:#f92672">`</span> <span style="color:#66d9ef">from</span> <span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>santa<span style="color:#f92672">`</span> <span style="color:#66d9ef">where</span> (<span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>santa<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>behavior<span style="color:#f92672">`</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;nice&#39;</span>) <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> <span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>santa<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>name<span style="color:#f92672">`</span>
</code></pre></div><p>We can already see that the MySQL 8 optimizer recognizes that this subquery can be merged with the inner query, and does this.</p>
<p>This can be done multiple times, but the optimizer handles this just fine:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">kris<span style="color:#f92672">@</span>localhost [kris]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">explain</span> 
  <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">select</span> s.name <span style="color:#66d9ef">from</span> (
  <span style="color:#f92672">-&gt;</span>   <span style="color:#66d9ef">select</span> t.name <span style="color:#66d9ef">from</span> (
  <span style="color:#f92672">-&gt;</span>     <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> santa <span style="color:#66d9ef">where</span> behavior <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;nice&#39;</span>
  <span style="color:#f92672">-&gt;</span>   ) <span style="color:#66d9ef">as</span> t <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> name
  <span style="color:#f92672">-&gt;</span> ) <span style="color:#66d9ef">as</span> s <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> name;
<span style="color:#f92672">+</span><span style="color:#75715e">----+-------------+-------+------------+------+---------------+------+---------+------+--------+----------+-----------------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> id <span style="color:#f92672">|</span> select_type <span style="color:#f92672">|</span> <span style="color:#66d9ef">table</span> <span style="color:#f92672">|</span> partitions <span style="color:#f92672">|</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">|</span> possible_keys <span style="color:#f92672">|</span> <span style="color:#66d9ef">key</span>  <span style="color:#f92672">|</span> key_len <span style="color:#f92672">|</span> <span style="color:#66d9ef">ref</span>  <span style="color:#f92672">|</span> <span style="color:#66d9ef">rows</span>   <span style="color:#f92672">|</span> filtered <span style="color:#f92672">|</span> Extra                       <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+-------------+-------+------------+------+---------------+------+---------+------+--------+----------+-----------------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span>  <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">SIMPLE</span>      <span style="color:#f92672">|</span> santa <span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span>       <span style="color:#f92672">|</span> <span style="color:#66d9ef">ALL</span>  <span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span>          <span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span>    <span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">987876</span> <span style="color:#f92672">|</span>    <span style="color:#ae81ff">50</span>.<span style="color:#ae81ff">00</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">Using</span> <span style="color:#66d9ef">where</span>; <span style="color:#66d9ef">Using</span> filesort <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+-------------+-------+------------+------+---------------+------+---------+------+--------+----------+-----------------------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span>, <span style="color:#ae81ff">1</span> warning (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

Note (Code <span style="color:#ae81ff">1003</span>): <span style="color:#75715e">/* select#1 */</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>santa<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>name<span style="color:#f92672">`</span> <span style="color:#66d9ef">AS</span> <span style="color:#f92672">`</span>name<span style="color:#f92672">`</span> <span style="color:#66d9ef">from</span> <span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>santa<span style="color:#f92672">`</span> <span style="color:#66d9ef">where</span> (<span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>santa<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>behavior<span style="color:#f92672">`</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;nice&#39;</span>) <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> <span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>santa<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>name<span style="color:#f92672">`</span>
</code></pre></div><p>We can see <code>using filesort</code>, so while we ask for the query result to be sorted by name twice, it is actually only sorted once.</p>
<h2 id="no-sorting-at-all">
    <a href="#no-sorting-at-all">
	No sorting at all
    </a>
</h2>
<p>We can improve on this, using a covering index in appropriate order:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">kris<span style="color:#f92672">@</span>localhost [kris]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">alter</span> <span style="color:#66d9ef">table</span> santa <span style="color:#66d9ef">add</span> <span style="color:#66d9ef">index</span> behavior_name (behavior, name);
Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">21</span>.<span style="color:#ae81ff">82</span> sec)
Records: <span style="color:#ae81ff">0</span>  Duplicates: <span style="color:#ae81ff">0</span>  Warnings: <span style="color:#ae81ff">0</span>
</code></pre></div><p>Having done this, we now see that we lost the <code>using filesort</code> altogether:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">kris<span style="color:#f92672">@</span>localhost [kris]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">explain</span> <span style="color:#66d9ef">select</span> s.name <span style="color:#66d9ef">from</span> ( <span style="color:#66d9ef">select</span> t.name <span style="color:#66d9ef">from</span> (<span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> santa <span style="color:#66d9ef">where</span> behavior <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;nice&#39;</span>) <span style="color:#66d9ef">as</span> t <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> name ) <span style="color:#66d9ef">as</span> s <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> name;
<span style="color:#f92672">+</span><span style="color:#75715e">----+-------------+-------+------------+------+---------------+---------------+---------+-------+--------+----------+--------------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> id <span style="color:#f92672">|</span> select_type <span style="color:#f92672">|</span> <span style="color:#66d9ef">table</span> <span style="color:#f92672">|</span> partitions <span style="color:#f92672">|</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">|</span> possible_keys <span style="color:#f92672">|</span> <span style="color:#66d9ef">key</span>           <span style="color:#f92672">|</span> key_len <span style="color:#f92672">|</span> <span style="color:#66d9ef">ref</span>   <span style="color:#f92672">|</span> <span style="color:#66d9ef">rows</span>   <span style="color:#f92672">|</span> filtered <span style="color:#f92672">|</span> Extra                    <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+-------------+-------+------------+------+---------------+---------------+---------+-------+--------+----------+--------------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span>  <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">SIMPLE</span>      <span style="color:#f92672">|</span> santa <span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span>       <span style="color:#f92672">|</span> <span style="color:#66d9ef">ref</span>  <span style="color:#f92672">|</span> behavior_name <span style="color:#f92672">|</span> behavior_name <span style="color:#f92672">|</span> <span style="color:#ae81ff">1</span>       <span style="color:#f92672">|</span> const <span style="color:#f92672">|</span> <span style="color:#ae81ff">493938</span> <span style="color:#f92672">|</span>   <span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">00</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">Using</span> <span style="color:#66d9ef">where</span>; <span style="color:#66d9ef">Using</span> <span style="color:#66d9ef">index</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+-------------+-------+------------+------+---------------+---------------+---------+-------+--------+----------+--------------------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span>, <span style="color:#ae81ff">1</span> warning (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

Note (Code <span style="color:#ae81ff">1003</span>): <span style="color:#75715e">/* select#1 */</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>santa<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>name<span style="color:#f92672">`</span> <span style="color:#66d9ef">AS</span> <span style="color:#f92672">`</span>name<span style="color:#f92672">`</span> <span style="color:#66d9ef">from</span> <span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>santa<span style="color:#f92672">`</span> <span style="color:#66d9ef">where</span> (<span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>santa<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>behavior<span style="color:#f92672">`</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;nice&#39;</span>) <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> <span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>santa<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>name<span style="color:#f92672">`</span>
</code></pre></div><p>The query is now annotated <code>using index</code>, which means that all data we ask for is present in the (covering) index <code>behavior_name</code>, and is stored in sort order. That means the data is physically stored and read in sort order and no actual sorting has to be done on read - despite us asking for sorting, twice.</p>
<h2 id="hidden-select--and-index-condition-pushdown">
    <a href="#hidden-select--and-index-condition-pushdown">
	Hidden &lsquo;SELECT *&rsquo; and Index Condition Pushdown
    </a>
</h2>
<p>In the example above, we have been asking for <code>s.name</code> and <code>t.name</code> only, and because the name is part of the index, <code>using index</code> is shown to indicate use of a covering index. We do not actually go to the table to generate the result set, we are using the index only.</p>
<p>Now, if we were to ask for <code>t.*</code> in the middle subquery, what will happen?</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">kris<span style="color:#f92672">@</span>localhost [kris]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">explain</span>
  <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">select</span> s.name <span style="color:#66d9ef">from</span> (
  <span style="color:#f92672">-&gt;</span>   <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> (
  <span style="color:#f92672">-&gt;</span>     <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> santa <span style="color:#66d9ef">where</span> behavior <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;nice&#39;</span>
  <span style="color:#f92672">-&gt;</span>   ) <span style="color:#66d9ef">as</span> t <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> name
  <span style="color:#f92672">-&gt;</span> ) <span style="color:#66d9ef">as</span> s <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> name;
<span style="color:#f92672">+</span><span style="color:#75715e">----+-------------+-------+------------+------+---------------+---------------+---------+-------+--------+----------+-----------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> id <span style="color:#f92672">|</span> select_type <span style="color:#f92672">|</span> <span style="color:#66d9ef">table</span> <span style="color:#f92672">|</span> partitions <span style="color:#f92672">|</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">|</span> possible_keys <span style="color:#f92672">|</span> <span style="color:#66d9ef">key</span>           <span style="color:#f92672">|</span> key_len <span style="color:#f92672">|</span> <span style="color:#66d9ef">ref</span>   <span style="color:#f92672">|</span> <span style="color:#66d9ef">rows</span>   <span style="color:#f92672">|</span> filtered <span style="color:#f92672">|</span> Extra                 <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+-------------+-------+------------+------+---------------+---------------+---------+-------+--------+----------+-----------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span>  <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">SIMPLE</span>      <span style="color:#f92672">|</span> santa <span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span>       <span style="color:#f92672">|</span> <span style="color:#66d9ef">ref</span>  <span style="color:#f92672">|</span> behavior_name <span style="color:#f92672">|</span> behavior_name <span style="color:#f92672">|</span> <span style="color:#ae81ff">1</span>       <span style="color:#f92672">|</span> const <span style="color:#f92672">|</span> <span style="color:#ae81ff">493938</span> <span style="color:#f92672">|</span>   <span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">00</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">Using</span> <span style="color:#66d9ef">index</span> condition <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+-------------+-------+------------+------+---------------+---------------+---------+-------+--------+----------+-----------------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span>, <span style="color:#ae81ff">1</span> warning (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

Note (Code <span style="color:#ae81ff">1003</span>): <span style="color:#75715e">/* select#1 */</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>santa<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>name<span style="color:#f92672">`</span> <span style="color:#66d9ef">AS</span> <span style="color:#f92672">`</span>name<span style="color:#f92672">`</span> <span style="color:#66d9ef">from</span> <span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>santa<span style="color:#f92672">`</span> <span style="color:#66d9ef">where</span> (<span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>santa<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>behavior<span style="color:#f92672">`</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;nice&#39;</span>) <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> <span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>santa<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>name<span style="color:#f92672">`</span>
</code></pre></div><p>In the <code>Code 1003 Note</code> we still see the exact same reconstituted query, but as can be seen in the plan annotastions, the internal handling changes - so the optimizer has not been working on this query at all times, but on some intermediary representation.</p>
<p>The &lsquo;using index condition&rsquo; annotation points to <a href="https://dev.mysql.com/doc/refman/8.0/en/index-condition-pushdown-optimization.html" target="_blank" rel="noopener">Index Condition Pushdown Optimization</a>

 being used. In our example, this is not good.</p>
<h2 id="worse-than-sorting-selectivity">
    <a href="#worse-than-sorting-selectivity">
	Worse than sorting: Selectivity
    </a>
</h2>
<p>The column we select on is a column with a cardinality of 2: <code>behavior</code> can be either <code>naughty</code> or <code>nice</code>. That means, in an equidistribution, around half of the values are <code>naughty</code>, the other half is <code>nice</code>.</p>
<p>Data from disk is read in pages of 16 KB. If one row in a page matches, the entire page has to be read from disk. In our example, we have a row length of around 200 Byte, so we end up with 75-80 records per page. Half of them will be <code>nice</code>, so with an average of around 40 <code>nice</code> records per page, we will very likely have to read all pages from disk anyway.</p>
<p>Using the index will not decrease the amount of data read from disk at all. In fact we will have to read the index pages on top of the data pages, so using an index on a low cardinality column has the potential of making the situation slightly worse than even a full table scan.</p>
<p>Generally speaking, defining an index on a low cardinality column is usually not helpful - if there are 10 or fewer values, benchmark carefully and decide, or just don&rsquo;t define an index.</p>
<p>In our case, the index is not even equidistributed, but biased to 90% <code>nice</code>. We end up with mostly <code>nice</code> records, so we can guarantee that all data pages will be read for the SQL <code>SELECT * FROM santa WHERE behavior = &quot;nice&quot;</code>, and the index usage will not be contributing in any positive way.</p>
<p>We could try to improve the query by adding conditions to make it more selective. For example, we could ask for people close to our current position, using an RTREE index such as this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">kris<span style="color:#f92672">@</span>localhost [kris]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">TABLE</span> santa <span style="color:#66d9ef">ADD</span> SPATIAL <span style="color:#66d9ef">INDEX</span> (loc);
...
kris<span style="color:#f92672">@</span>localhost [kris]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">set</span> <span style="color:#f92672">@</span>rect <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;polygon((10 10, 10 20, 20 20, 20 10, 10 10 ))&#39;</span>;
kris<span style="color:#f92672">@</span>localhost [kris]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> santa <span style="color:#66d9ef">where</span> mbrcovers(st_geomfromtext(<span style="color:#f92672">@</span>rect), loc);
...
<span style="color:#ae81ff">1535</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">3</span>.<span style="color:#ae81ff">53</span> sec)
</code></pre></div><p>The <code>ALTER</code> defines a spatial index (an RTREE), which can help to speed up coordinate queries.</p>
<p>The <code>SET</code> defines a coordinate rectangle around our current position (supposedly 15/15).</p>
<p>We then use the <code>mbrcovers()</code> function to find all points <code>loc</code> that are covered by the <code>@rect</code>. It seems to be somewhat complicated to get MySQL to actually use the index, but I have not been investigating deeply.</p>
<p>If we added an <code>ORDER BY name</code> here, we would see <code>using filesort</code> again, because data is retrieved in RTREE order, if the index <code>loc</code> is used, but we want output in <code>name</code> order.</p>
<h2 id="conclusion">
    <a href="#conclusion">
	Conclusion
    </a>
</h2>
<ul>
<li>The Santa query is inefficient, but likely sorting twice is not the root cause for that.
<ul>
<li>The optimizer will be able to merge the multiple sorts and be able to deliver the result with one or no sorting, depending on our index construction.</li>
<li>The optimizer is not using the reconstituted query shown in the warning to plan the execution, and that is weird.</li>
</ul>
</li>
<li>Selectivity matters, especially for indices on low cardinality columns.
<ul>
<li>Asking for all <code>nice</code> behaviors on a <code>naughty</code>/<code>nice</code> column is usually not benefitting from index usage.</li>
<li>Additional indexable conditions that improve selectivity can help, a lot.</li>
</ul>
</li>
</ul>


	
    </article>
</div>



            <footer>
    <p>
	&copy; Copyright 2021 Someone or something
    </p>
</footer>


        </main>

	





<script src="/js/bootstrap.js"></script>




<script src="/js/lunr.js"></script>





<script src="/js/app.js"></script>


    </body>
</html>
