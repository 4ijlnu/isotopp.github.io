<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Die wunderbare Welt von Isotopp - MySQL Foreign Key Constraints and Locking</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="site.webmanifest">
<link rel="apple-touch-icon" href="icon.png">
<link rel="favicon.ico" rel="icon" type="image/ico">





	



<link rel="stylesheet" href="/style.min.c5e5cd61f54911f9aafd1dbe09c2f90667957bfe1002126c87aace57759f3446.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
	<a class="navbar-brand" href="" rel="home" title=".Site.Title">
	    Die wunderbare Welt von Isotopp
	</a>
	<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
	</button>

	<div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
		
		
		<li class="nav-item ">
                    <a class="nav-link" href="/about/">
			
			<span>About</span>
			<span class="visually-hidden">(Current)</span>
		    </a>
		    
		</li>
            </ul>
            
	</div>
    </div>
</nav>


        <main role="main" class="container-fluid">

            


<div class="page">
    <article class="mysql-foreign-key-constraints-and-locking-page">
	<h1 class="title">
            MySQL Foreign Key Constraints and Locking
	</h1>

	<p>Since we now know how to look at the state of locking in a live database, let&rsquo;s look at what happens when we run a normal insert or update and an insert or update with foreign key relationships defined, and compare.</p>
<p>We will be using the tables and structures from our previous examples, a simple 1:n relationship between <code>a</code> and <code>b</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> a (
  a_id int <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> AUTO_INCREMENT,
  <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span> (a_id)
);

<span style="color:#66d9ef">INSERT</span> <span style="color:#66d9ef">INTO</span> a <span style="color:#66d9ef">VALUES</span> (<span style="color:#ae81ff">10</span>), (<span style="color:#ae81ff">20</span>), (<span style="color:#ae81ff">30</span>), (<span style="color:#ae81ff">40</span>);

<span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> b (
  b_id int <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> AUTO_INCREMENT,
  a_id int <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span> (b_id),
  <span style="color:#66d9ef">KEY</span> <span style="color:#f92672">`</span>a_id<span style="color:#f92672">`</span> (a_id),
  <span style="color:#66d9ef">CONSTRAINT</span> a_id_exists <span style="color:#66d9ef">FOREIGN</span> <span style="color:#66d9ef">KEY</span> (a_id) <span style="color:#66d9ef">REFERENCES</span> a (a_id) <span style="color:#66d9ef">ON</span> <span style="color:#66d9ef">DELETE</span> <span style="color:#66d9ef">RESTRICT</span> <span style="color:#66d9ef">ON</span> <span style="color:#66d9ef">UPDATE</span> <span style="color:#66d9ef">RESTRICT</span>
);

<span style="color:#66d9ef">INSERT</span> <span style="color:#66d9ef">INTO</span> b <span style="color:#66d9ef">VALUES</span> (<span style="color:#ae81ff">10</span>,<span style="color:#ae81ff">10</span>), (<span style="color:#ae81ff">40</span>,<span style="color:#ae81ff">40</span>);
</code></pre></div><p>or the same definition for <code>b</code> without the constraint.</p>
<h2 id="a-normal-insert-and-update">
    <a href="#a-normal-insert-and-update">
	A normal INSERT and UPDATE
    </a>
</h2>
<p>First, let&rsquo;s look at an insert and update into <code>b</code> without any defined constraints:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">start</span> <span style="color:#66d9ef">transaction</span> <span style="color:#66d9ef">read</span> <span style="color:#66d9ef">write</span>;
mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> b <span style="color:#66d9ef">values</span> (<span style="color:#ae81ff">30</span>,<span style="color:#ae81ff">30</span>);

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> performance_schema.data_locks<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
...
            LOCK_TYPE: <span style="color:#66d9ef">TABLE</span>                              
            LOCK_MODE: IX
          LOCK_STATUS: <span style="color:#66d9ef">GRANTED</span>
            LOCK_DATA: <span style="color:#66d9ef">NULL</span>
...

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">update</span> b <span style="color:#66d9ef">set</span> a_id<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span> <span style="color:#66d9ef">where</span> b_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>;

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> performance_schema.data_locks<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
...
       OBJECT_SCHEMA: kris
          OBJECT_NAME: b
           INDEX_NAME: <span style="color:#66d9ef">PRIMARY</span>
            LOCK_TYPE: RECORD
            LOCK_MODE: X,REC_NOT_GAP
          LOCK_STATUS: <span style="color:#66d9ef">GRANTED</span>
            LOCK_DATA: <span style="color:#ae81ff">10</span>
...
</code></pre></div><p>We can see that the <code>INSERT</code> did just create an intention-lock on the table, but did not actually have to create any row locks. The update had to change an existing table row <code>b.b_id=10</code>, and hence needed to X-lock the row 10.</p>
<h2 id="insert-and-update-with-a-foreign-key-constraint">
    <a href="#insert-and-update-with-a-foreign-key-constraint">
	INSERT and UPDATE with a foreign key constraint
    </a>
</h2>
<p>Redefining the <code>b</code> table as above, with a foreign key constraint defined, produces a much richer set of locks:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">start</span> <span style="color:#66d9ef">transaction</span> <span style="color:#66d9ef">read</span> <span style="color:#66d9ef">write</span>;
mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> b <span style="color:#66d9ef">values</span> (<span style="color:#ae81ff">30</span>,<span style="color:#ae81ff">30</span>);

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> performance_schema.data_locks<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
<span style="color:#66d9ef">select</span> object_schema, object_name, index_name, lock_mode, lock_data, lock_type <span style="color:#66d9ef">from</span> performance_schema.data_locks;
<span style="color:#f92672">+</span><span style="color:#75715e">---------------+-------------+------------+---------------+-----------+-----------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> object_schema <span style="color:#f92672">|</span> object_name <span style="color:#f92672">|</span> index_name <span style="color:#f92672">|</span> lock_mode     <span style="color:#f92672">|</span> lock_data <span style="color:#f92672">|</span> lock_type <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">---------------+-------------+------------+---------------+-----------+-----------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> kris          <span style="color:#f92672">|</span> b           <span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span>       <span style="color:#f92672">|</span> IX            <span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span>      <span style="color:#f92672">|</span> <span style="color:#66d9ef">TABLE</span>     <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> kris          <span style="color:#f92672">|</span> a           <span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span>       <span style="color:#f92672">|</span> <span style="color:#66d9ef">IS</span>            <span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span>      <span style="color:#f92672">|</span> <span style="color:#66d9ef">TABLE</span>     <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> kris          <span style="color:#f92672">|</span> a           <span style="color:#f92672">|</span> <span style="color:#66d9ef">PRIMARY</span>    <span style="color:#f92672">|</span> S,REC_NOT_GAP <span style="color:#f92672">|</span> <span style="color:#ae81ff">30</span>        <span style="color:#f92672">|</span> RECORD    <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">---------------+-------------+------------+---------------+-----------+-----------+
</span></code></pre></div><p>In order for the <code>INSERT</code> to be valid, we need to check if the <code>a_id</code> inserted into table <code>b</code> exists in <code>a</code> - that is a lookup operation.</p>
<p>We also need to ensure that the value we checked for stays there and is not modified until we finish the transaction. So we do get an additional intention-lock on <code>a</code>, and then an actual S-lock on <code>a.a_id=30</code>. The intention-lock on <code>b</code> is as before.</p>
<p>Continuing our exploration, we can now try to change a row:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">update</span> b <span style="color:#66d9ef">set</span> a_id<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span> <span style="color:#66d9ef">where</span> b_id<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>;

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> object_schema, object_name, index_name, lock_mode, lock_data, lock_type <span style="color:#66d9ef">from</span> performance_schema.data_locks;
<span style="color:#f92672">+</span><span style="color:#75715e">---------------+-------------+------------+---------------+-----------+-----------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> object_schema <span style="color:#f92672">|</span> object_name <span style="color:#f92672">|</span> index_name <span style="color:#f92672">|</span> lock_mode     <span style="color:#f92672">|</span> lock_data <span style="color:#f92672">|</span> lock_type <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">---------------+-------------+------------+---------------+-----------+-----------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> kris          <span style="color:#f92672">|</span> b           <span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span>       <span style="color:#f92672">|</span> IX            <span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span>      <span style="color:#f92672">|</span> <span style="color:#66d9ef">TABLE</span>     <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> kris          <span style="color:#f92672">|</span> a           <span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span>       <span style="color:#f92672">|</span> <span style="color:#66d9ef">IS</span>            <span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span>      <span style="color:#f92672">|</span> <span style="color:#66d9ef">TABLE</span>     <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> kris          <span style="color:#f92672">|</span> a           <span style="color:#f92672">|</span> <span style="color:#66d9ef">PRIMARY</span>    <span style="color:#f92672">|</span> S,REC_NOT_GAP <span style="color:#f92672">|</span> <span style="color:#ae81ff">20</span>        <span style="color:#f92672">|</span> RECORD    <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> kris          <span style="color:#f92672">|</span> a           <span style="color:#f92672">|</span> <span style="color:#66d9ef">PRIMARY</span>    <span style="color:#f92672">|</span> S,REC_NOT_GAP <span style="color:#f92672">|</span> <span style="color:#ae81ff">30</span>        <span style="color:#f92672">|</span> RECORD    <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> kris          <span style="color:#f92672">|</span> b           <span style="color:#f92672">|</span> <span style="color:#66d9ef">PRIMARY</span>    <span style="color:#f92672">|</span> X,REC_NOT_GAP <span style="color:#f92672">|</span> <span style="color:#ae81ff">10</span>        <span style="color:#f92672">|</span> RECORD    <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">---------------+-------------+------------+---------------+-----------+-----------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">5</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>We get another S-lock on <code>a.a_id=20</code> to ensure that our parent record stays unchanged until completion, and as we modify <code>b.b_id=10</code>, this is X-locked as in the normal case.</p>
<p>We observe:</p>
<ul>
<li>Defining foreign key constraints produces more S-locks.</li>
<li>Given a 1:n relationship between <code>a</code> and <code>b</code>, making changes to <code>a_id</code> fields of records in <code>b</code> will S-lock the records in <code>a</code> that the changed rows in <code>b.a_id</code> are pointing to.</li>
<li>We did not see this, but there was also a lookup in <code>a</code> to ensure that the <code>b.a_id</code> actually exists in <code>a</code>.</li>
</ul>
<p>Experiment yourself:</p>
<ul>
<li>Add a column <code>data integer not null</code> to b.</li>
<li>Make changes to <code>b.a_id</code> for one row, and to <code>b.data</code> for another row. How does the locking change?</li>
</ul>
<p>You will find:</p>
<ul>
<li>Making changes to <code>b.data</code> neither affects the relationship between the tables, nor creates S-locks in <code>a</code>.</li>
</ul>
<h2 id="given-the-observed-behavior-is-our-rmw-still-correct">
    <a href="#given-the-observed-behavior-is-our-rmw-still-correct">
	Given the observed behavior, is our RMW still correct?
    </a>
</h2>
<p>After looking at the locking behavior of these statements, and what we previously learned about locking: How would we <code>INSERT</code> and <code>UPDATE</code> the dependent records (<code>b</code> records) in our 1:n relationship correctly?</p>
<p>We can still manipulate all fields as before that are not foreign keys:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">drop</span> <span style="color:#66d9ef">table</span> b;
<span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> b (
  b_id int <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span> auto_increment,
  a_id int <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span>,
  <span style="color:#66d9ef">data</span> int <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span>,
  <span style="color:#66d9ef">primary</span> <span style="color:#66d9ef">key</span> (b_id)
  <span style="color:#66d9ef">index</span> (a_id).
  <span style="color:#66d9ef">constraint</span> a_id_exists <span style="color:#66d9ef">foreign</span> <span style="color:#66d9ef">key</span> (a_id) <span style="color:#66d9ef">references</span> a (a_id)
);
<span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> b <span style="color:#66d9ef">values</span> (<span style="color:#ae81ff">10</span>,<span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">10</span>), (<span style="color:#ae81ff">40</span>,<span style="color:#ae81ff">40</span>,<span style="color:#ae81ff">40</span>);
</code></pre></div><p>And the RMW for writes to <code>data</code> is as before:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">start</span> <span style="color:#66d9ef">transaction</span> <span style="color:#66d9ef">read</span> <span style="color:#66d9ef">write</span>;
<span style="color:#66d9ef">select</span> b_id, <span style="color:#66d9ef">data</span> <span style="color:#66d9ef">from</span> b <span style="color:#66d9ef">where</span> b_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span> <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">update</span>;
...
<span style="color:#66d9ef">update</span> b <span style="color:#66d9ef">set</span> <span style="color:#66d9ef">data</span> <span style="color:#f92672">=</span> <span style="color:#f92672">?</span> <span style="color:#66d9ef">where</span> b_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span><span style="color:#e6db74">&#39;;
</span><span style="color:#e6db74">commit;
</span></code></pre></div><p>When we make changes to the linking between <code>b</code> and <code>a</code>, we must put a share lock on the new <code>a.a_id</code> we intend to link to, to ensure it is present and does not change or vanish until completion.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">start</span> <span style="color:#66d9ef">transaction</span> <span style="color:#66d9ef">read</span> <span style="color:#66d9ef">write</span>;
<span style="color:#66d9ef">select</span> a_id <span style="color:#66d9ef">from</span> a <span style="color:#66d9ef">where</span> a_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span> <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">share</span>;
<span style="color:#66d9ef">select</span> b_id, a_id, <span style="color:#66d9ef">data</span> <span style="color:#66d9ef">from</span> b <span style="color:#66d9ef">where</span> b_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span> <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">update</span>;
...
<span style="color:#66d9ef">update</span> b <span style="color:#66d9ef">set</span> a_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span> <span style="color:#66d9ef">where</span> b_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span><span style="color:#e6db74">&#39;;
</span><span style="color:#e6db74">commit;
</span></code></pre></div><p>As this is a linking to be created, we have to use two distinct select statements for this, and the locks need to be in place before we make the change.</p>
<h2 id="self-referential-structures-and-locks">
    <a href="#self-referential-structures-and-locks">
	Self-referential structures and locks
    </a>
</h2>
<p>Let&rsquo;s create a tree <code>c</code> where we have records distinguished by <code>c.id</code>, and with <code>c.parent</code> pointing to the parent <code>c.id</code>. We then put in a few records, multiple levels deep:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> <span style="color:#66d9ef">c</span> (
  id integer <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span> <span style="color:#66d9ef">primary</span> <span style="color:#66d9ef">key</span>,
  parent integer <span style="color:#66d9ef">null</span>,
  <span style="color:#66d9ef">index</span>(parent),
  <span style="color:#66d9ef">constraint</span> up <span style="color:#66d9ef">foreign</span> <span style="color:#66d9ef">key</span> (parent) <span style="color:#66d9ef">references</span> <span style="color:#66d9ef">c</span> (id)
);

<span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> <span style="color:#66d9ef">c</span> <span style="color:#66d9ef">values</span> (<span style="color:#ae81ff">1</span>, <span style="color:#66d9ef">NULL</span>), (<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">1</span>), (<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">1</span>), (<span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">2</span>), (<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">2</span>), (<span style="color:#ae81ff">6</span>, <span style="color:#ae81ff">3</span>), (<span style="color:#ae81ff">7</span>, <span style="color:#ae81ff">3</span>), (<span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">3</span>), (<span style="color:#ae81ff">9</span>, <span style="color:#ae81ff">8</span>), (<span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">8</span>);
</code></pre></div><p>Again, we insert a new record:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">start</span> <span style="color:#66d9ef">transaction</span> <span style="color:#66d9ef">read</span> <span style="color:#66d9ef">write</span>;
mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> <span style="color:#66d9ef">c</span> <span style="color:#66d9ef">values</span> (<span style="color:#ae81ff">11</span>, <span style="color:#ae81ff">2</span>);

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> object_schema, object_name, index_name, lock_mode, lock_data, lock_type <span style="color:#66d9ef">from</span> performance_schema.data_locks;
<span style="color:#f92672">+</span><span style="color:#75715e">---------------+-------------+------------+---------------+-----------+-----------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> object_schema <span style="color:#f92672">|</span> object_name <span style="color:#f92672">|</span> index_name <span style="color:#f92672">|</span> lock_mode     <span style="color:#f92672">|</span> lock_data <span style="color:#f92672">|</span> lock_type <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">---------------+-------------+------------+---------------+-----------+-----------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> kris          <span style="color:#f92672">|</span> <span style="color:#66d9ef">c</span>           <span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span>       <span style="color:#f92672">|</span> IX            <span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span>      <span style="color:#f92672">|</span> <span style="color:#66d9ef">TABLE</span>     <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> kris          <span style="color:#f92672">|</span> <span style="color:#66d9ef">c</span>           <span style="color:#f92672">|</span> <span style="color:#66d9ef">PRIMARY</span>    <span style="color:#f92672">|</span> S,REC_NOT_GAP <span style="color:#f92672">|</span> <span style="color:#ae81ff">2</span>         <span style="color:#f92672">|</span> RECORD    <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">---------------+-------------+------------+---------------+-----------+-----------+
</span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">rollback</span>;
</code></pre></div><p>This looks exactly as we would expect from the previous case.</p>
<p>Then we modify an existing record, again, without surprises:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">start</span> <span style="color:#66d9ef">transaction</span> <span style="color:#66d9ef">read</span> <span style="color:#66d9ef">write</span>;
mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">update</span> <span style="color:#66d9ef">c</span> <span style="color:#66d9ef">set</span> parent<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> <span style="color:#66d9ef">where</span> id<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>;

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> object_schema, object_name, index_name, lock_mode, lock_data, lock_type <span style="color:#66d9ef">from</span> performance_schema.data_locks;
<span style="color:#f92672">+</span><span style="color:#75715e">---------------+-------------+------------+---------------+-----------+-----------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> object_schema <span style="color:#f92672">|</span> object_name <span style="color:#f92672">|</span> index_name <span style="color:#f92672">|</span> lock_mode     <span style="color:#f92672">|</span> lock_data <span style="color:#f92672">|</span> lock_type <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">---------------+-------------+------------+---------------+-----------+-----------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> kris          <span style="color:#f92672">|</span> <span style="color:#66d9ef">c</span>           <span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span>       <span style="color:#f92672">|</span> IX            <span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span>      <span style="color:#f92672">|</span> <span style="color:#66d9ef">TABLE</span>     <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> kris          <span style="color:#f92672">|</span> <span style="color:#66d9ef">c</span>           <span style="color:#f92672">|</span> <span style="color:#66d9ef">PRIMARY</span>    <span style="color:#f92672">|</span> X,REC_NOT_GAP <span style="color:#f92672">|</span> <span style="color:#ae81ff">10</span>        <span style="color:#f92672">|</span> RECORD    <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> kris          <span style="color:#f92672">|</span> <span style="color:#66d9ef">c</span>           <span style="color:#f92672">|</span> <span style="color:#66d9ef">PRIMARY</span>    <span style="color:#f92672">|</span> S,REC_NOT_GAP <span style="color:#f92672">|</span> <span style="color:#ae81ff">2</span>         <span style="color:#f92672">|</span> RECORD    <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">---------------+-------------+------------+---------------+-----------+-----------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">3</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">rollback</span>;
</code></pre></div><h2 id="upsert">
    <a href="#upsert">
	&ldquo;UPSERT&rdquo;
    </a>
</h2>
<p>The term &ldquo;UPSERT&rdquo; is database-speak for &ldquo;create a record, or if it exists, update it&rdquo;. The word is a portmanteau from Insert and Update. It can have three different resolutions for conflicts, and MySQL has three different special commands for this:</p>
<ul>
<li>
<p><em>Older Record wins:</em> When a new record is to be inserted, but an older record with this primary key already exists, the old record should stay unmodified. MySQL has the command <code>INSERT IGNORE</code> for this.</p>
</li>
<li>
<p><em>Newer Record wins:</em> When a new record is to be inserted, but an older record with this primary key already exists, the old record is to be deleted, then the new record is to be inserted. MySQL has the command <code>REPLACE INTO</code> for this.</p>
</li>
<li>
<p><em>Merge old and new:</em> When a new record is to be inserted, but an older record with this primary key already exists, the old and new records have to be merged somehow. MySQL has <code>INSERT ON DUPLICATE KEY UPDATE</code> and the <code>VALUES()</code> function for this.</p>
</li>
</ul>
<p>The generic way for this, without special commands, is again a RMW.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">start</span> <span style="color:#66d9ef">transaction</span> <span style="color:#66d9ef">read</span> <span style="color:#66d9ef">write</span>;
<span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> t <span style="color:#66d9ef">where</span> id <span style="color:#f92672">=</span> <span style="color:#f92672">?</span> <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">update</span>;
... <span style="color:#66d9ef">if</span> necessary, <span style="color:#66d9ef">select</span> referenced records <span style="color:#66d9ef">in</span> other tables <span style="color:#e6db74">&#34;for share&#34;</span>
... depending <span style="color:#66d9ef">on</span> the <span style="color:#66d9ef">result</span>, decide <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">or</span> <span style="color:#66d9ef">update</span>
<span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> t (id, ...) <span style="color:#66d9ef">values</span> (<span style="color:#f92672">?</span>, ...)
<span style="color:#66d9ef">OR</span>
<span style="color:#66d9ef">update</span> t <span style="color:#66d9ef">set</span> ... <span style="color:#66d9ef">where</span> id <span style="color:#f92672">=</span> <span style="color:#f92672">?</span>
<span style="color:#66d9ef">commit</span>;
</code></pre></div><p>This is also what we would expect any ORM to generate, if it has not implemented special support for the MySQL dialect.</p>


	
    </article>
</div>



            <footer>
    <p>
	&copy; Copyright 2021 Someone or something
    </p>
</footer>


        </main>

	





<script src="/js/bootstrap.js"></script>




<script src="/js/lunr.js"></script>





<script src="/js/app.js"></script>


    </body>
</html>
