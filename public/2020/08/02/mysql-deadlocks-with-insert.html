<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Die wunderbare Welt von Isotopp - MySQL Deadlocks with INSERT</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="site.webmanifest">
<link rel="apple-touch-icon" href="icon.png">
<link rel="favicon.ico" rel="icon" type="image/ico">





	



<link rel="stylesheet" href="/style.min.c5e5cd61f54911f9aafd1dbe09c2f90667957bfe1002126c87aace57759f3446.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
	<a class="navbar-brand" href="" rel="home" title=".Site.Title">
	    Die wunderbare Welt von Isotopp
	</a>
	<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
	</button>

	<div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
		
		
		<li class="nav-item ">
                    <a class="nav-link" href="/about/">
			
			<span>About</span>
			<span class="visually-hidden">(Current)</span>
		    </a>
		    
		</li>
            </ul>
            
	</div>
    </div>
</nav>


        <main role="main" class="container-fluid">

            


<div class="page">
    <article class="mysql-deadlocks-with-insert-page">
	<h1 class="title">
            MySQL Deadlocks with INSERT
	</h1>

	<p>Support Channel. &ldquo;Hi, I am getting deadlocks in the database and they occur when I have to rollback the transactions but if we don&rsquo;t have to roll back all transactions get executed.&rdquo; Wait, what? After some back and forth it becomes clear that the Dev experiences deadlocks and has data:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> pager <span style="color:#66d9ef">less</span>
mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> engine innodb status<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
...
MySQL thread id <span style="color:#ae81ff">142531</span>, OS thread handle <span style="color:#ae81ff">139990258222848</span>, query id <span style="color:#ae81ff">4799571</span>
somehost.somedomain someuser <span style="color:#66d9ef">update</span>
<span style="color:#66d9ef">INSERT</span> <span style="color:#66d9ef">into</span> sometable (identifier_id, currency, balance ) <span style="color:#66d9ef">VALUES</span> (<span style="color:#e6db74">&#39;d4e84cb1-4d56-4d67-9d16-1d548fd26b55&#39;</span>, <span style="color:#e6db74">&#39;EUR&#39;</span>, <span style="color:#e6db74">&#39;0&#39;</span>)
<span style="color:#f92672">***</span> (<span style="color:#ae81ff">2</span>) HOLDS THE <span style="color:#66d9ef">LOCK</span>(S):
RECORD LOCKS <span style="color:#66d9ef">space</span> id <span style="color:#ae81ff">3523</span> page <span style="color:#66d9ef">no</span> <span style="color:#ae81ff">1106463</span> n bits <span style="color:#ae81ff">224</span> <span style="color:#66d9ef">index</span> <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">of</span> <span style="color:#66d9ef">table</span> <span style="color:#f92672">`</span>somedb<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>sometable<span style="color:#f92672">`</span> trx id <span style="color:#ae81ff">9843342279</span> <span style="color:#66d9ef">lock</span> <span style="color:#66d9ef">mode</span> S locks gap <span style="color:#66d9ef">before</span> rec
</code></pre></div><p>and that is weird because of the <code>lock mode S locks gap</code> in the last line. We get the exact same statement with the exact same value on the second thread, but with <code>lock mode X locks gap</code>.</p>
<p>Both transactions have an undo log entry of the length 1 - one row, single insert and the insert has an S-lock.</p>
<h2 id="a-mystery-insert-and-opaque-code">
    <a href="#a-mystery-insert-and-opaque-code">
	A mystery INSERT and opaque code
    </a>
</h2>
<p>Many questions arise:</p>
<ul>
<li>how can an <code>INSERT</code> have an S-lock?</li>
<li>how can a single <code>INSERT</code> transaction deadlock?</li>
<li>what does the originating code look like?</li>
</ul>
<p>The last question can be actually answered by the developer, but because they are using Java, in true Java fashion it is almost - but not quite - useless to a database person.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Transactional</span><span style="color:#f92672">(</span>propagation <span style="color:#f92672">=</span> Propagation<span style="color:#f92672">.</span><span style="color:#a6e22e">REQUIRES_NEW</span><span style="color:#f92672">,</span> 
  timeout <span style="color:#f92672">=</span> MYSQL_TRANSACTION_TIMEOUT<span style="color:#f92672">,</span>
  rollbackFor <span style="color:#f92672">=</span> <span style="color:#f92672">{</span> 
    BucketNotFoundException<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span>
    DuplicateTransactionException<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span>
    BucketBalanceUpdateException<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span>
  <span style="color:#f92672">},</span> 
  isolation <span style="color:#f92672">=</span> Isolation<span style="color:#f92672">.</span><span style="color:#a6e22e">SERIALIZABLE</span>
<span style="color:#f92672">)</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">initiateBucketBalanceUpdate</span><span style="color:#f92672">(</span>Transaction transaction<span style="color:#f92672">)</span>
  <span style="color:#66d9ef">throws</span> BucketBalanceUpdateException<span style="color:#f92672">,</span>
         DuplicateTransactionException <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">validateAndInsertIdempotencyKey</span><span style="color:#f92672">(</span>transaction<span style="color:#f92672">);</span>
  <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">executeBucketBalanceUpdateFlow</span><span style="color:#f92672">(</span>transaction<span style="color:#f92672">);</span>
  <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">saveTransactionEntries</span><span style="color:#f92672">(</span>transaction<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>So, where is the SQL?</p>
<p>This is often a problem - Object Relational Mappers encapsulate the things that go on in the database so much that it is really hard for anybody - Developers, DBAs and everybody else - to understand what actually happens and make debugging quite painful.</p>
<p>Or, if they understand what goes on with the database, to map this to the code.</p>
<h2 id="transaction-isolation-level-serializable">
    <a href="#transaction-isolation-level-serializable">
	TRANSACTION ISOLATION LEVEL SERIALIZABLE
    </a>
</h2>
<p>In this case it is solvable, though. The <code>isolation = Isolation.SERIALIZABLE</code> is the culprit here.</p>
<p>So when we spoke about [transactions and isolation levels]({% link _posts/2020-07-29-mysql-transactions-the-logical-view.md %}) previously, I made the decision to leave the fourth and most useless isolation level out of the picture: <code>SET TRANSACTION ISOLATION LEVEL SERIALIZABLE</code>. <a href="https://dev.mysql.com/doc/refman/8.0/en/innodb-transaction-isolation-levels.html#isolevel_serializable" target="_blank" rel="noopener">The manual says</a>

:</p>
<blockquote>
<p><code>SERIALIZABLE</code></p>
<p>This level is like <code>REPEATABLE READ</code>, but InnoDB implicitly converts all plain <code>SELECT</code>  statements to <code>SELECT ... FOR SHARE</code> if autocommit is disabled.</p>
</blockquote>
<p>It then goes on to explain how <code>SERIALIZABLE</code> does nothing when there is no explicit transaction going on. It does not explain what it is good for (mostly: shooting yourself into the foot) and when you should use it (mostly: don&rsquo;t).</p>
<p>It does answer the question of &ldquo;Where to the S-Locks come from?&rdquo;, though.</p>
<p>The <code>SERIALIZABLE</code> isolation mode turns a normal <code>SELECT</code> statement into a Medusa&rsquo;s freeze ray that shoots S-Locks all over the tables onto everything it looks at, preventing other threads from changing these things until we end our transaction and drop our locks (And that is why you should not use it, and why I personally believe that your code is broken if it needs it).</p>
<h2 id="a-broken-rmw-and-lock-escalation">
    <a href="#a-broken-rmw-and-lock-escalation">
	A broken RMW and lock escalation
    </a>
</h2>
<p>So instead of a regular Read-Modify-Write</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">Session1<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">START</span> <span style="color:#66d9ef">TRANSACTION</span> <span style="color:#66d9ef">READ</span> <span style="color:#66d9ef">WRITE</span>;
Session1<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">FROM</span> sometable <span style="color:#66d9ef">WHERE</span> id<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span> <span style="color:#66d9ef">FOR</span> <span style="color:#66d9ef">UPDATE</span>; <span style="color:#75715e">-- X-lock granted on rec or gap
</span><span style="color:#75715e">-- ... Application decides INSERT or UPDATE
</span><span style="color:#75715e"></span>Session1<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">INSERT</span> <span style="color:#66d9ef">INTO</span> sometable (id, ...) <span style="color:#66d9ef">VALUES</span> ( <span style="color:#ae81ff">10</span>, ... );
Session1<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">COMMIT</span>;
</code></pre></div><p>we get the following broken Read-Modify-Write, minimum:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">Session1<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">START</span> <span style="color:#66d9ef">TRANSACTION</span> <span style="color:#66d9ef">READ</span> <span style="color:#66d9ef">WRITE</span>;
Session1<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">FROM</span> sometable <span style="color:#66d9ef">WHERE</span> id<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span> <span style="color:#66d9ef">FOR</span> <span style="color:#66d9ef">SHARE</span>; <span style="color:#75715e">-- S-lock granted on rec or gap
</span><span style="color:#75715e">-- ... Application decides INSERT or UPDATE
</span><span style="color:#75715e"></span>Session1<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">INSERT</span> <span style="color:#66d9ef">INTO</span> sometable (id, ...) <span style="color:#66d9ef">VALUES</span> ( <span style="color:#ae81ff">10</span>, ... ); <span style="color:#75715e">-- lock escalation to X
</span><span style="color:#75715e"></span>Session1<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">COMMIT</span>;
</code></pre></div><p>The <code>LOCK IN SHARE MODE</code> or equivalent <code>FOR SHARE</code> is not in the code, it is added implicitly by the isolation level <code>SERIALIZABLE</code>.</p>
<p>We get an S-Lock, which is not good for writing. Our transaction now did not get the required locks necessary for reading at the start of the transaction, because the later <code>INSERT</code> requires an X-lock, like any write statement would. The database needs to aquire the X-lock, that is, it needs to upgrade the S-lock to an X-lock.</p>
<p>If at that point in time another threads tries to run the exact same statement, which is what happens here, they already hold a second S-lock, preventing the first thread from completing their transaction (it is waiting until the second threads drops the S-lock or it times out).</p>
<p>And then that second thread also tries to upgrade their S-lock into an X-lock, which it can&rsquo;t do, because that first thread is trying to do the same thing, and we have the deadlock and a rollback.</p>
<h2 id="reproduction-of-the-problem">
    <a href="#reproduction-of-the-problem">
	Reproduction of the problem
    </a>
</h2>
<p>We can easily reproduce this.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">Session1<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">set</span> <span style="color:#66d9ef">transaction</span> <span style="color:#66d9ef">isolation</span> <span style="color:#66d9ef">level</span> <span style="color:#66d9ef">serializable</span>;
Session1<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">start</span> <span style="color:#66d9ef">transaction</span> <span style="color:#66d9ef">read</span> <span style="color:#66d9ef">write</span>;
Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

Session1<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> kris <span style="color:#66d9ef">where</span> id <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>;
<span style="color:#f92672">+</span><span style="color:#75715e">----+-------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> id <span style="color:#f92672">|</span> value <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+-------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> <span style="color:#ae81ff">10</span> <span style="color:#f92672">|</span>    <span style="color:#ae81ff">10</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+-------+
</span><span style="color:#75715e"></span>
Session1<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> performance_schema.data_locks<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
...
            LOCK_TYPE: <span style="color:#66d9ef">TABLE</span>
            LOCK_MODE: <span style="color:#66d9ef">IS</span>
          LOCK_STATUS: <span style="color:#66d9ef">GRANTED</span>
            LOCK_DATA: <span style="color:#66d9ef">NULL</span>
...
            LOCK_TYPE: RECORD
            LOCK_MODE: S,REC_NOT_GAP
          LOCK_STATUS: <span style="color:#66d9ef">GRANTED</span>
            LOCK_DATA: <span style="color:#ae81ff">10</span>
...

Session1<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">update</span> kris <span style="color:#66d9ef">set</span> value<span style="color:#f92672">=</span><span style="color:#ae81ff">11</span> <span style="color:#66d9ef">where</span> id <span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>;
</code></pre></div><p>We change the isolation level to <code>SERIALIZABLE</code> and start a transaction (because, as stated in the manual, autocommit does nothing). We then simply look at a single row, and check <code>PERFORMANCE_SCHEMA.DATA_LOCKS</code> afterwards. Lo and behold, S-Locks as promised by the manual.</p>
<p>Now, the setup for the deadlock with a second session, by doing the same thing:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">Session2<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">set</span> <span style="color:#66d9ef">transaction</span> <span style="color:#66d9ef">isolation</span> <span style="color:#66d9ef">level</span> <span style="color:#66d9ef">serializable</span>;
Session2<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">start</span> <span style="color:#66d9ef">transaction</span> <span style="color:#66d9ef">read</span> <span style="color:#66d9ef">write</span>;
Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

Session2<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> kris <span style="color:#66d9ef">where</span> id <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>;
<span style="color:#f92672">+</span><span style="color:#75715e">----+-------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> id <span style="color:#f92672">|</span> value <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+-------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> <span style="color:#ae81ff">10</span> <span style="color:#f92672">|</span>    <span style="color:#ae81ff">10</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+-------+
</span></code></pre></div><p>Checking the data_locks table we now see two sets of IS- and S-Locks belonging to two different threads. We go for an <code>UPDATE</code> here, because we chose existing rows and row locks, instead of non-existing rows and gap locks:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">Session1<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">update</span> kris <span style="color:#66d9ef">set</span> value<span style="color:#f92672">=</span><span style="color:#ae81ff">11</span> <span style="color:#66d9ef">where</span> id <span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>;
... hangs ...
</code></pre></div><p>and in the other connection:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">Session2<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">update</span> kris <span style="color:#66d9ef">set</span> value<span style="color:#f92672">=</span><span style="color:#ae81ff">13</span> <span style="color:#66d9ef">where</span> id <span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>;
ERROR <span style="color:#ae81ff">1213</span> (<span style="color:#ae81ff">40001</span>): Deadlock <span style="color:#66d9ef">found</span> <span style="color:#66d9ef">when</span> trying <span style="color:#66d9ef">to</span> <span style="color:#66d9ef">get</span> <span style="color:#66d9ef">lock</span>; try restarting <span style="color:#66d9ef">transaction</span>
</code></pre></div><p>Coming back to the first session, this now reads</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">Session1<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">update</span> kris <span style="color:#66d9ef">set</span> value<span style="color:#f92672">=</span><span style="color:#ae81ff">11</span> <span style="color:#66d9ef">where</span> id <span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>;
... hangs ...
Query OK, <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> affected (<span style="color:#ae81ff">2</span>.<span style="color:#ae81ff">43</span> sec)
<span style="color:#66d9ef">Rows</span> matched: <span style="color:#ae81ff">1</span>  Changed: <span style="color:#ae81ff">1</span>  Warnings: <span style="color:#ae81ff">0</span>
</code></pre></div><p>The timing given is the time I took to switch between terminals and to type the commands.</p>
<h2 id="resolution">
    <a href="#resolution">
	Resolution
    </a>
</h2>
<p>Coming back to the support case, the Dev analyzed their code and found out that what they are emitting is actually the sequence</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">Session1<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SET</span> <span style="color:#66d9ef">TRANSACTION</span> <span style="color:#66d9ef">ISOLATION</span> <span style="color:#66d9ef">LEVEL</span> <span style="color:#66d9ef">SERIALIZABLE</span>;
Session1<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">START</span> <span style="color:#66d9ef">TRANSACTION</span> <span style="color:#66d9ef">READ</span> <span style="color:#66d9ef">WRITE</span>;
Session1<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">FROM</span> sometable <span style="color:#66d9ef">WHERE</span> id<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>; <span style="color:#75715e">-- implied S-lock granted on rec or gap
</span><span style="color:#75715e">-- ... Application decides INSERT or UPDATE
</span><span style="color:#75715e"></span>
Session1<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">FROM</span> sometable <span style="color:#66d9ef">WHERE</span> id<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span> <span style="color:#66d9ef">FOR</span> UPDATEl <span style="color:#75715e">-- lock escalation to X
</span><span style="color:#75715e"></span>Session1<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">INSERT</span> <span style="color:#66d9ef">INTO</span> sometable (id, ...) <span style="color:#66d9ef">VALUES</span> ( <span style="color:#ae81ff">10</span>, ... );
Session1<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">COMMIT</span>;
</code></pre></div><p>so their code is already <em>almost</em> correct.</p>
<p>They do not need the double read and also not the isolation level <code>SERIALIZABLE</code>. This is an easy fix for them and the deadlocks are gone, the world is safe again.</p>
<p>So many things to learn from this:</p>
<ul>
<li>You won&rsquo;t need <code>SERIALIZABLE</code> unless your code is broken. Trying to use it is a warning sign.</li>
<li>A deadlock with an S-lock escalation means you need to check the isolation level.
<ul>
<li>In <code>SERIALIZABLE</code> it is totally possible to deadlock yourself with a simple invisible <code>SELECT</code> and a lone <code>INSERT</code> or <code>UPDATE</code>.</li>
</ul>
</li>
<li>The ORM will remove you quite a lot from the emitted SQL. Do you know how to trace your ORM and to get the actual SQL generated? If not, go and find out.
<ul>
<li>A server side trace will not save you - the server is a busy beast.</li>
<li>It also cannot see your stackframes, so it can&rsquo;t link your SQL to the line in your code that called the ORM. Yes, in the client side SQL trace, ideally you also want the tracer to bubble up the stack and give you the first line outside of the ORM to identify what is causing the SQL to be emitted and where in the code that happens.</li>
</ul>
</li>
<li>The deadlock information in <code>SHOW ENGINE INNODB STATUS</code> is painfully opaque, but learning to read it is worthwhile.
<ul>
<li>In reproduction, using performance schema is much easier and makes the sequence of events much easier to understand.</li>
<li>The server is not very good at explaining the root cause of deadlocks to a developer in the error messages and warnings generated.</li>
</ul>
</li>
</ul>


	
    </article>
</div>



            <footer>
    <p>
	&copy; Copyright 2021 Someone or something
    </p>
</footer>


        </main>

	





<script src="/js/bootstrap.js"></script>




<script src="/js/lunr.js"></script>





<script src="/js/app.js"></script>


    </body>
</html>
