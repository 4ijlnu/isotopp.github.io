<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Die wunderbare Welt von Isotopp - MySQL: Some Character Set Basics</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="site.webmanifest">
<link rel="apple-touch-icon" href="icon.png">
<link rel="favicon.ico" rel="icon" type="image/ico">





	



<link rel="stylesheet" href="/style.min.c5e5cd61f54911f9aafd1dbe09c2f90667957bfe1002126c87aace57759f3446.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
	<a class="navbar-brand" href="" rel="home" title=".Site.Title">
	    Die wunderbare Welt von Isotopp
	</a>
	<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
	</button>

	<div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
		
		
		<li class="nav-item ">
                    <a class="nav-link" href="/about/">
			
			<span>About</span>
			<span class="visually-hidden">(Current)</span>
		    </a>
		    
		</li>
            </ul>
            
	</div>
    </div>
</nav>


        <main role="main" class="container-fluid">

            


<div class="page">
    <article class="mysql-some-character-set-basics-page">
	<h1 class="title">
            MySQL: Some Character Set Basics
	</h1>

	<p>This is the updated and english version of some older posts of mine in German. It is likely still incomplete, and will need information added to match current MySQL, but hopefully it is already useful.</p>
<p>Old source articles in German: <a href="https://blog.koehntopp.info/2006/10/01/mysql-zeichensatz-grundlagen.html" target="_blank" rel="noopener">1</a>

, <a href="https://blog.koehntopp.info/2006/08/06/zeichensatz-rger.html" target="_blank" rel="noopener">2</a>

 and <a href="https://blog.koehntopp.info/2012/02/10/faq-mein-mysqldump-zerst-rt-meine-umlaute.html" target="_blank" rel="noopener">3</a>

.</p>
<h2 id="some-vocabulary">
    <a href="#some-vocabulary">
	Some vocabulary
    </a>
</h2>
<p><p class="md__image">
  <img src="/uploads/charset.png" alt=""  />
</p>

</p>
<p><em>Symbol, Font, Encoding and Collation - what do they even mean?</em></p>
<p>A character set is a collection of symbols that belong together. That is a completely abstract thing, and also almost useless. The only thing you can do with a character set is decide if a specific symbol is legal within a context or not. And, if it is legal, what position the symbol in the character set has (the code point).</p>
<p>To be able to print symbols they need a shape, which is defined in a Font. For example is this here: &ldquo;<!-- raw HTML omitted -->ö<!-- raw HTML omitted -->&rdquo; a letter &ldquo;ö&rdquo; in Arial, and &ldquo;<!-- raw HTML omitted -->ö<!-- raw HTML omitted -->&rdquo; the same thing in a different font, Times New Roman.</p>
<p>To be able to use symbols with computers they need a binary represenation of their code point, an encoding. In my Terminal we are using utf8. The Text &ldquo;Köhntopp&rdquo; is being represented as the byte sequence <code>4b c3 b6 68 6e 74 6f 70 70</code>. <a href="https://www.compart.com/en/unicode/U&#43;00F6" target="_blank" rel="noopener">LATIN SMALL LETTER O WITH DIARESIS</a>

 has the code point <code>0x00F6</code>, which is being represented as <code>C3 B6</code> in utf8 encoding.</p>
<pre><code class="language-console" data-lang="console">$ echo Köhntopp | hexdump -C
00000000  4b c3 b6 68 6e 74 6f 70  70 0a                    |K..hntopp.|
0000000a
</code></pre><p>If I change the terminal settings to use ISO-8859-1 (&ldquo;Latin1&rdquo;) instead, the same text is being encoded differently - <code>4b f6 68 6e 74 6f 70 70</code>. The ö is now <code>F6</code>.</p>
<pre><code class="language-console" data-lang="console">$ echo Köhntopp | hexdump -C
00000000  4b f6 68 6e 74 6f 70  70 0a                       |K.hntopp.|
00000009
</code></pre><p>If you have two character sequences and want to compare or sort them, you need a set of comparison and ordering rules, a collation. You can think of a collation as a canonical representation of an encoding for comparison and sorting.</p>
<p>For example, the collation latin1_german1_ci represents &ldquo;Köhntopp&rdquo; internally as &ldquo;kohntopp&rdquo; and uses this internal represenation to compare it to other strings or sort it. But in storage we always find the original string, &ldquo;Köhntopp&rdquo;.</p>
<p>There is a second german language collation, latin1_german2_ci, which internally writes &ldquo;Köhntopp&rdquo; as &ldquo;koehntopp&rdquo; to compare and sort - but it will also save the same &ldquo;Köhntopp&rdquo; to disk.</p>
<h2 id="the-variants-of-unicode-and-unicode-encoding">
    <a href="#the-variants-of-unicode-and-unicode-encoding">
	The variants of Unicode and Unicode encoding
    </a>
</h2>
<p>ASCII was a 7bit character set of 128 characters from 0 to 127. It works with english, but with almost no other writing systems in the world.</p>
<p>A set of 8 bit character sets were defined in ISO-8859, among them ISO-8859-1 (&ldquo;latin1&rdquo;), later slightly revised to ISO-8859-15 (modified to contain, among other things, the Euro sign). The code points that exist in both ISO-8859-1 and ASCII are identical, ISO-8859-1 is a full superset of ASCII.</p>
<p>ISO-8859 also contained other character sets for Cyrillic, Arabic, Greek, Hebrew and other languages, but because of the limitation to 8 bits, it was not possible to easily write text that switches between languages.</p>
<blockquote>
<p><em>Note:</em> The character set called <code>latin1</code> in MySQL is actually <code>Windows CP1252</code>, which is a superset of <code>iso-8859-1</code>. See <a href="https://mysqlserverteam.com/debugging-character-set-issues-by-example/" target="_blank" rel="noopener">this article</a>

 for details.</p>
</blockquote>
<p>Unicode development started in 1991 as a 16 bit character set, and it was assumed that this is sufficient to hold all characters from all possible writing systems. Unicode was design as a superset of ISO-8859-1, so codepoints that exist in both character sets are identical.</p>
<p>In 1996 it became clear that a set of 65536 characters was not sufficient, and Unicode 2.0 was fitted with an extension mechanism to allow more than 65536 symbols. Again, this extension is a true superset of original Unicode.</p>
<p>As of March 2020, Unicode 13.0 contains some 140k characters from 154 writing systems. The definition of Unicode 13.0 currently allows for 1.112064 possible characters. Some code points in the lower 65536 characters are reserved to encode <em>surrogate pairs</em>, basically extension characters for the original 16 bit character set, resulting in a weird number for the total possible characters.</p>
<p>16 Bit Unicode can be stored as UCS2 (what Windows NT used to use) - a fixed length encoding, which instead of 8 bit characters now uses 16 bit characters. When writing western languages, every other byte in text is 0.</p>
<p>UTF-16 extends UCS2 and uses variable length encoding of 2 bytes or 4 bytes to allow representation of all unicode characters, even those beyond the initial 65536 characters.</p>
<p>Unix systems tend to use UTF-8 (utf8), a variable length encoding in which Unicode characters are 1-3 bytes in length (for the initial 65536 characters of Unicode 1.0), or 1-4 bytes in length (for full unicode).</p>
<h2 id="mysql-server-terms">
    <a href="#mysql-server-terms">
	MySQL Server Terms
    </a>
</h2>
<p>MySQL names an encoding a &ldquo;CHARACTER SET&rdquo; or &ldquo;CHARSET&rdquo;. The charsets available in the server can be listed with <code>SHOW CHARSET</code>, or by searching through <code>INFORMATION_SCHEMA.CHARACTER_SETS</code>. In both cases, looking at the <code>Maxlen</code> column will tell you how long a symbols encoding in bytes can become in the worst case.</p>
<p>Conversely, <code>SHOW COLLATION</code> (and <code>INFORMATION_SCHEMA.COLLATIONS</code>) will show you the collations the server knows about. Collations are not things that can be used standalone, they always belong to charsets. So <code>INFORMATION_SCHEMA.COLLATION_CHARACTER_SET_APPLICABILITY</code> tells you which collation can be used with which character set (or you <code>SHOW COLLATION WHERE Charset = &quot;...&quot;</code>).</p>
<h2 id="mysql-objects-with-a-character-set-and-collation">
    <a href="#mysql-objects-with-a-character-set-and-collation">
	MySQL objects with a character set and collation
    </a>
</h2>
<p>The only storage thing in MySQL that <em>has</em> a character set and a collation is a column. Columns that store text (<code>VARCHAR</code>, all <code>TEXT</code> types, textual <code>enum</code> and JSON objects) have a character set and a collation. In JSON it is fixed by the standard, for the others we can set it. Other things such as tables, databases and servers provide a hierarchy of defaults.</p>
<p>The other thing in MySQL that <em>has</em> a character set and a collation is the connection. For the purpose of our discussion the connection represents the character set that your terminal or application uses in the server. So when you tell the server with <code>SET NAMES</code> what you are using, the server believes you.</p>
<p>MySQL converts, if possible, between connection and column. So when you send a string in utf8 through your connection that ends up being stored in a latin1 column, MySQL will turn that <code>0xc3b6</code> in the connection into a <code>0xf6</code> on disk. On read, it will do the opposite, if necessary and possible.</p>
<p>MySQL also converts if you convert columns. So if you <code>ALTER TABLE t MODIFY COLUMN c VARCHAR(80) CHARSET utf8</code> and that was previously a latin1 column, MySQL will take the <code>0xf6</code>es and turn them into <code>0xc3b6</code>es instead. All of that is automatic, safe and lossless, if possible. There are warnings and errors if not.</p>
<p>But let&rsquo;s look at the details step by step.</p>
<h2 id="setting-charset-and-collation-on-a-column">
    <a href="#setting-charset-and-collation-on-a-column">
	Setting charset and collation on a column
    </a>
</h2>
<p>Every string in MySQL is labeled with an charset and a collation. For database objects that happens at the column level: A column with CHAR, VARCHAR, or any TEXT type always has a charset and a collation. The same can be true for an ENUM type that contains strings.</p>
<p>If you define these without specifying, the column will inherit the table defaults. If you specify no table default, the table will inherit the database default, which in turn inherits from the server default, which is defined in the <code>my.cnf</code>:</p>
<pre><code class="language-console" data-lang="console">[mysqld]
default-character-set=utf8mb4
default-collation=utf8_0900_ai_ci
</code></pre><p>Or you set them at the database level:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">database</span> kris<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
       <span style="color:#66d9ef">Database</span>: kris
<span style="color:#66d9ef">Create</span> <span style="color:#66d9ef">Database</span>: <span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">DATABASE</span> <span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span> <span style="color:#75715e">/*!40100 DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci */</span> <span style="color:#75715e">/*!80016 DEFAULT ENCRYPTION=&#39;N&#39; */</span>
<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">01</span> sec)
</code></pre></div><p>Or at the table level:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> chset<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
       <span style="color:#66d9ef">Table</span>: chset
<span style="color:#66d9ef">Create</span> <span style="color:#66d9ef">Table</span>: <span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#f92672">`</span>chset<span style="color:#f92672">`</span> (
  <span style="color:#f92672">`</span>id<span style="color:#f92672">`</span> int unsigned <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> AUTO_INCREMENT,
  <span style="color:#f92672">`</span><span style="color:#66d9ef">c</span><span style="color:#f92672">`</span> char(<span style="color:#ae81ff">20</span>) CHARACTER <span style="color:#66d9ef">SET</span> utf8 <span style="color:#66d9ef">COLLATE</span> utf8_general_ci <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>d<span style="color:#f92672">`</span> varchar(<span style="color:#ae81ff">20</span>) CHARACTER <span style="color:#66d9ef">SET</span> cp850 <span style="color:#66d9ef">COLLATE</span> cp850_general_ci <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>t<span style="color:#f92672">`</span> text CHARACTER <span style="color:#66d9ef">SET</span> latin1 <span style="color:#66d9ef">COLLATE</span> latin1_german1_ci,
  <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span> (<span style="color:#f92672">`</span>id<span style="color:#f92672">`</span>)
) ENGINE<span style="color:#f92672">=</span>InnoDB <span style="color:#66d9ef">DEFAULT</span> CHARSET<span style="color:#f92672">=</span>utf8mb4 <span style="color:#66d9ef">COLLATE</span><span style="color:#f92672">=</span>utf8mb4_0900_ai_ci
<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><h2 id="string-literals">
    <a href="#string-literals">
	String Literals
    </a>
</h2>
<p>A string literal in MySQL is written in double quotes, &ldquo;a string literal&rdquo;. When nothing else is specified, the connections character set and collation are being used.</p>
<p>An identifier in MySQL is written as a bare word <code>tablename</code> or written in backticks `<code>weird tablename</code>`. When written in backticks, the identifier can contain any utf8 unicode character (unfortunately, not utf8mb4 character, so you have to constrain yourself to the BMP). <em>Don&rsquo;t do this in production, though.</em></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> <span style="color:#f92672">`</span><span style="color:#960050;background-color:#1e0010">❤</span><span style="color:#f92672">`</span> ( <span style="color:#f92672">`</span><span style="color:#960050;background-color:#1e0010">✔</span><span style="color:#f92672">`</span> serial ) ;
Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">07</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> <span style="color:#f92672">`</span><span style="color:#960050;background-color:#1e0010">❤</span><span style="color:#f92672">`</span> <span style="color:#66d9ef">values</span> (<span style="color:#ae81ff">1</span>);
Query OK, <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">02</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> <span style="color:#f92672">`</span><span style="color:#960050;background-color:#1e0010">❤</span><span style="color:#f92672">`</span>;
<span style="color:#f92672">+</span><span style="color:#75715e">-----+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> <span style="color:#960050;background-color:#1e0010">✔</span>   <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">-----+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span>   <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">-----+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>If you check, the table is stored with the filename <code>@2764.ibd</code> on disk.</p>
<p>The full notation for a string literal is <code>_charsetname &quot;string&quot; COLLATE collationname</code>. The <code>_charsetname</code> thing is called an introducer and tells the parser what character set label to put on the string that follows. It does not convert, the <code>CONVERT()</code> function would do that.</p>
<p>A string literal can also be written as <code>X'hexcode'</code>, so this works:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> _latin1 X<span style="color:#e6db74">&#39;F6&#39;</span> <span style="color:#66d9ef">as</span> umlaut;
<span style="color:#f92672">+</span><span style="color:#75715e">--------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> umlaut <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> <span style="color:#960050;background-color:#1e0010">ö</span>      <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>This creates a string literal from the hex code <code>0xF6</code> and labels it as latin1. The statement is then run, produces an Umlaut, and this Umlaut is then emitted as a result table. Because the connection is set to utf8, the Umlaut is converted to utf8, yields <code>C3 B6</code> and that is sent to the terminal, where it renders correctly.</p>
<p>This is the automatic conversion at work, that I spoke about earlier.</p>
<p>When we leave the label off, the conversion does not work. When we lie, the result is invalid and rejected:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> X<span style="color:#e6db74">&#39;F6&#39;</span> <span style="color:#66d9ef">as</span> umlaut;
<span style="color:#f92672">+</span><span style="color:#75715e">----------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> umlaut         <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> <span style="color:#ae81ff">0</span>xF6           <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> _utf8 X<span style="color:#e6db74">&#39;F6&#39;</span> <span style="color:#66d9ef">as</span> umlaut;
ERROR <span style="color:#ae81ff">1300</span> (HY000): Invalid utf8 character string: <span style="color:#e6db74">&#39;F6&#39;</span>
</code></pre></div><h2 id="charset-on-a-connection">
    <a href="#charset-on-a-connection">
	Charset on a connection
    </a>
</h2>
<p>The <em>other</em> thing that has a character set is the connection from the client to the database server. That is required, because when you type for example &ldquo;ö&rdquo; into a utf8 terminal to send it to <code>kris.chset</code>, column <code>t</code> as defined above, it has to be converted from utf8 (<code>C3B6</code>) to latin1 (<code>F6</code>), because the column <code>t</code> is defined with a charset of latin1.</p>
<p>MySQL does that automatically for you, if a conversion exists: You sent a utf8 <code>c3b6</code>, MySQL detects the column defined as latin1, and tries to convert, yielding <code>f6</code>, which is then stored.</p>
<p>How do you tell MySQL what charset the connection uses?</p>
<p>You can set a default with <code>default-character-set</code> and <code>default-encoding</code> in the <code>[mysql]</code> section of your <code>my.cnf</code> to tell MySQL what character set your terminal uses, or use the command <code>SET NAMES</code> to change it on the fly.</p>
<p>If I am setting up my terminal to send utf8, and <code>SET NAMES utf8</code>, these things match and all will be well and converted correctly, if at all possible.</p>
<p>I can check, using the <code>HEX()</code> function to see the actual bytes:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">root<span style="color:#f92672">@</span>localhost [kris]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">set</span> <span style="color:#66d9ef">names</span> utf8;
Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

root<span style="color:#f92672">@</span>localhost [kris]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> hex(<span style="color:#e6db74">&#34;ö&#34;</span>);
<span style="color:#f92672">+</span><span style="color:#75715e">-----------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> hex(<span style="color:#e6db74">&#34;ö&#34;</span>) <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">-----------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> C3B6      <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">-----------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>Switching my terminal to latin1, and then telling the database about this with <code>SET NAMES latin1</code>, I get:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">root<span style="color:#f92672">@</span>localhost [kris]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">set</span> <span style="color:#66d9ef">names</span> latin1;
Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

root<span style="color:#f92672">@</span>localhost [kris]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> hex(<span style="color:#e6db74">&#34;ö&#34;</span>);
<span style="color:#f92672">+</span><span style="color:#75715e">----------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> hex(<span style="color:#e6db74">&#34;ö&#34;</span>) <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> F6       <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>So this actually works.</p>
<h2 id="mysql-converts-automatically">
    <a href="#mysql-converts-automatically">
	MySQL converts automatically
    </a>
</h2>
<p>Now, let&rsquo;s use a utf8-Client to store data into a column into <code>kris.chset.t</code>, which is latin1. What will happen?</p>
<p>MySQL converts this automatically and we can show this.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">root<span style="color:#f92672">@</span>localhost [kris]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">set</span> <span style="color:#66d9ef">names</span> utf8;
Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> kris.chset (id, t) <span style="color:#66d9ef">values</span> ( <span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;ö&#34;</span>);
Query OK, <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">02</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> hex(<span style="color:#e6db74">&#34;ö&#34;</span>), hex(t), t <span style="color:#66d9ef">from</span> kris.chset <span style="color:#66d9ef">where</span> id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
<span style="color:#f92672">+</span><span style="color:#75715e">-----------+--------+------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> hex(<span style="color:#e6db74">&#34;ö&#34;</span>)  <span style="color:#f92672">|</span> hex(t) <span style="color:#f92672">|</span> t    <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">-----------+--------+------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> C3B6      <span style="color:#f92672">|</span> F6     <span style="color:#f92672">|</span> <span style="color:#960050;background-color:#1e0010">ö</span>    <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">-----------+--------+------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>I am sending <code>SET NAMES utf8</code> and I am inserting a row <code>id=1</code> into the table <code>kris.chset</code> (see above for the definition, which has the charset latin1).</p>
<p>Selecting the value back, I see the hex code for an actual &ldquo;ö&rdquo;, <code>C3B6</code>, utf8, so I know my terminal sends utf8.</p>
<p>I also see the hex code stored in the table, <code>F6</code>, by selecting the column value from <code>t</code>, wrapped in the <code>HEX()</code> function.</p>
<p>And on reading that back, I am still getting an &ldquo;ö&rdquo;. That proves the database sent me a <code>C3B6</code>, converting back from the storage character set to the terminal character set, as declared with <code>SET NAMES</code>.</p>
<p>So as long as I am not lying to the database about what my connection sends, values should be transparently converted back and forth if at all possible.</p>
<h2 id="convert-length-and-char_length-functions">
    <a href="#convert-length-and-char_length-functions">
	CONVERT(), LENGTH() and CHAR_LENGTH() functions
    </a>
</h2>
<p>Normally you will never need this, but it is possible to change the character set of a column or string literal explicitly using the <code>convert( ... using ... )</code> function:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> hex(<span style="color:#e6db74">&#34;ö&#34;</span>);
<span style="color:#f92672">+</span><span style="color:#75715e">-----------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> hex(<span style="color:#e6db74">&#34;ö&#34;</span>)  <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">-----------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> C3B6      <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">-----------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> hex(<span style="color:#66d9ef">convert</span>(<span style="color:#e6db74">&#34;Köhntopp&#34;</span> <span style="color:#66d9ef">using</span> latin1)) <span style="color:#66d9ef">as</span> example;
<span style="color:#f92672">+</span><span style="color:#75715e">------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> example          <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> <span style="color:#ae81ff">4</span>BF6686E746F7070 <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">------------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>After validating that my umlaut is indeed sent as <code>C3B6</code>, I am using a string with an Umlaut as an input to <code>CONVERT( ... USING ... )</code>. I am converting to latin1, and as you can see, I am indeed getting an <code>F6</code> as the second byte.</p>
<p>There are other encodings of unicode, too. Windows systems for example often use ucs2 instead of utf8. That is, each symbol is stored as a 16 bit code:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> hex(<span style="color:#66d9ef">convert</span>(<span style="color:#e6db74">&#34;Köhntopp&#34;</span> <span style="color:#66d9ef">using</span> ucs2)) <span style="color:#66d9ef">as</span> example;
<span style="color:#f92672">+</span><span style="color:#75715e">----------------------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> example                          <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----------------------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> <span style="color:#ae81ff">004</span>B00F60068006E0074006F00700070 <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----------------------------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>My Umlaut ends up being <code>00f6</code> on disk.</p>
<p>The points to take away from this: Some character sets have fixed length codes for letters. In latin1, each letter takes the fixed amount of one byte. In ucs2, each letter takes the fixed amount of 2 bytes.</p>
<p>Other character set have variable length encodings. In utf8, each letter can be between 1 and 3 bytes long. Later Unicode extensions define a larger character set, and utf32 stores them in a fixed set of 4 byte characters (3 of them 0 for the latin1 subset), while utf8mb4 stores them in 1 to 4 bytes, depending on the symbol.</p>
<p>Depending on what we want to know we have to ask differently:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#66d9ef">length</span>(<span style="color:#e6db74">&#34;Köhntopp&#34;</span>) <span style="color:#66d9ef">as</span> len, <span style="color:#66d9ef">char_length</span>(<span style="color:#e6db74">&#34;Köhntopp&#34;</span>) <span style="color:#66d9ef">as</span> clen;
<span style="color:#f92672">+</span><span style="color:#75715e">-----+------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> len <span style="color:#f92672">|</span> clen <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">-----+------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span>   <span style="color:#ae81ff">9</span> <span style="color:#f92672">|</span>    <span style="color:#ae81ff">8</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">-----+------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#66d9ef">length</span>(<span style="color:#66d9ef">convert</span>(<span style="color:#e6db74">&#34;Köhntopp&#34;</span> <span style="color:#66d9ef">using</span> ucs2)) <span style="color:#66d9ef">as</span> len, <span style="color:#66d9ef">char_length</span>(<span style="color:#66d9ef">convert</span>(<span style="color:#e6db74">&#34;Köhntopp&#34;</span> <span style="color:#66d9ef">using</span> ucs2)) <span style="color:#66d9ef">as</span> clen;
<span style="color:#f92672">+</span><span style="color:#75715e">------+------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> len  <span style="color:#f92672">|</span> clen <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">------+------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span>   <span style="color:#ae81ff">16</span> <span style="color:#f92672">|</span>    <span style="color:#ae81ff">8</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">------+------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>The function <code>LENGTH()</code> gives us the length of a symbol or string in bytes, which is dependent on the character set encoding used. The function <code>CHAR_LENGTH()</code> gives us the length of the symbol or string in symbols, which is fixed and independent of the character set encoding.</p>
<p>It is important to use the right function depending on what you want to know.</p>
<p>The default character set in MySQL you should be using is <code>utf8mb4</code>.</p>
<h2 id="comparison-and-sorting">
    <a href="#comparison-and-sorting">
	Comparison and Sorting
    </a>
</h2>
<p>When MySQL originally gained character set support, this was done by implementing a comparison function. The same function was used for sorting and comparison. So when &ldquo;Köhntopp&rdquo; sorts as &ldquo;kohntopp&rdquo; in the latin1_german1_ci collation, it also means that searching for &ldquo;Köhntopp&rdquo; will find &ldquo;Köhntopp&rdquo; as well as &ldquo;kohntopp&rdquo;, because to the comparison function they are the same string.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> t <span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
       <span style="color:#66d9ef">Table</span>: t
<span style="color:#66d9ef">Create</span> <span style="color:#66d9ef">Table</span>: <span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#f92672">`</span>t<span style="color:#f92672">`</span> (
  <span style="color:#f92672">`</span>id<span style="color:#f92672">`</span> bigint unsigned <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> AUTO_INCREMENT,
  <span style="color:#f92672">`</span>d<span style="color:#f92672">`</span> varchar(<span style="color:#ae81ff">20</span>) CHARACTER <span style="color:#66d9ef">SET</span> latin1 <span style="color:#66d9ef">COLLATE</span> latin1_german1_ci <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#66d9ef">UNIQUE</span> <span style="color:#66d9ef">KEY</span> <span style="color:#f92672">`</span>id<span style="color:#f92672">`</span> (<span style="color:#f92672">`</span>id<span style="color:#f92672">`</span>)
)
<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> t;
<span style="color:#f92672">+</span><span style="color:#75715e">----+-----------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> id <span style="color:#f92672">|</span> d         <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+-----------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span>  <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span> Köhntopp  <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span> kohntopp  <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+-----------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">2</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> t <span style="color:#66d9ef">where</span> d <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Köhntopp&#34;</span>;
<span style="color:#f92672">+</span><span style="color:#75715e">----+-----------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> id <span style="color:#f92672">|</span> d         <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+-----------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span>  <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span> Köhntopp  <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span> kohntopp  <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+-----------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">2</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>This was not exactly what most people expected, so in MySQL 8 things are a bit more differentiated when using <code>utf8mb4</code>. From <a href="https://dev.mysql.com/doc/refman/8.0/en/charset-collation-names.html" target="_blank" rel="noopener">the manual</a>

:</p>
<p>| Suffix | Meaning |
+&mdash;&mdash;&ndash;+&mdash;&mdash;&mdash;+
| _ai    | Accent-insensitive |
| _as    | Accent-sensitive   |
| _ci    | Case-insensitive   |
| _cs    | Case-sensitive     |
| _ks    | Kana-sensitive     |
| _bin   | Binary             |</p>
<p>&ldquo;Kana-sensitive&rdquo; collations distinguish Hiragana characters from Katakana characters in Japanese.</p>
<p>The collation you want with utf8mb4 is <code>utf8mb4_0900_ai_ci</code> (and replace ai and ci as necessary). The 0900 part is a reference to <a href="http://www.unicode.org/Public/UCA/9.0.0/allkeys.txt" target="_blank" rel="noopener">UCA 9.0.0</a>

, the current Unicode Comparison Algorithm. MySQL also supports UCA 5.2.0 (<code>utf8mb4_520_ci</code>) and 4.0.0 (<code>utf8mb4_unicode_ci</code>), but these have no ai/as variants.</p>
<p>UCA 9.0.0 solves the Köhntopp/koehntopp problem by defining different functions for searching things (testing for equality) and ordering (testing for smaller than).</p>
<h2 id="why-utf8mb4-and-not-simply-utf8">
    <a href="#why-utf8mb4-and-not-simply-utf8">
	Why utf8mb4, and not simply utf8?
    </a>
</h2>
<p>MySQL gained character set support with the MySQL 4.1 series of server releases in 2003. At that time, in MySQL utf8 was a character set with room for 65536 (2^16) code points, and the UCS2 encoding (for 16 bit fixed width characters used in Windows) plus the UTF8 encoding (for variable length characters of 1-3 bytes in length).</p>
<p>MySQL at that point in time changed character sets and collations several times, as bugs were detected and fixed.</p>
<p>This created a lot of problems: In databases, an Index is created by extracting the indexed column from a table, sorting it, and storing it next to the table in sorted order with pointers to the original rows. An index is, in short, a materialized order for the indexed column, in order to speed searches.</p>
<p>Now if you change the character set or the order of symbols in the character set by fixing the collation, the materialized order of the index differs from newly fixed and redefined order to the fixed collation. When upgrading to the changed server version the index needs to be dropped and recreated - which for large databases with many indexes on large tables can take a very, very long time.</p>
<p>If you do not do this, a query such as</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">FROM</span> t <span style="color:#66d9ef">WHERE</span> d <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;kohntopp&#34;</span>;
</code></pre></div><p>may find different results depending on the optimizer using an index (pre-update rules apply until the index is recreated) or not using an index (post-update rules apply immediately). This is unpredictable, and hence bad behavior.</p>
<p>It was decided that MySQL will, in order to simplify updates, never do this ever again.</p>
<p>Instead fixes and changes will be publicised under new names so that changes could be made at will and a pace set by the user by <code>ALTER TABLE</code>ing the index definitions from the old collation name to the new name.</p>
<p>Hence we have utf8 (the 16-bit character set) and utf8mb4 (the larger than 16 bit character set) that was defined later. And we have even collations referring to different UCA rules for collating utf8mb4 in order to allow controlled migration to newer, better comparison rules.</p>
<p>The same is true for Timezones: MySQL does not use operating system sort and comparison rules as offered in the glibc functions, but brings its own, and it also does not use Timezone functions and rules as offered by glibc, but again uses its own.</p>
<p>That provides stable and controlled migration that is also independent of operating system updates - the same comparison and index rules exist indendently of glibc updates, and on Linux, MacOS and Windows. This also keeps binary data files portable and upgradable across operating systems and database versions.</p>
<p>Compare that for example to Postgres, which uses glibc functions for string comparison, sorting and for timezone conversions. In Postgres, you have to be aware of operating system updates that affect sorting, comparison or timezones, and you have to recreate indexes every time you make changes to these operating system functions. Noticing glibc updates that affect the function of the database on a system with security auto-updates can be very hard.</p>
<h2 id="fixing-broken-data">
    <a href="#fixing-broken-data">
	Fixing broken data
    </a>
</h2>
<p>Sometimes data ends up inside the database, converted from latin1 to utf8 by an application and then again by the database. This can only happen when the declared character set of the connection (<code>SET NAMES</code>) and the data sent to not match.</p>
<p>For example, if you define a table with a <code>VARCHAR</code> column in latin1, and set the connection to latin1, but then send actual utf8 data to the table, you not triggering a conversion (connection and column have the same character set), but the data is not valid latin1.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> t ( id serial, d varchar(<span style="color:#ae81ff">20</span>) charset latin1 );
Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">08</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">set</span> <span style="color:#66d9ef">names</span> latin1; <span style="color:#75715e">-- we will be sending utf8
</span><span style="color:#75715e"></span>Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> t ( id, d ) <span style="color:#66d9ef">values</span> ( <span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;Köhntopp&#34;</span>); <span style="color:#75715e">-- this is utf8
</span><span style="color:#75715e"></span>Query OK, <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">01</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> hex(d) <span style="color:#66d9ef">from</span> t <span style="color:#66d9ef">where</span> id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>; <span style="color:#75715e">-- stored c3b6, should be f6
</span><span style="color:#75715e"></span><span style="color:#f92672">+</span><span style="color:#75715e">--------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> hex(d)             <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> <span style="color:#ae81ff">4</span>BC3B6686E746F7070 <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">set</span> <span style="color:#66d9ef">names</span> utf8;
Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected, <span style="color:#ae81ff">1</span> warning (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> t; <span style="color:#75715e">-- output broken
</span><span style="color:#75715e"></span><span style="color:#f92672">+</span><span style="color:#75715e">----+-------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> id <span style="color:#f92672">|</span> d           <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+-------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span>  <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span> KÃ<span style="color:#960050;background-color:#1e0010">¶</span>hntopp   <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+-------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>If we were to convert the column to utf8, the data would als be converted. But since it already is <code>c3b6</code>, this must not happen. So this does not work:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> hex(d) <span style="color:#66d9ef">from</span> t;
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> hex(d)             <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> <span style="color:#ae81ff">4</span>BC3B6686E746F7070 <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">alter</span> <span style="color:#66d9ef">table</span> t <span style="color:#66d9ef">modify</span> <span style="color:#66d9ef">column</span> d varchar(<span style="color:#ae81ff">20</span>) charset utf8;
Query OK, <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> affected, <span style="color:#ae81ff">1</span> warning (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">19</span> sec)
Records: <span style="color:#ae81ff">1</span>  Duplicates: <span style="color:#ae81ff">0</span>  Warnings: <span style="color:#ae81ff">1</span>

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> hex(d) <span style="color:#66d9ef">from</span> t; <span style="color:#75715e">-- broken utf8
</span><span style="color:#75715e"></span><span style="color:#f92672">+</span><span style="color:#75715e">------------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> hex(d)                 <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">------------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> <span style="color:#ae81ff">4</span>BC383C2B6686E746F7070 <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">------------------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>The correct solution converts in two steps:</p>
<ol>
<li>Convert to a <code>VARBINARY</code>. This keeps the binary data, but removes all charset labels, without conversion.</li>
<li>Convert to the target <code>VARCHAR</code> with the target <code>CHARSET</code>. This applies the charset label without conversion.</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> hex(d) <span style="color:#66d9ef">from</span> t; <span style="color:#75715e">-- column latin1, data utf8
</span><span style="color:#75715e"></span><span style="color:#f92672">+</span><span style="color:#75715e">--------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> hex(d)             <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> <span style="color:#ae81ff">4</span>BC3B6686E746F7070 <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">alter</span> <span style="color:#66d9ef">table</span> t <span style="color:#66d9ef">modify</span> <span style="color:#66d9ef">column</span> d varbinary(<span style="color:#ae81ff">20</span>); <span style="color:#75715e">-- convert to binary, keep data
</span><span style="color:#75715e"></span>Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">02</span> sec)
Records: <span style="color:#ae81ff">0</span>  Duplicates: <span style="color:#ae81ff">0</span>  Warnings: <span style="color:#ae81ff">0</span>

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">alter</span> <span style="color:#66d9ef">table</span> t <span style="color:#66d9ef">modify</span> <span style="color:#66d9ef">column</span> d varchar(<span style="color:#ae81ff">20</span>) charset utf8; <span style="color:#75715e">-- convert to utf8, keep data
</span><span style="color:#75715e"></span>Query OK, <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> affected, <span style="color:#ae81ff">1</span> warning (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">15</span> sec)
Records: <span style="color:#ae81ff">1</span>  Duplicates: <span style="color:#ae81ff">0</span>  Warnings: <span style="color:#ae81ff">1</span>

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> d, hex(d) <span style="color:#66d9ef">from</span> t; <span style="color:#75715e">-- all works now
</span><span style="color:#75715e"></span><span style="color:#f92672">+</span><span style="color:#75715e">-----------+--------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> d         <span style="color:#f92672">|</span> hex(d)             <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">-----------+--------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> Köhntopp  <span style="color:#f92672">|</span> <span style="color:#ae81ff">4</span>BC3B6686E746F7070 <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">-----------+--------------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">01</span> sec)
</code></pre></div>

	
    </article>
</div>



            <footer>
    <p>
	&copy; Copyright 2021 Someone or something
    </p>
</footer>


        </main>

	





<script src="/js/bootstrap.js"></script>




<script src="/js/lunr.js"></script>





<script src="/js/app.js"></script>


    </body>
</html>
