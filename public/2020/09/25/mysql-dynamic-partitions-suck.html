<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Die wunderbare Welt von Isotopp - MySQL: automatic partitions surely would be nice</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="site.webmanifest">
<link rel="apple-touch-icon" href="icon.png">
<link rel="favicon.ico" rel="icon" type="image/ico">





	



<link rel="stylesheet" href="/style.min.c5e5cd61f54911f9aafd1dbe09c2f90667957bfe1002126c87aace57759f3446.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
	<a class="navbar-brand" href="" rel="home" title=".Site.Title">
	    Die wunderbare Welt von Isotopp
	</a>
	<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
	</button>

	<div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
		
		
		<li class="nav-item ">
                    <a class="nav-link" href="/about/">
			
			<span>About</span>
			<span class="visually-hidden">(Current)</span>
		    </a>
		    
		</li>
            </ul>
            
	</div>
    </div>
</nav>


        <main role="main" class="container-fluid">

            


<div class="page">
    <article class="mysql-automatic-partitions-surely-would-be-nice-page">
	<h1 class="title">
            MySQL: automatic partitions surely would be nice
	</h1>

	<p>In [Deleting data]({% link _posts/2020-09-24-mysql-deleting-data.md %}) we have been looking at a process that loads data into MySQL, leveraging partitions to make it easier and faster to later get rid of the data again. For this, we created three processes, a data loader process, and two observers - one for creating partitions, and one for deleting them.</p>
<p>The observer processes have been running <code>ANALYZE TABLES</code> and then polling <code>INFORMATION_SCHEMA.PARTITIONS</code> every 1/10th of a second to check if intervention is needed. They then have been dynamically generating the necessary <code>ALTER TABLE</code> statements maintaining the proper partitioning of the table by adding and dropping additional partitions.</p>
<p>That is cumbersome and should not be necessary.</p>
<h2 id="using-sql-to-maintain-partitions">
    <a href="#using-sql-to-maintain-partitions">
	Using SQL to maintain partitions
    </a>
</h2>
<p>It is possible to prepare and execute dynamic DDL in MySQL, using <code>PREPARE</code>, <code>EXECUTE</code> and <code>DEALLOCATE PREPARE</code>.</p>
<p>So I can do the following, if I numb myself sufficiently to actually write and generate code in procedural SQL:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">kris<span style="color:#f92672">@</span>localhost [kris]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">set</span> <span style="color:#f92672">@</span>next_name :<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;p3&#34;</span>;
Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

kris<span style="color:#f92672">@</span>localhost [kris]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">set</span> <span style="color:#f92672">@</span>next_limit :<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;30000&#34;</span>;
Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

kris<span style="color:#f92672">@</span>localhost [kris]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> 
<span style="color:#f92672">-&gt;</span> concat(<span style="color:#e6db74">&#34;alter table data add partition ( partition &#34;</span>,
<span style="color:#f92672">-&gt;</span> <span style="color:#f92672">@</span>next_name, 
<span style="color:#f92672">-&gt;</span> <span style="color:#e6db74">&#34; values less than (&#34;</span>, 
<span style="color:#f92672">-&gt;</span> <span style="color:#f92672">@</span>next_limit, 
<span style="color:#f92672">-&gt;</span> <span style="color:#e6db74">&#34;))&#34;</span>) <span style="color:#66d9ef">as</span> cmd <span style="color:#66d9ef">into</span> <span style="color:#f92672">@</span>cmd;
Query OK, <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

kris<span style="color:#f92672">@</span>localhost [kris]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">@</span>cmd;
<span style="color:#f92672">+</span><span style="color:#75715e">-------------------------------------------------------------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> <span style="color:#f92672">@</span>cmd                                                                    <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">-------------------------------------------------------------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> <span style="color:#66d9ef">alter</span> <span style="color:#66d9ef">table</span> <span style="color:#66d9ef">data</span> <span style="color:#66d9ef">add</span> partition ( partition p3 <span style="color:#66d9ef">values</span> <span style="color:#66d9ef">less</span> <span style="color:#66d9ef">than</span> (<span style="color:#ae81ff">30000</span>)) <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">-------------------------------------------------------------------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

kris<span style="color:#f92672">@</span>localhost [kris]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">prepare</span> s <span style="color:#66d9ef">from</span> <span style="color:#f92672">@</span>cmd;
Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
<span style="color:#66d9ef">Statement</span> prepared

kris<span style="color:#f92672">@</span>localhost [kris]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">execute</span> s;
Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">10</span> sec)
Records: <span style="color:#ae81ff">0</span>  Duplicates: <span style="color:#ae81ff">0</span>  Warnings: <span style="color:#ae81ff">0</span>

kris<span style="color:#f92672">@</span>localhost [kris]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">deallocate</span> <span style="color:#66d9ef">prepare</span> s;
Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

kris<span style="color:#f92672">@</span>localhost [kris]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> <span style="color:#66d9ef">data</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
       <span style="color:#66d9ef">Table</span>: <span style="color:#66d9ef">data</span>
<span style="color:#66d9ef">Create</span> <span style="color:#66d9ef">Table</span>: <span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#f92672">`</span><span style="color:#66d9ef">data</span><span style="color:#f92672">`</span> (
  <span style="color:#f92672">`</span>id<span style="color:#f92672">`</span> int <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> AUTO_INCREMENT,
  <span style="color:#f92672">`</span>d<span style="color:#f92672">`</span> varchar(<span style="color:#ae81ff">64</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>e<span style="color:#f92672">`</span> varchar(<span style="color:#ae81ff">64</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span> (<span style="color:#f92672">`</span>id<span style="color:#f92672">`</span>)
) ENGINE<span style="color:#f92672">=</span>InnoDB <span style="color:#66d9ef">DEFAULT</span> CHARSET<span style="color:#f92672">=</span>utf8mb4 <span style="color:#66d9ef">COLLATE</span><span style="color:#f92672">=</span>utf8mb4_0900_ai_ci
PARTITION <span style="color:#66d9ef">BY</span> RANGE (<span style="color:#f92672">`</span>id<span style="color:#f92672">`</span>)
(PARTITION p1 <span style="color:#66d9ef">VALUES</span> <span style="color:#66d9ef">LESS</span> <span style="color:#66d9ef">THAN</span> (<span style="color:#ae81ff">10000</span>) ENGINE <span style="color:#f92672">=</span> InnoDB,
 PARTITION p2 <span style="color:#66d9ef">VALUES</span> <span style="color:#66d9ef">LESS</span> <span style="color:#66d9ef">THAN</span> (<span style="color:#ae81ff">20000</span>) ENGINE <span style="color:#f92672">=</span> InnoDB,
 PARTITION p3 <span style="color:#66d9ef">VALUES</span> <span style="color:#66d9ef">LESS</span> <span style="color:#66d9ef">THAN</span> (<span style="color:#ae81ff">30000</span>) ENGINE <span style="color:#f92672">=</span> InnoDB)
<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>I could put the logic of the partitioner and dropper into stored procedures and use the MySQL Event Scheduler to have this running in the background at all times to maintain the partitions on the <code>data</code> table.</p>
<p>Except that would still fail if I insert too many rows in a single transaction.</p>
<p>I may be able to run the calls to my stored procedures in an insert trigger, but that is overhead I&rsquo;d rather not have for each row inserted. Also, I am pretty confident that the trigger will also trigger a number of bugs in rarely used code pathes. :-)</p>
<h2 id="wishful-thinking">
    <a href="#wishful-thinking">
	Wishful thinking
    </a>
</h2>
<p>An actual solution would be a less cumbersome notation for partitions, specifically range partitioning by an auto_increment primary key, and range partitioning along a time dimensions.</p>
<p>I should be able to write how many partitions of which bucket size I want insteaf of maintaining a giant if-then-else of <code>VALUES LESS THAN</code> statements. SQL is supposed to be a declarative language, after all.</p>
<p>For the time dimension, I should be able to specifify the same, in retention time and intervals for the buckets. MySQL would then create and drop partitions automatically, and generate the names for them automatically, too.</p>
<p>So something like the following made-up syntax:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#75715e">-- maintain 10 buckets,
</span><span style="color:#75715e">-- equivalent to
</span><span style="color:#75715e">--   VALUES LESS THAN (&lt;previous value&gt; + 10000)
</span><span style="color:#75715e">--
</span><span style="color:#75715e">-- When new buckets are autogenerated at the top, and the number is larger than 10,
</span><span style="color:#75715e">-- drop the lowest one.
</span><span style="color:#75715e">--
</span><span style="color:#75715e"></span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> <span style="color:#66d9ef">data</span> (
  <span style="color:#f92672">`</span>id<span style="color:#f92672">`</span> int <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> AUTO_INCREMENT,
  <span style="color:#f92672">`</span>d<span style="color:#f92672">`</span> varchar(<span style="color:#ae81ff">64</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>e<span style="color:#f92672">`</span> varchar(<span style="color:#ae81ff">64</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span> (<span style="color:#f92672">`</span>id<span style="color:#f92672">`</span>)
) ENGINE<span style="color:#f92672">=</span>InnoDB <span style="color:#66d9ef">DEFAULT</span> CHARSET<span style="color:#f92672">=</span>utf8mb4 <span style="color:#66d9ef">COLLATE</span><span style="color:#f92672">=</span>utf8mb4_0900_ai_ci
PARTITION <span style="color:#66d9ef">BY</span> AUTOMATIC RANGE (<span style="color:#f92672">`</span>id<span style="color:#f92672">`</span>) ( PARTITIONS <span style="color:#ae81ff">10</span> <span style="color:#66d9ef">VALUES</span> (<span style="color:#ae81ff">10000</span>))


<span style="color:#75715e">-- maintain 10 buckets
</span><span style="color:#75715e">-- equivalent to
</span><span style="color:#75715e">--   VALUES LESS THAN (UNIX_TIMETSTAMP(&lt;previous value&gt; + INTERVAL 1 DAY))
</span><span style="color:#75715e">--
</span><span style="color:#75715e">-- When new buckets are autogenerated at the end, and the number is larger than 10,
</span><span style="color:#75715e">-- drop the oldest one.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> <span style="color:#66d9ef">data</span> (
  <span style="color:#f92672">`</span>created<span style="color:#f92672">`</span> DATETIME <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">CURRENT_TIMESTAMP</span>,
  <span style="color:#f92672">`</span>d<span style="color:#f92672">`</span> varchar(<span style="color:#ae81ff">64</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>e<span style="color:#f92672">`</span> varchar(<span style="color:#ae81ff">64</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span> (<span style="color:#f92672">`</span>id<span style="color:#f92672">`</span>)
) ENGINE<span style="color:#f92672">=</span>InnoDB <span style="color:#66d9ef">DEFAULT</span> CHARSET<span style="color:#f92672">=</span>utf8mb4 <span style="color:#66d9ef">COLLATE</span><span style="color:#f92672">=</span>utf8mb4_0900_ai_ci
PARTITION <span style="color:#66d9ef">BY</span> AUTOMATIC TIME RANGE (<span style="color:#f92672">`</span>created<span style="color:#f92672">`</span>) (PARTITIONS <span style="color:#ae81ff">10</span> <span style="color:#66d9ef">VALUES</span> (INTERVAL <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">DAY</span>))
</code></pre></div><p>This would get rid of any manually maintained procedures, events, triggers, and most importantly, implementations, and specify procedurally how and when partitions are created and how long they are kept.</p>
<p>Not quite as automatic as Cassandra TTL fields, but a large step forward.</p>


	
    </article>
</div>



            <footer>
    <p>
	&copy; Copyright 2021 Someone or something
    </p>
</footer>


        </main>

	





<script src="/js/bootstrap.js"></script>




<script src="/js/lunr.js"></script>





<script src="/js/app.js"></script>


    </body>
</html>
