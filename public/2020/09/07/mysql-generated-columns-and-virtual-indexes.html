<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Die wunderbare Welt von Isotopp - MySQL: Generated Columns and virtual indexes</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="site.webmanifest">
<link rel="apple-touch-icon" href="icon.png">
<link rel="favicon.ico" rel="icon" type="image/ico">





	



<link rel="stylesheet" href="/style.min.c5e5cd61f54911f9aafd1dbe09c2f90667957bfe1002126c87aace57759f3446.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
	<a class="navbar-brand" href="" rel="home" title=".Site.Title">
	    Die wunderbare Welt von Isotopp
	</a>
	<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
	</button>

	<div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
		
		
		<li class="nav-item ">
                    <a class="nav-link" href="/about/">
			
			<span>About</span>
			<span class="visually-hidden">(Current)</span>
		    </a>
		    
		</li>
            </ul>
            
	</div>
    </div>
</nav>


        <main role="main" class="container-fluid">

            


<div class="page">
    <article class="mysql-generated-columns-and-virtual-indexes-page">
	<h1 class="title">
            MySQL: Generated Columns and virtual indexes
	</h1>

	<p>We have had a look at [how MySQL 8 handles JSON]({% link _posts/2020-09-04-mysql-json-data-type.md %}) recently, but with all those JSON functions and expressions it is clear that many JSON accesses cannot be fast. To grab data from a JSON column, you will use a lot of <code>$-&gt;&gt;field</code> expressions and similar, and without indexes nothing of this will be fast.</p>
<p>JSON cannot be indexed.</p>
<p>But MySQL 8 offers another feature that comes in handy: Generated columns and indexes on those. Let&rsquo;s look at the parts, step by step, and how to make them work, because they are useful even outside of the context of JSON.</p>
<h2 id="an-example-table">
    <a href="#an-example-table">
	An example table
    </a>
</h2>
<p>For the following example we are going to define a table <code>t1</code> with an integer id and two integer data fields, <code>a</code> and <code>b</code>. We will be filling it with random integers up to 999 for the data values:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> t1 (
<span style="color:#f92672">-&gt;</span>   id integer <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span> <span style="color:#66d9ef">primary</span> <span style="color:#66d9ef">key</span> auto_increment,
<span style="color:#f92672">-&gt;</span>    a integer,
<span style="color:#f92672">-&gt;</span>    b integer
<span style="color:#f92672">-&gt;</span> );
Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">07</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> t1 ( id, a, b) <span style="color:#66d9ef">values</span> (<span style="color:#66d9ef">NULL</span>, ceil(rand()<span style="color:#f92672">*</span><span style="color:#ae81ff">1000</span>), ceil(rand()<span style="color:#f92672">*</span><span style="color:#ae81ff">1000</span>));
Query OK, <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">01</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> t1 (id, a, b) <span style="color:#66d9ef">select</span> <span style="color:#66d9ef">NULL</span>,  ceil(rand()<span style="color:#f92672">*</span><span style="color:#ae81ff">1000</span>), ceil(rand()<span style="color:#f92672">*</span><span style="color:#ae81ff">1000</span>) <span style="color:#66d9ef">from</span> t1;
Query OK, <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">01</span> sec)
Records: <span style="color:#ae81ff">1</span>  Duplicates: <span style="color:#ae81ff">0</span>  Warnings: <span style="color:#ae81ff">0</span>
...
mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> t1 (id, a, b) <span style="color:#66d9ef">select</span> <span style="color:#66d9ef">NULL</span>,  ceil(rand()<span style="color:#f92672">*</span><span style="color:#ae81ff">1000</span>), ceil(rand()<span style="color:#f92672">*</span><span style="color:#ae81ff">1000</span>) <span style="color:#66d9ef">from</span> t1;
Query OK, <span style="color:#ae81ff">524288</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">6</span>.<span style="color:#ae81ff">83</span> sec)
Records: <span style="color:#ae81ff">524288</span>  Duplicates: <span style="color:#ae81ff">0</span>  Warnings: <span style="color:#ae81ff">0</span>

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#66d9ef">count</span>(<span style="color:#f92672">*</span>) <span style="color:#66d9ef">from</span> t1;
<span style="color:#f92672">+</span><span style="color:#75715e">----------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> <span style="color:#66d9ef">count</span>(<span style="color:#f92672">*</span>) <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span>  <span style="color:#ae81ff">1048576</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">04</span> sec)
</code></pre></div><h2 id="generated-columns">
    <a href="#generated-columns">
	Generated columns
    </a>
</h2>
<p>A generated column is a column with values that are calculated from a deterministic expression provided in the column definition. It has the usual name and type, and then a <code>GENERATED ALWAYS AS ()</code> term. The parentheses are part of the syntax and cannot be left off. The <code>GENERATED ALWAYS</code> is optional, and we are going to leave it off, because we are lazy.</p>
<p>The column can be <code>VIRTUAL</code>, in which case the expression is evaluated when reading every time a value is needed, or <code>STORED</code>, in which case the value is materialized and stored on write.</p>
<p>In may also contain inline index definition and a column comment.</p>
<h3 id="virtual-generated-columns">
    <a href="#virtual-generated-columns">
	VIRTUAL generated columns
    </a>
</h3>
<p>So we get our trivial example:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">alter</span> <span style="color:#66d9ef">table</span> t1 <span style="color:#66d9ef">add</span> <span style="color:#66d9ef">column</span> <span style="color:#66d9ef">c</span> integer <span style="color:#66d9ef">as</span> ( a<span style="color:#f92672">+</span>b ) virtual;
Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">11</span> sec)
Records: <span style="color:#ae81ff">0</span>  Duplicates: <span style="color:#ae81ff">0</span>  Warnings: <span style="color:#ae81ff">0</span>

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> t1 <span style="color:#66d9ef">limit</span> <span style="color:#ae81ff">3</span>;
<span style="color:#f92672">+</span><span style="color:#75715e">----+------+------+------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> id <span style="color:#f92672">|</span> a    <span style="color:#f92672">|</span> b    <span style="color:#f92672">|</span> <span style="color:#66d9ef">c</span>    <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+------+------+------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span>  <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">997</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">808</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">1805</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>   <span style="color:#ae81ff">51</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">831</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">882</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">3</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">998</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">499</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">1497</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+------+------+------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">3</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>That was fast - the table definition is changed, but because the column is <code>VIRTUAL</code>, no data values need to be changed. Instead, the data is calculated on read access. We could have written our sample read as <code>SELECT id, a, b, a+b AS c FROM t1 LIMIT 3</code> for the same effect, because that is what happened.</p>
<p>We may even store that statement in a view and then call it, and that&rsquo;s effectively the same:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">view</span> v1 <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">select</span> id, a, b, a<span style="color:#f92672">+</span>b <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">c</span> <span style="color:#66d9ef">from</span> t1;
Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">03</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> v1 <span style="color:#66d9ef">limit</span> <span style="color:#ae81ff">3</span>;
<span style="color:#f92672">+</span><span style="color:#75715e">----+------+------+------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> id <span style="color:#f92672">|</span> a    <span style="color:#f92672">|</span> b    <span style="color:#f92672">|</span> <span style="color:#66d9ef">c</span>    <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+------+------+------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span>  <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">997</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">808</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">1805</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>   <span style="color:#ae81ff">51</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">831</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">882</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">3</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">998</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">499</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">1497</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+------+------+------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">3</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>Well, not quite. Let&rsquo;s explain the same query on <code>t1</code> and <code>v1</code> and see what the optimizer has to say:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">explain</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> t1 <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">c</span><span style="color:#f92672">&lt;</span><span style="color:#ae81ff">50</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
           id: <span style="color:#ae81ff">1</span>
  select_type: <span style="color:#66d9ef">SIMPLE</span>
        <span style="color:#66d9ef">table</span>: t1
   partitions: <span style="color:#66d9ef">NULL</span>
         <span style="color:#66d9ef">type</span>: <span style="color:#66d9ef">ALL</span>
possible_keys: <span style="color:#66d9ef">NULL</span>
          <span style="color:#66d9ef">key</span>: <span style="color:#66d9ef">NULL</span>
      key_len: <span style="color:#66d9ef">NULL</span>
          <span style="color:#66d9ef">ref</span>: <span style="color:#66d9ef">NULL</span>
         <span style="color:#66d9ef">rows</span>: <span style="color:#ae81ff">1046904</span>
     filtered: <span style="color:#ae81ff">33</span>.<span style="color:#ae81ff">33</span>
        Extra: <span style="color:#66d9ef">Using</span> <span style="color:#66d9ef">where</span>
<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span>, <span style="color:#ae81ff">1</span> warning (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

Note (Code <span style="color:#ae81ff">1003</span>): <span style="color:#75715e">/* select#1 */</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>t1<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>id<span style="color:#f92672">`</span> <span style="color:#66d9ef">AS</span> <span style="color:#f92672">`</span>id<span style="color:#f92672">`</span>,<span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>t1<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>a<span style="color:#f92672">`</span> <span style="color:#66d9ef">AS</span> <span style="color:#f92672">`</span>a<span style="color:#f92672">`</span>,<span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>t1<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>b<span style="color:#f92672">`</span> <span style="color:#66d9ef">AS</span> <span style="color:#f92672">`</span>b<span style="color:#f92672">`</span>,<span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>t1<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span><span style="color:#66d9ef">c</span><span style="color:#f92672">`</span> <span style="color:#66d9ef">AS</span> <span style="color:#f92672">`</span><span style="color:#66d9ef">c</span><span style="color:#f92672">`</span> <span style="color:#66d9ef">from</span> <span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>t1<span style="color:#f92672">`</span> <span style="color:#66d9ef">where</span> (<span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>t1<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span><span style="color:#66d9ef">c</span><span style="color:#f92672">`</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">50</span>)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">explain</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> v1 <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">c</span><span style="color:#f92672">&lt;</span><span style="color:#ae81ff">50</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
           id: <span style="color:#ae81ff">1</span>
  select_type: <span style="color:#66d9ef">SIMPLE</span>
        <span style="color:#66d9ef">table</span>: t1
   partitions: <span style="color:#66d9ef">NULL</span>
         <span style="color:#66d9ef">type</span>: <span style="color:#66d9ef">ALL</span>
possible_keys: <span style="color:#66d9ef">NULL</span>
          <span style="color:#66d9ef">key</span>: <span style="color:#66d9ef">NULL</span>
      key_len: <span style="color:#66d9ef">NULL</span>
          <span style="color:#66d9ef">ref</span>: <span style="color:#66d9ef">NULL</span>
         <span style="color:#66d9ef">rows</span>: <span style="color:#ae81ff">1046904</span>
     filtered: <span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">00</span>
        Extra: <span style="color:#66d9ef">Using</span> <span style="color:#66d9ef">where</span>
<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span>, <span style="color:#ae81ff">1</span> warning (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

Note (Code <span style="color:#ae81ff">1003</span>): <span style="color:#75715e">/* select#1 */</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>t1<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>id<span style="color:#f92672">`</span> <span style="color:#66d9ef">AS</span> <span style="color:#f92672">`</span>id<span style="color:#f92672">`</span>,<span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>t1<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>a<span style="color:#f92672">`</span> <span style="color:#66d9ef">AS</span> <span style="color:#f92672">`</span>a<span style="color:#f92672">`</span>,<span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>t1<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>b<span style="color:#f92672">`</span> <span style="color:#66d9ef">AS</span> <span style="color:#f92672">`</span>b<span style="color:#f92672">`</span>,(<span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>t1<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>a<span style="color:#f92672">`</span> <span style="color:#f92672">+</span> <span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>t1<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>b<span style="color:#f92672">`</span>) <span style="color:#66d9ef">AS</span> <span style="color:#f92672">`</span><span style="color:#66d9ef">c</span><span style="color:#f92672">`</span> <span style="color:#66d9ef">from</span> <span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>t1<span style="color:#f92672">`</span> <span style="color:#66d9ef">where</span> ((<span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>t1<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>a<span style="color:#f92672">`</span> <span style="color:#f92672">+</span> <span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>t1<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>b<span style="color:#f92672">`</span>) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">50</span>)
</code></pre></div><p>The output differs slightly in two places: the estimate given for filtered is different, and the view &ldquo;sees&rdquo; and exposes the definition for <code>c</code> as <code>a+b</code> in the reparsed statement in the &ldquo;Note&rdquo; section.</p>
<p>Further down we will also see how the generated column can be indexed, while the statement expression can not - and that in the end what makes the key difference in performance.</p>
<h3 id="stored-generated-columns">
    <a href="#stored-generated-columns">
	STORED generated columns
    </a>
</h3>
<p>Let&rsquo;s flip from <code>VIRTUAL</code> to <code>STORED</code> and see what happens. We drop the old definition of <code>c</code>, and re-add the same one, but with a <code>STORED</code> attribute.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">alter</span> <span style="color:#66d9ef">table</span> t1 <span style="color:#66d9ef">drop</span> <span style="color:#66d9ef">column</span> <span style="color:#66d9ef">c</span>, <span style="color:#66d9ef">add</span> <span style="color:#66d9ef">column</span> <span style="color:#66d9ef">c</span> integer <span style="color:#66d9ef">as</span> (a<span style="color:#f92672">+</span>b) stored;
Query OK, <span style="color:#ae81ff">1048576</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">6</span>.<span style="color:#ae81ff">27</span> sec)
Records: <span style="color:#ae81ff">1048576</span>  Duplicates: <span style="color:#ae81ff">0</span>  Warnings: <span style="color:#ae81ff">0</span>
</code></pre></div><p>If we looked at the average row length in <code>INFORMATION_SCHEMA.TABLES</code>, we would see it as a bit longer (but as is usual with I_S.TABLES output for small and narrow tables, the values are a bit off).</p>
<p>We also see the <code>ALTER TABLE</code> now takes actual time, proportional to the table size. What happened is that the values for <code>c</code> now get materialized on write, as if we defined a <code>BEFORE INSERT</code> trigger maintaining the values in <code>c</code>.</p>
<h3 id="trying-to-write-to-a-generated-column-fails-except-when-it-doesnt">
    <a href="#trying-to-write-to-a-generated-column-fails-except-when-it-doesnt">
	Trying to write to a generated column fails (except when it doesn&rsquo;t)
    </a>
</h3>
<p><code>VIRTUAL</code>and <code>STORED</code> don&rsquo;t matter: you can&rsquo;t write to generated columns:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">update</span> t1 <span style="color:#66d9ef">set</span> <span style="color:#66d9ef">c</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">17</span> <span style="color:#66d9ef">where</span> id <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>;
ERROR <span style="color:#ae81ff">3105</span> (HY000): The value specified <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">generated</span> <span style="color:#66d9ef">column</span> <span style="color:#e6db74">&#39;c&#39;</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">table</span> <span style="color:#e6db74">&#39;t1&#39;</span> <span style="color:#66d9ef">is</span> <span style="color:#66d9ef">not</span> allowed.

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">replace</span> <span style="color:#66d9ef">into</span> t1 <span style="color:#66d9ef">set</span> id<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, <span style="color:#66d9ef">c</span><span style="color:#f92672">=</span><span style="color:#ae81ff">17</span>;
ERROR <span style="color:#ae81ff">3105</span> (HY000): The value specified <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">generated</span> <span style="color:#66d9ef">column</span> <span style="color:#e6db74">&#39;c&#39;</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">table</span> <span style="color:#e6db74">&#39;t1&#39;</span> <span style="color:#66d9ef">is</span> <span style="color:#66d9ef">not</span> allowed.
</code></pre></div><p>With one exception:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">update</span> t1 <span style="color:#66d9ef">set</span> <span style="color:#66d9ef">c</span><span style="color:#f92672">=</span><span style="color:#66d9ef">default</span> <span style="color:#66d9ef">where</span> id <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>;
Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
<span style="color:#66d9ef">Rows</span> matched: <span style="color:#ae81ff">1</span>  Changed: <span style="color:#ae81ff">0</span>  Warnings: <span style="color:#ae81ff">0</span>
</code></pre></div><p>So if you aren&rsquo;t actually writing to <code>c</code>, you are allowed to write to <code>c</code>. That sounds stupid until you define a view on <code>t1</code> that includes <code>c</code> and is considered updatable - by allowing this construct, it stays updatable, even if it includes <code>c</code>.</p>
<p>Filling in the correct value is not the same as <code>default</code> and does not work:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> t1 <span style="color:#66d9ef">limit</span> <span style="color:#ae81ff">1</span>;
<span style="color:#f92672">+</span><span style="color:#75715e">----+------+------+------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> id <span style="color:#f92672">|</span> a    <span style="color:#f92672">|</span> b    <span style="color:#f92672">|</span> <span style="color:#66d9ef">c</span>    <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+------+------+------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span>  <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">997</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">808</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">1805</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+------+------+------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">update</span> t1 <span style="color:#66d9ef">set</span> <span style="color:#66d9ef">c</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1805</span> <span style="color:#66d9ef">where</span> id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;
ERROR <span style="color:#ae81ff">3105</span> (HY000): The value specified <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">generated</span> <span style="color:#66d9ef">column</span> <span style="color:#e6db74">&#39;c&#39;</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">table</span> <span style="color:#e6db74">&#39;t1&#39;</span> <span style="color:#66d9ef">is</span> <span style="color:#66d9ef">not</span> allowed.
</code></pre></div><h3 id="caution-create-table--as-select-vs-generated-columns">
    <a href="#caution-create-table--as-select-vs-generated-columns">
	Caution: CREATE TABLE &hellip; AS SELECT vs. generated columns
    </a>
</h3>
<p>We already know (I hope) that <code>CREATE TABLE ... AS SELECT</code> is of the devil and should not be used to copy table definitions: It creates a table from the result set of the select statement, which is most definitively not the definition of the original table.</p>
<p>We have seen this fail already with indexes and foreign key definitions, and in case you didn&rsquo;t, here is what I mean:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> sane ( id integer <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span> <span style="color:#66d9ef">primary</span> <span style="color:#66d9ef">key</span> auto_increment, t1id integer, <span style="color:#66d9ef">foreign</span> <span style="color:#66d9ef">key</span> (t1id) <span style="color:#66d9ef">references</span> t1(i
d) );
Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">06</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> sane<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
       <span style="color:#66d9ef">Table</span>: sane
<span style="color:#66d9ef">Create</span> <span style="color:#66d9ef">Table</span>: <span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#f92672">`</span>sane<span style="color:#f92672">`</span> (
  <span style="color:#f92672">`</span>id<span style="color:#f92672">`</span> int <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> AUTO_INCREMENT,
  <span style="color:#f92672">`</span>t1id<span style="color:#f92672">`</span> int <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span> (<span style="color:#f92672">`</span>id<span style="color:#f92672">`</span>),
  <span style="color:#66d9ef">KEY</span> <span style="color:#f92672">`</span>t1id<span style="color:#f92672">`</span> (<span style="color:#f92672">`</span>t1id<span style="color:#f92672">`</span>),
  <span style="color:#66d9ef">CONSTRAINT</span> <span style="color:#f92672">`</span>sane_ibfk_1<span style="color:#f92672">`</span> <span style="color:#66d9ef">FOREIGN</span> <span style="color:#66d9ef">KEY</span> (<span style="color:#f92672">`</span>t1id<span style="color:#f92672">`</span>) <span style="color:#66d9ef">REFERENCES</span> <span style="color:#f92672">`</span>t1<span style="color:#f92672">`</span> (<span style="color:#f92672">`</span>id<span style="color:#f92672">`</span>)
) ENGINE<span style="color:#f92672">=</span>InnoDB <span style="color:#66d9ef">DEFAULT</span> CHARSET<span style="color:#f92672">=</span>utf8mb4 <span style="color:#66d9ef">COLLATE</span><span style="color:#f92672">=</span>utf8mb4_0900_ai_ci
<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> sane <span style="color:#66d9ef">values</span> (<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>), (<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>), (<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">3</span>), (<span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">4</span>);
Query OK, <span style="color:#ae81ff">4</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">01</span> sec)
Records: <span style="color:#ae81ff">4</span>  Duplicates: <span style="color:#ae81ff">0</span>  Warnings: <span style="color:#ae81ff">0</span>

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> broken <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> sane;
Query OK, <span style="color:#ae81ff">4</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">07</span> sec)
Records: <span style="color:#ae81ff">4</span>  Duplicates: <span style="color:#ae81ff">0</span>  Warnings: <span style="color:#ae81ff">0</span>

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> broken<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
       <span style="color:#66d9ef">Table</span>: broken
<span style="color:#66d9ef">Create</span> <span style="color:#66d9ef">Table</span>: <span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#f92672">`</span>broken<span style="color:#f92672">`</span> (
  <span style="color:#f92672">`</span>id<span style="color:#f92672">`</span> int <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> <span style="color:#66d9ef">DEFAULT</span> <span style="color:#e6db74">&#39;0&#39;</span>,
  <span style="color:#f92672">`</span>t1id<span style="color:#f92672">`</span> int <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">NULL</span>
) ENGINE<span style="color:#f92672">=</span>InnoDB <span style="color:#66d9ef">DEFAULT</span> CHARSET<span style="color:#f92672">=</span>utf8mb4 <span style="color:#66d9ef">COLLATE</span><span style="color:#f92672">=</span>utf8mb4_0900_ai_ci
<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">01</span> sec)
</code></pre></div><p><code>broken</code> is most decidedly not the same table as <code>sane</code>. The definition of <code>broken</code> has been inferred from the format of the result set, which may or may not have the same types as the base table(s). It also has no indexes and no constraints.</p>
<p>The correct way to copy a table definition is <code>CREATE TABLE ... LIKE ...</code> and then move the data with <code>INSERT ... SELECT ...</code>. You still have to move the foreign key constraints manually, though:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> unbroken <span style="color:#66d9ef">like</span> sane;
Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">10</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> unbroken <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> sane;
Query OK, <span style="color:#ae81ff">4</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">01</span> sec)
Records: <span style="color:#ae81ff">4</span>  Duplicates: <span style="color:#ae81ff">0</span>  Warnings: <span style="color:#ae81ff">0</span>

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> unbroken<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
       <span style="color:#66d9ef">Table</span>: unbroken
<span style="color:#66d9ef">Create</span> <span style="color:#66d9ef">Table</span>: <span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#f92672">`</span>unbroken<span style="color:#f92672">`</span> (
  <span style="color:#f92672">`</span>id<span style="color:#f92672">`</span> int <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> AUTO_INCREMENT,
  <span style="color:#f92672">`</span>t1id<span style="color:#f92672">`</span> int <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span> (<span style="color:#f92672">`</span>id<span style="color:#f92672">`</span>),
  <span style="color:#66d9ef">KEY</span> <span style="color:#f92672">`</span>t1id<span style="color:#f92672">`</span> (<span style="color:#f92672">`</span>t1id<span style="color:#f92672">`</span>)
) ENGINE<span style="color:#f92672">=</span>InnoDB AUTO_INCREMENT<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span> <span style="color:#66d9ef">DEFAULT</span> CHARSET<span style="color:#f92672">=</span>utf8mb4 <span style="color:#66d9ef">COLLATE</span><span style="color:#f92672">=</span>utf8mb4_0900_ai_ci
<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>And here is how it works with generated columns:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> t2 <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> t1;
Query OK, <span style="color:#ae81ff">1048576</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">14</span>.<span style="color:#ae81ff">89</span> sec)
Records: <span style="color:#ae81ff">1048576</span>  Duplicates: <span style="color:#ae81ff">0</span>  Warnings: <span style="color:#ae81ff">0</span>

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> t2<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
       <span style="color:#66d9ef">Table</span>: t2
<span style="color:#66d9ef">Create</span> <span style="color:#66d9ef">Table</span>: <span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#f92672">`</span>t2<span style="color:#f92672">`</span> (
  <span style="color:#f92672">`</span>id<span style="color:#f92672">`</span> int <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> <span style="color:#66d9ef">DEFAULT</span> <span style="color:#e6db74">&#39;0&#39;</span>,
  <span style="color:#f92672">`</span>a<span style="color:#f92672">`</span> int <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>b<span style="color:#f92672">`</span> int <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span><span style="color:#66d9ef">c</span><span style="color:#f92672">`</span> int <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">NULL</span>
) ENGINE<span style="color:#f92672">=</span>InnoDB <span style="color:#66d9ef">DEFAULT</span> CHARSET<span style="color:#f92672">=</span>utf8mb4 <span style="color:#66d9ef">COLLATE</span><span style="color:#f92672">=</span>utf8mb4_0900_ai_ci
<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p><code>CREATE TABLE ... AS SELECT ...</code> defined a table from the result set of the select clause, and the fact that <code>c</code> is generated is completely lost. So we now have a normal 4-column table.</p>
<p>So, how about <code>CREATE TABLE ... LIKE ...</code>?</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">drop</span> <span style="color:#66d9ef">table</span> t2;
Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">08</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> t2 <span style="color:#66d9ef">like</span> t1;
Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">10</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> t2<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
       <span style="color:#66d9ef">Table</span>: t2
<span style="color:#66d9ef">Create</span> <span style="color:#66d9ef">Table</span>: <span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#f92672">`</span>t2<span style="color:#f92672">`</span> (
  <span style="color:#f92672">`</span>id<span style="color:#f92672">`</span> int <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> AUTO_INCREMENT,
  <span style="color:#f92672">`</span>a<span style="color:#f92672">`</span> int <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>b<span style="color:#f92672">`</span> int <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span><span style="color:#66d9ef">c</span><span style="color:#f92672">`</span> int <span style="color:#66d9ef">GENERATED</span> ALWAYS <span style="color:#66d9ef">AS</span> ((<span style="color:#f92672">`</span>a<span style="color:#f92672">`</span> <span style="color:#f92672">+</span> <span style="color:#f92672">`</span>b<span style="color:#f92672">`</span>)) STORED,
  <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span> (<span style="color:#f92672">`</span>id<span style="color:#f92672">`</span>)
) ENGINE<span style="color:#f92672">=</span>InnoDB <span style="color:#66d9ef">DEFAULT</span> CHARSET<span style="color:#f92672">=</span>utf8mb4 <span style="color:#66d9ef">COLLATE</span><span style="color:#f92672">=</span>utf8mb4_0900_ai_ci
<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>Yes! Success! Ok, now the data:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> t2 <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> t1;
ERROR <span style="color:#ae81ff">3105</span> (HY000): The value specified <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">generated</span> <span style="color:#66d9ef">column</span> <span style="color:#e6db74">&#39;c&#39;</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">table</span> <span style="color:#e6db74">&#39;t2&#39;</span> <span style="color:#66d9ef">is</span> <span style="color:#66d9ef">not</span> allowed.
</code></pre></div><p>Oh, right.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> t2 <span style="color:#66d9ef">select</span> id, a, b <span style="color:#66d9ef">from</span> t1;
ERROR <span style="color:#ae81ff">1136</span> (<span style="color:#ae81ff">21</span>S01): <span style="color:#66d9ef">Column</span> <span style="color:#66d9ef">count</span> doesn<span style="color:#e6db74">&#39;t match value count at row 1
</span></code></pre></div><p>Awww, yes. Okay, the full monty:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> t2 (id, a, b) <span style="color:#66d9ef">select</span> id, a, b <span style="color:#66d9ef">from</span> t1;
</code></pre></div><p>Finally.</p>
<p>Ok, copying data between tables with generated columns requires a bit more engineering than a mindless <code>INSERT ... SELECT *</code>. The rules are not unexpected, we have explored them right above, still&hellip;</p>
<h3 id="the-wrong-data-type">
    <a href="#the-wrong-data-type">
	The wrong data type
    </a>
</h3>
<p>Ok, let&rsquo;s get a bit mean. What happens when we define <code>c tinyint as (a+b) virtual</code> so that the values exceed the range possible in a signed single bit value?</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> t1 <span style="color:#66d9ef">limit</span> <span style="color:#ae81ff">3</span>;
<span style="color:#f92672">+</span><span style="color:#75715e">----+------+------+------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> id <span style="color:#f92672">|</span> a    <span style="color:#f92672">|</span> b    <span style="color:#f92672">|</span> <span style="color:#66d9ef">c</span>    <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+------+------+------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span>  <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">997</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">808</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">1805</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>   <span style="color:#ae81ff">51</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">831</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">882</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">3</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">998</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">499</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">1497</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+------+------+------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">3</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">alter</span> <span style="color:#66d9ef">table</span> t1 <span style="color:#66d9ef">drop</span> <span style="color:#66d9ef">column</span> <span style="color:#66d9ef">c</span>, <span style="color:#66d9ef">add</span> <span style="color:#66d9ef">column</span> <span style="color:#66d9ef">c</span> tinyint <span style="color:#66d9ef">as</span> (a<span style="color:#f92672">+</span>b) virtual;
ERROR <span style="color:#ae81ff">1264</span> (<span style="color:#ae81ff">22003</span>): <span style="color:#66d9ef">Out</span> <span style="color:#66d9ef">of</span> range value <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">column</span> <span style="color:#e6db74">&#39;c&#39;</span> <span style="color:#66d9ef">at</span> <span style="color:#66d9ef">row</span> <span style="color:#ae81ff">1</span>
</code></pre></div><p>Oh, they are on to us!?!? Are they?</p>
<p>They are not when we do it in two steps:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">alter</span> <span style="color:#66d9ef">table</span> t1 <span style="color:#66d9ef">drop</span> <span style="color:#66d9ef">column</span> <span style="color:#66d9ef">c</span>;
Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">9</span>.<span style="color:#ae81ff">24</span> sec)
Records: <span style="color:#ae81ff">0</span>  Duplicates: <span style="color:#ae81ff">0</span>  Warnings: <span style="color:#ae81ff">0</span>

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">alter</span> <span style="color:#66d9ef">table</span> t1 <span style="color:#66d9ef">add</span> <span style="color:#66d9ef">column</span> <span style="color:#66d9ef">c</span> tinyint <span style="color:#66d9ef">as</span> (a<span style="color:#f92672">+</span>b) virtual;
Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">08</span> sec)
Records: <span style="color:#ae81ff">0</span>  Duplicates: <span style="color:#ae81ff">0</span>  Warnings: <span style="color:#ae81ff">0</span>

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> t1 <span style="color:#66d9ef">limit</span> <span style="color:#ae81ff">3</span>;
<span style="color:#f92672">+</span><span style="color:#75715e">----+------+------+------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> id <span style="color:#f92672">|</span> a    <span style="color:#f92672">|</span> b    <span style="color:#f92672">|</span> <span style="color:#66d9ef">c</span>    <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+------+------+------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span>  <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">997</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">808</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">127</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>   <span style="color:#ae81ff">51</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">831</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">127</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">3</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">998</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">499</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">127</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+------+------+------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">3</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>It clips the values according to the rules that MySQL always had, and that ate so much data.</p>
<p>Now, let&rsquo;s <code>CREATE TABLE ... AS SELECT</code> again:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">drop</span> <span style="color:#66d9ef">table</span> broken;
Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">07</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> broken <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> t1;
ERROR <span style="color:#ae81ff">1264</span> (<span style="color:#ae81ff">22003</span>): <span style="color:#66d9ef">Out</span> <span style="color:#66d9ef">of</span> range value <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">column</span> <span style="color:#e6db74">&#39;c&#39;</span> <span style="color:#66d9ef">at</span> <span style="color:#66d9ef">row</span> <span style="color:#ae81ff">2</span>
Error (Code <span style="color:#ae81ff">1264</span>): <span style="color:#66d9ef">Out</span> <span style="color:#66d9ef">of</span> range value <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">column</span> <span style="color:#e6db74">&#39;c&#39;</span> <span style="color:#66d9ef">at</span> <span style="color:#66d9ef">row</span> <span style="color:#ae81ff">2</span>
Error (Code <span style="color:#ae81ff">1030</span>): Got error <span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> <span style="color:#e6db74">&#39;Operation not permitted&#39;</span> <span style="color:#66d9ef">from</span> <span style="color:#66d9ef">storage</span> engine
</code></pre></div><p>Wow. No less than three error messages. At least they mention the column <code>c</code> and the word &ldquo;range&rdquo;, so we kind of can have an idea what goes on. Still, this is only medium helpful and initially confusing.</p>
<p>What happens, and why?</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">@@</span>sql_mode;
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------------------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> <span style="color:#f92672">@@</span>sql_mode                                 <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------------------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> STRICT_TRANS_TABLES,NO_ENGINE_SUBSTITUTION <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------------------------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">set</span> sql_mode <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>;
Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> broken <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> t1;
...
Warning (Code <span style="color:#ae81ff">1264</span>): <span style="color:#66d9ef">Out</span> <span style="color:#66d9ef">of</span> range value <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">column</span> <span style="color:#e6db74">&#39;c&#39;</span> <span style="color:#66d9ef">at</span> <span style="color:#66d9ef">row</span> <span style="color:#ae81ff">1028</span>
Warning (Code <span style="color:#ae81ff">1264</span>): <span style="color:#66d9ef">Out</span> <span style="color:#66d9ef">of</span> range value <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">column</span> <span style="color:#e6db74">&#39;c&#39;</span> <span style="color:#66d9ef">at</span> <span style="color:#66d9ef">row</span> <span style="color:#ae81ff">1029</span>
Warning (Code <span style="color:#ae81ff">1264</span>): <span style="color:#66d9ef">Out</span> <span style="color:#66d9ef">of</span> range value <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">column</span> <span style="color:#e6db74">&#39;c&#39;</span> <span style="color:#66d9ef">at</span> <span style="color:#66d9ef">row</span> <span style="color:#ae81ff">1030</span>
</code></pre></div><p><code>SQL_MODE</code> helpfully detected the problem and prevented data loss. As usual, <code>SQL_MODE</code> was as useless as it was helpful - while it prevented data loss, it did not directly point us into the right direction with its error messages.</p>
<p>By turning off <code>SQL_MODE</code> we get the clipped values copied and a bunch of warnings that everybody ignores all of the time, anyway, so I guess it&rsquo;s an improvement.</p>
<h3 id="allowed-and-disallowed-functions">
    <a href="#allowed-and-disallowed-functions">
	Allowed and disallowed functions
    </a>
</h3>
<p>For generated columns to work it is a requirement that the functions are deterministic, idempotent and side-effect free. All user defined functions and stored functions are disallowed, and the usual suspects from the set of builtins are also out:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> testme (id integer <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span> <span style="color:#66d9ef">primary</span> <span style="color:#66d9ef">key</span> auto_increment, a integer, b integer, <span style="color:#66d9ef">c</span> integer <span style="color:#66d9ef">as</span> (sleep(<span style="color:#ae81ff">2</span>)));
ERROR <span style="color:#ae81ff">3763</span> (HY000): Expression <span style="color:#66d9ef">of</span> <span style="color:#66d9ef">generated</span> <span style="color:#66d9ef">column</span> <span style="color:#e6db74">&#39;c&#39;</span> <span style="color:#66d9ef">contains</span> a disallowed <span style="color:#66d9ef">function</span>: sleep.
mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> testme (id integer <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span> <span style="color:#66d9ef">primary</span> <span style="color:#66d9ef">key</span> auto_increment, a integer, b integer, <span style="color:#66d9ef">c</span> integer <span style="color:#66d9ef">as</span> (uuid()));
ERROR <span style="color:#ae81ff">3763</span> (HY000): Expression <span style="color:#66d9ef">of</span> <span style="color:#66d9ef">generated</span> <span style="color:#66d9ef">column</span> <span style="color:#e6db74">&#39;c&#39;</span> <span style="color:#66d9ef">contains</span> a disallowed <span style="color:#66d9ef">function</span>: uuid.
mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> testme (id integer <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span> <span style="color:#66d9ef">primary</span> <span style="color:#66d9ef">key</span> auto_increment, a integer, b integer, <span style="color:#66d9ef">c</span> integer <span style="color:#66d9ef">as</span> (rand()));
ERROR <span style="color:#ae81ff">3763</span> (HY000): Expression <span style="color:#66d9ef">of</span> <span style="color:#66d9ef">generated</span> <span style="color:#66d9ef">column</span> <span style="color:#e6db74">&#39;c&#39;</span> <span style="color:#66d9ef">contains</span> a disallowed <span style="color:#66d9ef">function</span>: rand.
mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> testme (id integer <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span> <span style="color:#66d9ef">primary</span> <span style="color:#66d9ef">key</span> auto_increment, a integer, b integer, <span style="color:#66d9ef">c</span> integer <span style="color:#66d9ef">as</span> (now()));
ERROR <span style="color:#ae81ff">3763</span> (HY000): Expression <span style="color:#66d9ef">of</span> <span style="color:#66d9ef">generated</span> <span style="color:#66d9ef">column</span> <span style="color:#e6db74">&#39;c&#39;</span> <span style="color:#66d9ef">contains</span> a disallowed <span style="color:#66d9ef">function</span>: now.
mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> testme (id integer <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span> <span style="color:#66d9ef">primary</span> <span style="color:#66d9ef">key</span> auto_increment, a integer, b integer, <span style="color:#66d9ef">c</span> integer <span style="color:#66d9ef">as</span> (connection_id()));
ERROR <span style="color:#ae81ff">3763</span> (HY000): Expression <span style="color:#66d9ef">of</span> <span style="color:#66d9ef">generated</span> <span style="color:#66d9ef">column</span> <span style="color:#e6db74">&#39;c&#39;</span> <span style="color:#66d9ef">contains</span> a disallowed <span style="color:#66d9ef">function</span>: connection_id.
mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> testme (id integer <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span> <span style="color:#66d9ef">primary</span> <span style="color:#66d9ef">key</span> auto_increment, a integer, b integer, <span style="color:#66d9ef">c</span> integer <span style="color:#66d9ef">as</span> (last_insert_id()));
ERROR <span style="color:#ae81ff">3763</span> (HY000): Expression <span style="color:#66d9ef">of</span> <span style="color:#66d9ef">generated</span> <span style="color:#66d9ef">column</span> <span style="color:#e6db74">&#39;c&#39;</span> <span style="color:#66d9ef">contains</span> a disallowed <span style="color:#66d9ef">function</span>: last_insert_id.


mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">set</span> <span style="color:#f92672">@</span><span style="color:#66d9ef">c</span> :<span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> testme (id integer <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span> <span style="color:#66d9ef">primary</span> <span style="color:#66d9ef">key</span> auto_increment, a integer, b integer, <span style="color:#66d9ef">c</span> integer <span style="color:#66d9ef">as</span> (<span style="color:#f92672">@</span><span style="color:#66d9ef">c</span>));
ERROR <span style="color:#ae81ff">3772</span> (HY000): <span style="color:#66d9ef">Default</span> value expression <span style="color:#66d9ef">of</span> <span style="color:#66d9ef">column</span> <span style="color:#e6db74">&#39;c&#39;</span> cannot refer <span style="color:#66d9ef">user</span> <span style="color:#66d9ef">or</span> <span style="color:#66d9ef">system</span> variables.

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> testme (id integer <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span> <span style="color:#66d9ef">primary</span> <span style="color:#66d9ef">key</span> auto_increment, a integer, b integer, <span style="color:#66d9ef">c</span> integer <span style="color:#66d9ef">as</span> (id));
ERROR <span style="color:#ae81ff">3109</span> (HY000): <span style="color:#66d9ef">Generated</span> <span style="color:#66d9ef">column</span> <span style="color:#e6db74">&#39;c&#39;</span> cannot refer <span style="color:#66d9ef">to</span> auto<span style="color:#f92672">-</span><span style="color:#66d9ef">increment</span> <span style="color:#66d9ef">column</span>.

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> testme (id integer <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span> <span style="color:#66d9ef">primary</span> <span style="color:#66d9ef">key</span> auto_increment, a integer, b integer, <span style="color:#66d9ef">c</span> integer <span style="color:#66d9ef">as</span> (a));
Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">09</span> sec)
mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">alter</span> <span style="color:#66d9ef">table</span> testme change <span style="color:#66d9ef">column</span> a x integer;
ERROR <span style="color:#ae81ff">3108</span> (HY000): <span style="color:#66d9ef">Column</span> <span style="color:#e6db74">&#39;a&#39;</span> has a <span style="color:#66d9ef">generated</span> <span style="color:#66d9ef">column</span> dependency.
mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">alter</span> <span style="color:#66d9ef">table</span> testme <span style="color:#66d9ef">drop</span> <span style="color:#66d9ef">column</span> <span style="color:#66d9ef">c</span>, change <span style="color:#66d9ef">column</span> a x integer, <span style="color:#66d9ef">add</span> <span style="color:#66d9ef">column</span> <span style="color:#66d9ef">c</span> integer <span style="color:#66d9ef">as</span> (x);
Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">21</span> sec)
Records: <span style="color:#ae81ff">0</span>  Duplicates: <span style="color:#ae81ff">0</span>  Warnings: <span style="color:#ae81ff">0</span>
</code></pre></div><p>From the final example above we learn that it is also impossible to change the existing definition of any column that is used by a generated column definition. We need to drop the generated column, change the definition of the base columns and then recreate the generated column.</p>
<p>For <code>VIRTUAL</code> columns that is cheap, for <code>STORED</code> - less so.</p>
<h2 id="secondary-indexes-and-generated-columns">
    <a href="#secondary-indexes-and-generated-columns">
	Secondary indexes and generated columns
    </a>
</h2>
<p>So far, so nice. Now let&rsquo;s cash in on this: Indexes, we have them. At least secondary indexes:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> wtf ( b integer <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span>,  id integer <span style="color:#66d9ef">as</span> (b) <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span> <span style="color:#66d9ef">primary</span> <span style="color:#66d9ef">key</span>);
ERROR <span style="color:#ae81ff">3106</span> (HY000): <span style="color:#e6db74">&#39;Defining a virtual generated column as primary key&#39;</span> <span style="color:#66d9ef">is</span> <span style="color:#66d9ef">not</span> supported <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">generated</span> columns.

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> t1<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
       <span style="color:#66d9ef">Table</span>: t1
<span style="color:#66d9ef">Create</span> <span style="color:#66d9ef">Table</span>: <span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#f92672">`</span>t1<span style="color:#f92672">`</span> (
  <span style="color:#f92672">`</span>id<span style="color:#f92672">`</span> int <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> AUTO_INCREMENT,
  <span style="color:#f92672">`</span>a<span style="color:#f92672">`</span> int <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>b<span style="color:#f92672">`</span> int <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span><span style="color:#66d9ef">c</span><span style="color:#f92672">`</span> int <span style="color:#66d9ef">GENERATED</span> ALWAYS <span style="color:#66d9ef">AS</span> ((<span style="color:#f92672">`</span>a<span style="color:#f92672">`</span> <span style="color:#f92672">+</span> <span style="color:#f92672">`</span>b<span style="color:#f92672">`</span>)) VIRTUAL,
  <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span> (<span style="color:#f92672">`</span>id<span style="color:#f92672">`</span>)
) ENGINE<span style="color:#f92672">=</span>InnoDB AUTO_INCREMENT<span style="color:#f92672">=</span><span style="color:#ae81ff">1376221</span> <span style="color:#66d9ef">DEFAULT</span> CHARSET<span style="color:#f92672">=</span>utf8mb4 <span style="color:#66d9ef">COLLATE</span><span style="color:#f92672">=</span>utf8mb4_0900_ai_ci
<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">alter</span> <span style="color:#66d9ef">table</span> t1 <span style="color:#66d9ef">add</span> <span style="color:#66d9ef">index</span>(<span style="color:#66d9ef">c</span>);
Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">5</span>.<span style="color:#ae81ff">62</span> sec)
Records: <span style="color:#ae81ff">0</span>  Duplicates: <span style="color:#ae81ff">0</span>  Warnings: <span style="color:#ae81ff">0</span>
</code></pre></div><p>As expected, adding the index takes time, even if the column <code>c</code> is <code>VIRTUAL</code>: For an index we extract the indexed values from the table, sort them and store them together with pointers to the base row in the (secondary) index tree. In InnoDB, the pointer to the base row always is the primary key, so what we get in the index is actually pairs of <code>(c, id)</code>.</p>
<p>We can prove that:</p>
<ol>
<li>Queries for <code>c</code> can be answered from the index. The index is called <em>covering</em>, it saves us chasing the row pointer and an access to the actual row. In an <code>EXPLAIN</code> we see this being indicated with <code>using index</code>.</li>
<li>Queries for <code>c</code> and <code>id</code> should also be <em>covering</em>: the queried values are all present in the index so that going to the base row is unnecessary.</li>
<li>Querying for <code>c</code> and <code>a</code> is not covering, so the <code>using index</code> should be gone.</li>
</ol>
<p>And indeed:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">explain</span> <span style="color:#66d9ef">select</span> <span style="color:#66d9ef">c</span> <span style="color:#66d9ef">from</span> t1 <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">c</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">50</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
...
possible_keys: <span style="color:#66d9ef">c</span>
          <span style="color:#66d9ef">key</span>: <span style="color:#66d9ef">c</span>
...
         <span style="color:#66d9ef">rows</span>: <span style="color:#ae81ff">1257</span>
        Extra: <span style="color:#66d9ef">Using</span> <span style="color:#66d9ef">where</span>; <span style="color:#66d9ef">Using</span> <span style="color:#66d9ef">index</span>
<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span>, <span style="color:#ae81ff">1</span> warning (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

Note (Code <span style="color:#ae81ff">1003</span>): <span style="color:#75715e">/* select#1 */</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>t1<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span><span style="color:#66d9ef">c</span><span style="color:#f92672">`</span> <span style="color:#66d9ef">AS</span> <span style="color:#f92672">`</span><span style="color:#66d9ef">c</span><span style="color:#f92672">`</span> <span style="color:#66d9ef">from</span> <span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>t1<span style="color:#f92672">`</span> <span style="color:#66d9ef">where</span> (<span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>t1<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span><span style="color:#66d9ef">c</span><span style="color:#f92672">`</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">50</span>)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">explain</span> <span style="color:#66d9ef">select</span> <span style="color:#66d9ef">c</span>, id <span style="color:#66d9ef">from</span> t1 <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">c</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">50</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
          <span style="color:#66d9ef">key</span>: <span style="color:#66d9ef">c</span>
...
        Extra: <span style="color:#66d9ef">Using</span> <span style="color:#66d9ef">where</span>; <span style="color:#66d9ef">Using</span> <span style="color:#66d9ef">index</span>
<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span>, <span style="color:#ae81ff">1</span> warning (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

Note (Code <span style="color:#ae81ff">1003</span>): <span style="color:#75715e">/* select#1 */</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>t1<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span><span style="color:#66d9ef">c</span><span style="color:#f92672">`</span> <span style="color:#66d9ef">AS</span> <span style="color:#f92672">`</span><span style="color:#66d9ef">c</span><span style="color:#f92672">`</span>,<span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>t1<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>id<span style="color:#f92672">`</span> <span style="color:#66d9ef">AS</span> <span style="color:#f92672">`</span>id<span style="color:#f92672">`</span> <span style="color:#66d9ef">from</span> <span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>t1<span style="color:#f92672">`</span> <span style="color:#66d9ef">where</span> (<span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>t1<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span><span style="color:#66d9ef">c</span><span style="color:#f92672">`</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">50</span>)
mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">explain</span> <span style="color:#66d9ef">select</span> <span style="color:#66d9ef">c</span>, a <span style="color:#66d9ef">from</span> t1 <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">c</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">50</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
...
possible_keys: <span style="color:#66d9ef">c</span>
          <span style="color:#66d9ef">key</span>: <span style="color:#66d9ef">c</span>
...
        Extra: <span style="color:#66d9ef">Using</span> <span style="color:#66d9ef">where</span>
<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span>, <span style="color:#ae81ff">1</span> warning (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

Note (Code <span style="color:#ae81ff">1003</span>): <span style="color:#75715e">/* select#1 */</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>t1<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>id<span style="color:#f92672">`</span> <span style="color:#66d9ef">AS</span> <span style="color:#f92672">`</span>id<span style="color:#f92672">`</span>,<span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>t1<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>a<span style="color:#f92672">`</span> <span style="color:#66d9ef">AS</span> <span style="color:#f92672">`</span>a<span style="color:#f92672">`</span>,<span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>t1<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>b<span style="color:#f92672">`</span> <span style="color:#66d9ef">AS</span> <span style="color:#f92672">`</span>b<span style="color:#f92672">`</span>,<span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>t1<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span><span style="color:#66d9ef">c</span><span style="color:#f92672">`</span> <span style="color:#66d9ef">AS</span> <span style="color:#f92672">`</span><span style="color:#66d9ef">c</span><span style="color:#f92672">`</span> <span style="color:#66d9ef">from</span> <span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>t1<span style="color:#f92672">`</span> <span style="color:#66d9ef">where</span> (<span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>t1<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span><span style="color:#66d9ef">c</span><span style="color:#f92672">`</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">50</span>)
</code></pre></div><p>As predicted, the final query for <code>c</code>, <code>a</code> cannot be covering and is missing the <code>using index</code> notice in the Extra column. This is still a good query: it is considering and using the index on <code>c</code> - the index alone is just not sufficient to resolve the query.</p>
<p>This should give us an idea about how to design:</p>
<p>In almost all cases <code>STORED</code> columns will not be paying off. They use disk space, and still need to evaluate the expression at least once for storage. If indexed, they will use disk space in the index a second time - the column is actually materialized twice, in the table in primary key order and the index in index order.</p>
<p><code>STORED</code> generated columns make sense only if the expression is complicated and slow to calculate. But with the set of functions available to us that is hardly going to be the case, ever. So unless the expression is being evaluated really often the cost for the storage is not ever amortized.</p>
<p>Even then, for generated columns <code>STORED</code> and <code>VIRTUAL</code>, many queries can probably be answered leveraging an index on the generated column so that we might try to get away with <code>VIRTUAL</code> columns all of the time.</p>
<h3 id="generated-columns-and-the-optimizer">
    <a href="#generated-columns-and-the-optimizer">
	Generated columns and the Optimizer
    </a>
</h3>
<p>The optimizer is aware of the generated column definitions, and can leverage them, as long as they match:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> t1<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
       <span style="color:#66d9ef">Table</span>: t1
<span style="color:#66d9ef">Create</span> <span style="color:#66d9ef">Table</span>: <span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#f92672">`</span>t1<span style="color:#f92672">`</span> (
  <span style="color:#f92672">`</span>id<span style="color:#f92672">`</span> int <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> AUTO_INCREMENT,
  <span style="color:#f92672">`</span>a<span style="color:#f92672">`</span> int <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>b<span style="color:#f92672">`</span> int <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span><span style="color:#66d9ef">c</span><span style="color:#f92672">`</span> int <span style="color:#66d9ef">GENERATED</span> ALWAYS <span style="color:#66d9ef">AS</span> ((<span style="color:#f92672">`</span>a<span style="color:#f92672">`</span> <span style="color:#f92672">+</span> <span style="color:#f92672">`</span>b<span style="color:#f92672">`</span>)) VIRTUAL,
  <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span> (<span style="color:#f92672">`</span>id<span style="color:#f92672">`</span>),
  <span style="color:#66d9ef">KEY</span> <span style="color:#f92672">`</span><span style="color:#66d9ef">c</span><span style="color:#f92672">`</span> (<span style="color:#f92672">`</span><span style="color:#66d9ef">c</span><span style="color:#f92672">`</span>)
) ENGINE<span style="color:#f92672">=</span>InnoDB AUTO_INCREMENT<span style="color:#f92672">=</span><span style="color:#ae81ff">1376221</span> <span style="color:#66d9ef">DEFAULT</span> CHARSET<span style="color:#f92672">=</span>utf8mb4 <span style="color:#66d9ef">COLLATE</span><span style="color:#f92672">=</span>utf8mb4_0900_ai_ci
<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">explain</span> <span style="color:#66d9ef">select</span> a<span style="color:#f92672">+</span>b <span style="color:#66d9ef">from</span> t1 <span style="color:#66d9ef">where</span> a<span style="color:#f92672">+</span>b<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">50</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
<span style="color:#f92672">***************************</span> <span style="color:#ae81ff">1</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">***************************</span>
           id: <span style="color:#ae81ff">1</span>
  select_type: <span style="color:#66d9ef">SIMPLE</span>
        <span style="color:#66d9ef">table</span>: t1
   partitions: <span style="color:#66d9ef">NULL</span>
         <span style="color:#66d9ef">type</span>: range
possible_keys: <span style="color:#66d9ef">c</span>
          <span style="color:#66d9ef">key</span>: <span style="color:#66d9ef">c</span>
      key_len: <span style="color:#ae81ff">5</span>
          <span style="color:#66d9ef">ref</span>: <span style="color:#66d9ef">NULL</span>
         <span style="color:#66d9ef">rows</span>: <span style="color:#ae81ff">1257</span>
     filtered: <span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">00</span>
        Extra: <span style="color:#66d9ef">Using</span> <span style="color:#66d9ef">where</span>
<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span>, <span style="color:#ae81ff">1</span> warning (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

Note (Code <span style="color:#ae81ff">1003</span>): <span style="color:#75715e">/* select#1 */</span> <span style="color:#66d9ef">select</span> (<span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>t1<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>a<span style="color:#f92672">`</span> <span style="color:#f92672">+</span> <span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>t1<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>b<span style="color:#f92672">`</span>) <span style="color:#66d9ef">AS</span> <span style="color:#f92672">`</span>a<span style="color:#f92672">+</span>b<span style="color:#f92672">`</span> <span style="color:#66d9ef">from</span> <span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>t1<span style="color:#f92672">`</span> <span style="color:#66d9ef">where</span> (<span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>t1<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span><span style="color:#66d9ef">c</span><span style="color:#f92672">`</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">50</span>)
</code></pre></div><p>The optimizer is still the MySQL optimizer we all love to hate, so you have to be pretty literal for the match:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">explain</span> <span style="color:#66d9ef">select</span> b<span style="color:#f92672">+</span>a <span style="color:#66d9ef">from</span> t1 <span style="color:#66d9ef">where</span> b<span style="color:#f92672">+</span>a<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">50</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
<span style="color:#f92672">***************************</span> <span style="color:#ae81ff">1</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">***************************</span>
           id: <span style="color:#ae81ff">1</span>
  select_type: <span style="color:#66d9ef">SIMPLE</span>
        <span style="color:#66d9ef">table</span>: t1
   partitions: <span style="color:#66d9ef">NULL</span>
         <span style="color:#66d9ef">type</span>: <span style="color:#66d9ef">ALL</span>
possible_keys: <span style="color:#66d9ef">NULL</span>
          <span style="color:#66d9ef">key</span>: <span style="color:#66d9ef">NULL</span>
      key_len: <span style="color:#66d9ef">NULL</span>
          <span style="color:#66d9ef">ref</span>: <span style="color:#66d9ef">NULL</span>
         <span style="color:#66d9ef">rows</span>: <span style="color:#ae81ff">1046422</span>
     filtered: <span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">00</span>
        Extra: <span style="color:#66d9ef">Using</span> <span style="color:#66d9ef">where</span>
<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span>, <span style="color:#ae81ff">1</span> warning (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

Note (Code <span style="color:#ae81ff">1003</span>): <span style="color:#75715e">/* select#1 */</span> <span style="color:#66d9ef">select</span> (<span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>t1<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>b<span style="color:#f92672">`</span> <span style="color:#f92672">+</span> <span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>t1<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>a<span style="color:#f92672">`</span>) <span style="color:#66d9ef">AS</span> <span style="color:#f92672">`</span>b<span style="color:#f92672">+</span>a<span style="color:#f92672">`</span> <span style="color:#66d9ef">from</span> <span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>t1<span style="color:#f92672">`</span> <span style="color:#66d9ef">where</span> ((<span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>t1<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>b<span style="color:#f92672">`</span> <span style="color:#f92672">+</span> <span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>t1<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>a<span style="color:#f92672">`</span>) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">50</span>)
</code></pre></div><p>Yup, no canonicalization, for reasons.</p>
<h2 id="making-it-work-with-json">
    <a href="#making-it-work-with-json">
	Making it work with JSON
    </a>
</h2>
<p>That&rsquo;s a long article. Do you still remember how we started?</p>
<blockquote>
<p>JSON cannot be indexed.</p>
</blockquote>
<p>Well, now it can and you know how.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> t<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
       <span style="color:#66d9ef">Table</span>: t
<span style="color:#66d9ef">Create</span> <span style="color:#66d9ef">Table</span>: <span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#f92672">`</span>t<span style="color:#f92672">`</span> (
  <span style="color:#f92672">`</span>id<span style="color:#f92672">`</span> int <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> AUTO_INCREMENT,
  <span style="color:#f92672">`</span>j<span style="color:#f92672">`</span> json <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span> (<span style="color:#f92672">`</span>id<span style="color:#f92672">`</span>)
) ENGINE<span style="color:#f92672">=</span>InnoDB AUTO_INCREMENT<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span> <span style="color:#66d9ef">DEFAULT</span> CHARSET<span style="color:#f92672">=</span>utf8mb4 <span style="color:#66d9ef">COLLATE</span><span style="color:#f92672">=</span>utf8mb4_0900_ai_ci
<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> t;
<span style="color:#f92672">+</span><span style="color:#75715e">----+-------------------------------------------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> id <span style="color:#f92672">|</span> j                                                     <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+-------------------------------------------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span>  <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span> <span style="color:#960050;background-color:#1e0010">{</span><span style="color:#e6db74">&#34;home&#34;</span>: <span style="color:#e6db74">&#34;/home/kris&#34;</span>, <span style="color:#e6db74">&#34;paid&#34;</span>: <span style="color:#66d9ef">false</span>, <span style="color:#e6db74">&#34;user&#34;</span>: <span style="color:#e6db74">&#34;kris&#34;</span><span style="color:#960050;background-color:#1e0010">}</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span> <span style="color:#960050;background-color:#1e0010">{</span><span style="color:#e6db74">&#34;home&#34;</span>: <span style="color:#e6db74">&#34;/home/sven&#34;</span>, <span style="color:#e6db74">&#34;paid&#34;</span>: <span style="color:#66d9ef">false</span>, <span style="color:#e6db74">&#34;user&#34;</span>: <span style="color:#e6db74">&#34;sven&#34;</span><span style="color:#960050;background-color:#1e0010">}</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">3</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">false</span>                                                 <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+-------------------------------------------------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">3</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">alter</span> <span style="color:#66d9ef">table</span> t <span style="color:#66d9ef">add</span> <span style="color:#66d9ef">column</span> <span style="color:#66d9ef">user</span> varchar(<span style="color:#ae81ff">80</span>) <span style="color:#66d9ef">as</span> (j<span style="color:#f92672">-&gt;</span><span style="color:#e6db74">&#39;$.user&#39;</span>) virtual, <span style="color:#66d9ef">add</span> <span style="color:#66d9ef">index</span> (<span style="color:#66d9ef">user</span>);
Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">10</span> sec)
Records: <span style="color:#ae81ff">0</span>  Duplicates: <span style="color:#ae81ff">0</span>  Warnings: <span style="color:#ae81ff">0</span>

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#66d9ef">user</span>, id <span style="color:#66d9ef">from</span> t;
<span style="color:#f92672">+</span><span style="color:#75715e">--------+----+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> <span style="color:#66d9ef">user</span>   <span style="color:#f92672">|</span> id <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------+----+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span>   <span style="color:#f92672">|</span>  <span style="color:#ae81ff">3</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#e6db74">&#34;kris&#34;</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#e6db74">&#34;sven&#34;</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------+----+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">3</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">explain</span> <span style="color:#66d9ef">select</span> id, j <span style="color:#66d9ef">from</span> t <span style="color:#66d9ef">where</span> id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
<span style="color:#f92672">***************************</span> <span style="color:#ae81ff">1</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">***************************</span>
           id: <span style="color:#ae81ff">1</span>
  select_type: <span style="color:#66d9ef">SIMPLE</span>
        <span style="color:#66d9ef">table</span>: t
   partitions: <span style="color:#66d9ef">NULL</span>
         <span style="color:#66d9ef">type</span>: const
possible_keys: <span style="color:#66d9ef">PRIMARY</span>
          <span style="color:#66d9ef">key</span>: <span style="color:#66d9ef">PRIMARY</span>
      key_len: <span style="color:#ae81ff">4</span>
          <span style="color:#66d9ef">ref</span>: const
         <span style="color:#66d9ef">rows</span>: <span style="color:#ae81ff">1</span>
     filtered: <span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">00</span>
        Extra: <span style="color:#66d9ef">NULL</span>
<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span>, <span style="color:#ae81ff">1</span> warning (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

Note (Code <span style="color:#ae81ff">1003</span>): <span style="color:#75715e">/* select#1 */</span> <span style="color:#66d9ef">select</span> <span style="color:#e6db74">&#39;1&#39;</span> <span style="color:#66d9ef">AS</span> <span style="color:#f92672">`</span>id<span style="color:#f92672">`</span>,<span style="color:#e6db74">&#39;{&#34;home&#34;: &#34;/home/kris&#34;, &#34;paid&#34;: false, &#34;user&#34;: &#34;kris&#34;}&#39;</span> <span style="color:#66d9ef">AS</span> <span style="color:#f92672">`</span>j<span style="color:#f92672">`</span> <span style="color:#66d9ef">from</span> <span style="color:#f92672">`</span>kris<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>t<span style="color:#f92672">`</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">true</span>
</code></pre></div><p>Yay, <code>ref: const</code>, primary key lookup in the optimizer and we did not even have a query to run.</p>
<h2 id="summary">
    <a href="#summary">
	Summary
    </a>
</h2>
<p>We have been looking at the two flavors of generated columns, and how they can make our life easier in many ways. We have been looking at various pitfalls with respect to copying data and table definitions around. We have been learning about indexing generated columns, and how the optimizer can leverage indexes even against the expressions defined in generated columns.</p>
<p>Finally we put the parts together and made JSON data lookups fast.</p>
<p>This should give us a number of ideas in terms of sensible table design around JSON. Often we use JSON for variable-ish data while we explore a data model. Then a JSON schema solidifies, and we can leverage values we require and rely on by putting them into generated columns and index these, then use these for search and access.</p>
<p>Eventually we may extract the columns from the variable JSON part of the schema completely and turn them into actually statically typed columns of the SQL schema, because we require them all of the time.</p>
<p>This opens up a pathway to incremental schema design while at the same time being flexible enough to have bag style soft and denormalized data types where we need them.</p>
<h2 id="the-fine-manual">
    <a href="#the-fine-manual">
	The Fine Manual
    </a>
</h2>
<p>There is a lot more to all of this than I can show here. This means you have homework. Read the following manual pages:</p>
<ul>
<li>
<p><a href="https://dev.mysql.com/doc/refman/8.0/en/create-table-generated-columns.html" target="_blank" rel="noopener">CREATE TABLE and Generated Columns</a>


The basics in a single page.</p>
</li>
<li>
<p><a href="https://dev.mysql.com/doc/refman/8.0/en/create-table-secondary-indexes.html" target="_blank" rel="noopener">Secondary Indexes and Generated Columns</a>


Indexing generated columns, with special considerations on indexing JSON</p>
</li>
<li>
<p><a href="https://dev.mysql.com/doc/refman/8.0/en/generated-column-index-optimizations.html" target="_blank" rel="noopener">Optimizer Use of Generated Column Indexes</a>


We all love to hate the optimizer, but it has learned a lot of new tricks. Here&rsquo;s what it does understand.</p>
</li>
<li>
<p>The CREATE INDEX statement and <a href="https://dev.mysql.com/doc/refman/8.0/en/create-index.html#create-index-multi-valued" target="_blank" rel="noopener">multi valued indexes</a>


The entire page is useful, because it speaks about functional indexes and how they are implemented as hidden virtual columns and indexes on these (which has implications). But within the discussion of JSON, the interesting part are Multi-Valued Indexes, which are indexes on non-scalar values such as JSON arrays, and how they are being used to speed up certain JSON functions that deal with array membership and overlaps.</p>
</li>
</ul>


	
    </article>
</div>



            <footer>
    <p>
	&copy; Copyright 2021 Someone or something
    </p>
</footer>


        </main>

	





<script src="/js/bootstrap.js"></script>




<script src="/js/lunr.js"></script>





<script src="/js/app.js"></script>


    </body>
</html>
