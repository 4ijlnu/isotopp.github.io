<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Die wunderbare Welt von Isotopp - MySQL: Encoding fields for great profit.</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="site.webmanifest">
<link rel="apple-touch-icon" href="icon.png">
<link rel="favicon.ico" rel="icon" type="image/ico">





	



<link rel="stylesheet" href="/style.min.c5e5cd61f54911f9aafd1dbe09c2f90667957bfe1002126c87aace57759f3446.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
	<a class="navbar-brand" href="" rel="home" title=".Site.Title">
	    Die wunderbare Welt von Isotopp
	</a>
	<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
	</button>

	<div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
		
		
		<li class="nav-item ">
                    <a class="nav-link" href="/about/">
			
			<span>About</span>
			<span class="visually-hidden">(Current)</span>
		    </a>
		    
		</li>
            </ul>
            
	</div>
    </div>
</nav>


        <main role="main" class="container-fluid">

            


<div class="page">
    <article class="mysql-encoding-fields-for-great-profit.-page">
	<h1 class="title">
            MySQL: Encoding fields for great profit.
	</h1>

	<p>Iterating schemas over time is not an uncommon thing. Often requirements emerge only after you have data, and then directed action is possible. Consequently, working on existing data, and structuring and cleaning it up is a common task.</p>
<p>In todays example we work with a log table that logged state transitions of things in freeform <code>VARCHAR</code> fields. After some time the log table grew quite sizeable, and the log strings are repeated rather often, contributing to the overall size of the table considerably.</p>
<p>We are starting with this table:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#f92672">`</span>log<span style="color:#f92672">`</span> (
  <span style="color:#f92672">`</span>id<span style="color:#f92672">`</span> int <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> AUTO_INCREMENT,
  <span style="color:#f92672">`</span>device_id<span style="color:#f92672">`</span> int <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>change_time<span style="color:#f92672">`</span> datetime <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>old_state<span style="color:#f92672">`</span> varchar(<span style="color:#ae81ff">64</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>new_state<span style="color:#f92672">`</span> varchar(<span style="color:#ae81ff">64</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span> (<span style="color:#f92672">`</span>id<span style="color:#f92672">`</span>)
) ENGINE<span style="color:#f92672">=</span>InnoDB
</code></pre></div><p>That is, our log table has an <code>id</code> field to allow individual row addressing, and then logs the state change of a <code>device_id</code> at a certain <code>change_time</code> from an <code>old_state</code> into a <code>new_state</code>. The two state fields are <code>varchar(64)</code> and contain one of some 13 or so different strings.</p>
<p>Maybe they also contain typos, outdated state codes or other stuff that will later needs remapping and cleanup, but in today example we want to concentrate on the cleanup.</p>
<p>Some small manual sample data:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> log;
<span style="color:#f92672">+</span><span style="color:#75715e">----+-----------+---------------------+---------------+---------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> id <span style="color:#f92672">|</span> device_id <span style="color:#f92672">|</span> change_time         <span style="color:#f92672">|</span> old_state     <span style="color:#f92672">|</span> new_state     <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+-----------+---------------------+---------------+---------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span>  <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>        <span style="color:#ae81ff">17</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span><span style="color:#f92672">-</span><span style="color:#ae81ff">18</span> <span style="color:#ae81ff">18</span>:<span style="color:#ae81ff">06</span>:<span style="color:#ae81ff">37</span> <span style="color:#f92672">|</span> racked        <span style="color:#f92672">|</span> burn<span style="color:#f92672">-</span><span style="color:#66d9ef">in</span>       <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>        <span style="color:#ae81ff">17</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span><span style="color:#f92672">-</span><span style="color:#ae81ff">18</span> <span style="color:#ae81ff">18</span>:<span style="color:#ae81ff">14</span>:<span style="color:#ae81ff">18</span> <span style="color:#f92672">|</span> burn<span style="color:#f92672">-</span><span style="color:#66d9ef">in</span>       <span style="color:#f92672">|</span> provisionable <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">3</span> <span style="color:#f92672">|</span>        <span style="color:#ae81ff">17</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span><span style="color:#f92672">-</span><span style="color:#ae81ff">18</span> <span style="color:#ae81ff">18</span>:<span style="color:#ae81ff">14</span>:<span style="color:#ae81ff">34</span> <span style="color:#f92672">|</span> provisionable <span style="color:#f92672">|</span> setup         <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">4</span> <span style="color:#f92672">|</span>        <span style="color:#ae81ff">17</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span><span style="color:#f92672">-</span><span style="color:#ae81ff">18</span> <span style="color:#ae81ff">18</span>:<span style="color:#ae81ff">14</span>:<span style="color:#ae81ff">48</span> <span style="color:#f92672">|</span> setup         <span style="color:#f92672">|</span> installed     <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">5</span> <span style="color:#f92672">|</span>        <span style="color:#ae81ff">17</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span><span style="color:#f92672">-</span><span style="color:#ae81ff">18</span> <span style="color:#ae81ff">18</span>:<span style="color:#ae81ff">14</span>:<span style="color:#ae81ff">56</span> <span style="color:#f92672">|</span> installed     <span style="color:#f92672">|</span> live          <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+-----------+---------------------+---------------+---------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">5</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>Let&rsquo;s build a list of all possible states from both columns, <code>old_state</code> and <code>new_state</code>. This is easily done. Using <code>old_state</code>, and we prepend a <code>NULL</code> column because we want to <code>INSERT ... SELECT ...</code> this later into a <code>map</code> table which will map the string to an <code>id</code> value. We will then encode the strings using exactly this value.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#66d9ef">NULL</span> <span style="color:#66d9ef">as</span> id, 
<span style="color:#f92672">-&gt;</span>            old_state 
<span style="color:#f92672">-&gt;</span>       <span style="color:#66d9ef">from</span> log 
<span style="color:#f92672">-&gt;</span>   <span style="color:#66d9ef">group</span> <span style="color:#66d9ef">by</span> old_state;
<span style="color:#f92672">+</span><span style="color:#75715e">------+---------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> id   <span style="color:#f92672">|</span> old_state     <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">------+---------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span> <span style="color:#f92672">|</span> racked        <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span> <span style="color:#f92672">|</span> burn<span style="color:#f92672">-</span><span style="color:#66d9ef">in</span>       <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span> <span style="color:#f92672">|</span> provisionable <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span> <span style="color:#f92672">|</span> setup         <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span> <span style="color:#f92672">|</span> installed     <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">------+---------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">5</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>Now using a <code>UNION</code> we extend it to <code>new_state</code> as well.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#66d9ef">NULL</span> <span style="color:#66d9ef">as</span> id, 
<span style="color:#f92672">-&gt;</span>             old_state 
<span style="color:#f92672">-&gt;</span>        <span style="color:#66d9ef">from</span> log 
<span style="color:#f92672">-&gt;</span>    <span style="color:#66d9ef">group</span> <span style="color:#66d9ef">by</span> old_state
<span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">union</span>
<span style="color:#f92672">-&gt;</span>      <span style="color:#66d9ef">select</span> <span style="color:#66d9ef">NULL</span> <span style="color:#66d9ef">as</span> id, 
<span style="color:#f92672">-&gt;</span>             new_state 
<span style="color:#f92672">-&gt;</span>        <span style="color:#66d9ef">from</span> log 
<span style="color:#f92672">-&gt;</span>    <span style="color:#66d9ef">group</span> <span style="color:#66d9ef">by</span> new_state;
<span style="color:#f92672">+</span><span style="color:#75715e">------------+---------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> id         <span style="color:#f92672">|</span> old_state     <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">------------+---------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> <span style="color:#ae81ff">0</span>x         <span style="color:#f92672">|</span> racked        <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#ae81ff">0</span>x         <span style="color:#f92672">|</span> burn<span style="color:#f92672">-</span><span style="color:#66d9ef">in</span>       <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#ae81ff">0</span>x         <span style="color:#f92672">|</span> provisionable <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#ae81ff">0</span>x         <span style="color:#f92672">|</span> setup         <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#ae81ff">0</span>x         <span style="color:#f92672">|</span> installed     <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#ae81ff">0</span>x         <span style="color:#f92672">|</span> live          <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">------------+---------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">6</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>The result strings look good, but something happened to our <code>NULL</code> values. In the original statement they were still good, but in the <code>UNION</code> they get mangled.</p>
<p>The data types of the result table are derived from the values and their types in the first result set of the <code>UNION</code>. And <code>NULL</code> is not a good value to guess anything from.</p>
<p>So let&rsquo;s be more explicit about the types:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#66d9ef">cast</span>(<span style="color:#66d9ef">NULL</span> <span style="color:#66d9ef">as</span> signed) <span style="color:#66d9ef">as</span> id, 
<span style="color:#f92672">-&gt;</span>            old_state <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">state</span>
<span style="color:#f92672">-&gt;</span>       <span style="color:#66d9ef">from</span> log 
<span style="color:#f92672">-&gt;</span>   <span style="color:#66d9ef">group</span> <span style="color:#66d9ef">by</span> <span style="color:#66d9ef">state</span>
<span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">union</span>
<span style="color:#f92672">-&gt;</span>     <span style="color:#66d9ef">select</span> <span style="color:#66d9ef">cast</span>(<span style="color:#66d9ef">NULL</span> <span style="color:#66d9ef">as</span> signed) <span style="color:#66d9ef">as</span> id, 
<span style="color:#f92672">-&gt;</span>            new_state <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">state</span>
<span style="color:#f92672">-&gt;</span>       <span style="color:#66d9ef">from</span> log
<span style="color:#f92672">-&gt;</span>   <span style="color:#66d9ef">group</span> <span style="color:#66d9ef">by</span> <span style="color:#66d9ef">state</span>;
<span style="color:#f92672">+</span><span style="color:#75715e">------+---------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> id   <span style="color:#f92672">|</span> <span style="color:#66d9ef">state</span>         <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">------+---------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span> <span style="color:#f92672">|</span> racked        <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span> <span style="color:#f92672">|</span> burn<span style="color:#f92672">-</span><span style="color:#66d9ef">in</span>       <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span> <span style="color:#f92672">|</span> provisionable <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span> <span style="color:#f92672">|</span> setup         <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span> <span style="color:#f92672">|</span> installed     <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span> <span style="color:#f92672">|</span> live          <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">------+---------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">6</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>This now works, and we can feed it into an <code>INSERT ... SELECT ...</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> <span style="color:#66d9ef">map</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
       <span style="color:#66d9ef">Table</span>: <span style="color:#66d9ef">map</span>
<span style="color:#66d9ef">Create</span> <span style="color:#66d9ef">Table</span>: <span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#f92672">`</span><span style="color:#66d9ef">map</span><span style="color:#f92672">`</span> (
  <span style="color:#f92672">`</span>id<span style="color:#f92672">`</span> int <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> AUTO_INCREMENT,
  <span style="color:#f92672">`</span><span style="color:#66d9ef">state</span><span style="color:#f92672">`</span> varchar(<span style="color:#ae81ff">64</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span> (<span style="color:#f92672">`</span>id<span style="color:#f92672">`</span>)
) ENGINE<span style="color:#f92672">=</span>InnoDB 

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> <span style="color:#66d9ef">map</span> 
<span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#66d9ef">cast</span>(<span style="color:#66d9ef">NULL</span> <span style="color:#66d9ef">as</span> signed) <span style="color:#66d9ef">as</span> id, old_state <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">state</span> <span style="color:#66d9ef">from</span> log <span style="color:#66d9ef">group</span> <span style="color:#66d9ef">by</span> <span style="color:#66d9ef">state</span>
<span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">union</span>
<span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#66d9ef">cast</span>(<span style="color:#66d9ef">NULL</span> <span style="color:#66d9ef">as</span> signed) <span style="color:#66d9ef">as</span> id, new_state <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">state</span> <span style="color:#66d9ef">from</span> log <span style="color:#66d9ef">group</span> <span style="color:#66d9ef">by</span> <span style="color:#66d9ef">state</span>;
Query OK, <span style="color:#ae81ff">6</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">02</span> sec)
Records: <span style="color:#ae81ff">6</span>  Duplicates: <span style="color:#ae81ff">0</span>  Warnings: <span style="color:#ae81ff">0</span>

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> <span style="color:#66d9ef">map</span>;
<span style="color:#f92672">+</span><span style="color:#75715e">----+---------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> id <span style="color:#f92672">|</span> <span style="color:#66d9ef">state</span>         <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+---------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span>  <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span> racked        <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span> burn<span style="color:#f92672">-</span><span style="color:#66d9ef">in</span>       <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">3</span> <span style="color:#f92672">|</span> provisionable <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">4</span> <span style="color:#f92672">|</span> setup         <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">5</span> <span style="color:#f92672">|</span> installed     <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">6</span> <span style="color:#f92672">|</span> live          <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+---------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">6</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>Yay. A nice and autonumbered list of all possible states from the existing data. We need this indexed, and we also need indices on the two source columns.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">alter</span> <span style="color:#66d9ef">table</span> <span style="color:#66d9ef">map</span> <span style="color:#66d9ef">add</span> <span style="color:#66d9ef">index</span>(<span style="color:#66d9ef">state</span>);
Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">08</span> sec)
Records: <span style="color:#ae81ff">0</span>  Duplicates: <span style="color:#ae81ff">0</span>  Warnings: <span style="color:#ae81ff">0</span>

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">alter</span> <span style="color:#66d9ef">table</span> log <span style="color:#66d9ef">add</span> <span style="color:#66d9ef">index</span>(old_state), <span style="color:#66d9ef">add</span> <span style="color:#66d9ef">index</span>(new_state);
Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">08</span> sec)
Records: <span style="color:#ae81ff">0</span>  Duplicates: <span style="color:#ae81ff">0</span>  Warnings: <span style="color:#ae81ff">0</span>
</code></pre></div><p>If we want to encode these two columns with id-Values from map, we need to add columns for that.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">alter</span> <span style="color:#66d9ef">table</span> log <span style="color:#66d9ef">add</span> <span style="color:#66d9ef">column</span> old_state_id integer <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span> <span style="color:#66d9ef">after</span> old_state,
<span style="color:#f92672">-&gt;</span>                     <span style="color:#66d9ef">add</span> <span style="color:#66d9ef">column</span> new_state_id integer <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span> <span style="color:#66d9ef">after</span> new_state;
</code></pre></div><p>We can now encode by looking up each <code>log.old_state</code> value in <code>map.state</code> and returning the matching <code>map.id</code> value. With this we should be able to construct an <code>UPDATE</code> statement that fills in the <code>log.old_state_id</code> column.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#66d9ef">map</span>.id <span style="color:#66d9ef">as</span> old_state_id 
<span style="color:#f92672">-&gt;</span>       <span style="color:#66d9ef">from</span> <span style="color:#66d9ef">map</span> <span style="color:#66d9ef">join</span> log 
<span style="color:#f92672">-&gt;</span>         <span style="color:#66d9ef">on</span> <span style="color:#66d9ef">map</span>.<span style="color:#66d9ef">state</span> <span style="color:#f92672">=</span> log.old_state;
<span style="color:#f92672">+</span><span style="color:#75715e">--------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> old_state_id <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span>            <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>            <span style="color:#ae81ff">5</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>            <span style="color:#ae81ff">3</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>            <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>            <span style="color:#ae81ff">4</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">5</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>Let&rsquo;s try this out in an <code>UPDATE</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">update</span> log 
<span style="color:#f92672">-&gt;</span>        <span style="color:#66d9ef">set</span> log.old_state_id <span style="color:#f92672">=</span> ( 
<span style="color:#f92672">-&gt;</span>          <span style="color:#66d9ef">select</span> id <span style="color:#66d9ef">from</span> <span style="color:#66d9ef">map</span> <span style="color:#66d9ef">where</span> log.old_state <span style="color:#f92672">=</span> <span style="color:#66d9ef">map</span>.<span style="color:#66d9ef">state</span>
<span style="color:#f92672">-&gt;</span>        );
Query OK, <span style="color:#ae81ff">5</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">02</span> sec)
<span style="color:#66d9ef">Rows</span> matched: <span style="color:#ae81ff">5</span>  Changed: <span style="color:#ae81ff">5</span>  Warnings: <span style="color:#ae81ff">0</span>

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">update</span> log 
<span style="color:#f92672">-&gt;</span>        <span style="color:#66d9ef">set</span> log.new_state_id <span style="color:#f92672">=</span> ( 
<span style="color:#f92672">-&gt;</span>          <span style="color:#66d9ef">select</span> id <span style="color:#66d9ef">from</span> <span style="color:#66d9ef">map</span> <span style="color:#66d9ef">where</span> log.new_state <span style="color:#f92672">=</span> <span style="color:#66d9ef">map</span>.<span style="color:#66d9ef">state</span>
<span style="color:#f92672">-&gt;</span>        );
Query OK, <span style="color:#ae81ff">5</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">01</span> sec)
<span style="color:#66d9ef">Rows</span> matched: <span style="color:#ae81ff">5</span>  Changed: <span style="color:#ae81ff">5</span>  Warnings: <span style="color:#ae81ff">0</span>

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> log;
<span style="color:#f92672">+</span><span style="color:#75715e">----+-----------+---------------------+---------------+--------------+---------------+--------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> id <span style="color:#f92672">|</span> device_id <span style="color:#f92672">|</span> change_time         <span style="color:#f92672">|</span> old_state     <span style="color:#f92672">|</span> old_state_id <span style="color:#f92672">|</span> new_state     <span style="color:#f92672">|</span> new_state_id <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+-----------+---------------------+---------------+--------------+---------------+--------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span>  <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>        <span style="color:#ae81ff">17</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span><span style="color:#f92672">-</span><span style="color:#ae81ff">18</span> <span style="color:#ae81ff">10</span>:<span style="color:#ae81ff">06</span>:<span style="color:#ae81ff">37</span> <span style="color:#f92672">|</span> racked        <span style="color:#f92672">|</span>            <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span> burn<span style="color:#f92672">-</span><span style="color:#66d9ef">in</span>       <span style="color:#f92672">|</span>            <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>        <span style="color:#ae81ff">17</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span><span style="color:#f92672">-</span><span style="color:#ae81ff">18</span> <span style="color:#ae81ff">10</span>:<span style="color:#ae81ff">14</span>:<span style="color:#ae81ff">18</span> <span style="color:#f92672">|</span> burn<span style="color:#f92672">-</span><span style="color:#66d9ef">in</span>       <span style="color:#f92672">|</span>            <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span> provisionable <span style="color:#f92672">|</span>            <span style="color:#ae81ff">3</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">3</span> <span style="color:#f92672">|</span>        <span style="color:#ae81ff">17</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span><span style="color:#f92672">-</span><span style="color:#ae81ff">18</span> <span style="color:#ae81ff">10</span>:<span style="color:#ae81ff">14</span>:<span style="color:#ae81ff">34</span> <span style="color:#f92672">|</span> provisionable <span style="color:#f92672">|</span>            <span style="color:#ae81ff">3</span> <span style="color:#f92672">|</span> setup         <span style="color:#f92672">|</span>            <span style="color:#ae81ff">4</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">4</span> <span style="color:#f92672">|</span>        <span style="color:#ae81ff">17</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span><span style="color:#f92672">-</span><span style="color:#ae81ff">18</span> <span style="color:#ae81ff">10</span>:<span style="color:#ae81ff">14</span>:<span style="color:#ae81ff">48</span> <span style="color:#f92672">|</span> setup         <span style="color:#f92672">|</span>            <span style="color:#ae81ff">4</span> <span style="color:#f92672">|</span> installed     <span style="color:#f92672">|</span>            <span style="color:#ae81ff">5</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">5</span> <span style="color:#f92672">|</span>        <span style="color:#ae81ff">17</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span><span style="color:#f92672">-</span><span style="color:#ae81ff">18</span> <span style="color:#ae81ff">10</span>:<span style="color:#ae81ff">14</span>:<span style="color:#ae81ff">56</span> <span style="color:#f92672">|</span> installed     <span style="color:#f92672">|</span>            <span style="color:#ae81ff">5</span> <span style="color:#f92672">|</span> live          <span style="color:#f92672">|</span>            <span style="color:#ae81ff">6</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+-----------+---------------------+---------------+--------------+---------------+--------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">5</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>So we update <code>log</code>, specifically setting each current <code>log.old_state_id</code> value to whatever is returned as matching, for this row, from the subselect we wrote. We then do the same, again, for the <code>new_state</code> column. The result is as shown, it works.</p>
<p>We now have two redundant columns and the indexes that go with them, and can drop these. Let&rsquo;s also check the new table structure, and validate the output by joining the id values for resolution against the map.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">alter</span> <span style="color:#66d9ef">table</span> log <span style="color:#66d9ef">drop</span> <span style="color:#66d9ef">column</span> old_state, <span style="color:#66d9ef">drop</span> <span style="color:#66d9ef">column</span> new_state;
Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">24</span> sec)
Records: <span style="color:#ae81ff">0</span>  Duplicates: <span style="color:#ae81ff">0</span>  Warnings: <span style="color:#ae81ff">0</span>

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> log<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
       <span style="color:#66d9ef">Table</span>: log
<span style="color:#66d9ef">Create</span> <span style="color:#66d9ef">Table</span>: <span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#f92672">`</span>log<span style="color:#f92672">`</span> (
  <span style="color:#f92672">`</span>id<span style="color:#f92672">`</span> int <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> AUTO_INCREMENT,
  <span style="color:#f92672">`</span>device_id<span style="color:#f92672">`</span> int <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>change_time<span style="color:#f92672">`</span> datetime <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>old_state_id<span style="color:#f92672">`</span> int <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>new_state_id<span style="color:#f92672">`</span> int <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span> (<span style="color:#f92672">`</span>id<span style="color:#f92672">`</span>)
) ENGINE<span style="color:#f92672">=</span>InnoDB AUTO_INCREMENT<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span> <span style="color:#66d9ef">DEFAULT</span> CHARSET<span style="color:#f92672">=</span>utf8mb4 <span style="color:#66d9ef">COLLATE</span><span style="color:#f92672">=</span>utf8mb4_0900_ai_ci
<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">01</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> log;
<span style="color:#f92672">+</span><span style="color:#75715e">----+-----------+---------------------+--------------+--------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> id <span style="color:#f92672">|</span> device_id <span style="color:#f92672">|</span> change_time         <span style="color:#f92672">|</span> old_state_id <span style="color:#f92672">|</span> new_state_id <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+-----------+---------------------+--------------+--------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span>  <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>        <span style="color:#ae81ff">17</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span><span style="color:#f92672">-</span><span style="color:#ae81ff">18</span> <span style="color:#ae81ff">10</span>:<span style="color:#ae81ff">06</span>:<span style="color:#ae81ff">37</span> <span style="color:#f92672">|</span>            <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>            <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>        <span style="color:#ae81ff">17</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span><span style="color:#f92672">-</span><span style="color:#ae81ff">18</span> <span style="color:#ae81ff">10</span>:<span style="color:#ae81ff">14</span>:<span style="color:#ae81ff">18</span> <span style="color:#f92672">|</span>            <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>            <span style="color:#ae81ff">3</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">3</span> <span style="color:#f92672">|</span>        <span style="color:#ae81ff">17</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span><span style="color:#f92672">-</span><span style="color:#ae81ff">18</span> <span style="color:#ae81ff">10</span>:<span style="color:#ae81ff">14</span>:<span style="color:#ae81ff">34</span> <span style="color:#f92672">|</span>            <span style="color:#ae81ff">3</span> <span style="color:#f92672">|</span>            <span style="color:#ae81ff">4</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">4</span> <span style="color:#f92672">|</span>        <span style="color:#ae81ff">17</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span><span style="color:#f92672">-</span><span style="color:#ae81ff">18</span> <span style="color:#ae81ff">10</span>:<span style="color:#ae81ff">14</span>:<span style="color:#ae81ff">48</span> <span style="color:#f92672">|</span>            <span style="color:#ae81ff">4</span> <span style="color:#f92672">|</span>            <span style="color:#ae81ff">5</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">5</span> <span style="color:#f92672">|</span>        <span style="color:#ae81ff">17</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span><span style="color:#f92672">-</span><span style="color:#ae81ff">18</span> <span style="color:#ae81ff">10</span>:<span style="color:#ae81ff">14</span>:<span style="color:#ae81ff">56</span> <span style="color:#f92672">|</span>            <span style="color:#ae81ff">5</span> <span style="color:#f92672">|</span>            <span style="color:#ae81ff">6</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+-----------+---------------------+--------------+--------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">5</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> log.id, 
<span style="color:#f92672">-&gt;</span>            log.device_id, 
<span style="color:#f92672">-&gt;</span>            log.change_time, 
<span style="color:#f92672">-&gt;</span>            oldmap.<span style="color:#66d9ef">state</span> <span style="color:#66d9ef">as</span> old_state, 
<span style="color:#f92672">-&gt;</span>            newmap.<span style="color:#66d9ef">state</span> <span style="color:#66d9ef">as</span> new_state 
<span style="color:#f92672">-&gt;</span>       <span style="color:#66d9ef">from</span> log <span style="color:#66d9ef">join</span> <span style="color:#66d9ef">map</span> <span style="color:#66d9ef">as</span> oldmap 
<span style="color:#f92672">-&gt;</span>         <span style="color:#66d9ef">on</span> log.old_state_id <span style="color:#f92672">=</span> oldmap.id 
<span style="color:#f92672">-&gt;</span>       <span style="color:#66d9ef">join</span> <span style="color:#66d9ef">map</span> <span style="color:#66d9ef">as</span> newmap 
<span style="color:#f92672">-&gt;</span>         <span style="color:#66d9ef">on</span> log.new_state_id <span style="color:#f92672">=</span> newmap.id;
<span style="color:#f92672">+</span><span style="color:#75715e">----+-----------+---------------------+---------------+---------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> id <span style="color:#f92672">|</span> device_id <span style="color:#f92672">|</span> change_time         <span style="color:#f92672">|</span> old_state     <span style="color:#f92672">|</span> new_state     <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+-----------+---------------------+---------------+---------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span>  <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>        <span style="color:#ae81ff">17</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span><span style="color:#f92672">-</span><span style="color:#ae81ff">18</span> <span style="color:#ae81ff">10</span>:<span style="color:#ae81ff">06</span>:<span style="color:#ae81ff">37</span> <span style="color:#f92672">|</span> racked        <span style="color:#f92672">|</span> burn<span style="color:#f92672">-</span><span style="color:#66d9ef">in</span>       <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>        <span style="color:#ae81ff">17</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span><span style="color:#f92672">-</span><span style="color:#ae81ff">18</span> <span style="color:#ae81ff">10</span>:<span style="color:#ae81ff">14</span>:<span style="color:#ae81ff">18</span> <span style="color:#f92672">|</span> burn<span style="color:#f92672">-</span><span style="color:#66d9ef">in</span>       <span style="color:#f92672">|</span> provisionable <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">3</span> <span style="color:#f92672">|</span>        <span style="color:#ae81ff">17</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span><span style="color:#f92672">-</span><span style="color:#ae81ff">18</span> <span style="color:#ae81ff">10</span>:<span style="color:#ae81ff">14</span>:<span style="color:#ae81ff">34</span> <span style="color:#f92672">|</span> provisionable <span style="color:#f92672">|</span> setup         <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">4</span> <span style="color:#f92672">|</span>        <span style="color:#ae81ff">17</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span><span style="color:#f92672">-</span><span style="color:#ae81ff">18</span> <span style="color:#ae81ff">10</span>:<span style="color:#ae81ff">14</span>:<span style="color:#ae81ff">48</span> <span style="color:#f92672">|</span> setup         <span style="color:#f92672">|</span> installed     <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">5</span> <span style="color:#f92672">|</span>        <span style="color:#ae81ff">17</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span><span style="color:#f92672">-</span><span style="color:#ae81ff">18</span> <span style="color:#ae81ff">10</span>:<span style="color:#ae81ff">14</span>:<span style="color:#ae81ff">56</span> <span style="color:#f92672">|</span> installed     <span style="color:#f92672">|</span> live          <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+-----------+---------------------+---------------+---------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">5</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>Note that we have to join against the map twice, once for each source column, and that also means we have to rename the map table to get unique names for each usage.</p>
<p>Well, that&rsquo;s a toy example. Let&rsquo;s do that at scale, using a Python driver implementing exactly this procedure. <a href="https://github.com/isotopp/mysql-dev-examples/blob/master/mysql-lookups/lookups.py" target="_blank" rel="noopener">Code is on github.com</a>

.</p>
<p>We <a href="https://github.com/isotopp/mysql-dev-examples/blob/master/mysql-lookups/lookups.py#L95-L102" target="_blank" rel="noopener">set up our source tables</a>

 by going over the table creation statements in the <a href="https://github.com/isotopp/mysql-dev-examples/blob/master/mysql-lookups/lookups.py#L19-L23" target="_blank" rel="noopener">sql_setup list</a>

.</p>
<p>We are also defining a <a href="https://github.com/isotopp/mysql-dev-examples/blob/master/mysql-lookups/lookups.py#L25-L39" target="_blank" rel="noopener">list of possible states</a>

, and in a <a href="https://github.com/isotopp/mysql-dev-examples/blob/master/mysql-lookups/lookups.py#L77-L93" target="_blank" rel="noopener">data generation loop</a>

 fill the log table with many state transitions from random devices. Note that we do not really care much about matching source and target states, so the transitions are really random jumps. We commit once every <code>statecount</code> many rows (once for each device) to make it a bit faster.</p>
<p>In a <a href="https://github.com/isotopp/mysql-dev-examples/blob/master/mysql-lookups/lookups.py#L48-L53" target="_blank" rel="noopener">prepare_log_transformation</a>

 function we basically add the missing columns and indexes, then in perform_log_transformation, <a href="https://github.com/isotopp/mysql-dev-examples/blob/master/mysql-lookups/lookups.py#L57-L60" target="_blank" rel="noopener">populate the map</a>

 and <a href="https://github.com/isotopp/mysql-dev-examples/blob/master/mysql-lookups/lookups.py#L62-L68" target="_blank" rel="noopener">encode the log</a>

.</p>
<p>Finally, in <a href="https://github.com/isotopp/mysql-dev-examples/blob/master/mysql-lookups/lookups.py#L70-L75" target="_blank" rel="noopener">finish_log_transformation</a>

, we drop the unneeded columns and also implicitly any indices defined on them.</p>
<p>On my super slow test machine, filling the table with a million rows from a thousand devices yields a 64M data file after 2 minutes. I have some 59M of data, and a bit of empty space:</p>
<pre><code class="language-console" data-lang="console">$ time ./lookups.py create-log-data --devicecount 1000 --statecount 1000

real	2m9.729s
user	0m30.487s
sys	0m7.536s

$ ls -l /var/lib/mysql/kris/log.ibd
-rw-r----- 1 mysql mysql  64M Sep 18 12:27 log.ibd

mysql&gt; select * from information_schema.tables where table_name = &quot;log&quot;\G
  TABLE_CATALOG: def
   TABLE_SCHEMA: kris
     TABLE_NAME: log
     TABLE_TYPE: BASE TABLE
         ENGINE: InnoDB
        VERSION: 10
     ROW_FORMAT: Dynamic
     TABLE_ROWS: 998347
 AVG_ROW_LENGTH: 59
    DATA_LENGTH: 59326464
MAX_DATA_LENGTH: 0
   INDEX_LENGTH: 0
      DATA_FREE: 4194304
 AUTO_INCREMENT: 1000001
    CREATE_TIME: 2020-09-18 12:24:50
    UPDATE_TIME: 2020-09-18 12:27:05
     CHECK_TIME: NULL
TABLE_COLLATION: utf8mb4_0900_ai_ci
       CHECKSUM: NULL
 CREATE_OPTIONS:
  TABLE_COMMENT:
1 row in set (0.00 sec)
</code></pre><p>The file size will go up to 132M in the transformation step, most of that is from the indexing we add.</p>
<pre><code class="language-console" data-lang="console">$ time ./lookups.py prepare-log-transformation
Adding id columns and indexes

real    0m24.395s
user    0m0.050s
sys     0m0.004s

$ time ./lookups.py perform-log-transformation
Populating map
Converting old_states
Converting new_states

real    0m39.729s
user    0m0.050s
sys     0m0.008s

$ ls -l /var/lib/mysql/kris/log.ibd
-rw-r----- 1 mysql mysql 132M Sep 18 12:31 log.ibd

mysql&gt; select * from information_schema.tables where table_name = &quot;log&quot;\G
  TABLE_CATALOG: def
   TABLE_SCHEMA: kris
     TABLE_NAME: log
     TABLE_TYPE: BASE TABLE
         ENGINE: InnoDB
        VERSION: 10
     ROW_FORMAT: Dynamic
     TABLE_ROWS: 996152
 AVG_ROW_LENGTH: 78
    DATA_LENGTH: 78200832
MAX_DATA_LENGTH: 0
   INDEX_LENGTH: 50446336
      DATA_FREE: 5242880
 AUTO_INCREMENT: 1000001
    CREATE_TIME: 2020-09-18 12:28:04
    UPDATE_TIME: 2020-09-18 12:28:07
     CHECK_TIME: NULL
TABLE_COLLATION: utf8mb4_0900_ai_ci
       CHECKSUM: NULL
 CREATE_OPTIONS:
  TABLE_COMMENT:
1 row in set (0.00 sec)
</code></pre><p>Finishing up will drop the two <code>VARCHAR</code> columns and the indices defined on them, but leaves us with the encoded values.</p>
<pre><code class="language-console" data-lang="console">$ time ./lookups.py finish-log-transformation
Removing string columns

real    0m10.486s
user    0m0.045s
sys     0m0.008s

$ ls -l /var/lib/mysql/kris/log.ibd
-rw-r----- 1 mysql mysql  52M Sep 18 12:32 log.ibd

mysql&gt; select * from information_schema.tables where table_name = &quot;log&quot;\G
  TABLE_CATALOG: def
   TABLE_SCHEMA: kris
     TABLE_NAME: log
     TABLE_TYPE: BASE TABLE
         ENGINE: InnoDB
        VERSION: 10
     ROW_FORMAT: Dynamic
     TABLE_ROWS: 997632
 AVG_ROW_LENGTH: 48
    DATA_LENGTH: 48824320
MAX_DATA_LENGTH: 0
   INDEX_LENGTH: 0
      DATA_FREE: 2097152
 AUTO_INCREMENT: 1000001
    CREATE_TIME: 2020-09-18 12:31:43
    UPDATE_TIME: NULL
     CHECK_TIME: NULL
TABLE_COLLATION: utf8mb4_0900_ai_ci
       CHECKSUM: NULL
 CREATE_OPTIONS:
  TABLE_COMMENT:
1 row in set (0.00 sec)
</code></pre><p>So data length went from 59326464 bytes to 48824320 bytes, a reduction to 82.3% of the original size. We could save even more by not using <code>integer</code> 4-byte values to encode, but for example <code>tinyint unsigned</code> 1-byte values. On the other hand, that may become a problem later on when we exceed the id-space of the map table as we add new states.</p>
<p>On top of that, the size of the target <code>log</code> table is now a function of the row number, as we have no variable length columns any more. The size of the source table is dependent on the variable length string values as well, so by encoding we also got a better plannable table size.</p>
<p>TL;DR:</p>
<ul>
<li>Using a map table, and update statements with a subselect, we can encode variable length repeated string values into integer values.</li>
<li>We also get better data quality, as now only legal values from the map table can be encoded.</li>
<li>The transformation requires at least two <code>ALTER TABLE</code> statements (or matching online schema changes), and one full scan for each column to be encoded. A lot of intermediate disk space is required. This needs planning.</li>
</ul>


	
    </article>
</div>



            <footer>
    <p>
	&copy; Copyright 2021 Someone or something
    </p>
</footer>


        </main>

	





<script src="/js/bootstrap.js"></script>




<script src="/js/lunr.js"></script>





<script src="/js/app.js"></script>


    </body>
</html>
