<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Die wunderbare Welt von Isotopp - Gosund and Tasmota</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="site.webmanifest">
<link rel="apple-touch-icon" href="icon.png">
<link rel="favicon.ico" rel="icon" type="image/ico">





	



<link rel="stylesheet" href="/style.min.c5e5cd61f54911f9aafd1dbe09c2f90667957bfe1002126c87aace57759f3446.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
	<a class="navbar-brand" href="" rel="home" title=".Site.Title">
	    Die wunderbare Welt von Isotopp
	</a>
	<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
	</button>

	<div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
		
		
		<li class="nav-item ">
                    <a class="nav-link" href="/about/">
			
			<span>About</span>
			<span class="visually-hidden">(Current)</span>
		    </a>
		    
		</li>
            </ul>
            
	</div>
    </div>
</nav>


        <main role="main" class="container-fluid">

            


<div class="page">
    <article class="gosund-and-tasmota-page">
	<h1 class="title">
            Gosund and Tasmota
	</h1>

	<p>(continued from [Plugs with Wifi]({% link _posts/2020-05-12-plugs-with-wifi.md %})) So the Gosund plugs came, as did the Raspi 4. I did cancel the Shelly plug and decomissioned the TP-Link Kaka, because Tasmota on Gosund is awesome and the Gosund hardware is dirt cheap.</p>
<p><p class="md__image">
  <img src="/uploads/2020/05/tasmota-grafana.jpg" alt=""  />
</p>

</p>
<p><em>Power consumption of the local data grave, with too old a mainboard and CPU and way too much storage</em></p>
<p>But lets start at the beginning:</p>
<p><a href="https://www.amazon.de/dp/B082XR5C6J" target="_blank" rel="noopener">4 Pack of Gosund SP111 V1.1</a>

, so they come in at around 10 Euro/pc. They come with a chinese cloud application that is utterly useless, and I never even tried to get them running with it. This is recommended, because running that app might update the native firmware of these things and potentially lock it.</p>
<p>There is <a href="https://github.com/ct-Open-Source/tuya-convert" target="_blank" rel="noopener">tuya-convert</a>

 for solder-free flashing. The software needs to run on a machine with a controllable Wifi chip, in my case a Raspi 4. It fakes a trustworthy firmware update hotspot and then flashes an alternate firmware onto the plug. For me, this was an entirely pain-free process.</p>
<p><em>Clarification:</em> tuya-convert is a solder-free conversion process that exploits a firmware update vulnerability in the original firmware. For some plugs or ESP devices in general it can work, and if it does, it is a breeze.</p>
<p>Some Tuya devices are locked. In this case it is always possible to convert them by connecting a serial port to the GPIO pins of the ESP chip. This can be done with a <a href="https://www.amazon.de/gp/product/B07TC2BK1X" target="_blank" rel="noopener">Raspi 4</a>

 (<a href="https://www.amazon.de/gp/product/B085795KPX" target="_blank" rel="noopener">Case</a>

, <a href="https://www.amazon.de/gp/product/B07ZCK2B8J" target="_blank" rel="noopener">Power</a>

, <a href="https://www.amazon.de/gp/product/B073JYVKNX" target="_blank" rel="noopener">SD Card</a>

), a <a href="https://www.amazon.de/gp/product/B01N7KA3OO" target="_blank" rel="noopener">RS232 adapter</a>

, and some headers and breadboard wires. Sometimes the connection can be made without soldering using the breadboard wires, and always with a quick solder drop to make the connection more reliable. In my case all of that was not necessary for the Gosund plugs, tuya-convert worked.</p>
<p>In my home, the new firmware is <a href="https://github.com/arendst/Tasmota" target="_blank" rel="noopener">Tasmota</a>

 - there is also esphome. Tasmota does http, mqtt (both with TLS, if you wish) and syslog.</p>
<p><p class="md__image">
  <img src="/uploads/2020/05/tasmota-ui.jpg" alt=""  />
</p>

</p>
<p><em>Tasmota UI in Admin mode. When configured, it can be locked to only show the data and the ON/OFF toggle. Control is then only possible via MQTT. It can also be basic-auth protected.</em></p>
<p>After conversion, the plug is a hotspot. You join with a cellphone and enter the &ldquo;login to hotspot&rdquo; screen. You see a config for Wifi credentials. The plug joins your local Wifi, and config continues via normal Wifi, using http or mqtt.</p>
<p>Apart from the obvious config through http, you want</p>
<pre><code class="language-console" data-lang="console">{&quot;NAME&quot;:&quot;SP111 v1.1&quot;,&quot;GPIO&quot;:[56,0,158,0,132,134,0,0,131,17,0,21,0],&quot;FLAG&quot;:0,&quot;BASE&quot;:45}
</code></pre><p>as the template of choice for the v1.1 plug. Tasmota Templates select the binary function module that controls the plug, here 45 - Blitzwolf SHP6 - and then assigns functions to the GPIO pins.</p>
<p>Apart from setting up syslog, MQTT and Wifi, you also want to run some Console commands:</p>
<pre><code class="language-console" data-lang="console">VoltageSet 235
SetOption21 1
</code></pre><p>The former sets the base voltage the plug sees, calibrating things, and the latter makes the plug report voltage even when the relais is off.</p>
<p>Some people also recommend to shorten the power consumption reporting interval. The minimum is 10s. This can be done in the web interface, or with a console command:</p>
<pre><code class="language-console" data-lang="console">TelePeriod 10
</code></pre><p>Additionally, the number of digits after the comma can be dialled up. If you trust the equipment to actually deliver this precision, do configure like this, and also set a NTP server.</p>
<pre><code class="language-console" data-lang="console">Backlog AmpRes 3; EnergyRes 5; FreqRes 3; VoltRes 3; WattRes 3
NtpServer http://ptbtime1.ptb.de
</code></pre><p><a href="http://nilhcem.com/iot/home-monitoring-with-mqtt-influxdb-grafana" target="_blank" rel="noopener">MQTT to Influx and Grafana</a>

 contains instructions for dockering Influx and Grafana and a small piece of Python that can be trivially adjusted to grab the power reports from the plug and load them into the Influx.</p>
<p>I added a total of 10 plugs to the household and may have need for another 10. I am also looking at a potential IPv4 shortage at home and may need to expand beyond a single /24.</p>


	
    </article>
</div>



            <footer>
    <p>
	&copy; Copyright 2021 Someone or something
    </p>
</footer>


        </main>

	





<script src="/js/bootstrap.js"></script>




<script src="/js/lunr.js"></script>





<script src="/js/app.js"></script>


    </body>
</html>
