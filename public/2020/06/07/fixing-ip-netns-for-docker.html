<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Die wunderbare Welt von Isotopp - Fixing &#34;ip netns&#34; for docker</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="site.webmanifest">
<link rel="apple-touch-icon" href="icon.png">
<link rel="favicon.ico" rel="icon" type="image/ico">





	



<link rel="stylesheet" href="/style.min.c5e5cd61f54911f9aafd1dbe09c2f90667957bfe1002126c87aace57759f3446.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
	<a class="navbar-brand" href="" rel="home" title=".Site.Title">
	    Die wunderbare Welt von Isotopp
	</a>
	<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
	</button>

	<div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
		
		
		<li class="nav-item ">
                    <a class="nav-link" href="/about/">
			
			<span>About</span>
			<span class="visually-hidden">(Current)</span>
		    </a>
		    
		</li>
            </ul>
            
	</div>
    </div>
</nav>


        <main role="main" class="container-fluid">

            


<div class="page">
    <article class="fixing-ip-netns-for-docker-page">
	<h1 class="title">
            Fixing &ldquo;ip netns&rdquo; for docker
	</h1>

	<p>So I want to monitor my Jitsi Videobridge to get some useful statistics. The instructions say to <a href="https://github.com/jitsi/jitsi-videobridge/blob/master/doc/statistics.md" target="_blank" rel="noopener">enable Videobridge statistics</a>

 and then grab stuff from port 8080.</p>
<p>Ok, I think I did that, but it did not work. Time to dig into the container network config.</p>
<p>And while I have a lot of network namespaces, they are unknown to <code>ip netns</code>, as can be seen when asking for a list. When we define a network namespace with <code>ip netns</code>, it will symlink the assigned name from <code>/var/run/netns/&lt;name&gt;</code> to <code>/proc/&lt;pid&gt;/ns/net</code> of the process that leads that namespace.</p>
<p>So these are our container names, we want them as netns names:</p>
<pre><code class="language-console{%" data-lang="console{%"># docker ps --format='{{.Names}}'
jitsi-jvb
...
{% endraw %}```

We can turn them into PIDs:

```console{% raw %}
# docker inspect -f '{{.State.Pid}}' jitsi-jvb
3899821
{% endraw %}```

And with that, we can create a mapping script:

```console{% raw %}
#! /bin/bash

names=&quot;$(docker ps --format='{{.Names}}')&quot;
for name in $names
do
  pid=&quot;$(docker inspect -f '{{.State.Pid}}' $name)&quot;
  if [ -z &quot;$pid&quot; ]; then echo &quot;Cannot resolve $name&quot;; continue; fi
  echo $pid $name
  ln -sf /proc/$pid/ns/net &quot;/var/run/netns/$name&quot;
done
{% endraw %}```


Sure enough, I can now `ip netns` things:

```console{% raw %}
# ip netns list
influxdb (id: 5)
mosquitto (id: 2)
grafana (id: 0)
z2m (id: 8)
mqttbridge (id: 9)
jitsi-web (id: 3)
jitsi-prosody (id: 1)
jitsi-jvb (id: 4)
jitsi-jicofo (id: 6)
# ip netns exec jitsi-jvb lsof -i -n -P
COMMAND     PID   USER   FD   TYPE   DEVICE SIZE/OFF NODE NAME
dockerd   16420   root  134u  IPv4 34920699      0t0  UDP 127.0.0.11:45441
dockerd   16420   root  138u  IPv4 34920700      0t0  TCP 127.0.0.11:34251 (LISTEN)
java    3900157 docker  152u  IPv4 34917278      0t0  UDP 172.3.0.5:10000
java    3900157 docker  153u  IPv4 34927830      0t0  TCP 172.3.0.5:59998-&gt;172.3.0.2:5222 (ESTABLISHED)
java    3900157 docker  157u  IPv4 34927885      0t0  UDP *:5000
java    3900157 docker  159u  IPv6 34927887      0t0  UDP *:5000
{% endraw %}```

[@ascii158](https://twitter.com/ascii158/status/1269868957458186240) points me at

```console# nsenter -n -t $(docker inspect &lt;containername&gt; -f '{{.State.Pid}}') lsof -i -n -P```

as an alternative solution. That works, but is also quite a lot to type. Like the former solution it needs a script, just a different one. It still is more flexible: works with non-network namespaces and does not need to update a static lookup table.

It also highlights the fact that `docker ps` prints a lot of different identifiers, none of which are the actual PID. Which is funny, because that is kind of the point of a thing called `ps`, isn't it?</code></pre>

	
    </article>
</div>



            <footer>
    <p>
	&copy; Copyright 2021 Someone or something
    </p>
</footer>


        </main>

	





<script src="/js/bootstrap.js"></script>




<script src="/js/lunr.js"></script>





<script src="/js/app.js"></script>


    </body>
</html>
