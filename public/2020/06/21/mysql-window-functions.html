<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Die wunderbare Welt von Isotopp - MySQL Window Functions</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="site.webmanifest">
<link rel="apple-touch-icon" href="icon.png">
<link rel="favicon.ico" rel="icon" type="image/ico">





	



<link rel="stylesheet" href="/style.min.c5e5cd61f54911f9aafd1dbe09c2f90667957bfe1002126c87aace57759f3446.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
	<a class="navbar-brand" href="" rel="home" title=".Site.Title">
	    Die wunderbare Welt von Isotopp
	</a>
	<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
	</button>

	<div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
		
		
		<li class="nav-item ">
                    <a class="nav-link" href="/about/">
			
			<span>About</span>
			<span class="visually-hidden">(Current)</span>
		    </a>
		    
		</li>
            </ul>
            
	</div>
    </div>
</nav>


        <main role="main" class="container-fluid">

            


<div class="page">
    <article class="mysql-window-functions-page">
	<h1 class="title">
            MySQL Window Functions
	</h1>

	<p>Two questions from Reddit&rsquo;s /r/mysql related to Window Functions: <a href="https://www.reddit.com/r/mysql/comments/gue9ct/how_do_i_make_rownumbers_happen/" target="_blank" rel="noopener">How do I make row.numbers happen</a>

 and <a href="https://www.reddit.com/r/mysql/comments/hbx5kk/get_the_difference_between_two_values_in/" target="_blank" rel="noopener">Get the difference between two values in different recordings</a>

.</p>
<p>One of the new things in MySQL is the implementation of Window Functions. They are related to aggregates, but do not actually lump values together.</p>
<p>To better understand what goes on, let&rsquo;s create some fake data to work with:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#! /usr/bin/env python3</span>
<span style="color:#75715e"># -*- coding: utf-8 -*-</span>

<span style="color:#f92672">import</span> MySQLdb <span style="color:#f92672">as</span> mdb
<span style="color:#f92672">import</span> MySQLdb.cursors <span style="color:#f92672">as</span> cursors
<span style="color:#f92672">from</span> datetime <span style="color:#f92672">import</span> datetime, timedelta
<span style="color:#f92672">from</span> random <span style="color:#f92672">import</span> randint, random

<span style="color:#75715e"># We have {sensors} sensors, each producing {values} values </span>
<span style="color:#75715e"># between {minvalue} and {maxvalue}, at a random time after {starttime} plus {delta}</span>
sensors <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
values <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
minvalue <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
maxvalue <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
starttime <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>fromisoformat(<span style="color:#e6db74">&#34;2020-01-01 00:00:00&#34;</span>)
delta <span style="color:#f92672">=</span> timedelta(days<span style="color:#f92672">=</span><span style="color:#ae81ff">31</span>)

script <span style="color:#f92672">=</span> [
    <span style="color:#e6db74">&#34;drop table if exists series&#34;</span>,
    <span style="color:#e6db74">&#34;create table if not exists series ( id serial, sensor integer not null, checktime timestamp not null, value float )&#34;</span>,
]

con <span style="color:#f92672">=</span> mdb<span style="color:#f92672">.</span>connect(
    host<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;localhost&#34;</span>, user<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;root&#34;</span>, db<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;kris&#34;</span>, cursorclass<span style="color:#f92672">=</span>cursors<span style="color:#f92672">.</span>DictCursor
)
cur <span style="color:#f92672">=</span> con<span style="color:#f92672">.</span>cursor()

<span style="color:#75715e"># Create a table</span>
<span style="color:#66d9ef">for</span> stmt <span style="color:#f92672">in</span> script:
    cur<span style="color:#f92672">.</span>execute(stmt)
    <span style="color:#66d9ef">print</span>(f<span style="color:#e6db74">&#34;{cur._last_executed}&#34;</span>)
con<span style="color:#f92672">.</span>commit()

<span style="color:#75715e"># insert values</span>
insert_stmt <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;insert into series values ( </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">, </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">, </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">, </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">)&#34;</span>
<span style="color:#66d9ef">for</span> s <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, sensors):
    <span style="color:#66d9ef">print</span>(
        f<span style="color:#e6db74">&#34;Sensor {s}: {values} measurements ({minvalue}, {maxvalue}), ({starttime}, {starttime+delta}).&#34;</span>
    )
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, values):
        value <span style="color:#f92672">=</span> random() <span style="color:#f92672">*</span> maxvalue <span style="color:#f92672">+</span> minvalue
        t <span style="color:#f92672">=</span> starttime <span style="color:#f92672">+</span> timedelta(days<span style="color:#f92672">=</span>randint(<span style="color:#ae81ff">0</span>, delta<span style="color:#f92672">.</span>days))
        data <span style="color:#f92672">=</span> (None, s, t, value)
        cur<span style="color:#f92672">.</span>execute(insert_stmt, data)
    con<span style="color:#f92672">.</span>commit()
</code></pre></div><p>This will create test data for a number of fictional sensors <code>sensors</code>. For each sensor, there will be <code>values</code> many readings with a random float value between <code>minvalue</code> and <code>maxvalue</code>. The sensor readings will be taken at a random point in time between <code>starttime</code> and <code>delta</code> days later. In our sample config, that is 3 sensors with 10 readings each, values between 0 and 10, at some random point in time in January 2020.</p>
<p>We get data similar to this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">root<span style="color:#f92672">@</span>localhost [kris]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> series;
<span style="color:#f92672">+</span><span style="color:#75715e">----+--------+---------------------+----------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> id <span style="color:#f92672">|</span> sensor <span style="color:#f92672">|</span> checktime           <span style="color:#f92672">|</span> value    <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+--------+---------------------+----------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span>  <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">0</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">01</span><span style="color:#f92672">-</span><span style="color:#ae81ff">12</span> <span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">9</span>.<span style="color:#ae81ff">72828</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">0</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">01</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span> <span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">3</span>.<span style="color:#ae81ff">59015</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">3</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">0</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">01</span><span style="color:#f92672">-</span><span style="color:#ae81ff">24</span> <span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">701136</span> <span style="color:#f92672">|</span>
<span style="color:#960050;background-color:#1e0010">…</span>
<span style="color:#f92672">|</span> <span style="color:#ae81ff">11</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">01</span><span style="color:#f92672">-</span><span style="color:#ae81ff">27</span> <span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">9</span>.<span style="color:#ae81ff">64586</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#ae81ff">12</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">01</span><span style="color:#f92672">-</span><span style="color:#ae81ff">25</span> <span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">6</span>.<span style="color:#ae81ff">19484</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#ae81ff">13</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">01</span><span style="color:#f92672">-</span><span style="color:#ae81ff">15</span> <span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">2</span>.<span style="color:#ae81ff">18511</span> <span style="color:#f92672">|</span>
<span style="color:#960050;background-color:#1e0010">…</span>
<span style="color:#f92672">|</span> <span style="color:#ae81ff">28</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">01</span><span style="color:#f92672">-</span><span style="color:#ae81ff">02</span> <span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">1</span>.<span style="color:#ae81ff">36718</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#ae81ff">29</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">01</span><span style="color:#f92672">-</span><span style="color:#ae81ff">03</span> <span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">2</span>.<span style="color:#ae81ff">71718</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#ae81ff">30</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">01</span><span style="color:#f92672">-</span><span style="color:#ae81ff">20</span> <span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">5</span>.<span style="color:#ae81ff">86109</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+--------+---------------------+----------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">30</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>We could group this data, for example by sensor. The database would then make piles for each sensor value, and we could apply aggregate functions to each pile:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">root<span style="color:#f92672">@</span>localhost [kris]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> sensor, 
   <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">count</span>(value) <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">count</span>,
   <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">min</span>(value) <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">min</span>, 
   <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">max</span>(value) <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">max</span>, 
   <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">avg</span>(value) <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">avg</span> 
   <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">from</span> series 
   <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">group</span> <span style="color:#66d9ef">by</span> sensor;
<span style="color:#f92672">+</span><span style="color:#75715e">--------+-------+----------+---------+-------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> sensor <span style="color:#f92672">|</span> <span style="color:#66d9ef">count</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">min</span>      <span style="color:#f92672">|</span> <span style="color:#66d9ef">max</span>     <span style="color:#f92672">|</span> <span style="color:#66d9ef">avg</span>               <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------+-------+----------+---------+-------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span>      <span style="color:#ae81ff">0</span> <span style="color:#f92672">|</span>    <span style="color:#ae81ff">10</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">065623</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">9</span>.<span style="color:#ae81ff">72828</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">4</span>.<span style="color:#ae81ff">031341724842787</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>      <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>    <span style="color:#ae81ff">10</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">1</span>.<span style="color:#ae81ff">16093</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">9</span>.<span style="color:#ae81ff">64586</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">5</span>.<span style="color:#ae81ff">11824003458023</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>      <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>    <span style="color:#ae81ff">10</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">1</span>.<span style="color:#ae81ff">36718</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">9</span>.<span style="color:#ae81ff">90121</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">5</span>.<span style="color:#ae81ff">031034636497497</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------+-------+----------+---------+-------------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">3</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>Window Functions work similarly, but they do not make piles. They work by defining partitions over the data, and then walking through each partition, resetting the window functions applied at each partition boundary.</p>
<p>As with <code>GROUP BY</code>, when leaving out a partitioning the entire table is taken as one:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">root<span style="color:#f92672">@</span>localhost [kris]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> id, sensor, row_number() over () <span style="color:#66d9ef">from</span> series;
<span style="color:#f92672">+</span><span style="color:#75715e">----+--------+----------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> id <span style="color:#f92672">|</span> sensor <span style="color:#f92672">|</span> row_number() over () <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+--------+----------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span>  <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">0</span> <span style="color:#f92672">|</span>                    <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">0</span> <span style="color:#f92672">|</span>                    <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">3</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">0</span> <span style="color:#f92672">|</span>                    <span style="color:#ae81ff">3</span> <span style="color:#f92672">|</span>
<span style="color:#960050;background-color:#1e0010">…</span>
<span style="color:#f92672">|</span> <span style="color:#ae81ff">28</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>                   <span style="color:#ae81ff">28</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#ae81ff">29</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>                   <span style="color:#ae81ff">29</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#ae81ff">30</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>                   <span style="color:#ae81ff">30</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+--------+----------------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">30</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>The <code>id</code> is stored, the <code>row_number()</code> is generated. Let&rsquo;s add a partitioning by sensor number and re-run the command:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">root<span style="color:#f92672">@</span>localhost [kris]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> id, sensor, 
  <span style="color:#f92672">-&gt;</span> row_number() over (partition <span style="color:#66d9ef">by</span> sensor) <span style="color:#66d9ef">as</span> r
  <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">from</span> series;
<span style="color:#f92672">+</span><span style="color:#75715e">----+--------+----+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> id <span style="color:#f92672">|</span> sensor <span style="color:#f92672">|</span>  r <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+--------+----+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span>  <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">0</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">0</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">3</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">0</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">3</span> <span style="color:#f92672">|</span>
<span style="color:#960050;background-color:#1e0010">…</span>
<span style="color:#f92672">|</span> <span style="color:#ae81ff">10</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">0</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">10</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#ae81ff">11</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#ae81ff">12</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#ae81ff">13</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">3</span> <span style="color:#f92672">|</span>
<span style="color:#960050;background-color:#1e0010">…</span>
<span style="color:#f92672">|</span> <span style="color:#ae81ff">20</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">10</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#ae81ff">21</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#ae81ff">22</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#ae81ff">23</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">3</span> <span style="color:#f92672">|</span>
<span style="color:#960050;background-color:#1e0010">…</span>
<span style="color:#f92672">|</span> <span style="color:#ae81ff">30</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">10</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+--------+----+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">30</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>By defining partition boundaries at <code>sensor</code> value changes with <code>PARTITION BY sensor</code>, the <code>row_number()</code> counter is reset each time the <code>sensor</code> value changes. Within each partition, we can order the values as we wish. Using the same statement as before, but ordering the values by <code>id</code> in reverse, we get</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">root<span style="color:#f92672">@</span>localhost [kris]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> id, sensor, 
  <span style="color:#f92672">-&gt;</span> row_number() over (partition <span style="color:#66d9ef">by</span> sensor <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> id <span style="color:#66d9ef">desc</span>) <span style="color:#66d9ef">as</span> r 
  <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">from</span> series;
<span style="color:#f92672">+</span><span style="color:#75715e">----+--------+----+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> id <span style="color:#f92672">|</span> sensor <span style="color:#f92672">|</span> r  <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+--------+----+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> <span style="color:#ae81ff">10</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">0</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">9</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">0</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">8</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">0</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">3</span> <span style="color:#f92672">|</span>
<span style="color:#960050;background-color:#1e0010">…</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">0</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">10</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#ae81ff">20</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#ae81ff">19</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#ae81ff">18</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">3</span> <span style="color:#f92672">|</span>
<span style="color:#960050;background-color:#1e0010">…</span>
<span style="color:#f92672">|</span> <span style="color:#ae81ff">11</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">10</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#ae81ff">30</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#ae81ff">29</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#ae81ff">28</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">3</span> <span style="color:#f92672">|</span>
<span style="color:#960050;background-color:#1e0010">…</span>
<span style="color:#f92672">|</span> <span style="color:#ae81ff">21</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">10</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+--------+----+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">30</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">01</span> sec)
</code></pre></div><p>Note that the <code>OVER ()</code> clause is written as a field. Different windows and hence different partitions and orderings can be defined concurrently.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">root<span style="color:#f92672">@</span>localhost [kris]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> id, sensor, row_number() over (partition <span style="color:#66d9ef">by</span> sensor <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> id <span style="color:#66d9ef">desc</span>) <span style="color:#66d9ef">as</span> r, row_number() over (<span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> id <span style="color:#66d9ef">desc</span> ) <span style="color:#66d9ef">as</span> rr  <span style="color:#66d9ef">from</span> series <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> id;
<span style="color:#f92672">+</span><span style="color:#75715e">----+--------+----+----+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> id <span style="color:#f92672">|</span> sensor <span style="color:#f92672">|</span> r  <span style="color:#f92672">|</span> rr <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+--------+----+----+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span>  <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">0</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">10</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">30</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">0</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">9</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">29</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">3</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">0</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">8</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">28</span> <span style="color:#f92672">|</span>
<span style="color:#960050;background-color:#1e0010">…</span>
<span style="color:#f92672">|</span> <span style="color:#ae81ff">10</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">0</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">21</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#ae81ff">11</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">10</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">20</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#ae81ff">12</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">9</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">19</span> <span style="color:#f92672">|</span>
<span style="color:#960050;background-color:#1e0010">…</span>
<span style="color:#f92672">|</span> <span style="color:#ae81ff">29</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#ae81ff">30</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+--------+----+----+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">30</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>Most aggregate functions can be used with <code>OVER()</code> clauses, among them not only <code>AVG()</code> and the other statistics functions, but also <code>JSON_ARRAYAGG()</code> and <code>JSON_OBJECTAGG()</code>. On top of that a number of window-specific functions have been defined, as listed in <a href="https://dev.mysql.com/doc/refman/8.0/en/window-function-descriptions.html" target="_blank" rel="noopener">Window Function Descriptions</a>

 in the manual. Among these are <code>RANK()</code> and <code>DENSE_RANK()</code> , as well as <code>LAG()</code> and <code>LEAD()</code>, which refer to the value next or preceding the current row.</p>
<p>We can already answer <a href="https://www.reddit.com/r/mysql/comments/gue9ct/how_do_i_make_rownumbers_happen/" target="_blank" rel="noopener">the question about row numbers</a>

 now, and better than <a href="http://mysqldump.azundris.com/archives/32-The-Quota-Query-and-Running-Sums-by-Jan-and-Kai.html" target="_blank" rel="noopener">before MySQL 8</a>

 (differently <a href="https://stackoverflow.com/questions/5436263/ranking-with-millions-of-entries/5491052#5491052" target="_blank" rel="noopener">here</a>

). These methods are outdated and should no longer be used.</p>
<p>We have shown above already how to produce global row numbers and row numbers per sensor. We can also quite easily run a topK query, for example &ldquo;show me the three smallest values per sensor&rdquo;:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">root<span style="color:#f92672">@</span>localhost [kris]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> (
  <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">select</span> sensor, 
  <span style="color:#f92672">-&gt;</span>        value, 
  <span style="color:#f92672">-&gt;</span>        rank() over (partition <span style="color:#66d9ef">by</span> sensor <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> value) <span style="color:#66d9ef">as</span> svrank 
  <span style="color:#f92672">-&gt;</span>   <span style="color:#66d9ef">from</span> series
  <span style="color:#f92672">-&gt;</span> ) <span style="color:#66d9ef">as</span> t 
  <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">where</span> svrank <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">4</span>;
<span style="color:#f92672">+</span><span style="color:#75715e">--------+----------+--------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> sensor <span style="color:#f92672">|</span> value    <span style="color:#f92672">|</span> svrank <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------+----------+--------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span>      <span style="color:#ae81ff">0</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">065623</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>      <span style="color:#ae81ff">0</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">701136</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>      <span style="color:#ae81ff">0</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">1</span>.<span style="color:#ae81ff">87906</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">3</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>      <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">1</span>.<span style="color:#ae81ff">16093</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>      <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">2</span>.<span style="color:#ae81ff">18511</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>      <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">3</span>.<span style="color:#ae81ff">83464</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">3</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>      <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">1</span>.<span style="color:#ae81ff">36718</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>      <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>   <span style="color:#ae81ff">1</span>.<span style="color:#ae81ff">8867</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>      <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">2</span>.<span style="color:#ae81ff">71718</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">3</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------+----------+--------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">9</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">01</span> sec)
</code></pre></div><p>We need a subquery here, because according to <a href="">the manual</a>

:</p>
<blockquote>
<p>Query result rows are determined from the FROM clause, after WHERE, GROUP BY, and HAVING processing, and windowing execution occurs before ORDER BY, LIMIT, and SELECT DISTINCT.</p>
</blockquote>
<p>So if we want to filter on the result of a window function like rank, we need to take our result from an inner query and then apply the filter in an outer query.</p>
<p>To answer the <a href="https://www.reddit.com/r/mysql/comments/hbx5kk/get_the_difference_between_two_values_in" target="_blank" rel="noopener">second Reddit question</a>

, we need to use <code>LAG()</code> and <code>LEAD()</code>. With them we can also process differences between two adjacent rows in the same partition:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">root<span style="color:#f92672">@</span>localhost [kris]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> id, 
  <span style="color:#f92672">-&gt;</span> sensor, 
  <span style="color:#f92672">-&gt;</span> checktime, 
  <span style="color:#f92672">-&gt;</span> value, 
  <span style="color:#f92672">-&gt;</span> lag(value) over (partition <span style="color:#66d9ef">by</span> sensor <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> checktime) <span style="color:#f92672">-</span> value <span style="color:#66d9ef">as</span> delta 
  <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">from</span> series 
  <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> sensor, checktime;
<span style="color:#f92672">+</span><span style="color:#75715e">----+--------+---------------------+----------+----------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> id <span style="color:#f92672">|</span> sensor <span style="color:#f92672">|</span> checktime           <span style="color:#f92672">|</span> value    <span style="color:#f92672">|</span> delta                <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+--------+---------------------+----------+----------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span>  <span style="color:#ae81ff">9</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">0</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">01</span><span style="color:#f92672">-</span><span style="color:#ae81ff">04</span> <span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">9</span>.<span style="color:#ae81ff">20321</span> <span style="color:#f92672">|</span>                 <span style="color:#66d9ef">NULL</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">5</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">0</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">01</span><span style="color:#f92672">-</span><span style="color:#ae81ff">06</span> <span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">4</span>.<span style="color:#ae81ff">63966</span> <span style="color:#f92672">|</span>     <span style="color:#ae81ff">4</span>.<span style="color:#ae81ff">56355619430542</span> <span style="color:#f92672">|</span>
<span style="color:#960050;background-color:#1e0010">…</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">3</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">0</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">01</span><span style="color:#f92672">-</span><span style="color:#ae81ff">24</span> <span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">701136</span> <span style="color:#f92672">|</span>   <span style="color:#ae81ff">1</span>.<span style="color:#ae81ff">7513115406036377</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#ae81ff">20</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">01</span><span style="color:#f92672">-</span><span style="color:#ae81ff">03</span> <span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span> <span style="color:#f92672">|</span>   <span style="color:#ae81ff">5</span>.<span style="color:#ae81ff">3703</span> <span style="color:#f92672">|</span>                 <span style="color:#66d9ef">NULL</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#ae81ff">17</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">01</span><span style="color:#f92672">-</span><span style="color:#ae81ff">07</span> <span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">6</span>.<span style="color:#ae81ff">00236</span> <span style="color:#f92672">|</span>  <span style="color:#f92672">-</span><span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">6320672035217285</span> <span style="color:#f92672">|</span>
<span style="color:#960050;background-color:#1e0010">…</span>
<span style="color:#f92672">|</span> <span style="color:#ae81ff">14</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">01</span><span style="color:#f92672">-</span><span style="color:#ae81ff">31</span> <span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">3</span>.<span style="color:#ae81ff">83464</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">11126899719238281</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#ae81ff">28</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">01</span><span style="color:#f92672">-</span><span style="color:#ae81ff">02</span> <span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">1</span>.<span style="color:#ae81ff">36718</span> <span style="color:#f92672">|</span>                 <span style="color:#66d9ef">NULL</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#ae81ff">25</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">01</span><span style="color:#f92672">-</span><span style="color:#ae81ff">03</span> <span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">4</span>.<span style="color:#ae81ff">10965</span> <span style="color:#f92672">|</span>   <span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>.<span style="color:#ae81ff">742463231086731</span> <span style="color:#f92672">|</span>
<span style="color:#960050;background-color:#1e0010">…</span>
<span style="color:#f92672">|</span> <span style="color:#ae81ff">22</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">2</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">01</span><span style="color:#f92672">-</span><span style="color:#ae81ff">30</span> <span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span> <span style="color:#f92672">|</span>   <span style="color:#ae81ff">1</span>.<span style="color:#ae81ff">8867</span> <span style="color:#f92672">|</span>    <span style="color:#ae81ff">8</span>.<span style="color:#ae81ff">014503359794617</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+--------+---------------------+----------+----------------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">30</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>We define a partition by sensor, and process values in each partition in temporal order (we generated our fake sensor data in random temporal order within a time window). We calculate the difference between the current value and the lagging (following) value as <code>delta</code>.</p>
<p>The way we have written the delta calculation highlights a pecularity of the syntax: The expression for the preceding value is not <code>LAG(value)</code>, it is <code>lag(value) over (partition by sensor order by checktime)</code>. We have to put the different <code>- value</code> behind the full window expression, not into the middle of it: <code>lag(value)-value over (partition by sensor order by checktime) as delta</code> yields a syntax error.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">root<span style="color:#f92672">@</span>localhost [kris]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> id, sensor, checktime, value, lag(value)<span style="color:#f92672">-</span>value over (partition <span style="color:#66d9ef">by</span> sensor <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> checktime) <span style="color:#66d9ef">as</span> delta <span style="color:#66d9ef">from</span> series <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> sensor, checktime;
ERROR <span style="color:#ae81ff">1064</span> (<span style="color:#ae81ff">42000</span>): You have an error <span style="color:#66d9ef">in</span> your <span style="color:#66d9ef">SQL</span> syntax; <span style="color:#66d9ef">check</span> the manual that corresponds <span style="color:#66d9ef">to</span> your MySQL server <span style="color:#66d9ef">version</span> <span style="color:#66d9ef">for</span> the <span style="color:#66d9ef">right</span> syntax <span style="color:#66d9ef">to</span> use near <span style="color:#e6db74">&#39;-value over (partition by sensor order by checktime) as delta from series order &#39;</span> <span style="color:#66d9ef">at</span> line <span style="color:#ae81ff">1</span>
</code></pre></div><p>Because <code>OVER()</code> expressions can become quite unwieldy (especially if you also define frames - not explained here - in them), they can be named and put into the select-statement at a place behind the <code>FROM</code> clause.</p>
<p>This gives us</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">root<span style="color:#f92672">@</span>localhost [kris]<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> id, 
  <span style="color:#f92672">-&gt;</span> sensor, 
  <span style="color:#f92672">-&gt;</span> checktime, 
  <span style="color:#f92672">-&gt;</span> value, 
  <span style="color:#f92672">-&gt;</span> lag(value) over w <span style="color:#f92672">-</span> value <span style="color:#66d9ef">as</span> delta 
  <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">from</span> series 
  <span style="color:#f92672">-&gt;</span> window w <span style="color:#66d9ef">as</span> (partition <span style="color:#66d9ef">by</span> sensor <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> checktime);
<span style="color:#f92672">+</span><span style="color:#75715e">----+--------+---------------------+----------+----------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> id <span style="color:#f92672">|</span> sensor <span style="color:#f92672">|</span> checktime           <span style="color:#f92672">|</span> value    <span style="color:#f92672">|</span> delta                <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----+--------+---------------------+----------+----------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span>  <span style="color:#ae81ff">9</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">0</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">01</span><span style="color:#f92672">-</span><span style="color:#ae81ff">04</span> <span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">9</span>.<span style="color:#ae81ff">20321</span> <span style="color:#f92672">|</span>                 <span style="color:#66d9ef">NULL</span> <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span>  <span style="color:#ae81ff">5</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">0</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">01</span><span style="color:#f92672">-</span><span style="color:#ae81ff">06</span> <span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span> <span style="color:#f92672">|</span>  <span style="color:#ae81ff">4</span>.<span style="color:#ae81ff">63966</span> <span style="color:#f92672">|</span>     <span style="color:#ae81ff">4</span>.<span style="color:#ae81ff">56355619430542</span> <span style="color:#f92672">|</span>
<span style="color:#960050;background-color:#1e0010">…</span>
</code></pre></div><p>as a different syntax with the same result. It is possible to define more than window, as long as they have different window names, and it is possible for a window to be referred to zero or more times.</p>
<p>The Manual on <a href="https://dev.mysql.com/doc/refman/8.0/en/window-functions.html" target="_blank" rel="noopener">Windows Functions</a>

.</p>


	
    </article>
</div>



            <footer>
    <p>
	&copy; Copyright 2021 Someone or something
    </p>
</footer>


        </main>

	





<script src="/js/bootstrap.js"></script>




<script src="/js/lunr.js"></script>





<script src="/js/app.js"></script>


    </body>
</html>
