<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Die wunderbare Welt von Isotopp - MySQL Undo Log</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="site.webmanifest">
<link rel="apple-touch-icon" href="icon.png">
<link rel="favicon.ico" rel="icon" type="image/ico">





	



<link rel="stylesheet" href="/style.min.c5e5cd61f54911f9aafd1dbe09c2f90667957bfe1002126c87aace57759f3446.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
	<a class="navbar-brand" href="" rel="home" title=".Site.Title">
	    Die wunderbare Welt von Isotopp
	</a>
	<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
	</button>

	<div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
		
		
		<li class="nav-item ">
                    <a class="nav-link" href="/about/">
			
			<span>About</span>
			<span class="visually-hidden">(Current)</span>
		    </a>
		    
		</li>
            </ul>
            
	</div>
    </div>
</nav>


        <main role="main" class="container-fluid">

            


<div class="page">
    <article class="mysql-undo-log-page">
	<h1 class="title">
            MySQL Undo Log
	</h1>

	<p><p class="md__image">
  <img src="/uploads/undo_log_stats.png" alt=""  />
</p>

</p>
<p>&ldquo;Kris, kannst Du bitte mal gucken?&rdquo;</p>
<p>Seit heute morgen, 10:00 Uhr, wächst das Undo Log immer weiter an.</p>
<p>Immer wenn InnoDB Daten schreibt wird die alte Version einer Zeile aus der
Tabelle in das Undo-Log verschoben, also physikalisch von der ibd-Datei der
Tabelle in die ibdata1 im Datadir von MySQL. In der Tabelle wird in der
veränderten Zeile ein Zeiger von der neuen Version auf die alte Version der
Zeile im Undo-Log installiert, der Roll(back)-Pointer. Die alte Version im
Undo-Log zeigt mit ihrem eigenen Roll-Pointer auf eine noch ältere Version
derselben Zeile und so weiter - es entsteht für jede Zeile in der Datenbank
eine lineare Liste von Versionen in die Vergangenheit einer Row.</p>
<p>Der InnoDB Purge Thread hat die Aufgabe, das Undo Log zu verkürzen. Wenn er
das nicht tut, dann sieht das so aus wie oben im Graphen gezeigt. Dafür kann
es zwei Gründe geben: Purge Lag - also mehr Writes als der Purge Thread
wegschaffen kann. Oder lang laufende Transaktionen. Denn der Purge Thread
kann nur dann eine Zeile aus dem Undo Log streichen, wenn es keine aktive
Transaktion mehr im ganzen System gibt, die älter ist als die zu streichende
Zeile.</p>
<p>Das ist die weitaus wahrscheinlichere Fehlerquelle. Wie also finden wir den
Schuldigen?</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> pager grep ACTIVE
mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> engine innodb status<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
...
<span style="color:#75715e">---TRANSACTION A90E003AB, ACTIVE 16830 sec, process no 12098, OS thread id 1749563712
</span><span style="color:#75715e"></span>...
mysql<span style="color:#f92672">&gt;</span> pager
mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> engine innodb status<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
...
<span style="color:#75715e">---TRANSACTION A90E003AB, ACTIVE 16830 sec, process no 12098, OS thread id 1749563712
</span><span style="color:#75715e"></span><span style="color:#ae81ff">3</span> <span style="color:#66d9ef">lock</span> struct(s), heap <span style="color:#66d9ef">size</span> <span style="color:#ae81ff">1248</span>, <span style="color:#ae81ff">2</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">lock</span>(s), undo log entries <span style="color:#ae81ff">1</span>
MySQL thread id <span style="color:#ae81ff">146473882</span>, query id <span style="color:#ae81ff">4156570244</span> mc02cronapp<span style="color:#f92672">-</span><span style="color:#ae81ff">01</span> <span style="color:#ae81ff">192</span>.<span style="color:#ae81ff">168</span>.<span style="color:#ae81ff">1</span>.<span style="color:#ae81ff">10</span> cron_bp
Trx <span style="color:#66d9ef">read</span> <span style="color:#66d9ef">view</span> will <span style="color:#66d9ef">not</span> see trx <span style="color:#66d9ef">with</span> id <span style="color:#f92672">&gt;=</span> A90E14DE8, sees <span style="color:#f92672">&lt;</span> A90E14DE8
...
</code></pre></div><p>Ein Cronjob hängt also in einer offenen Transaktion seit geraumer Zeit fest?
Mehr Informationen bekommen wir aus der Prozeßliste:</p>
<pre><code class="language-console" data-lang="console">mysql&gt; pager grep cron
mysql&gt; show processlist;
...
| 146473882 | cron_bp       | mc02cronapp-01:50154 | bp   | Sleep       |   16434 |
...
</code></pre><p>Ein Login auf der mc02cronapp-01 und ein &ldquo;lsof -i -n -P | grep 50154&rdquo; zeigt
schnell: Mitnichten ein Cronjob. Ein User hat einen MySQL
Kommandozeilenclient gestartet und eine manuelle Verbindung und Transaktion
offen gelassen. Ein &ldquo;KILL 146473882&rdquo; auf den Thread in MySQL trennt die
Verbindung und der Purge Thread kann seine Arbeit fortsetzen, ein Sysadmin
mit einem Cluebat kann zu dem User dispatched werden.</p>
<p>Das Undo-Log ist Teil der ibdata1-Datei. Diese startet mit einer Größe von
10M und wächst per Default in Schritten von 8M im autoextend-Modus. Lang
laufende Transaktionen, die den Purge Thread anhalten, führen zu einem
Wachstum der ibdata1. InnoDB schrumpft Dateien niemals, und es gibt auch
keine Methode, das zu tun - zwar wird der Platz <em>in</em> der Datei
freigegeben und später wieder genutzt, aber für das Betriebssystem ist der
Platz verloren.</p>
<pre><code class="language-console" data-lang="console">[root@mc01bpmdb-01 ~]# cd /mysql/bp/data
[root@mc01bpmdb-01 data]# ls -lh ibdata*
-rw-rw---- 1 mysql mysql 1.3G Apr 28 14:50 ibdata1
</code></pre>

	
    </article>
</div>



            <footer>
    <p>
	&copy; Copyright 2021 Someone or something
    </p>
</footer>


        </main>

	





<script src="/js/bootstrap.js"></script>




<script src="/js/lunr.js"></script>





<script src="/js/app.js"></script>


    </body>
</html>
