<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Die wunderbare Welt von Isotopp - MySQL hakt...</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="site.webmanifest">
<link rel="apple-touch-icon" href="icon.png">
<link rel="favicon.ico" rel="icon" type="image/ico">





    



<link rel="stylesheet" href="https://blog.koehntopp.info/style.min.e525cc19e18f2cbf426091105e559b85dfd95ed4f6e083666ffc41242d16af82.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light px-lg-4 pt-lg-4">
    <div class="container-fluid">
        <a class="navbar-brand justify-content-center" href="https://blog.koehntopp.info" rel="home" title="Die wunderbare Welt von Isotopp">
            <img height='48' width='48' src='/assets/img/kris.jpg' class='p-0 me-3 d-block d-lg-inline'>
            <span class='h4 d-block d-lg-inline'>Die wunderbare Welt von Isotopp</span>
        </a>

        <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                
                <li class="nav-item ">
                    <a class="nav-link" href="/about/">
                        <span class="">About</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/contribute/">
                        <span class="">Contribute</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/search/">
                        <span class=""><svg class='bi' height='1.5rem' width='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#search'/></svg></span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/tags/">
                        <span class=""><svg class='bi' width='1.5rem' height='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#tags-fill'/></svg></span>
                        
                    </a>
                </li>
                
            </ul>
            
        </div>

    </div>
</nav>


        <main role="main" class="container-fluid p-0">

            


<div class="page">
  <article class="mysql-hakt...-page">
    <div class='row justify-content-center text-center my-4 mx-0'>
      <header>
        <div class='col'>
          <h1 class="title mb-lg-4 text-white">
            MySQL hakt&hellip;
          </h1>
          <div class='text-uppercase text-light' style='letter-spacing: 0.1rem;'>
              <img src='/assets/img/kris.jpg' class='me-1 p-0' style='width: 1.9rem; border-radius: 1rem;'>
              <a href="https://twitter.com/isotopp" class='text-light text-decoration-none'>
                Kristian Köhntopp
              </a>
            

            
              <span class='d-none d-lg-inline'>-</span> 
              <div class='d-block d-lg-inline'>August 21, 2012</div>
            

          </div>
        </div>
        <img src='https://blog.koehntopp.info/assets/img/background/rijksmuseum.jpg'>
      </header>
    </div>

    <div class='row justify-content-center mx-0 mt-5 mb-5'>
      <div class='col-lg-8'>
        <p>&ldquo;Hey, Kris!  Wir haben zwischen 16:20 und 17:20 CEST einen Lasttest
durchgeführt und kurz vor 17:00 Uhr einen unerklärlichen Spike und einen
Leistungsabfall festgestellt.  Kannst Du mal gucken?&rdquo;</p>
<p>Klar kann ich.  Wo ich arbeite machen wir etwas, das wir
<a href="https://blog.koehntopp.info/2011/12/02/testing-in-production.html">Testing in Production</a>


nennen.</p>
<p>Für Lasttests bedeutet das, daß wir einzelne Systeme im Loadbalancer so
lange relativ höher gewichten bis sie Probleme bekommen und umfallen.  Zur
Kontrolle legen wir mit Apache Siege eine Reihe von Sensor-Requests in das
zu testende System, nicht zur Lastgenerierung, sondern um zu sehen, wann die
Latenz nach oben geht, also um Sättigung des zu testenden Systems zu
bemerken bevor es Fehler zu generieren beginnt.</p>
<p>Wenn wir nahe an den Sättigungspunkt gelangen, erhöhen wir die Last in sehr
winzigen Schritten, bis wir tatsächlich Systemversagen zu beobachten
beginnen und können so nicht nur die Lastgrenze, sondern auch die Symptome
beim Systemversterben genau und unter realistischen Bedingungen ermitteln.
Das macht die Arbeit im Operations Team sehr viel einfacher.</p>
<p>Wenn ein System aber Probleme hat und dann bei statischer Load zurück kommt,
liegt eine andere Situation vor.  Es ist wichtig herauszufinden, was genau
hier passiert.</p>
<p>Hier die Metriken:</p>
<p><p class="md__image">
  <img src="/uploads/mysql-problem1-replication-delay.png" alt="MySQL: Replication Delay"  />
</p>

</p>
<p>Replication Delay legt das Krisenfenster in die Zeit zwischen 16:53 (Delay
Spike) und 17:00 (Recovery).</p>
<p>Zur selben Zeit auch ein Disk Read Spike.  Read Spikes sind ungewöhnlich,
weil das betreffende System so dimensioniert ist, daß es seinen Working Set
praktisch vollständig im Hauptspeicher halten kann:</p>
<p><p class="md__image">
  <img src="/uploads/mysql-problem2-disk-read-spike.png" alt="System: Disk I/O Operations"  />
</p>

</p>
<p>Das fragliche System soll operativ für alle praktischen Zwecke gar nicht von
der Platte lesen.</p>
<p>Wir können nun nach weiteren Quellen für ungewöhnliches Verhalten suchen:
CPU und Connections gehen von 16:52 bis 17:00 hoch, aber es gibt keine Row
Acces Spikes, keine Spikes bei Tmp-Tables-to-disk und auch keine Spikes bei
Sortiervorgängen, insbesondere Merge Sorts.</p>
<p>Der InnoDB Buffer Pool Graph hat am Ende den entscheidenden Hinweis:</p>
<p><p class="md__image">
  <img src="/uploads/mysql-problem3-buffer-pool-drop.png" alt="MySQL: InnoDB Buffer Pool Usage"  />
</p>

</p>
<p>16:52 - InnoDB Buffer Pool <em>verkleinert</em> sich.</p>
<p>Um 16:52 verkleinert sich der InnoDB Buffer Pool.  Das tritt im Normalfall
nur dann auf, wenn Speicherseiten im Pool freigegeben werden, und das
wiederum kann nur dann geschehen, wenn eine Tabelle mit TRUNCATE TABLE
zurückgesetzt oder mit DROP TABLE gelöscht wird.</p>
<p>Wir müssen also schauen, ob es in der Zeit von 16:50 bis 16:53
DDL-Statements gegeben haben, die Tabellen kürzen oder löschen.  Auf allen
unseren Systemen läuft zu diesem Zweck
<a href="http://blog.wl0.org/2011/02/log_processlist-sh-script-for-monitoring-mysql-instances/" target="_blank" rel="noopener">log_processlist</a>


das eine Reihe interessanter Dinge aus der Datenbank für post-mortem
Analysen lokal aufzeichnet und für bis zu eine Woche vorhält.</p>
<p>Tatsächlich findet sich:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp"># </span>less 16_52.innodb.gz
<span class="go">...
</span><span class="go">SQL: SELECT * FROM INFORMATION_SCHEMA.INNODB_TRX
</span><span class="go">910556099       RUNNING 2012-08-08 16:51:59     
</span><span class="go">  NULL    NULL    0       2       
</span><span class="go">  TRUNCATE TABLE tmp_gethoteldescriptiontranslations
</span><span class="go">  truncating table        1       1       0       376
</span><span class="go">  0       0       0       
</span><span class="go">  REPEATABLE READ 1       1       
</span><span class="go">  NULL    0       10000
</span><span class="go">...
</span></code></pre></div><p>Der Pileup entsteht durch eine Folge von DDL-Locks, die durch ein
Wartungsscript erzeugt werden.  Das Script lädt eine neue Tabelle in die
Datenbank, tauscht die aktive Tabelle mit der neuen Tabelle aus und setzt
die alte Tabelle dann zurück bevor es sie löscht.</p>
<p><a href="http://www.mysqlperformanceblog.com/2012/06/22/drop-table-and-stalls-lazy-drop-table-in-percona-server-and-the-new-fixes-in-mysql/" target="_blank" rel="noopener">Background Table Drop</a>


würde hier helfen, aber die fragliche Kiste ist wie ihre Geschwister noch
5.5.16 und nicht 5.5.23.</p>

      </div>
    </div>

    <div class='row justify-content-center mb-3'>
      <div class='col-lg-8 text-center'>
        <span class='letter-spacing-01 text-uppercase text-secondary me-2'>Share</span>
        <a href='https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.koehntopp.info%2f2012%2f08%2f21%2fmysql-hakt.html' target='_blank'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#facebook'/></svg>
        </a>
        <a href='https://twitter.com/intent/tweet?source=https%3a%2f%2fblog.koehntopp.info%2f2012%2f08%2f21%2fmysql-hakt.html&text=MySQL%20hakt...%20%7C%20Die+wunderbare+Welt+von+Isotopp:%20https%3a%2f%2fblog.koehntopp.info%2f2012%2f08%2f21%2fmysql-hakt.html' target='_blank'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#twitter'/></svg>
        </a>
      </div>
    </div>

    <div class='row justify-content-center mb-5 pt-5 border-top'>
      <div class='col-lg-4 text-center text-lg-start'>
         
          <div>
            <div class='letter-spacing-01 text-uppercase text-secondary'>
              Next Post
            </div>
            <a class='text-decoration-none' href="https://blog.koehntopp.info/2012/08/21/fertig-gelesen-the-epoch-index-if-at-first.html">Fertig gelesen: The Epoch Index und If at first...</a>
          </div>
        
      </div>

      <div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
         
          <div>
            <div class='letter-spacing-01 text-uppercase text-secondary'>
              Previous Post
            </div>
            <a class='text-decoration-none' href="https://blog.koehntopp.info/2012/08/20/fertig-gelesen-nymph-the-singularity.html">Fertig gelesen: Nymph - The Singularity</a>
          </div>
        
      </div>
    </div>

    
    </article>
</div>



            <footer class='row justify-content-center mb-4 pb-4 mx-0'>
  <div class='col-8 text-center'>
    <div>
      A collection of old stuff, new stuff and random stuff. 
    </div>
    <div class='row text-primary mt-4'>
      <div class='col'>

        <a href='/index.xml' title='Follow RSS feed' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#rss-fill'/></svg>
        </a>

        <a href='mailto:kristian.koehntopp@gmail.com' title='Email' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#envelope'/></svg>
        </a>

        <a href='https://github.com/isotopp' title='Follow on GitHub' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#github'/></svg>
        </a>

        <a href='https://www.reddit.com/user/isotopp' title='Follow on Reddit' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#reddit'/></svg>
        </a>

        <a href='http://steamcommunity.com/id/ixotopp' title='Follow on Steam' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#steam'/></svg>
        </a>

        <a href='https://twitter.com/isotopp' title='Follow on Twitter' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#twitter'/></svg>
        </a>

        <a href='https://www.youtube.com/user/isotopp' title='Follow on YouTube' class=''>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#youtube'/></svg>
        </a>

      </div>
    </div>
  </div>
</footer>


        </main>

	





<script src="https://blog.koehntopp.info/js/bootstrap.js"></script>




<script src="https://blog.koehntopp.info/js/lunr.js"></script>





<script src="https://blog.koehntopp.info/js/app.js"></script>


    </body>
</html>
